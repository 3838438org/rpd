/**
 * rpd - RPD is a minimal framework for building Node-Based User Interfaces, powered by Reactive Programming
 * Built at Sat, 09 Jan 2016 22:33:38 GMT
 *
 * @version v0.2.0-alpha
 * @link http://shamansir.github.io/rpd
 * @author Ulric Wilfred <shaman.sir@gmail.com>
 * @license MIT
 * 
 * Selected Renderers: svg
 * Selected Styles: compact-v
 * Selected Toolkits: core
 * Selected I/O Modules: [None]
 * d3.js or d3_tiny.js: d3_tiny.js
 *
 * User Styles: [None]
 * User Toolkits: [None]
 *
 * Command: gulp --root . --renderer svg --style compact-v --toolkit core --target-name rpd-docs --compilation simple
 */
(function(e){var g=e.Kefir;"undefined"===typeof g&&"undefined"!==typeof require&&(g=require("../vendor/kefir.min.js"));if(!g)throw Error("Kefir.js (https://github.com/rpominov/kefir) is required for Rpd to work");var c=function(){function d(a){return function(){return a}}function k(a){this.id=n();this.name=a;var f=this;a={"patch/is-ready":[],"patch/enter":[],"patch/exit":[],"patch/set-inputs":["inputs"],"patch/set-outputs":["outputs"],"patch/project":["node","target"],"patch/refer":["node","target"],
"patch/add-node":["node"],"patch/remove-node":["node"]};this.event=z(a);this.events=t(a,this.event,"patch",this);this.renderQueue=g.emitter();a=g.combine([this.events],[this.renderQueue.scan(function(a,b){var m=b.alias,c=b.target,g=b.config,d=a[m];d||(d={},d.produce=K[m](f),d.handlers=[],a[m]=d);if(d.produce){var e=d.produce(c,g);e&&d.handlers.push("function"===typeof e?e:function(a){if(e[a.type])e[a.type](a)})}return a},{})]);a=a.bufferBy(this.renderQueue).take(1).flatten().concat(a);a.onValue(function(a){var f=
a[0];a=a[1];for(var b=Object.keys(a),m,c=0,d=b.length;c<d;c++){m=a[b[c]];m=m.handlers;for(var e=0,g=m.length;e<g;e++)m[e](D(H(f),b[c]))}});this.projections=g.emitter();g.combine([this.projections],[this.event["patch/set-inputs"],this.event["patch/set-outputs"]]).onValue(function(a){var b=a[0],m=a[1];a=a[2];for(var c,d=0;d<m.length;d++)c=b.addInlet(m[d].type,m[d].name),c.event["inlet/update"].onValue(function(a){return function(f){a.receive(f)}}(m[d]));for(d=0;d<a.length;d++)m=b.addOutlet(a[d].type,
a[d].name),a[d].event["outlet/update"].onValue(function(a){return function(f){a.send(f)}}(m));f.event["patch/project"].emit({node:b,target:b.patch});b.patch.event["patch/refer"].emit({node:b,target:f})});this.nodesToRemove=g.emitter();this.event["patch/is-ready"].emit()}function e(a,f,l,b){this.type=a||"core/empty";this.id=n();this.patch=f;f={"node/turn-on":[],"node/is-ready":[],"node/process":["inlets","outlets"],"node/turn-off":[],"node/add-inlet":["inlet"],"node/remove-inlet":["inlet"],"node/add-outlet":["outlet"],
"node/remove-outlet":["outlet"],"node/move":["position"]};this.event=z(f);this.events=t(f,this.event,"node",this);(f=I(F[this.type],this))||w("Node type "+this.type+" is not registered!");this.def=f;this.name=l||f.name||a;this.render=m(y[this.type],this);b&&b(this);var c=this;if(this.def.handle)this.events.onValue(function(a){if(c.def.handle[a.type])c.def.handle[a.type](a)});if(this.def.process){var d=this.def.process;a=g.combine([this.event["node/add-inlet"].flatMap(function(a){var f=a.event["inlet/update"].map(function(f){return{inlet:a,
value:f}});c.def.tune&&(f=c.def.tune(f));return f})],[this.event["node/add-outlet"].scan(function(a,f){a[f.alias]=f;return a},{})]);a=a.bufferBy(this.event["node/is-ready"]).take(1).flatten().concat(a);a=a.scan(function(a,f){var l=f[0].inlet,b=l.alias;a.inlets.prev[b]=a.inlets.cur[b];a.inlets.cur[b]=f[0].value;a.outlets=f[1];a.source=l;return a},{inlets:{prev:{},cur:{}},outlets:{}}).changes();a=a.filter(function(a){return!a.source.cold});a.onValue(function(a){var f=d.bind(c)(a.inlets.cur,a.inlets.prev);
c.event["node/process"].emit({inlets:a.inlets.cur,outlets:f});a=a.outlets;for(var l in f)a[l]&&(f[l]instanceof g.Stream?a[l].stream(f[l]):a[l].send(f[l]))})}if(this.def.inlets){this.inlets={};for(var k in this.def.inlets)a=this.def.inlets[k],a=this.addInlet(a.type,k,a.name,a.default,a.hidden,a.readonly,a.cold),this.inlets[k]=a}if(this.def.outlets)for(k in this.outlets={},this.def.outlets)a=this.def.outlets[k],a=this.addOutlet(a.type,k,a.name,a.default),this.outlets[k]=a;this.def.prepare&&this.def.prepare(this.inlets,
this.outlets);this.event["node/is-ready"].emit()}function p(a,f,l,b,c,d,e,k){this.type=a||"core/any";this.id=n();var q=I(G[this.type],this);q||w("Channel type "+this.type+" is not registered!");this.def=q;(this.alias=l||q.alias||b)||w("Inlet should have either alias or name");this.name=b||q.name||this.alias||a;this.node=f;this.hidden=d||!1;this.readonly=v(e||q.readonly)?e||q.readonly:!0;this.cold=k||!1;this.default=v(c)?c:q.default;this.value=g.pool();this.render=m(B[this.type],this);a={"inlet/update":["value"]};
this.event=z(a);var J=this.event["inlet/update"];f=J.merge(this.value);q.tune&&(f=q.tune(f));q.accept&&(f=f.flatten(function(a){if(q.accept(a))return[a];J.error();return[]}));q.adapt&&(f=f.map(q.adapt));this.event["inlet/update"]=f.onValue(function(){});this.events=t(a,this.event,"inlet",this)}function h(a,f,l,b,c){this.type=a||"core/any";this.id=n();var d=I(G[this.type],this);d||w("Channel type "+this.type+" is not registered!");this.def=d;(this.alias=l||d.alias||b)||w("Outlet should have either alias or name");
this.name=b||this.alias||d.name||a;this.node=f;this.default=v(c)?c:d.default;this.value=g.pool();this.render=m(B[this.type],this);a={"outlet/update":["value"],"outlet/connect":["link","inlet"],"outlet/disconnect":["link"]};this.event=z(a);f=this.event["outlet/update"].merge(this.value);this.event["outlet/update"]=f.onValue(function(a){});this.events=t(a,this.event,"outlet",this);var e=this;g.combine([this.event["outlet/connect"]],[this.event["outlet/update"]]).onValue(function(a){e.value.plug(g.constant(a[1]))})}
function b(a,f,l){this.id=n();this.name=l||"";this.outlet=a;this.inlet=f;this.value=g.emitter();var b=this;this.receiver=a.node.id!==f.node.id?function(a){b.pass(a)}:function(a){setTimeout(function(){b.pass(a)},0)};a={"link/enable":[],"link/disable":[],"link/pass":["value"]};this.event=z(a);l=this.event["link/pass"].merge(this.value);this.event["link/pass"]=l.onValue(function(a){});this.events=t(a,this.event,"link",this);this.enabled=g.merge([this.event["link/disable"].map(d(!1)),this.event["link/enable"].map(d(!0))]).toProperty(d(!0));
this.event["link/pass"].filterBy(this.enabled).onValue(function(a){f.receive(a)});g.combine([this.event["link/enable"]],[this.event["link/pass"]]).onValue(function(a){b.pass(a[1])})}function H(a){for(var f={},l=Object.keys(a),b=0,m=l.length;b<m;b++)f[l[b]]=a[l[b]];return f}function v(a){return"undefined"!==typeof a}function I(a,f){return a?"function"===typeof a?a(f):a:null}function m(a,f){if(!a)return{};var l={},b;for(b in a)l[b]=I(a[b],f);return l}function z(a){var f={};a=Object.keys(a);for(var l=
0,b;l<a.length;l++)b=a[l],f[b]=g.emitter();return f}function q(a,f){if(0===f.length)return function(){return{type:a}};if(1===f.length)return function(l){var b={};b.type=a;b[f[0]]=l;return b};if(1<f.length)return function(f){f=H(f);f.type=a;return f}}function t(a,f,l,b){for(var m=g.pool(),c=Object.keys(a),d=0;d<c.length;d++)m.plug(f[c[d]].map(q(c[d],a[c[d]])).map(function(a){a[l]=b;return a}));return m}function w(a,f){throw f||Error(a);}function n(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}
function D(a,f){var l=a.type;if("patch/add-node"===l||"node/process"===l)a.render=a.node.render[f]||{};else if("node/add-inlet"===l||"inlet/update"===l)a.render=a.inlet.render[f]||{};else if("node/add-outlet"===l||"outlet/update"===l)a.render=a.outlet.render[f]||{};return a}(function(){g.emitter=function(){var a,f=g.stream(function(f){a=f;return function(){a=void 0}});f.emit=function(f){a&&a.emit(f);return this};f.error=function(f){a&&a.error(f);return this};f.end=function(){a&&a.end();return this};
f.emitEvent=function(f){a&&a.emitEvent(f);return this};return f.setName("emitter")}})();var F={},G={},y={},B={},J={},C={},K={},x={"network/add-patch":["patch"]},r=z(x),u=t(x,r,"network",c);r["network/add-patch"].onValue(function(a){u.plug(a.events)});var A=g.emitter();k.prototype.render=function(a,f,l){a=Array.isArray(a)?a:[a];f=Array.isArray(f)?f:[f];for(var b=0,m=a.length,c;b<m;b++)for(var d=0,e=f.length,g;d<e;d++){c=a[b];g=f[d];if(!K[c])throw Error("Renderer "+c+" is not registered");this.renderQueue.emit({alias:c,
target:g,config:l})}return this};k.prototype.addNode=function(a,f){var l=this;return new e(a,this,f,function(a){l.events.plug(a.events);l.event["patch/add-node"].emit(a);a.turnOn()})};k.prototype.removeNode=function(a){a.turnOff();this.event["patch/remove-node"].emit(a);this.events.unplug(a.events)};k.prototype.enter=function(){this.event["patch/enter"].emit();return this};k.prototype.exit=function(){this.event["patch/exit"].emit();return this};k.prototype.inputs=function(a){this.event["patch/set-inputs"].emit(a)};
k.prototype.outputs=function(a){this.event["patch/set-outputs"].emit(a)};k.prototype.project=function(a){this.projections.emit(a)};e.prototype.turnOn=function(){this.event["node/turn-on"].emit()};e.prototype.turnOff=function(){this.event["node/turn-off"].emit()};e.prototype.addInlet=function(a,f,l,b,m,c,d){a=new p(a,this,f,l,b,m,c,d);this.events.plug(a.events);this.event["node/add-inlet"].emit(a);a.toDefault();return a};e.prototype.addOutlet=function(a,f,l,b){a=new h(a,this,f,l,b);this.events.plug(a.events);
this.event["node/add-outlet"].emit(a);a.toDefault();return a};e.prototype.removeInlet=function(a){this.event["node/remove-inlet"].emit(a);this.events.unplug(a.events)};e.prototype.removeOutlet=function(a){this.event["node/remove-outlet"].emit(a);this.events.unplug(a.events)};e.prototype.move=function(a,f){this.event["node/move"].emit([a,f]);return this};p.prototype.receive=function(a){this.value.plug(g.constant(a))};p.prototype.stream=function(a){this.value.plug(a)};p.prototype.toDefault=function(){v(this.default)&&
(this.default instanceof g.Stream?this.stream(this.default):this.receive(this.default))};p.prototype.allows=function(a){if(a.type===this.type)return!0;if(!this.def.allow&&a.type!==this.type)return!1;if(this.def.allow){var f=!1;this.def.allow.forEach(function(l){a.type===l&&(f=!0)});return f}return!0};h.prototype.connect=function(a){if(!a.allows(this))throw Error("Outlet of type "+this.type+" is not allowed to connect to inlet of type "+a.type);var f=new b(this,a);this.events.plug(f.events);this.value.onValue(f.receiver);
this.event["outlet/connect"].emit({link:f,inlet:a});return f};h.prototype.disconnect=function(a){this.event["outlet/disconnect"].emit(a);this.value.offValue(a.receiver);this.events.unplug(a.events);return this};h.prototype.send=function(a){this.value.plug(g.constant(a))};h.prototype.stream=function(a){this.value.plug(a)};h.prototype.toDefault=function(){v(this.default)&&(this.default instanceof g.Stream?this.stream(this.default):this.send(this.default))};b.prototype.pass=function(a){this.value.emit(a)};
b.prototype.enable=function(){this.event["link/enable"].emit()};b.prototype.disable=function(){this.event["link/disable"].emit()};b.prototype.disconnect=function(){this.outlet.disconnect(this)};return{VERSION:"v2.0",_:{Patch:k,Node:e,Inlet:p,Outlet:h,Link:b},unit:d,not:function(a){return!a},event:r,events:u,addPatch:function(a){a=new k(a);r["network/add-patch"].emit(a);return a},render:function(a,f,l){A.emit([a,f,l]);var b=function(b){b.render(a,f,l)};r["network/add-patch"].onValue(b);return function(){r["network/add-patch"].offValue(b)}},
nodetype:function(a,f){F[a]=f||{}},channeltype:function(a,f){G[a]=f||{}},nodedescription:function(a,f){J[a]=f},renderer:function(a,f){K[a]=f},styles:C,style:function(a,f,b){C[a]||(C[a]={});C[a][f]=b},noderenderer:function(a,f,b){if(!F[a])throw Error("Node type "+a+" is not registered");y[a]||(y[a]={});y[a][f]=b},channelrenderer:function(a,f,b){if(!G[a])throw Error("Channel type "+a+" is not registered");B[a]||(B[a]={});B[a][f]=b},"import":{},"export":{},allNodeTypes:F,allChannelTypes:G,allNodeRenderers:y,
allChannelRenderers:B,allNodeDescriptions:J,getStyle:function(a,f){if(!a)throw Error("Unknown style requested: "+a);if(!C[a])throw Error("Style '"+a+"' is not registered");var b=C[a][f];if(!b)throw Error("Style '"+a+"' has no definition for '"+f+"' renderer");return b},short_uid:n}}();"function"===typeof define&&define.amd?(define([],function(){return c}),e.Rpd=c):"object"===typeof module&&"object"===typeof exports?(module.exports=c,c.Rpd=c):e.Rpd=c})(this);var d3_tiny=function(){function e(c,d,e){for(var g="function"===typeof d?d:function(){return d},p=c.selection,h=0,b=p.length;h<b;h++)e(p[h],g.bind(p[h])(h));return c}function g(c,d,e){d=d||document;selection="string"===typeof c?e?Array.prototype.slice.call(d.querySelectorAll(c),0):[d.querySelector(c)]:c instanceof Node?[c]:Array.isArray(c)?c:[c];this.namespace=1===selection.length&&selection[0]?selection[0].namespaceURI:null;this.selection=selection}g.prototype.empty=function(){return 1===this.selection.length&&
!this.selection[0]||!this.selection.length?!0:!1};g.prototype.attr=function(c,d){return"undefined"===typeof d&&1===this.selection.length?this.selection[0].getAttribute(c):e(this,d,function(d,e){d.setAttributeNS(null,c,e)})};g.prototype.property=function(c,d){return"undefined"===typeof d&&1===this.selection.length?this.selection[0][c]:e(this,d,function(d,e){d[c]=e})};g.prototype.style=function(c,d){"-"===c[0]&&(c=c.slice(1));c=c.replace(/-([a-z])/g,function(c){return c[1].toUpperCase()});return e(this,
d,function(d,e){d.style[c]=e})};g.prototype.text=function(c){return"undefined"===typeof c&&1===this.selection.length?this.selection[0].textContent||this.selection[0].innerText:e(this,c,function(c,e){c.innerText=c.textContent=e})};g.prototype.classed=function(c,d){return"object"===typeof c?e(this,Object.keys(c),function(d,e){for(var g=0,h=e.length;g<h;g++)d.classList.toggle(e[g],c[e[g]])}):e(this,d,function(d,e){d.classList.toggle(c,e)})};g.prototype.select=function(c){return new g(c,this.selection[0])};
g.prototype.selectAll=function(c){return new g(c,this.selection[0],!0)};g.prototype.append=function(c){var d=[];e(this,"string"===typeof c?document.createElementNS(this.namespace,c):c,function(c,e){c.appendChild(e);d.push(e)});return new g(d)};g.prototype.remove=function(){return e(this,function(){return null},function(c){c.parentElement.removeChild(c)})};g.prototype.node=function(c){return this.selection[c||0]};g.prototype.on=function(c,d){return e(this,function(){return d},function(d,e){d.addEventListener(c,
e)})};g.prototype.data=function(c){return c?e(this,c,function(c,e){c.__data__=e}):this.node().__data__};g.prototype.call=function(c){c(this);return this};return{ns:{prefix:{svg:"http://www.w3.org/2000/svg",html:"http://www.w3.org/1999/xhtml"}},select:function(c,d){return new g(c,d)},selectAll:function(c,d){return new g(c,d,!0)}}}();Rpd.Render=function(){function e(b){this.currentPatch=null;this.getPatchByHash=b;var c=this;Kefir.fromEvents(window,"hashchange").map(function(){return window.location.hash?window.location.hash.slice(1):null}).filter(function(b){return!(c.currentPatch&&b===c.currentPatch.id)}).map(c.getPatchByHash).filter(function(b){return null!=b}).onValue(function(b){c.currentPatch&&c.currentPatch.exit();b.enter()})}function g(b){this.nodeRects=[];this.edgePadding=b.edgePadding||{horizontal:30,vertical:20};this.boxPadding=
b.boxPadding||{horizontal:20,vertical:30}}function c(b,c){this.root=b;this.style=c}function d(b,c){this.link=b;this.style=c;this.element=this.styledLink=null}function k(){this.vlinks=[]}function E(b){b.stopPropagation();return b}function p(b){return{x:b.clientX,y:b.clientY}}function h(c,d,e,g){Kefir.fromEvents(c,"click").map(E).map(b(g||!1)).scan(Rpd.not).onValue(function(b){b?d():e()})}var b=Rpd.unit,H=d3_tiny||H;e.prototype.switch=function(b){b&&(this.currentPatch=b,0<=document.title.indexOf("\u2014")?
document.title=document.title.replace(/\u2014.+$/,"\u2014 "+b.name||"[Unnamed]"):document.title+=" \u2014 "+b.name||"[Unnamed]",window.location.hash=b.id)};g.DEFAULT_LIMITS=[1E3,1E3];g.prototype.nextPosition=function(b,c,d){d=d||g.DEFAULT_LIMITS;b=this.nodeRects;var e=this.boxPadding,k=this.edgePadding,n=c.width;c=c.height;var h=b.length?b[b.length-1]:null,h={x:h?h.x:k.horizontal,y:h?h.y+h.height+e.vertical:k.vertical,width:n,height:c};h.y+c+k.vertical>d.height&&(h.x=h.x+n+e.horizontal,h.y=k.vertical);
b.push(h);return{x:h.x,y:h.y}};c.prototype.add=function(b,c){var d=this.root,e=this.style,g=c.start,k=c.end,h=c.drag;Kefir.fromEvents(b.node(),"mousedown").map(p).map(e.getLocalPos).flatMap(function(c){var h=g(),z=c.x-h.x,H=c.y-h.y;c=Kefir.fromEvents(d.node(),"mousemove").map(E).takeUntilBy(Kefir.merge([Kefir.fromEvents(d.node(),"mouseup"),Kefir.fromEvents(b.node(),"mouseup")])).map(p).map(e.getLocalPos).map(function(b){return{x:b.x-z,y:b.y-H}}).toProperty(function(){return h});c.last().onValue(k);
return c}).onValue(h)};d.prototype.construct=function(b){if(this.styledLink)throw Error("VLink is already constructed");this.styledLink=b=this.style.createLink(this.link);this.element=H.select(b.element);return this};d.prototype.rotate=function(b,c,d,e){this.styledLink.rotate(b,c,d,e);return this};d.prototype.rotateI=function(b,c,d){var e=this.style,e=e.getLocalPos(e.getInletPos(d));return this.rotate(b,c,e.x,d.y)};d.prototype.rotateO=function(b,c,d){var e=this.style;b=e.getLocalPos(e.getOutletPos(b));
return this.rotate(b.x,b.y,c,d)};d.prototype.rotateOI=function(b,c){var d=this.style,e=d.getLocalPos(d.getOutletPos(b)),d=d.getLocalPos(d.getInletPos(c));return this.rotate(e.x,e.y,d.x,d.y)};d.prototype.update=function(){if(this.link){var b=this.link;this.rotateOI(b.outlet,b.inlet);return this}};d.prototype.appendTo=function(b){b.append(this.element.node());return this};d.prototype.removeFrom=function(b){this.element.remove();return this};d.prototype.noPointerEvents=function(){this.styledLink.noPointerEvents&&
this.styledLink.noPointerEvents();return this};d.prototype.listenForClicks=function(){var b=this.link;h(this.element.node(),function(){b.enable()},function(){b.disable()});return this};d.prototype.enable=function(){this.element.classed("rpd-disabled",!1)};d.prototype.disable=function(){this.element.classed("rpd-disabled",!0)};d.prototype.get=function(){return this.link};d.prototype.getElement=function(){return this.element.node()};k.prototype.clear=function(){this.vlinks=[]};k.prototype.add=function(b){this.vlinks.push(b);
return b};k.prototype.remove=function(b){this.vlinks=this.vlinks.filter(function(c){return c!==b})};k.prototype.forEach=function(b){this.vlinks.forEach(b)};k.prototype.updateAll=function(){this.forEach(function(b){b.update()})};k.prototype.count=function(){return this.vlinks.length};k.prototype.getLast=function(){return this.count()?this.vlinks[this.vlinks.length-1]:null};var v=function(){var b={};return function(c,d,e){d.classed("rpd-error",!0);b[c]&&clearTimeout(b[c]);b[c]=setTimeout(function(){d.classed("rpd-error",
!1);b[c]=null},e||1)}}(),I=function(){var b={};return function(c,d,e){d.classed("rpd-stale",!1);d.classed("rpd-fresh",!0);b[c]&&clearTimeout(b[c]);b[c]=setTimeout(function(){d.classed("rpd-fresh",!1);d.classed("rpd-stale",!0);b[c]=null},e||1)}}();return{Navigation:e,Placing:g,DragAndDrop:c,VLink:d,VLinks:k,mergeConfig:function(b,c){if(b){var d={};Object.keys(c).forEach(function(b){d[b]=c[b]});Object.keys(b).forEach(function(c){d[c]=b[c]});return d}return c},preventDefault:function(b){b.preventDefault();
return b},stopPropagation:E,extractPos:p,addTarget:function(b){return function(c){return{pos:c,target:b}}},addClickSwitch:h,addValueErrorEffect:v,addValueUpdateEffect:I,subscribeUpdates:function(b,c){c&&Object.keys(c).forEach(function(d){(function(c,d){b.event["node/add-inlet"].filter(function(b){return b.alias===d}).onValue(function(d){b.event["node/is-ready"].onValue(function(){c.default&&d.receive(c.default());if(c.valueOut)c.valueOut.onValue(function(b){d.receive(b)})})})})(c[d],d)})}}}();Rpd.style("compact-v","svg",function(){function e(d){return document.createElementNS(c.ns.prefix.svg,d)}function g(c){c=c.getBoundingClientRect();return{x:c.left,y:c.top}}var c=c||d3_tiny;return function(d){var k,E={},p={},h={};return{edgePadding:{horizontal:20,vertical:40},boxPadding:{horizontal:20,vertical:80},createRoot:function(b,d){return{element:c.select(e("g")).classed("rpd-patch",!0).node()}},createNode:function(b,d,g){function h(b,c,d){b=16+20*(Math.max(b,c)-1);return{width:d.width,height:Math.max(10+
b,10+d.height)}}function k(){var b=B,c=h(D,F,q);if(c.width!==b.width||c.height!==b.height)n.select("rect.rpd-shadow").attr("height",c.height).attr("width",c.width),n.select("rect.rpd-body").attr("height",c.height).attr("width",c.width),n.select("rect.rpd-content").attr("height",c.height-10),n.select("g.rpd-process").attr("transform","translate(0,"+(10+(c.height-10)/2)+")"),B=c}function p(){G.forEach(function(b,c){b.attr("transform","translate(0,"+(8+20*c)+")")});y.forEach(function(b,c){b.attr("transform",
"translate(0,"+(8+20*c)+")")})}var q=d.size?{width:d.size.width||60,height:d.size.height||25}:{width:60,height:25};d=h(b.def.inlets?Object.keys(b.def.inlets).length:0,b.def.outlets?Object.keys(b.def.outlets).length:0,q);var t=d.width,w=d.height,n=c.select(e("g")).attr("class","rpd-node");n.append("rect").attr("class","rpd-shadow").attr("width",t).attr("height",w).attr("x",5).attr("y",6).attr("rx",3).attr("ry",3);n.append("rect").attr("class","rpd-header").classed("rpd-drag-handle",!0).attr("x",0).attr("y",
0).attr("width",t).attr("height",10);n.append("g").attr("class","rpd-name-holder").attr("transform","translate(0, 3)").append("text").attr("class","rpd-name").text(b.name).attr("x",3).attr("y",2).style("pointer-events","none");n.append("rect").attr("class","rpd-content").attr("x",0).attr("y",10).attr("width",t).attr("height",w-10);n.append("rect").attr("class","rpd-body").attr("width",t).attr("height",w).style("pointer-events","none");n.select(".rpd-header").append(e("title")).text(g?g+" ("+b.type+
")":b.type);n.append("g").attr("class","rpd-remove-button").attr("transform","translate("+(t-10.5)+",0.5)").call(function(b){b.append("rect").attr("width",10).attr("height",9.5).attr("class","rpd-remove-button-handle");b.append("text").text("x").attr("x",3).attr("y",1.5).style("pointer-events","none")});n.append("g").attr("class","rpd-inlets").attr("transform","translate(0,10)").data({position:{x:0,y:10}});n.append("g").attr("class","rpd-process").attr("transform","translate(0,"+(10+(w-10)/2)+")");
n.append("g").attr("class","rpd-outlets").attr("transform","translate("+t+",10)").data({position:{x:t,y:10}});n.classed("rpd-"+b.type.slice(0,b.type.indexOf("/"))+"-toolkit-node",!0).classed("rpd-"+b.type.replace("/","-"),!0);var D=0,F=0,G=[],y=[],B=d;E[b.id]={inlet:function(b){D++;G.push(b);k();p()},outlet:function(b){F++;y.push(b);k();p()}};return{element:n.node(),size:d}},createInlet:function(b,d){var g=c.select(e("g")).attr("class","rpd-inlet");g.call(function(c){c.append("rect").attr("class",
"rpd-connector").attr("x",-2).attr("y",-2).attr("width",4).attr("height",4);c.append("text").attr("class","rpd-name").text(b.name).attr("x",-5).attr("y",0);c.append("g").attr("class","rpd-value-holder").attr("transform","translate(-5,7)").append("text").attr("class","rpd-value")});E[b.node.id].inlet(g);p[b.id]=g.select(".rpd-connector");return{element:g.node()}},createOutlet:function(b,d){var g=c.select(e("g")).attr("class","rpd-outlet");g.call(function(c){c.append("rect").attr("class","rpd-connector").attr("x",
-2).attr("y",-2).attr("width",4).attr("height",4);c.append("text").attr("class","rpd-name").text(b.name).attr("x",5).attr("y",0);c.append("g").attr("class","rpd-value-holder").attr("transform","translate(5,7)").append("text").attr("class","rpd-value").attr("x",0).attr("y",0).style("pointer-events","none")});E[b.node.id].outlet(g);h[b.id]=g.select(".rpd-connector");return{element:g.node()}},createLink:function(b){var d=c.select(e("line")).attr("class","rpd-link");return{element:d.node(),rotate:function(b,
c,e,g){d.attr("x1",b).attr("y1",c).attr("x2",e).attr("y2",g)},noPointerEvents:function(){d.style("pointer-events","none")}}},getInletPos:function(b){b=g(p[b.id].node());return{x:b.x+2,y:b.y+2}},getOutletPos:function(b){b=g(h[b.id].node());return{x:b.x+2,y:b.y+2}},getLocalPos:function(b){if(!k)return b;var c=g(k.node());return{x:b.x+c.x,y:b.y+c.y}},onPatchSwitch:function(b,d){k=c.select(d)},onNodeRemove:function(b){E[b.id]=null}}}}());(function(){function e(b){return document.createElementNS(p.ns.prefix.svg,b)}function g(c){return function(g,k){var x=t(k,E),r=Rpd.getStyle(x.style,"svg")(x);g=p.select(g).classed("rpd-network",!0);var u,A,a;return{"patch/is-ready":function(f){var d=p.select(document.documentElement);u=p.select(e("svg")).attr("width",d.property("clientWidth")).attr("height",d.property("clientHeight"));u.append("rect").attr("class","rpd-background").attr("width",d.property("clientWidth")).attr("height",d.property("clientHeight"));
var k=u.append(r.createRoot(c,g).element).classed("rpd-style-"+x.style,!0).classed("rpd-values-"+(x.valuesOnHover?"on-hover":"always-shown"),!0).classed("rpd-show-boxes",x.showBoxes).data(f.patch);b.patches[c.id]=u.data({root:k,width:d.property("clientWidth"),height:d.property("clientHeight"),patch:f.patch});b.patchToPlacing[c.id]=new h.Placing(r);b.patchToLinks[c.id]=new q;A=new m(u,r,x);x.nodeMovingAllowed&&(a=new h.DragAndDrop(u,r));Kefir.fromEvents(u.node(),"selectstart").onValue(w);Kefir.fromEvents(window,
"resize").map(function(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}).onValue(function(a){u.attr("height",a);u.data().height=a})},"patch/enter":function(a){v=a.patch;H.switch(a.patch);var c=b.patches[a.patch.id];g.append(c.node());b.patchToLinks[a.patch.id].updateAll();if(r.onPatchSwitch)r.onPatchSwitch(v,c.node())},"patch/exit":function(a){v=null;u.remove()},"patch/refer":function(a){var d=b.nodes[a.node.id];d.select(".rpd-node").classed("rpd-patch-reference",
!0);d.data().processTarget.append(e("text")).text("["+(a.target.name||a.target.id)+"]");Kefir.fromEvents(d.data().processTarget.node(),"click").onValue(function(a,b){return function(){a.exit();b.enter()}}(c,a.target))},"patch/add-node":function(f){var d=f.node,g=f.render;f=b.patchToPlacing[f.patch.id];var k=b.patches[v.id].data(),h=p.select(e("g")).attr("class","rpd-node-box"),u=r.createNode(d,g,I[d.type]),m=h.append(u.element);b.nodes[d.id]=h.data({inletsTarget:m.select(".rpd-inlets"),outletsTarget:m.select(".rpd-outlets"),
processTarget:m.select(".rpd-process"),position:A,size:u.size});var A=f.nextPosition(d,u.size,{width:k.width,height:k.height});d.move(A.x,A.y);var t=new q;b.nodeToLinks[d.id]=t;if(x.nodeMovingAllowed){var C=m.select(".rpd-shadow"),A=m.select(".rpd-drag-handle");A.empty()||a.add(A,{start:function(){m.classed("rpd-dragging",!0);C.empty()||C.attr("x",7).attr("y",8);return h.data().position},drag:function(a){h.attr("transform","translate("+a.x+","+a.y+")");t.forEach(function(a){a.update()})},end:function(a){d.move(a.x,
a.y);C.empty()||C.attr("x",5).attr("y",6);m.classed("rpd-dragging",!1)}})}g.prepare&&g.prepare.bind(d)(b.patches[c.id].node(),b.patches[v.id].node());g.first&&B(d,g.first.bind(d)(m.select(".rpd-process").node()));if(g.always)d.event["node/process"].throttle(100).onValue(function(){t.updateAll()});if(!m.select(".rpd-remove-button").empty())Kefir.fromEvents(m.select(".rpd-remove-button-handle").node(),"click").map(n).onValue(function(){c.removeNode(d)});b.patches[d.patch.id].data().root.append(h.node())},
"patch/remove-node":function(a){a=a.node;var c=b.nodes[a.id];b.nodeToLinks[a.id].forEach(function(a){a.get().disconnect()});c.remove();if(r.onNodeRemove)r.onNodeRemove(a);b.nodes[a.id]=null;b.nodeToLinks[a.id]=null},"node/move":function(a){var c=b.nodes[a.node.id];a=a.position;c.attr("transform","translate("+Math.floor(a[0])+","+Math.floor(a[1])+")");c.data().position={x:a[0],y:a[1]}},"node/process":function(a){var c=a.node,d=a.render;if(d.always){var e=b.nodes[c.id].data().processTarget.node();d.always.bind(c)(e,
a.inlets,a.outlets)}},"node/add-inlet":function(a){var c=a.inlet;if(!c.hidden){var g=b.nodes[a.node.id].data().inletsTarget;a=a.render;var h;h=p.select(r.createInlet(c,a).element);h.classed("rpd-"+c.type.replace("/","-"),!0);h.classed({"rpd-stale":!0,"rpd-readonly":c.readonly,"rpd-cold":c.cold});var k=null;!c.readonly&&a.edit&&(k=new d(c,a,u,h.select(".rpd-value-holder"),h.select(".rpd-value"),p.select(e("g"))),h.select(".rpd-value-holder").append(k.editorElm.node()));b.inlets[c.id]=h.data({connector:h.select(".rpd-connector"),
value:h.select(".rpd-value"),vlinks:new q,editor:k});c.event["inlet/update"].onError(function(){G(c.id,h,x.effectTime)});A.subscribeInlet(c,h.select(".rpd-connector"));g.append(h.node())}},"node/add-outlet":function(a){var c=a.outlet,d=b.nodes[a.node.id].data().outletsTarget;a=p.select(r.createOutlet(c,a.render).element);a.classed("rpd-"+c.type.replace("/","-"),!0);a.classed("rpd-stale",!0);b.outlets[c.id]=a.data({connector:a.select(".rpd-connector"),value:a.select(".rpd-value"),vlinks:new q});A.subscribeOutlet(c,
a.select(".rpd-connector"));d.append(a.node())},"node/remove-inlet":function(a){a=a.inlet;b.inlets[a.id].data().vlinks.forEach(function(a){a.get().disconnect()});b.inlets[a.id].remove();if(r.onInletRemove)r.onInletRemove(a);b.inlets[a.id]=null},"node/remove-outlet":function(a){a=a.outlet;b.outlets[a.id].data().vlinks.forEach(function(a){a.get().disconnect()});b.outlets[a.id].remove();if(r.onOutletRemove)r.onOutletRemove(a);b.outlets[a.id]=null},"inlet/update":function(a){var c=a.inlet;if(!c.hidden){var d=
a.render,e=b.inlets[c.id],g=e.data().value;if(!g.empty()){var h=c.def.show?c.def.show(a.value):a.value;d.show?d.show.bind(c)(g.node(),a.value,h):g.text(h)}y(c.id,e,x.effectTime)}},"outlet/update":function(a){var c=a.outlet,d=a.render,e=b.outlets[c.id],g=e.data().value;if(!g.empty()){var h=c.def.show?c.def.show(a.value):a.value;d.show?d.show.bind(c)(g.node(),a.value,h):g.text(h)}y(c.id,e,x.effectTime)},"outlet/connect":function(a){a=a.link;var d=a.outlet,e=a.inlet,g=b.inlets[e.id],h=b.outlets[d.id].data(),
g=g.data();if(!x.inletAcceptsMultipleLinks&&1===g.vlinks.count())throw Error("Inlet is already connected to a link");g.editor&&g.editor.disable();var k=new z(a,r);k.construct(x.linkWidth).rotateOI(d,e);p.select(k.getElement()).classed("rpd-"+e.type.replace("/","-"),!0).classed("rpd-"+d.type.replace("/","-"),!0);b.links[a.id]=k;h.vlinks.add(k);g.vlinks.add(k);b.nodeToLinks[d.node.id].add(k);d.node.id!==e.node.id&&b.nodeToLinks[e.node.id].add(k);b.patchToLinks[c.id].add(k);k.listenForClicks();k.appendTo(u)},
"outlet/disconnect":function(a){a=a.link;var d=b.links[a.id],e=a.outlet,g=a.inlet,h=b.outlets[e.id].data(),k=b.inlets[g.id].data();b.links[a.id]=null;h.vlinks.remove(d);k.vlinks.remove(d);b.nodeToLinks[e.node.id].remove(d);e.node.id!==g.node.id&&b.nodeToLinks[g.node.id].remove(d);b.patchToLinks[c.id].remove(d);d.removeFrom(u)},"link/enable":function(a){var c=b.inlets[a.link.inlet.id].data();c.editor&&c.editor.disable();b.links[a.link.id].enable()},"link/disable":function(a){b.links[a.link.id].disable()}}}}
function c(b,c){return Kefir.merge([b.map(k(!0)),c.map(k(!1))]).toProperty(k(!1))}function d(c,d,e,g,h,u){var m=Kefir.emitter(),a=Kefir.emitter();this.disableEditor=a;this.editorElm=u;this.valueElm=h;u.classed("rpd-value-editor",!0);d.edit.bind(c)(u.node(),c,m).onValue(function(a){c.receive(a)});Kefir.combine([Kefir.merge([Kefir.fromEvents(g.node(),"click").map(n).map(k(!0)),Kefir.fromEvents(e.node(),"click").merge(a).map(k(!1))]).toProperty(k(!1)).skipDuplicates()],[c.event["inlet/update"]]).map(function(a){return{lastValue:a[1],
startEditing:a[0],cancelEditing:!a[0]}}).onValue(function(a){if(a.startEditing){var d=b.inlets[c.id].data();d.link&&d.link.disable();m.emit(a.lastValue);g.classed("rpd-editor-enabled",!0)}else a.cancelEditing&&(h.classed("rpd-edited",!0),g.classed("rpd-editor-enabled",!1))});g.classed("rpd-editor-disabled",!0)}var k=Rpd.unit,E={style:"quartz",valuesOnHover:!1,showBoxes:!1,nodeMovingAllowed:!0,renderNodeList:!0,nodeListCollapsed:!0,inletAcceptsMultipleLinks:!1,effectTime:1E3},p=p||d3_tiny,h=Rpd.Render,
b={patches:{},nodes:{},inlets:{},outlets:{},links:{},patchToPlacing:{},patchToLinks:{},nodeToLinks:{}},H=new h.Navigation(function(b){return function(c){return b.patches[c].data().patch}}(b)),v,I=Rpd.allNodeDescriptions,m=function(){function d(c){return b.inlets[c.id].data().vlinks}function e(b){return function(){return 0<d(b).count()}}function g(b){1===b.count()&&(b=b.getLast().link,b.outlet.disconnect(b))}function h(b,c){b.forEach(function(a){a.link.outlet.id===c.id&&c.disconnect(a.link)})}function m(b,
d,a){this.root=b;this.style=d;this.config=a;this.rootClicks=Kefir.fromEvents(this.root.node(),"click");this.inletClicks=Kefir.pool();this.outletClicks=Kefir.pool();this.startLink=Kefir.emitter();this.finishLink=Kefir.emitter();this.doingLink=c(this.startLink,this.finishLink)}m.prototype.subscribeOutlet=function(b,e){var a=this.root,f=this.style,l=this.config,m=this.rootClicks,q=this.outletClicks,r=this.inletClicks,t=this.startLink,v=this.finishLink,w=this.doingLink;q.plug(Kefir.fromEvents(e.node(),
"click").map(D).map(F(b)));Kefir.fromEvents(e.node(),"click").map(n).filterBy(c(q,w)).map(D).onValue(function(c){t.emit();var e=(new z(null,f)).construct(l.linkWidth).rotateO(b,c.x,c.y).noPointerEvents().appendTo(a);p.select(e.getElement()).classed("rpd-"+b.type.replace("/","-"),!0);Kefir.fromEvents(a.node(),"mousemove").takeUntilBy(Kefir.merge([r,q.map(k(!1)),m.map(k(!1))]).take(1).onValue(function(a){if(a){a=a.target;var c=d(a);l.inletAcceptsMultipleLinks?h(c,b):g(c);b.connect(a)}})).map(D).map(f.getLocalPos).onValue(function(a){e.rotateO(b,
a.x,a.y)}).onEnd(function(){e.removeFrom(a);v.emit()})})};m.prototype.subscribeInlet=function(b,m){var a=this.root,f=this.style,l=this.config,q=this.rootClicks,r=this.outletClicks,t=this.inletClicks,v=this.startLink,w=this.finishLink,y=this.doingLink;t.plug(Kefir.fromEvents(m.node(),"click").map(D).map(F(b)));Kefir.fromEvents(m.node(),"click").map(n).filterBy(c(t,y)).filter(e(b)).onValue(function(c){var e=d(b).getLast().link,m=e.outlet;m.disconnect(e);v.emit();var n=(new z(null,f)).construct(l.linkWidth).rotateO(m,
c.x,c.y).noPointerEvents().appendTo(a);p.select(n.getElement()).classed("rpd-"+b.type.replace("/","-"),!0).classed("rpd-"+m.type.replace("/","-"),!0);Kefir.fromEvents(a.node(),"mousemove").takeUntilBy(Kefir.merge([t,r.map(k(!1)),q.map(k(!1))]).take(1).onValue(function(a){if(a){a=a.target;var b=d(a);l.inletAcceptsMultipleLinks?h(b,m):g(b);m.connect(a)}})).map(D).map(f.getLocalPos).onValue(function(a){n.rotateO(m,a.x,a.y)}).onEnd(function(){n.removeFrom(a);w.emit()})})};return m}();d.prototype.disable=
function(){this.valueElm.classed("rpd-edited",!1);this.disableEditor.emit()};var z=h.VLink,q=h.VLinks,t=h.mergeConfig,w=h.preventDefault,n=h.stopPropagation,D=h.extractPos,F=h.addTarget,G=h.addValueErrorEffect,y=h.addValueUpdateEffect,B=h.subscribeUpdates;Rpd.SvgRenderer=g;Rpd.renderer("svg",g)})();Rpd.nodedescription("core/custom","May have any number of inlets and outlets, a target for extension.");Rpd.nodetype("core/custom",{name:"Custom"});Rpd.channeltype("core/number",{default:0,readonly:!1,accept:function(e){if(Infinity===e)return!0;e=parseFloat(e);return!isNaN(e)&&isFinite(e)},adapt:function(e){return parseFloat(e)}});
Rpd.channeltype("core/time",{default:1E3,accept:function(e){e=parseFloat(e);return!isNaN(e)&&isFinite(e)},adapt:function(e){return parseFloat(e)},show:function(e){return Math.floor(e/10)/100+"s"}});Rpd.nodetype("core/number",{name:"number",inlets:{"user-value":{type:"core/number",default:0,hidden:!0}},outlets:{out:{type:"core/number"}},process:function(e){return{out:e["user-value"]}}});
Rpd.nodetype("core/random",function(){var e=0;return{name:"random",inlets:{min:{type:"core/number",default:0},max:{type:"core/number",default:100},period:{type:"core/time",default:1E3}},outlets:{out:{type:"core/number"}},process:function(g){if(g.hasOwnProperty("period"))return e++,{out:Kefir.withInterval(g.period,function(c){c.emit(Math.floor(g.min+Math.random()*(g.max-g.min)))}).takeWhile(function(c){return function(){return c===e}}(e))}}}});
Rpd.nodetype("core/bounded-number",{name:"bounded number",inlets:{min:{type:"core/number",default:0},max:{type:"core/number",default:Infinity},spinner:{type:"core/number",default:0,hidden:!0}},outlets:{out:{type:"core/number"}},process:function(e){if(e.hasOwnProperty("spinner"))return{out:e.spinner}}});Rpd.channeltype("core/any",{});Rpd.channeltype("core/boolean",{default:!1,readonly:!1,adapt:function(e){return e?!0:!1}});Rpd.channelrenderer("core/number","svg",{edit:function(e,g,c){g=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");g.setAttributeNS(null,"width",20);g.setAttributeNS(null,"height",30);var d=document.createElementNS("http://www.w3.org/1999/xhtml","input");d.type="number";c.onValue(function(c){d.value=c});g.appendChild(d);e.appendChild(g);return Kefir.fromEvents(d,"change").map(function(){return d.value})}});Rpd.noderenderer("core/random","svg",function(){return{size:{width:40}}});

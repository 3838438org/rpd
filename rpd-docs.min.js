/**
 * rpd - RPD is a minimal framework for building Node-Based User Interfaces, powered by Reactive Programming
 * Built at Fri, 08 Jan 2016 12:53:26 GMT
 *
 * @version v0.2.0-alpha
 * @link http://shamansir.github.io/rpd
 * @author Ulric Wilfred <shaman.sir@gmail.com>
 * @license MIT
 * 
 * Selected Renderers: svg
 * Selected Styles: quartz
 * Selected Toolkits: core
 * Selected I/O Modules: [None]
 * d3.js or d3_tiny.js: d3_tiny.js
 *
 * User Styles: [None]
 * User Toolkits: [None]
 *
 * Command: gulp --root . --renderer svg --style quartz --toolkit core --target-name rpd-docs --compilation simple
 */
(function(h){var d=h.Kefir;"undefined"===typeof d&&"undefined"!==typeof require&&(d=require("../vendor/kefir.min.js"));if(!d)throw Error("Kefir.js (https://github.com/rpominov/kefir) is required for Rpd to work");var b=function(){function e(a){return function(){return a}}function k(a){this.id=y();this.name=a;var f=this;a={"patch/is-ready":[],"patch/enter":[],"patch/exit":[],"patch/set-inputs":["inputs"],"patch/set-outputs":["outputs"],"patch/project":["node","target"],"patch/refer":["node","target"],
"patch/add-node":["node"],"patch/remove-node":["node"]};this.event=n(a);this.events=D(a,this.event,"patch",this);this.renderQueue=d.emitter();a=d.combine([this.events],[this.renderQueue.scan(function(a,c){var z=c.alias,b=c.target,n=c.config,d=a[z];d||(d={},d.produce=K[z](f),d.handlers=[],a[z]=d);if(d.produce){var e=d.produce(b,n);e&&d.handlers.push("function"===typeof e?e:function(a){if(e[a.type])e[a.type](a)})}return a},{})]);a=a.bufferBy(this.renderQueue).take(1).flatten().concat(a);a.onValue(function(a){var f=
a[0];a=a[1];for(var c=Object.keys(a),b,d=0,n=c.length;d<n;d++){b=a[c[d]];b=b.handlers;for(var e=0,t=b.length;e<t;e++)b[e](I(x(f),c[d]))}});this.projections=d.emitter();d.combine([this.projections],[this.event["patch/set-inputs"],this.event["patch/set-outputs"]]).onValue(function(a){var c=a[0],b=a[1];a=a[2];for(var d,n=0;n<b.length;n++)d=c.addInlet(b[n].type,b[n].name),d.event["inlet/update"].onValue(function(a){return function(f){a.receive(f)}}(b[n]));for(n=0;n<a.length;n++)b=c.addOutlet(a[n].type,
a[n].name),a[n].event["outlet/update"].onValue(function(a){return function(f){a.send(f)}}(b));f.event["patch/project"].emit({node:c,target:c.patch});c.patch.event["patch/refer"].emit({node:c,target:f})});this.nodesToRemove=d.emitter();this.event["patch/is-ready"].emit()}function h(a,f,m,b){this.type=a||"core/empty";this.id=y();this.patch=f;f={"node/turn-on":[],"node/is-ready":[],"node/process":["inlets","outlets"],"node/turn-off":[],"node/add-inlet":["inlet"],"node/remove-inlet":["inlet"],"node/add-outlet":["outlet"],
"node/remove-outlet":["outlet"],"node/move":["position"]};this.event=n(f);this.events=D(f,this.event,"node",this);(f=H(p[this.type],this))||v("Node type "+this.type+" is not registered!");this.def=f;this.name=m||f.name||a;this.render=c(w[this.type],this);b&&b(this);var z=this;if(this.def.handle)this.events.onValue(function(a){if(z.def.handle[a.type])z.def.handle[a.type](a)});if(this.def.process){var e=this.def.process;a=d.combine([this.event["node/add-inlet"].flatMap(function(a){var f=a.event["inlet/update"].map(function(f){return{inlet:a,
value:f}});z.def.tune&&(f=z.def.tune(f));return f})],[this.event["node/add-outlet"].scan(function(a,f){a[f.alias]=f;return a},{})]);a=a.bufferBy(this.event["node/is-ready"]).take(1).flatten().concat(a);a=a.scan(function(a,f){var m=f[0].inlet,c=m.alias;a.inlets.prev[c]=a.inlets.cur[c];a.inlets.cur[c]=f[0].value;a.outlets=f[1];a.source=m;return a},{inlets:{prev:{},cur:{}},outlets:{}}).changes();a=a.filter(function(a){return!a.source.cold});a.onValue(function(a){var f=e.bind(z)(a.inlets.cur,a.inlets.prev);
z.event["node/process"].emit({inlets:a.inlets.cur,outlets:f});a=a.outlets;for(var m in f)a[m]&&(f[m]instanceof d.Stream?a[m].stream(f[m]):a[m].send(f[m]))})}if(this.def.inlets){this.inlets={};for(var t in this.def.inlets)a=this.def.inlets[t],a=this.addInlet(a.type,t,a.name,a.default,a.hidden,a.readonly,a.cold),this.inlets[t]=a}if(this.def.outlets)for(t in this.outlets={},this.def.outlets)a=this.def.outlets[t],a=this.addOutlet(a.type,t,a.name,a.default),this.outlets[t]=a;this.def.prepare&&this.def.prepare(this.inlets,
this.outlets);this.event["node/is-ready"].emit()}function q(a,f,m,b,z,e,t,k){this.type=a||"core/any";this.id=y();var g=H(A[this.type],this);g||v("Channel type "+this.type+" is not registered!");this.def=g;(this.alias=m||g.alias||b)||v("Inlet should have either alias or name");this.name=b||g.name||this.alias||a;this.node=f;this.hidden=e||!1;this.readonly=C(t||g.readonly)?t||g.readonly:!0;this.cold=k||!1;this.default=C(z)?z:g.default;this.value=d.pool();this.render=c(F[this.type],this);a={"inlet/update":["value"]};
this.event=n(a);var h=this.event["inlet/update"];f=h.merge(this.value);g.tune&&(f=g.tune(f));g.accept&&(f=f.flatten(function(a){if(g.accept(a))return[a];h.error();return[]}));g.adapt&&(f=f.map(g.adapt));this.event["inlet/update"]=f.onValue(function(){});this.events=D(a,this.event,"inlet",this)}function l(a,f,m,b,z){this.type=a||"core/any";this.id=y();var e=H(A[this.type],this);e||v("Channel type "+this.type+" is not registered!");this.def=e;(this.alias=m||e.alias||b)||v("Outlet should have either alias or name");
this.name=b||this.alias||e.name||a;this.node=f;this.default=C(z)?z:e.default;this.value=d.pool();this.render=c(F[this.type],this);a={"outlet/update":["value"],"outlet/connect":["link","inlet"],"outlet/disconnect":["link"]};this.event=n(a);f=this.event["outlet/update"].merge(this.value);this.event["outlet/update"]=f.onValue(function(a){});this.events=D(a,this.event,"outlet",this);var t=this;d.combine([this.event["outlet/connect"]],[this.event["outlet/update"]]).onValue(function(a){t.value.plug(d.constant(a[1]))})}
function g(a,f,m){this.id=y();this.name=m||"";this.outlet=a;this.inlet=f;this.value=d.emitter();var c=this;this.receiver=a.node.id!==f.node.id?function(a){c.pass(a)}:function(a){setTimeout(function(){c.pass(a)},0)};a={"link/enable":[],"link/disable":[],"link/pass":["value"]};this.event=n(a);m=this.event["link/pass"].merge(this.value);this.event["link/pass"]=m.onValue(function(a){});this.events=D(a,this.event,"link",this);this.enabled=d.merge([this.event["link/disable"].map(e(!1)),this.event["link/enable"].map(e(!0))]).toProperty(e(!0));
this.event["link/pass"].filterBy(this.enabled).onValue(function(a){f.receive(a)});d.combine([this.event["link/enable"]],[this.event["link/pass"]]).onValue(function(a){c.pass(a[1])})}function x(a){for(var f={},m=Object.keys(a),c=0,b=m.length;c<b;c++)f[m[c]]=a[m[c]];return f}function C(a){return"undefined"!==typeof a}function H(a,f){return a?"function"===typeof a?a(f):a:null}function c(a,f){if(!a)return{};var m={},c;for(c in a)m[c]=H(a[c],f);return m}function n(a){var f={};a=Object.keys(a);for(var m=
0,c;m<a.length;m++)c=a[m],f[c]=d.emitter();return f}function t(a,f){if(0===f.length)return function(){return{type:a}};if(1===f.length)return function(m){var c={};c.type=a;c[f[0]]=m;return c};if(1<f.length)return function(f){f=x(f);f.type=a;return f}}function D(a,f,m,c){for(var b=d.pool(),n=Object.keys(a),e=0;e<n.length;e++)b.plug(f[n[e]].map(t(n[e],a[n[e]])).map(function(a){a[m]=c;return a}));return b}function v(a,f){throw f||Error(a);}function y(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}
function I(a,f){var m=a.type;if("patch/add-node"===m||"node/process"===m)a.render=a.node.render[f]||{};else if("node/add-inlet"===m||"inlet/update"===m)a.render=a.inlet.render[f]||{};else if("node/add-outlet"===m||"outlet/update"===m)a.render=a.outlet.render[f]||{};return a}(function(){d.emitter=function(){var a,f=d.stream(function(f){a=f;return function(){a=void 0}});f.emit=function(f){a&&a.emit(f);return this};f.error=function(f){a&&a.error(f);return this};f.end=function(){a&&a.end();return this};
f.emitEvent=function(f){a&&a.emitEvent(f);return this};return f.setName("emitter")}})();var p={},A={},w={},F={},J={},B={},K={},L={"network/add-patch":["patch"]},u=n(L),r=D(L,u,"network",b);u["network/add-patch"].onValue(function(a){r.plug(a.events)});var G=d.emitter();k.prototype.render=function(a,f,m){a=Array.isArray(a)?a:[a];f=Array.isArray(f)?f:[f];for(var c=0,b=a.length,n;c<b;c++)for(var e=0,d=f.length,t;e<d;e++){n=a[c];t=f[e];if(!K[n])throw Error("Renderer "+n+" is not registered");this.renderQueue.emit({alias:n,
target:t,config:m})}return this};k.prototype.addNode=function(a,f){var m=this;return new h(a,this,f,function(a){m.events.plug(a.events);m.event["patch/add-node"].emit(a);a.turnOn()})};k.prototype.removeNode=function(a){a.turnOff();this.event["patch/remove-node"].emit(a);this.events.unplug(a.events)};k.prototype.enter=function(){this.event["patch/enter"].emit();return this};k.prototype.exit=function(){this.event["patch/exit"].emit();return this};k.prototype.inputs=function(a){this.event["patch/set-inputs"].emit(a)};
k.prototype.outputs=function(a){this.event["patch/set-outputs"].emit(a)};k.prototype.project=function(a){this.projections.emit(a)};h.prototype.turnOn=function(){this.event["node/turn-on"].emit()};h.prototype.turnOff=function(){this.event["node/turn-off"].emit()};h.prototype.addInlet=function(a,f,m,c,b,n,e){a=new q(a,this,f,m,c,b,n,e);this.events.plug(a.events);this.event["node/add-inlet"].emit(a);a.toDefault();return a};h.prototype.addOutlet=function(a,f,m,c){a=new l(a,this,f,m,c);this.events.plug(a.events);
this.event["node/add-outlet"].emit(a);a.toDefault();return a};h.prototype.removeInlet=function(a){this.event["node/remove-inlet"].emit(a);this.events.unplug(a.events)};h.prototype.removeOutlet=function(a){this.event["node/remove-outlet"].emit(a);this.events.unplug(a.events)};h.prototype.move=function(a,f){this.event["node/move"].emit([a,f]);return this};q.prototype.receive=function(a){this.value.plug(d.constant(a))};q.prototype.stream=function(a){this.value.plug(a)};q.prototype.toDefault=function(){C(this.default)&&
(this.default instanceof d.Stream?this.stream(this.default):this.receive(this.default))};q.prototype.allows=function(a){if(a.type===this.type)return!0;if(!this.def.allow&&a.type!==this.type)return!1;if(this.def.allow){var f=!1;this.def.allow.forEach(function(m){a.type===m&&(f=!0)});return f}return!0};l.prototype.connect=function(a){if(!a.allows(this))throw Error("Outlet of type "+this.type+" is not allowed to connect to inlet of type "+a.type);var f=new g(this,a);this.events.plug(f.events);this.value.onValue(f.receiver);
this.event["outlet/connect"].emit({link:f,inlet:a});return f};l.prototype.disconnect=function(a){this.event["outlet/disconnect"].emit(a);this.value.offValue(a.receiver);this.events.unplug(a.events);return this};l.prototype.send=function(a){this.value.plug(d.constant(a))};l.prototype.stream=function(a){this.value.plug(a)};l.prototype.toDefault=function(){C(this.default)&&(this.default instanceof d.Stream?this.stream(this.default):this.send(this.default))};g.prototype.pass=function(a){this.value.emit(a)};
g.prototype.enable=function(){this.event["link/enable"].emit()};g.prototype.disable=function(){this.event["link/disable"].emit()};g.prototype.disconnect=function(){this.outlet.disconnect(this)};return{VERSION:"v2.0",_:{Patch:k,Node:h,Inlet:q,Outlet:l,Link:g},unit:e,not:function(a){return!a},event:u,events:r,addPatch:function(a){a=new k(a);u["network/add-patch"].emit(a);return a},render:function(a,f,m){G.emit([a,f,m]);var c=function(c){c.render(a,f,m)};u["network/add-patch"].onValue(c);return function(){u["network/add-patch"].offValue(c)}},
nodetype:function(a,f){p[a]=f||{}},channeltype:function(a,f){A[a]=f||{}},nodedescription:function(a,f){J[a]=f},renderer:function(a,f){K[a]=f},styles:B,style:function(a,f,c){B[a]||(B[a]={});B[a][f]=c},noderenderer:function(a,f,c){if(!p[a])throw Error("Node type "+a+" is not registered");w[a]||(w[a]={});w[a][f]=c},channelrenderer:function(a,f,c){if(!A[a])throw Error("Channel type "+a+" is not registered");F[a]||(F[a]={});F[a][f]=c},"import":{},"export":{},allNodeTypes:p,allChannelTypes:A,allNodeRenderers:w,
allChannelRenderers:F,allNodeDescriptions:J,getStyle:function(a,f){if(!a)throw Error("Unknown style requested: "+a);if(!B[a])throw Error("Style '"+a+"' is not registered");var c=B[a][f];if(!c)throw Error("Style '"+a+"' has no definition for '"+f+"' renderer");return c},short_uid:y}}();"function"===typeof define&&define.amd?(define([],function(){return b}),h.Rpd=b):"object"===typeof module&&"object"===typeof exports?(module.exports=b,b.Rpd=b):h.Rpd=b})(this);var d3_tiny=function(){function h(b,e,d){for(var h="function"===typeof e?e:function(){return e},q=b.selection,l=0,g=q.length;l<g;l++)d(q[l],h.bind(q[l])(l));return b}function d(b,e,d){e=e||document;selection="string"===typeof b?d?Array.prototype.slice.call(e.querySelectorAll(b),0):[e.querySelector(b)]:b instanceof Node?[b]:Array.isArray(b)?b:[b];this.namespace=1===selection.length&&selection[0]?selection[0].namespaceURI:null;this.selection=selection}d.prototype.empty=function(){return 1===this.selection.length&&
!this.selection[0]||!this.selection.length?!0:!1};d.prototype.attr=function(b,e){return"undefined"===typeof e&&1===this.selection.length?this.selection[0].getAttribute(b):h(this,e,function(e,d){e.setAttributeNS(null,b,d)})};d.prototype.property=function(b,e){return"undefined"===typeof e&&1===this.selection.length?this.selection[0][b]:h(this,e,function(e,d){e[b]=d})};d.prototype.style=function(b,e){"-"===b[0]&&(b=b.slice(1));b=b.replace(/-([a-z])/g,function(b){return b[1].toUpperCase()});return h(this,
e,function(e,d){e.style[b]=d})};d.prototype.text=function(b){return"undefined"===typeof b&&1===this.selection.length?this.selection[0].textContent||this.selection[0].innerText:h(this,b,function(b,d){b.innerText=b.textContent=d})};d.prototype.classed=function(b,d){return"object"===typeof b?h(this,Object.keys(b),function(d,e){for(var h=0,l=e.length;h<l;h++)d.classList.toggle(e[h],b[e[h]])}):h(this,d,function(d,e){d.classList.toggle(b,e)})};d.prototype.select=function(b){return new d(b,this.selection[0])};
d.prototype.selectAll=function(b){return new d(b,this.selection[0],!0)};d.prototype.append=function(b){var e=[];h(this,"string"===typeof b?document.createElementNS(this.namespace,b):b,function(b,d){b.appendChild(d);e.push(d)});return new d(e)};d.prototype.remove=function(){return h(this,function(){return null},function(b){b.parentElement.removeChild(b)})};d.prototype.node=function(b){return this.selection[b||0]};d.prototype.on=function(b,d){return h(this,function(){return d},function(d,e){d.addEventListener(b,
e)})};d.prototype.data=function(b){return b?h(this,b,function(b,d){b.__data__=d}):this.node().__data__};d.prototype.call=function(b){b(this);return this};return{ns:{prefix:{svg:"http://www.w3.org/2000/svg",html:"http://www.w3.org/1999/xhtml"}},select:function(b,e){return new d(b,e)},selectAll:function(b,e){return new d(b,e,!0)}}}();Rpd.Render=function(){function h(c){this.currentPatch=null;this.getPatchByHash=c;var b=this;Kefir.fromEvents(window,"hashchange").map(function(){return window.location.hash?window.location.hash.slice(1):null}).filter(function(c){return!(b.currentPatch&&c===b.currentPatch.id)}).map(b.getPatchByHash).filter(function(c){return null!=c}).onValue(function(c){b.currentPatch&&b.currentPatch.exit();c.enter()})}function d(c){this.nodeRects=[];this.edgePadding=c.edgePadding||{horizontal:30,vertical:20};this.boxPadding=
c.boxPadding||{horizontal:20,vertical:30}}function b(c,b){this.root=c;this.style=b}function e(c,b){this.link=c;this.style=b;this.element=this.styledLink=null}function k(){this.vlinks=[]}function E(c){c.stopPropagation();return c}function q(c){return{x:c.clientX,y:c.clientY}}function l(c,b,d,e){Kefir.fromEvents(c,"click").map(E).map(g(e||!1)).scan(Rpd.not).onValue(function(c){c?b():d()})}var g=Rpd.unit,x=d3_tiny||x;h.prototype.switch=function(c){c&&(this.currentPatch=c,0<=document.title.indexOf("\u2014")?
document.title=document.title.replace(/\u2014.+$/,"\u2014 "+c.name||"[Unnamed]"):document.title+=" \u2014 "+c.name||"[Unnamed]",window.location.hash=c.id)};d.DEFAULT_LIMITS=[1E3,1E3];d.prototype.nextPosition=function(c,b,e){e=e||d.DEFAULT_LIMITS;c=this.nodeRects;var g=this.boxPadding,h=this.edgePadding,x=b.width;b=b.height;var k=c.length?c[c.length-1]:null,k={x:k?k.x:h.horizontal,y:k?k.y+k.height+g.vertical:h.vertical,width:x,height:b};k.y+b+h.vertical>e.height&&(k.x=k.x+x+g.horizontal,k.y=h.vertical);
c.push(k);return{x:k.x,y:k.y}};b.prototype.add=function(c,b){var d=this.root,e=this.style,g=b.start,h=b.end,x=b.drag;Kefir.fromEvents(c.node(),"mousedown").map(q).map(e.getLocalPos).flatMap(function(b){var n=g(),x=b.x-n.x,k=b.y-n.y;b=Kefir.fromEvents(d.node(),"mousemove").map(E).takeUntilBy(Kefir.merge([Kefir.fromEvents(d.node(),"mouseup"),Kefir.fromEvents(c.node(),"mouseup")])).map(q).map(e.getLocalPos).map(function(c){return{x:c.x-x,y:c.y-k}}).toProperty(function(){return n});b.last().onValue(h);
return b}).onValue(x)};e.prototype.construct=function(c){if(this.styledLink)throw Error("VLink is already constructed");this.styledLink=c=this.style.createLink(this.link);this.element=x.select(c.element);return this};e.prototype.rotate=function(c,b,d,e){this.styledLink.rotate(c,b,d,e);return this};e.prototype.rotateI=function(c,b,d){var e=this.style,e=e.getLocalPos(e.getInletPos(d));return this.rotate(c,b,e.x,d.y)};e.prototype.rotateO=function(c,b,d){var e=this.style;c=e.getLocalPos(e.getOutletPos(c));
return this.rotate(c.x,c.y,b,d)};e.prototype.rotateOI=function(c,b){var d=this.style,e=d.getLocalPos(d.getOutletPos(c)),d=d.getLocalPos(d.getInletPos(b));return this.rotate(e.x,e.y,d.x,d.y)};e.prototype.update=function(){if(this.link){var c=this.link;this.rotateOI(c.outlet,c.inlet);return this}};e.prototype.appendTo=function(c){c.append(this.element.node());return this};e.prototype.removeFrom=function(c){this.element.remove();return this};e.prototype.noPointerEvents=function(){this.styledLink.noPointerEvents&&
this.styledLink.noPointerEvents();return this};e.prototype.listenForClicks=function(){var c=this.link;l(this.element.node(),function(){c.enable()},function(){c.disable()});return this};e.prototype.enable=function(){this.element.classed("rpd-disabled",!1)};e.prototype.disable=function(){this.element.classed("rpd-disabled",!0)};e.prototype.get=function(){return this.link};e.prototype.getElement=function(){return this.element.node()};k.prototype.clear=function(){this.vlinks=[]};k.prototype.add=function(c){this.vlinks.push(c);
return c};k.prototype.remove=function(c){this.vlinks=this.vlinks.filter(function(b){return b!==c})};k.prototype.forEach=function(c){this.vlinks.forEach(c)};k.prototype.updateAll=function(){this.forEach(function(c){c.update()})};k.prototype.count=function(){return this.vlinks.length};k.prototype.getLast=function(){return this.count()?this.vlinks[this.vlinks.length-1]:null};var C=function(){var c={};return function(b,d,e){d.classed("rpd-error",!0);c[b]&&clearTimeout(c[b]);c[b]=setTimeout(function(){d.classed("rpd-error",
!1);c[b]=null},e||1)}}(),H=function(){var c={};return function(b,d,e){d.classed("rpd-stale",!1);d.classed("rpd-fresh",!0);c[b]&&clearTimeout(c[b]);c[b]=setTimeout(function(){d.classed("rpd-fresh",!1);d.classed("rpd-stale",!0);c[b]=null},e||1)}}();return{Navigation:h,Placing:d,DragAndDrop:b,VLink:e,VLinks:k,mergeConfig:function(c,b){if(c){var d={};Object.keys(b).forEach(function(c){d[c]=b[c]});Object.keys(c).forEach(function(b){d[b]=c[b]});return d}return b},preventDefault:function(c){c.preventDefault();
return c},stopPropagation:E,extractPos:q,addTarget:function(c){return function(b){return{pos:b,target:c}}},addClickSwitch:l,addValueErrorEffect:C,addValueUpdateEffect:H,subscribeUpdates:function(c,b){b&&Object.keys(b).forEach(function(d){(function(b,d){c.event["node/add-inlet"].filter(function(b){return b.alias===d}).onValue(function(d){c.event["node/is-ready"].onValue(function(){b.default&&d.receive(b.default());if(b.valueOut)b.valueOut.onValue(function(b){d.receive(b)})})})})(b[d],d)})}}}();Rpd.style("quartz","svg",function(h){function d(b){return document.createElementNS(k.ns.prefix.svg,b)}function b(b,d,e,c,g,h,k,l){return"M"+b+","+d+(g?"v"+g+"a"+g+","+g+" 0 0 1 "+g+","+-g:"")+"h"+(e-(g?g:0)-(h?h:0))+(h?"a"+h+","+h+" 0 0 1 "+h+","+h:"")+"v"+(c-(h?h:0)-(k?k:0))+(k?"a"+k+","+k+" 0 0 1 "+-k+","+k:"")+"h"+((k?k:0)+(l?l:0)-e)+(l?"a"+l+","+l+" 0 0 1 "+-l+","+-l:"")+"v"+((l?l:0)+(g?g:0)-c)+"z"}function e(b){b=b.getBoundingClientRect();return{x:b.left,y:b.top}}var k=k||d3_tiny,E=null,q={},
l={},g={};return{edgePadding:{horizontal:30,vertical:20},boxPadding:{horizontal:20,vertical:30},createRoot:function(b,e){return{element:k.select(d("g")).classed("rpd-patch",!0).node()}},createNode:function(e,g,h){function c(b,c,d){b=30+25*(Math.max(b,c)-1);return{width:d.width,height:21+Math.max(b,d.height)}}function n(){var d=B,e=c(A,w,D);if(e.width!==d.width||e.height!==d.height)p.select("rect.rpd-shadow").attr("height",e.height).attr("width",e.width),p.select("rect.rpd-body").attr("height",e.height).attr("width",
e.width),p.select("path.rpd-content").attr("d",b(0,21,e.width,e.height-21,0,0,2,2)),p.select("g.rpd-process").attr("transform","translate("+e.width/2+","+(21+(e.height-21)/2)+")"),B=e}function l(){F.forEach(function(b,c){var d,e;A>=w?(d=0,e=15+25*c):(d=0,e=(30+25*(w-1))/2+25*(-1*(A-1)/2+c));b.attr("transform","translate("+d+","+e+")")});J.forEach(function(b,c){var d,e;w>=A?(d=0,e=15+25*c):(d=0,e=(30+25*(A-1))/2+25*(-1*(w-1)/2+c));b.attr("transform","translate("+d+","+e+")")})}var D=g.size?{width:g.size.width||
100,height:g.size.height||40}:{width:100,height:40};g=c(e.def.inlets?Object.keys(e.def.inlets).length:0,e.def.outlets?Object.keys(e.def.outlets).length:0,D);var v=g.width,y=g.height,E=y-21,p=k.select(d("g")).attr("class","rpd-node");p.append("rect").attr("class","rpd-shadow").attr("width",v).attr("height",y).attr("x",5).attr("y",6).attr("rx",3).attr("ry",3);p.append("path").attr("class","rpd-header").classed("rpd-drag-handle",!0).attr("d",b(0,0,v,21,2,2,0,0));p.append("text").attr("class","rpd-name").text(e.name).attr("x",
5).attr("y",6).style("pointer-events","none");p.append("path").attr("class","rpd-content").attr("d",b(0,21,v,E,0,0,2,2));p.append("rect").attr("class","rpd-body").attr("width",v).attr("height",y).attr("rx",2).attr("ry",2).style("pointer-events","none");p.select(".rpd-header").append(d("title")).text(h?h+" ("+e.type+")":e.type);p.append("g").attr("class","rpd-remove-button").attr("transform","translate("+(v-12)+",1)").call(function(c){c.append("path").attr("d",b(0,0,11,11,2,2,2,3)).attr("class","rpd-remove-button-handle");
c.append("text").text("x").attr("x",3).attr("y",2).style("pointer-events","none")});p.append("g").attr("class","rpd-inlets").attr("transform","translate(0,21)").data({position:{x:0,y:21}});p.append("g").attr("class","rpd-process").attr("transform","translate("+v/2+","+(21+(y-21)/2)+")");p.append("g").attr("class","rpd-outlets").attr("transform","translate("+v+",21)").data({position:{x:v,y:21}});p.classed("rpd-"+e.type.slice(0,e.type.indexOf("/"))+"-toolkit-node",!0).classed("rpd-"+e.type.replace("/",
"-"),!0);var A=0,w=0,F=[],J=[],B=g;q[e.id]={inlet:function(b){A++;F.push(b);n();l()},outlet:function(b){w++;J.push(b);n();l()}};return{element:p.node(),size:g}},createInlet:function(b,e){var g=k.select(d("g")).attr("class","rpd-inlet");g.call(function(c){c.append("circle").attr("class","rpd-connector").attr("cx",0).attr("cy",0).attr("r",2.5);c.append("g").attr("class","rpd-value-holder").attr("transform","translate(-15,0)").append("text").attr("class","rpd-value");c.append("text").attr("class","rpd-name").text(b.name).attr("x",
10).attr("y",0)});q[b.node.id].inlet(g);l[b.id]=g.select(".rpd-connector");return{element:g.node()}},createOutlet:function(b,e){var h=k.select(d("g")).attr("class","rpd-outlet");h.call(function(c){c.append("circle").attr("class","rpd-connector").attr("cx",0).attr("cy",0).attr("r",2.5);c.append("g").attr("class","rpd-value-holder").append("text").attr("class","rpd-value").attr("x",10).attr("y",0).style("pointer-events","none");c.append("text").attr("class","rpd-name").text(b.name).attr("x",-10).attr("y",
0)});q[b.node.id].outlet(h);g[b.id]=h.select(".rpd-connector");return{element:h.node()}},createLink:function(b){var e=k.select(d("line")).attr("class","rpd-link");return{element:e.node(),rotate:function(b,c,d,g){e.attr("x1",b).attr("y1",c).attr("x2",d).attr("y2",g)},noPointerEvents:function(){e.style("pointer-events","none")}}},getInletPos:function(b){b=e(l[b.id].node());return{x:b.x+3,y:b.y+3}},getOutletPos:function(b){b=e(g[b.id].node());return{x:b.x+3,y:b.y+3}},getLocalPos:function(b){if(!E)return b;
var d=e(E.node());return{x:b.x+d.x,y:b.y+d.y}},onPatchSwitch:function(b,d){E=k.select(d)},onNodeRemove:function(b){q[b.id]=null}}});(function(){function h(b){return document.createElementNS(q.ns.prefix.svg,b)}function d(b){return function(d,k){var p=D(k,E),u=Rpd.getStyle(p.style,"svg")(p);d=q.select(d).classed("rpd-network",!0);var r,G,a;return{"patch/is-ready":function(f){var e=q.select(document.documentElement);r=q.select(h("svg")).attr("width",e.property("clientWidth")).attr("height",e.property("clientHeight"));r.append("rect").attr("class","rpd-background").attr("width",e.property("clientWidth")).attr("height",e.property("clientHeight"));
var k=r.append(u.createRoot(b,d).element).classed("rpd-style-"+p.style,!0).classed("rpd-values-"+(p.valuesOnHover?"on-hover":"always-shown"),!0).classed("rpd-show-boxes",p.showBoxes).data(f.patch);g.patches[b.id]=r.data({root:k,width:e.property("clientWidth"),height:e.property("clientHeight"),patch:f.patch});g.patchToPlacing[b.id]=new l.Placing(u);g.patchToLinks[b.id]=new t;G=new c(r,u,p);p.nodeMovingAllowed&&(a=new l.DragAndDrop(r,u));Kefir.fromEvents(r.node(),"selectstart").onValue(v);Kefir.fromEvents(window,
"resize").map(function(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}).onValue(function(a){r.attr("height",a);r.data().height=a})},"patch/enter":function(a){C=a.patch;x.switch(a.patch);var b=g.patches[a.patch.id];d.append(b.node());g.patchToLinks[a.patch.id].updateAll();if(u.onPatchSwitch)u.onPatchSwitch(C,b.node())},"patch/exit":function(a){C=null;r.remove()},"patch/refer":function(a){var c=g.nodes[a.node.id];c.select(".rpd-node").classed("rpd-patch-reference",
!0);c.data().processTarget.append(h("text")).text("["+(a.target.name||a.target.id)+"]");Kefir.fromEvents(c.data().processTarget.node(),"click").onValue(function(a,b){return function(){a.exit();b.enter()}}(b,a.target))},"patch/add-node":function(f){var c=f.node,d=f.render;f=g.patchToPlacing[f.patch.id];var e=g.patches[C.id].data(),k=q.select(h("g")).attr("class","rpd-node-box"),l=u.createNode(c,d,H[c.type]),r=k.append(l.element);g.nodes[c.id]=k.data({inletsTarget:r.select(".rpd-inlets"),outletsTarget:r.select(".rpd-outlets"),
processTarget:r.select(".rpd-process"),position:n,size:l.size});var n=f.nextPosition(c,l.size,{width:e.width,height:e.height});c.move(n.x,n.y);var G=new t;g.nodeToLinks[c.id]=G;if(p.nodeMovingAllowed){var B=r.select(".rpd-shadow"),n=r.select(".rpd-drag-handle");n.empty()||a.add(n,{start:function(){r.classed("rpd-dragging",!0);B.empty()||B.attr("x",7).attr("y",8);return k.data().position},drag:function(a){k.attr("transform","translate("+a.x+","+a.y+")");G.forEach(function(a){a.update()})},end:function(a){c.move(a.x,
a.y);B.empty()||B.attr("x",5).attr("y",6);r.classed("rpd-dragging",!1)}})}d.prepare&&d.prepare.bind(c)(g.patches[b.id].node(),g.patches[C.id].node());d.first&&F(c,d.first.bind(c)(r.select(".rpd-process").node()));if(d.always)c.event["node/process"].throttle(100).onValue(function(){G.updateAll()});if(!r.select(".rpd-remove-button").empty())Kefir.fromEvents(r.select(".rpd-remove-button-handle").node(),"click").map(y).onValue(function(){b.removeNode(c)});g.patches[c.patch.id].data().root.append(k.node())},
"patch/remove-node":function(a){a=a.node;var b=g.nodes[a.id];g.nodeToLinks[a.id].forEach(function(a){a.get().disconnect()});b.remove();if(u.onNodeRemove)u.onNodeRemove(a);g.nodes[a.id]=null;g.nodeToLinks[a.id]=null},"node/move":function(a){var b=g.nodes[a.node.id];a=a.position;b.attr("transform","translate("+Math.floor(a[0])+","+Math.floor(a[1])+")");b.data().position={x:a[0],y:a[1]}},"node/process":function(a){var b=a.node,c=a.render;if(c.always){var d=g.nodes[b.id].data().processTarget.node();c.always.bind(b)(d,
a.inlets,a.outlets)}},"node/add-inlet":function(a){var b=a.inlet;if(!b.hidden){var c=g.nodes[a.node.id].data().inletsTarget;a=a.render;var d;d=q.select(u.createInlet(b,a).element);d.classed("rpd-"+b.type.replace("/","-"),!0);d.classed({"rpd-stale":!0,"rpd-readonly":b.readonly,"rpd-cold":b.cold});var k=null;!b.readonly&&a.edit&&(k=new e(b,a,r,d.select(".rpd-value-holder"),d.select(".rpd-value"),q.select(h("g"))),d.select(".rpd-value-holder").append(k.editorElm.node()));g.inlets[b.id]=d.data({connector:d.select(".rpd-connector"),
value:d.select(".rpd-value"),vlinks:new t,editor:k});b.event["inlet/update"].onError(function(){A(b.id,d,p.effectTime)});G.subscribeInlet(b,d.select(".rpd-connector"));c.append(d.node())}},"node/add-outlet":function(a){var b=a.outlet,c=g.nodes[a.node.id].data().outletsTarget;a=q.select(u.createOutlet(b,a.render).element);a.classed("rpd-"+b.type.replace("/","-"),!0);a.classed("rpd-stale",!0);g.outlets[b.id]=a.data({connector:a.select(".rpd-connector"),value:a.select(".rpd-value"),vlinks:new t});G.subscribeOutlet(b,
a.select(".rpd-connector"));c.append(a.node())},"node/remove-inlet":function(a){a=a.inlet;g.inlets[a.id].data().vlinks.forEach(function(a){a.get().disconnect()});g.inlets[a.id].remove();if(u.onInletRemove)u.onInletRemove(a);g.inlets[a.id]=null},"node/remove-outlet":function(a){a=a.outlet;g.outlets[a.id].data().vlinks.forEach(function(a){a.get().disconnect()});g.outlets[a.id].remove();if(u.onOutletRemove)u.onOutletRemove(a);g.outlets[a.id]=null},"inlet/update":function(a){var b=a.inlet;if(!b.hidden){var c=
a.render,d=g.inlets[b.id],e=d.data().value;if(!e.empty()){var h=b.def.show?b.def.show(a.value):a.value;c.show?c.show.bind(b)(e.node(),a.value,h):e.text(h)}w(b.id,d,p.effectTime)}},"outlet/update":function(a){var b=a.outlet,c=a.render,d=g.outlets[b.id],e=d.data().value;if(!e.empty()){var h=b.def.show?b.def.show(a.value):a.value;c.show?c.show.bind(b)(e.node(),a.value,h):e.text(h)}w(b.id,d,p.effectTime)},"outlet/connect":function(a){a=a.link;var c=a.outlet,d=a.inlet,e=g.inlets[d.id],h=g.outlets[c.id].data(),
e=e.data();if(!p.inletAcceptsMultipleLinks&&1===e.vlinks.count())throw Error("Inlet is already connected to a link");e.editor&&e.editor.disable();var k=new n(a,u);k.construct(p.linkWidth).rotateOI(c,d);q.select(k.getElement()).classed("rpd-"+d.type.replace("/","-"),!0).classed("rpd-"+c.type.replace("/","-"),!0);g.links[a.id]=k;h.vlinks.add(k);e.vlinks.add(k);g.nodeToLinks[c.node.id].add(k);c.node.id!==d.node.id&&g.nodeToLinks[d.node.id].add(k);g.patchToLinks[b.id].add(k);k.listenForClicks();k.appendTo(r)},
"outlet/disconnect":function(a){a=a.link;var c=g.links[a.id],d=a.outlet,e=a.inlet,h=g.outlets[d.id].data(),k=g.inlets[e.id].data();g.links[a.id]=null;h.vlinks.remove(c);k.vlinks.remove(c);g.nodeToLinks[d.node.id].remove(c);d.node.id!==e.node.id&&g.nodeToLinks[e.node.id].remove(c);g.patchToLinks[b.id].remove(c);c.removeFrom(r)},"link/enable":function(a){var b=g.inlets[a.link.inlet.id].data();b.editor&&b.editor.disable();g.links[a.link.id].enable()},"link/disable":function(a){g.links[a.link.id].disable()}}}}
function b(b,c){return Kefir.merge([b.map(k(!0)),c.map(k(!1))]).toProperty(k(!1))}function e(b,c,d,e,h,r){var n=Kefir.emitter(),a=Kefir.emitter();this.disableEditor=a;this.editorElm=r;this.valueElm=h;r.classed("rpd-value-editor",!0);c.edit.bind(b)(r.node(),b,n).onValue(function(a){b.receive(a)});Kefir.combine([Kefir.merge([Kefir.fromEvents(e.node(),"click").map(y).map(k(!0)),Kefir.fromEvents(d.node(),"click").merge(a).map(k(!1))]).toProperty(k(!1)).skipDuplicates()],[b.event["inlet/update"]]).map(function(a){return{lastValue:a[1],
startEditing:a[0],cancelEditing:!a[0]}}).onValue(function(a){if(a.startEditing){var c=g.inlets[b.id].data();c.link&&c.link.disable();n.emit(a.lastValue);e.classed("rpd-editor-enabled",!0)}else a.cancelEditing&&(h.classed("rpd-edited",!0),e.classed("rpd-editor-enabled",!1))});e.classed("rpd-editor-disabled",!0)}var k=Rpd.unit,E={style:"quartz",valuesOnHover:!1,showBoxes:!1,nodeMovingAllowed:!0,renderNodeList:!0,nodeListCollapsed:!0,inletAcceptsMultipleLinks:!1,effectTime:1E3},q=q||d3_tiny,l=Rpd.Render,
g={patches:{},nodes:{},inlets:{},outlets:{},links:{},patchToPlacing:{},patchToLinks:{},nodeToLinks:{}},x=new l.Navigation(function(b){return function(c){return b.patches[c].data().patch}}(g)),C,H=Rpd.allNodeDescriptions,c=function(){function c(b){return g.inlets[b.id].data().vlinks}function d(b){return function(){return 0<c(b).count()}}function e(b){1===b.count()&&(b=b.getLast().link,b.outlet.disconnect(b))}function h(b,c){b.forEach(function(a){a.link.outlet.id===c.id&&c.disconnect(a.link)})}function l(c,
d,a){this.root=c;this.style=d;this.config=a;this.rootClicks=Kefir.fromEvents(this.root.node(),"click");this.inletClicks=Kefir.pool();this.outletClicks=Kefir.pool();this.startLink=Kefir.emitter();this.finishLink=Kefir.emitter();this.doingLink=b(this.startLink,this.finishLink)}l.prototype.subscribeOutlet=function(d,g){var a=this.root,f=this.style,m=this.config,l=this.rootClicks,t=this.outletClicks,u=this.inletClicks,v=this.startLink,w=this.finishLink,x=this.doingLink;t.plug(Kefir.fromEvents(g.node(),
"click").map(I).map(p(d)));Kefir.fromEvents(g.node(),"click").map(y).filterBy(b(t,x)).map(I).onValue(function(b){v.emit();var g=(new n(null,f)).construct(m.linkWidth).rotateO(d,b.x,b.y).noPointerEvents().appendTo(a);q.select(g.getElement()).classed("rpd-"+d.type.replace("/","-"),!0);Kefir.fromEvents(a.node(),"mousemove").takeUntilBy(Kefir.merge([u,t.map(k(!1)),l.map(k(!1))]).take(1).onValue(function(a){if(a){a=a.target;var b=c(a);m.inletAcceptsMultipleLinks?h(b,d):e(b);d.connect(a)}})).map(I).map(f.getLocalPos).onValue(function(a){g.rotateO(d,
a.x,a.y)}).onEnd(function(){g.removeFrom(a);w.emit()})})};l.prototype.subscribeInlet=function(g,l){var a=this.root,f=this.style,m=this.config,t=this.rootClicks,u=this.outletClicks,v=this.inletClicks,w=this.startLink,x=this.finishLink,A=this.doingLink;v.plug(Kefir.fromEvents(l.node(),"click").map(I).map(p(g)));Kefir.fromEvents(l.node(),"click").map(y).filterBy(b(v,A)).filter(d(g)).onValue(function(b){var d=c(g).getLast().link,l=d.outlet;l.disconnect(d);w.emit();var p=(new n(null,f)).construct(m.linkWidth).rotateO(l,
b.x,b.y).noPointerEvents().appendTo(a);q.select(p.getElement()).classed("rpd-"+g.type.replace("/","-"),!0).classed("rpd-"+l.type.replace("/","-"),!0);Kefir.fromEvents(a.node(),"mousemove").takeUntilBy(Kefir.merge([v,u.map(k(!1)),t.map(k(!1))]).take(1).onValue(function(a){if(a){a=a.target;var b=c(a);m.inletAcceptsMultipleLinks?h(b,l):e(b);l.connect(a)}})).map(I).map(f.getLocalPos).onValue(function(a){p.rotateO(l,a.x,a.y)}).onEnd(function(){p.removeFrom(a);x.emit()})})};return l}();e.prototype.disable=
function(){this.valueElm.classed("rpd-edited",!1);this.disableEditor.emit()};var n=l.VLink,t=l.VLinks,D=l.mergeConfig,v=l.preventDefault,y=l.stopPropagation,I=l.extractPos,p=l.addTarget,A=l.addValueErrorEffect,w=l.addValueUpdateEffect,F=l.subscribeUpdates;Rpd.SvgRenderer=d;Rpd.renderer("svg",d)})();Rpd.nodedescription("core/custom","May have any number of inlets and outlets, a target for extension.");Rpd.nodetype("core/custom",{name:"Custom"});Rpd.channeltype("core/number",{default:0,readonly:!1,accept:function(h){if(Infinity===h)return!0;h=parseFloat(h);return!isNaN(h)&&isFinite(h)},adapt:function(h){return parseFloat(h)}});
Rpd.channeltype("core/time",{default:1E3,accept:function(h){h=parseFloat(h);return!isNaN(h)&&isFinite(h)},adapt:function(h){return parseFloat(h)},show:function(h){return Math.floor(h/10)/100+"s"}});Rpd.nodetype("core/number",{name:"number",inlets:{"user-value":{type:"core/number",default:0,hidden:!0}},outlets:{out:{type:"core/number"}},process:function(h){return{out:h["user-value"]}}});
Rpd.nodetype("core/random",function(){var h=0;return{name:"random",inlets:{min:{type:"core/number",default:0},max:{type:"core/number",default:100},period:{type:"core/time",default:1E3}},outlets:{out:{type:"core/number"}},process:function(d){if(d.hasOwnProperty("period"))return h++,{out:Kefir.withInterval(d.period,function(b){b.emit(Math.floor(d.min+Math.random()*(d.max-d.min)))}).takeWhile(function(b){return function(){return b===h}}(h))}}}});
Rpd.nodetype("core/bounded-number",{name:"bounded number",inlets:{min:{type:"core/number",default:0},max:{type:"core/number",default:Infinity},spinner:{type:"core/number",default:0,hidden:!0}},outlets:{out:{type:"core/number"}},process:function(h){if(h.hasOwnProperty("spinner"))return{out:h.spinner}}});Rpd.channeltype("core/any",{});Rpd.channeltype("core/boolean",{default:!1,readonly:!1,adapt:function(h){return h?!0:!1}});Rpd.channelrenderer("core/number","svg",{edit:function(h,d,b){d=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");d.setAttributeNS(null,"width",20);d.setAttributeNS(null,"height",30);var e=document.createElementNS("http://www.w3.org/1999/xhtml","input");e.type="number";b.onValue(function(b){e.value=b});d.appendChild(e);h.appendChild(d);return Kefir.fromEvents(e,"change").map(function(){return e.value})}});Rpd.noderenderer("core/random","svg",function(){return{size:{width:40}}});

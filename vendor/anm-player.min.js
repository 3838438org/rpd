/*
 * Copyright (c) 2011-2014 by Animatron.
 * All rights are reserved.
 * 
 * Animatron Player is licensed under the MIT License.
 * 
 * v1.3, built at Mon Feb 02 2015 00:32:48 GMT+0100 (CET) / 2015-02-01T23:32:48.834Z
 */
!function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module){function Animation(){this.id=utils.guid(),this.tree=[],this.hash={},this.name="",this.duration=void 0,this.bgfill=null,this.width=void 0,this.height=void 0,this.zoom=1,this.speed=1,this.repeat=!1,this.meta={},this.__informEnabled=!0,this._laters=[],this._initHandlers()}var C=require("../constants.js"),engine=require("engine"),Element=require("./element.js"),Clip=Element,Brush=require("../graphics/brush.js"),provideEvents=require("../events.js").provideEvents,AnimationError=require("../errors.js").AnimationError,Errors=require("../loc.js").Errors,ResMan=require("../resource_manager.js"),FontDetector=require("../../vendor/font_detector.js"),utils=require("../utils.js"),is=utils.is,iter=utils.iter,DOM_TO_EVT_MAP={mouseup:C.X_MUP,mousedown:C.X_MDOWN,mousemove:C.X_MMOVE,mouseover:C.X_MOVER,mouseout:C.X_MOUT,click:C.X_MCLICK,dblclick:C.X_MDCLICK,keyup:C.X_KUP,keydown:C.X_KDOWN,keypress:C.X_KPRESS};Animation.DEFAULT_DURATION=10,provideEvents(Animation,[C.X_MCLICK,C.X_MDCLICK,C.X_MUP,C.X_MDOWN,C.X_MMOVE,C.X_MOVER,C.X_MOUT,C.X_KPRESS,C.X_KUP,C.X_KDOWN,C.X_DRAW,C.S_CHANGE_STATE,C.S_PLAY,C.S_PAUSE,C.S_STOP,C.S_COMPLETE,C.S_REPEAT,C.S_IMPORT,C.S_LOAD,C.S_RES_LOAD,C.S_ERROR]),Animation.prototype.add=function(arg1,arg2,arg3){if(arg2){var elm=new Element(arg1,arg2);arg3&&elm.changeTransform(arg3),this.addToTree(elm)}else if(is.arr(arg1)){var clip=new Clip;clip.add(arg1),this.addToTree(_clip)}else this.addToTree(arg1);return this},Animation.prototype.remove=function(elm){return elm.parent?elm.parent.remove(elm):this._unregister(elm),this},Animation.prototype.traverse=function(visitor,data){for(var elmId in this.hash)visitor(this.hash[elmId],data);return this},Animation.prototype.each=function(visitor,data){for(var i=0,tlen=this.tree.length;tlen>i;i++)visitor(this.tree[i],data);return this},Animation.prototype.iter=function(func,rfunc){return iter(this.tree).each(func,rfunc),this},Animation.prototype.render=function(ctx,time,dt){ctx.save();var zoom=this.zoom;try{1!=zoom&&ctx.scale(zoom,zoom),this.bgfill&&(this.bgfill instanceof Brush||(this.bgfill=Brush.fill(this.bgfill)),ctx.fillStyle=this.bgfill.apply(ctx),ctx.fillRect(0,0,this.width,this.height)),this.each(function(child){child.render(ctx,time,dt)})}finally{ctx.restore()}this.fire(C.X_DRAW,ctx)},Animation.prototype.handle__x=function(type,evt){return this.traverse(function(elm){elm.fire(type,evt)}),!0},Animation.prototype.getFittingDuration=function(){var max_pos=-1/0;return this.each(function(child){var elm_tpos=child._max_tpos();elm_tpos>max_pos&&(max_pos=elm_tpos)}),max_pos},Animation.prototype.reset=function(){return this.__informEnabled=!0,this.each(function(child){child.reset()}),this},Animation.prototype.dispose=function(){this.disposeHandlers();var me=this;return this.iter(function(child){return me._unregister_no_rm(child),child.dispose(),!1}),this},Animation.prototype.isEmpty=function(){return 0===this.tree.length},Animation.prototype.toString=function(){return"[ Animation "+(this.name?"'"+this.name+"'":"")+"]"},Animation.prototype.subscribeEvents=function(canvas){engine.subscribeAnimationToEvents(canvas,this,DOM_TO_EVT_MAP)},Animation.prototype.unsubscribeEvents=function(canvas){engine.unsubscribeAnimationFromEvents(canvas,this)},Animation.prototype.addToTree=function(elm){if(!elm.children)throw new AnimationError("It appears that it is not a clip object or element that you pass");this._register(elm),this.tree.push(elm)},Animation.prototype._register=function(elm){if(this.hash[elm.id])throw new AnimationError(Errors.A.ELEMENT_IS_REGISTERED);elm.registered=!0,elm.anim=this,this.hash[elm.id]=elm;var me=this;elm.each(function(child){me._register(child)})},Animation.prototype._unregister_no_rm=function(elm){this._unregister(elm,!0)},Animation.prototype._unregister=function(elm,save_in_tree){if(!elm.registered)throw new AnimationError(Errors.A.ELEMENT_IS_NOT_REGISTERED);var me=this;elm.each(function(child){me._unregister(child)});var pos=-1;if(!save_in_tree)for(;(pos=this.tree.indexOf(elm))>=0;)this.tree.splice(pos,1);delete this.hash[elm.id],elm.registered=!1,elm.anim=null},Animation.prototype._collectRemoteResources=function(player){var remotes=[],anim=this;return this.traverse(function(elm){elm._hasRemoteResources(anim,player)&&(remotes=remotes.concat(elm._collectRemoteResources(anim,player)))}),this.fonts&&this.fonts.length&&(remotes=remotes.concat(this.fonts.map(function(f){return f.url}))),remotes},Animation.prototype._loadRemoteResources=function(player){var anim=this;this.traverse(function(elm){elm._hasRemoteResources(anim,player)&&elm._loadRemoteResources(anim,player)}),anim.loadFonts(player)},Animation.prototype.find=function(name,where){where=where||this;var found=[];return where.name==name&&found.push(name),where.traverse(function(elm){elm.name==name&&found.push(elm)}),found},Animation.prototype.findById=function(id){return this.hash[id]},Animation.prototype.invokeAllLaters=function(){for(var i=0;i<this._laters.length;i++)this._laters[i].call(this)},Animation.prototype.clearAllLaters=function(){this._laters=[]},Animation.prototype.invokeLater=function(f){this._laters.push(f)};var FONT_LOAD_TIMEOUT=1e4,https=engine.isHttps;Animation.prototype.loadFonts=function(player){if(this.fonts&&this.fonts.length){for(var fonts=this.fonts,style=engine.createStyle(),css="",fontsToLoad=[],detector=new FontDetector,i=0;i<fonts.length;i++){var font=fonts[i];if(font.url&&font.face){var url=font.url,woff=font.woff;https&&(url=url.replace("http:","https:"),woff&&(woff=woff.replace("http:","https:"))),fontsToLoad.push(font),css+='@font-face {\nfont-family: "'+font.face+'";\nsrc:'+(woff?' url("'+woff+'") format("woff"),\n':"")+' url("'+url+'") format("truetype");\n'+(font.style?"font-style: "+font.style+";\n":"")+(font.weight?"font-weight: "+font.weight+";\n":"")+"}\n"}}if(0!==fontsToLoad.length){style.innerHTML=css,document.head.appendChild(style);var getLoader=function(i){var face=fontsToLoad[i].face;return function(success){var intervalId,interval=100,counter=0,checkLoaded=function(){counter+=interval;var loaded=detector.detect(face);(loaded||counter>FONT_LOAD_TIMEOUT)&&(clearInterval(intervalId),success())};intervalId=setInterval(checkLoaded,interval)}};for(i=0;i<fontsToLoad.length;i++)ResMan.loadOrGet(player.id,fontsToLoad[i].url,getLoader(i))}}},module.exports=Animation},{"../../vendor/font_detector.js":36,"../constants.js":9,"../errors.js":10,"../events.js":11,"../graphics/brush.js":14,"../loc.js":22,"../resource_manager.js":29,"../utils.js":33,"./element.js":4,engine:34}],2:[function(require,module){var Bands={};Bands.recalc=function(elm,in_band){in_band=in_band||(elm.parent?elm.parent.gband:[0,0]),elm.gband=[in_band[0]+elm.lband[0],in_band[0]+elm.lband[1]],elm.each(function(child){Bands.recalc(child,elm.gband)})},Bands.wrap=function(outer,inner){return outer?[outer[0]+inner[0],outer[0]+inner[1]<=outer[1]?outer[0]+inner[1]:outer[1]]:inner},Bands.expand=function(from,to){return from?[to[0]<from[0]?to[0]:from[0],to[1]>from[1]?to[1]:from[1]]:to},Bands.reduce=function(from,to){return from?[to[0]>from[0]?to[0]:from[0],to[1]<from[1]?to[1]:from[1]]:to},module.exports=Bands},{}],3:[function(require,module){function registerSegEasing(alias,points){C["E_"+alias]=alias;var seg=new CSeg(points);SEGS[alias]=seg;var func=function(t){return seg.atT([0,0],t)[1]};C["EF_"+alias]=func,EasingImpl[alias]=function(){return func}}var C=require("../constants.js"),CSeg=require("../graphics/segments.js").CSeg,EasingImpl={};EasingImpl[C.E_PATH]=function(path){return function(t){return path.pointAt(t)[1]}},EasingImpl[C.E_FUNC]=function(f){return f},EasingImpl[C.E_CSEG]=function(seg){return function(t){return seg.atT([0,0],t)[1]}},EasingImpl[C.E_STDF]=function(num){return STD_EASINGS[num]};var SEGS={};registerSegEasing("DEF",[.25,.1,.25,1,1,1]),registerSegEasing("IN",[.42,0,1,1,1,1]),registerSegEasing("OUT",[0,0,.58,1,1,1]),registerSegEasing("INOUT",[.42,0,.58,1,1,1]),registerSegEasing("SIN",[.47,0,.745,.715,1,1]),registerSegEasing("SOUT",[.39,.575,.565,1,1,1]),registerSegEasing("SINOUT",[.445,.05,.55,.95,1,1]),registerSegEasing("QIN",[.55,.085,.68,.53,1,1]),registerSegEasing("QOUT",[.25,.46,.45,.94,1,1]),registerSegEasing("QINOUT",[.455,.03,.515,.955,1,1]),registerSegEasing("CIN",[.55,.055,.675,.19,1,1]),registerSegEasing("COUT",[.215,.61,.355,1,1,1]),registerSegEasing("CINOUT",[.645,.045,.355,1,1,1]),registerSegEasing("QTIN",[.895,.03,.685,.22,1,1]),registerSegEasing("QTOUT",[.165,.84,.44,1,1,1]),registerSegEasing("QTINOUT",[.77,0,.175,1,1,1]),registerSegEasing("QIIN",[.755,.05,.855,.06,1,1]),registerSegEasing("QIOUT",[.23,1,.32,1,1,1]),registerSegEasing("QIINOUT",[.86,0,.07,1,1,1]),registerSegEasing("EIN",[.95,.05,.795,.035,1,1]),registerSegEasing("EOUT",[.19,1,.22,1,1,1]),registerSegEasing("EINOUT",[1,0,0,1,1,1]),registerSegEasing("CRIN",[.6,.04,.98,.335,1,1]),registerSegEasing("CROUT",[.075,.82,.165,1,1,1]),registerSegEasing("CRINOUT",[.785,.135,.15,.86,1,1]),registerSegEasing("BIN",[.6,-.28,.735,.045,1,1]),registerSegEasing("BOUT",[.175,.885,.32,1.275,1,1]),registerSegEasing("BINOUT",[.68,-.55,.265,1.55,1,1]);var STD_EASINGS=[function(t){return C.EF_DEF(t)},function(t){return C.EF_IN(t)},function(t){return C.EF_OUT(t)},function(t){return C.EF_INOUT(t)},function(t){return t*t},function(t){return t*(2-t)},function(t){return.5>t?2*t*t:(t=2*(t-.5),-(t*(t-2)-1)/2)},function(t){return t*t*t},function(t){return t-=1,t*t*t+1},function(t){return.5>t?(t=2*t,t*t*t/2):(t=2*(t-.5)-1,(t*t*t+2)/2)},function(t){return 1-Math.cos(t*(Math.PI/2))},function(t){return Math.sin(t*(Math.PI/2))},function(t){return-(Math.cos(Math.PI*t)-1)/2},function(t){return 0>=t?0:Math.pow(2,10*(t-1))},function(t){return t>=1?1:-Math.pow(2,-10*t)+1},function(t){return 0>=t?0:t>=1?1:.5>t?Math.pow(2,10*(2*t-1))/2:(-Math.pow(2,-10*(t-.5)*2)+2)/2},function(t){return 1-Math.sqrt(1-t*t)},function(t){return t-=1,Math.sqrt(1-t*t)},function(t){return(t*=2)<1?-(Math.sqrt(1-t*t)-1)/2:(Math.sqrt(1-(t-=2)*t)+1)/2},function(t){var s=1.70158;return t*t*((s+1)*t-s)},function(t){var s=1.70158;return(t-=1)*t*((s+1)*t+s)+1},function(t){var s=1.70158;return(t*=2)<1?t*t*(((s*=1.525)+1)*t-s)/2:((t-=2)*t*(((s*=1.525)+1)*t+s)+2)/2},function(t){return 1-STD_EASINGS[23](1-t)},function(t){return 1/2.75>t?7.5625*t*t:2/2.75>t?7.5625*(t-=1.5/2.75)*t+.75:2.5/2.75>t?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},function(t){return.5>t?.5*STD_EASINGS[22](2*t):.5*STD_EASINGS[23](2*t-1)+.5}];module.exports=EasingImpl},{"../constants.js":9,"../graphics/segments.js":17}],4:[function(require,module){function t_adjust(t){return utils.roundTo(t,TIME_PRECISION)}function t_cmp(t0,t1){return t_adjust(t0)>t_adjust(t1)?1:t_adjust(t0)<t_adjust(t1)?-1:0}function Element(name,draw,onframe){this.id=utils.guid(),this.name=name||"",this.type=C.ET_EMPTY,this.children=[],this.parent=null,this.level=0,this.anim=null,this.disabled=!1,this.visible=!0,this.$data=null,this.shown=!1,this.registered=!1,this.rendering=!1,this.initState(),this.initVisuals(),this.initTime(),this.initEvents(),this.$modifiers={},this.$painters={},onframe&&this.modify(onframe),draw&&this.paint(draw),this.__modifying=null,this.__painting=null,this.__modifiers_hash={},this.__painters_hash={},this.__detachQueue=[],this.__frameProcessors=[],this._initHandlers();var me=this,default_on=this.on;this.on=function(type,handler){return type&C.XT_CONTROL?this.m_on.call(me,type,handler):default_on.call(me,type,handler)},this.addSysModifiers(),this.addSysPainters(),global_opts.liveDebug&&this.addDebugRender()}var log=require("../log.js"),utils=require("../utils.js"),global_opts=require("../global_opts.js"),iter=utils.iter,is=utils.is,engine=require("engine"),C=require("../constants.js"),provideEvents=require("../events.js").provideEvents,Transform=require("../../vendor/transform.js"),Render=require("../render.js"),Brush=require("../graphics/brush.js"),Color=require("../graphics/color.js"),Bounds=require("../graphics/bounds.js"),Modifier=require("./modifier.js"),Painter=require("./painter.js"),Bands=require("./band.js"),AnimationError=require("../errors.js").AnimationError,Errors=require("../loc.js").Errors,TIME_PRECISION=9,isPlayerEvent=function(type){return type==C.S_CHANGE_STATE||type==C.S_PLAY||type==C.S_PAUSE||type==C.S_STOP||type==C.S_REPEAT||type==C.S_LOAD||type==C.S_RES_LOAD||type==C.S_ERROR||type==C.S_IMPORT||type==C.S_COMPLETE};Element.DEFAULT_PVT=[.5,.5],Element.DEFAULT_REG=[0,0],Element._$=function(name,draw,onframe){return new Element(name,draw,onframe)},Element.NO_BAND=null,Element.DEFAULT_LEN=1/0,Element._customImporters=[],provideEvents(Element,[C.X_MCLICK,C.X_MDCLICK,C.X_MUP,C.X_MDOWN,C.X_MMOVE,C.X_MOVER,C.X_MOUT,C.X_KPRESS,C.X_KUP,C.X_KDOWN,C.X_DRAW,C.X_START,C.X_STOP,C.S_CHANGE_STATE,C.S_PLAY,C.S_PAUSE,C.S_STOP,C.S_COMPLETE,C.S_REPEAT,C.S_IMPORT,C.S_LOAD,C.S_RES_LOAD,C.S_ERROR]),Element.prototype.is=function(type){return this.type==type},Element.prototype.initState=function(){return this.x=0,this.y=0,this.sx=1,this.sy=1,this.hx=0,this.hy=0,this.angle=0,this.alpha=1,this.matrix?this.matrix.reset():this.matrix=new Transform,this._x=0,this._y=0,this._sx=1,this._sy=1,this._hx=1,this._hy=1,this._angle=0,this._alpha=1,this._matrix?this._matrix.reset():this._matrix=new Transform,this.$reg=Element.DEFAULT_REG,this.$pivot=Element.DEFAULT_PVT,this},Element.prototype.resetState=Element.prototype.initState,Element.prototype.initVisuals=function(){return this.$fill=null,this.$stroke=null,this.$shadow=null,this.$path=null,this.$text=null,this.$image=null,this.composite_op=null,this.$mask=null,this.$mpath=null,this.$bounds=null,this.lastBoundsSavedAt=null,this.$my_bounds=null,this.$audio=null,this},Element.prototype.resetVisuals=Element.prototype.initVisuals,Element.prototype.initTime=function(){return this.mode=C.R_ONCE,this.nrep=1/0,this.lband=[0,Element.DEFAULT_LEN],this.gband=[0,Element.DEFAULT_LEN],this.keys={},this.tf=null,this.key=null,this.t=null,this.__resetTimeFlags(),this},Element.prototype.resetTime=Element.prototype.initTime,Element.prototype.__resetTimeFlags=function(){this.__lastJump=null,this.__jumpLock=!1,this.__firedStart=!1,this.__firedStop=!1},Element.prototype.initEvents=function(){return this.evts={},this.__evt_st=0,this.__evtCache=[],this},Element.prototype.resetEvents=Element.prototype.initEvents,Element.prototype.path=function(value){return value?(this.invalidate(),this.type=C.ET_PATH,this.$path=is.str(value)?new Path(value):value,this):this.$path},Element.prototype.text=function(value){return value?(this.invalidate(),this.type=C.ET_TEXT,this.$text=is.str(value)||is.arr(value)?new Text(value):value,this):this.$text},Element.prototype.image=function(value,callback){return value?(this.invalidate(),this.type=C.ET_SHEET,this.$image=is.str(value)?new Image(value,callback):value,this):this.$image},Element.prototype.fill=function(value){return value?(this.$fill=value instanceof Brush?value:Brush.fill(value),this):this.$fill},Element.prototype.noFill=function(){return this.$fill=Color.TRANSPARENT,this},Element.prototype.stroke=function(value,width){return value?(value instanceof Brush?(this.$stroke=value,is.defined(width)&&(this.$stroke.width=width)):this.$stroke=Brush.stroke(value,width),this):this.$stroke},Element.prototype.noStroke=function(){return this.$stroke=null,this},Element.prototype.modifiers=function(ltime,dt,types){var elm=this,order=types||Modifier.ALL_MODIFIERS;dt=dt||0,elm.applyPrevState(elm),is.num(elm.__appliedAt)&&(elm._t=elm.__appliedAt,elm._rt=elm.__appliedAt*(elm.lband[1]-elm.lband[0])),elm.__loadEvents();for(var type,typed_modifiers,modifier,lbtime,modifiers=this.$modifiers,i=0,il=order.length;il>i;i++){if(type=order[i],elm.__modifying=type,elm.__mbefore(type),typed_modifiers=modifiers[type])for(var j=0,jl=typed_modifiers.length;jl>j;j++)if(modifier=typed_modifiers[j],lbtime=elm.__adaptModTime(modifier,ltime),null!==lbtime&&(lbtime===!1||modifier.call(elm,lbtime[0],dt,lbtime[1])===!1))return elm.__mafter(ltime,elm.__modifying,!1),elm.__modifying=null,!1;elm.__mafter(ltime,type,!0)}return elm.matrix=Element.getMatrixOf(elm,elm.matrix),elm.__modifying=null,elm.__appliedAt=ltime,elm.resetEvents(),!0},Element.prototype.painters=function(ctx,types){for(var type,typed_painters,painter,elm=this,order=types||Painter.ALL_PAINTERS,painters=this.$painters,i=0,il=order.length;il>i;i++){if(type=order[i],elm.__painting=type,elm.__pbefore(ctx,type),typed_painters=painters[type])for(var j=0,jl=typed_painters.length;jl>j;j++)painter=typed_painters[j],painter.call(elm,ctx);elm.__pafter(ctx,type)}elm.__painting=null},Element.prototype.forAllModifiers=function(f){for(var type,typed_modifiers,order=Modifier.ALL_MODIFIERS,modifiers=this.$modifiers,i=0,il=order.length;il>i;i++)if(type=order[i],typed_modifiers=modifiers[type])for(var j=0,jl=typed_modifiers.length;jl>j;j++)f(typed_modifiers[j],type)},Element.prototype.forAllPainters=function(f){for(var type,typed_painters,order=Painter.ALL_PAINTERS,painters=this.$painters,i=0,il=order.length;il>i;i++)if(type=order[i],typed_painters=painters[type])for(var j=0,jl=typed_painters.length;jl>j;j++)f(typed_painters[j],type)},Element.prototype.adapt=function(pts){if(is.arr(pts)){for(var trg=[],matrix=this.matrix,i=0,il=pts.length;il>i;i++)trg.push(matrix.transformPoint(pts[i].x,pts[i].y));return trg}return this.matrix.transformPoint(pts.x,pts.y)},Element.prototype.adaptBounds=function(bounds){var matrix=this.matrix,tl=matrix.transformPoint(bounds.x,bounds.y),tr=matrix.transformPoint(bounds.x+bounds.width,bounds.y),br=matrix.transformPoint(bounds.x+bounds.width,bounds.y+bounds.height),bl=matrix.transformPoint(bounds.x,bounds.y+bounds.height),minX=Math.min(tl.x,tr.x,bl.x,br.x),minY=Math.min(tl.y,tr.y,bl.y,br.y),maxX=Math.max(tl.x,tr.x,bl.x,br.x),maxY=Math.max(tl.y,tr.y,bl.y,br.y);return new Bounds(minX,minY,maxX-minX,maxY-minY)},Element.prototype.draw=Element.prototype.painters,Element.prototype.transform=function(ctx){return ctx.globalAlpha*=this.alpha,this.matrix.apply(ctx),this.matrix},Element.prototype.invTransform=function(ctx){var inv_matrix=Element.getIMatrixOf(this);return ctx.globalAlpha*=this.alpha,inv_matrix.apply(ctx),inv_matrix},Element.prototype.render=function(ctx,gtime,dt){if(!this.disabled){this.rendering=!0;var drawMe=!1,ltime=this.ltime(gtime);if(drawMe=this.__preRender(gtime,ltime,ctx),this.anim&&this.anim.__informEnabled&&this.inform(ltime),drawMe&&(drawMe=this.fits(ltime)&&this.modifiers(ltime,dt)&&this.visible),drawMe){ctx.save();try{if(gtime=this.gtime(ltime),this.$mask){var mask=this.$mask;if(!(mask.fits(ltime)&&mask.modifiers(ltime,dt)&&mask.visible))return;mask.ensureHasMaskCanvas();for(var pt,mcvs=mask.__maskCvs,mctx=mask.__maskCtx,bcvs=mask.__backCvs,bctx=mask.__backCtx,bounds_pts=mask.bounds(ltime).toPoints(),minX=Number.MAX_VALUE,minY=Number.MAX_VALUE,maxX=Number.MIN_VALUE,maxY=Number.MIN_VALUE,i=0,il=bounds_pts.length;il>i;i++)pt=bounds_pts[i],pt.x<minX&&(minX=pt.x),pt.y<minY&&(minY=pt.y),pt.x>maxX&&(maxX=pt.x),pt.y>maxY&&(maxY=pt.y);var ratio=engine.PX_RATIO,x=minX,y=minY,width=Math.round(maxX-minX),height=Math.round(maxY-minY),last_cvs_size=this._maskCvsSize||engine.getCanvasSize(mcvs);last_cvs_size[0]<width||last_cvs_size[1]<height?(this._maskCvsSize=engine.setCanvasSize(mcvs,width,height),engine.setCanvasSize(bcvs,width,height)):this._maskCvsSize=last_cvs_size;var scale=ratio;bctx.clearRect(0,0,width*scale,height*scale),mctx.clearRect(0,0,width*scale,height*scale),bctx.save(),mctx.save(),bctx.setTransform(scale,0,0,scale,-x*scale,-y*scale),mctx.setTransform(scale,0,0,scale,-x*scale,-y*scale),this.transform(bctx),this.painters(bctx),this.each(function(child){child.render(bctx,gtime,dt)}),mask.transform(mctx),mask.painters(mctx),mask.each(function(child){child.render(mctx,gtime,dt)}),bctx.globalCompositeOperation="destination-in",bctx.setTransform(1,0,0,1,0,0),bctx.drawImage(mcvs,0,0),ctx.drawImage(bcvs,0,0,width*scale,height*scale,x,y,width,height),mctx.restore(),bctx.restore()}else this.transform(ctx),this.painters(ctx),this.each(function(child){child.render(ctx,gtime,dt)})}catch(e){log.error(e)}finally{ctx.restore()}}return this.shown=drawMe,this.__postRender(),this.rendering=!1,drawMe&&this.fire(C.X_DRAW,ctx),this}},Element.prototype.pivot=function(x,y){return this.$pivot=[x,y],this},Element.prototype.reg=function(x,y){return this.$reg=[x,y],this},Element.prototype.move=function(x,y){return this.x=x,this.y=y,this},Element.prototype.rotate=function(angle){return this.angle=angle,this},Element.prototype.rotateInDeg=function(angle){return this.rotate(angle/180*Math.PI)},Element.prototype.scale=function(sx,sy){return this.sx=sx,this.sy=sy,this},Element.prototype.skew=function(hx,hy){return this.hx=hx,this.hy=hy,this},Element.prototype.repeat=function(mode,nrep){return this.mode=mode,this.nrep=is.num(nrep)?nrep:1/0,this},Element.prototype.once=function(){return this.mode=C.R_ONCE,this.nrep=1/0,this},Element.prototype.stay=function(){return this.mode=C.R_STAY,this.nrep=1/0,this},Element.prototype.loop=function(nrep){return this.mode=C.R_LOOP,this.nrep=is.num(nrep)?nrep:1/0,this},Element.prototype.bounce=function(nrep){return this.mode=C.R_BOUNCE,this.nrep=is.num(nrep)?nrep:1/0,this},Element.prototype.modify=function(band,modifier){if(is.arr(band)||(modifier=band,band=null),!modifier)throw new AnimationError("No modifier was passed to .modify() method");if(!is.modifier(modifier)&&is.fun(modifier))modifier=new Modifier(modifier,C.MOD_USER);else if(!is.modifier(modifier))throw new AnimationError("Modifier should be either a function or a Modifier instance");if(!modifier.type)throw new AnimationError("Modifier should have a type defined");if(band&&(modifier.$band=band),modifier.__applied_to&&modifier.__applied_to[this.id])throw new AnimationError("This modifier is already applied to this Element");return this.$modifiers[modifier.type]||(this.$modifiers[modifier.type]=[]),this.$modifiers[modifier.type].push(modifier),this.__modifiers_hash[modifier.id]=modifier,modifier.__applied_to||(modifier.__applied_to={}),modifier.__applied_to[this.id]=this.$modifiers[modifier.type].length,this},Element.prototype.removeModifier=function(modifier){if(!is.modifier(modifier))throw new AnimationError("Please pass Modifier instance to removeModifier");if(!this.__modifiers_hash[modifier.id])throw new AnimationError("Modifier wasn't applied to this element");if(!modifier.__applied_to||!modifier.__applied_to[this.id])throw new AnimationError(Errors.A.MODIFIER_NOT_ATTACHED);return utils.removeElement(this.__modifiers_hash,modifier.id),utils.removeElement(this.$modifiers[modifier.type],modifier),utils.removeElement(modifier.__applied_to,this.id),this},Element.prototype.paint=function(painter){if(!painter)throw new AnimationError("No painter was passed to .paint() method");if(!is.painter(painter)&&is.fun(painter))painter=new Painter(painter,C.MOD_USER);else if(!is.painter(painter))throw new AnimationError("Painter should be either a function or a Painter instance");if(!painter.type)throw new AnimationError("Painter should have a type defined");if(painter.__applied_to&&painter.__applied_to[this.id])throw new AnimationError("This painter is already applied to this Element");return this.$painters[painter.type]||(this.$painters[painter.type]=[]),this.$painters[painter.type].push(painter),this.__painters_hash[painter.id]=painter,painter.__applied_to||(painter.__applied_to={}),painter.__applied_to[this.id]=this.$painters[painter.type].length,this},Element.prototype.removePainter=function(painter){if(!is.painter(painter))throw new AnimationError("Please pass Painter instance to removePainter");if(!this.__painters_hash[painter.id])throw new AnimationError("Painter wasn't applied to this element");if(!painter.__applied_to||!painter.__applied_to[this.id])throw new AnimErr(Errors.A.PAINTER_NOT_ATTACHED);return utils.removeElement(this.__painters_hash,painter.id),utils.removeElement(this.$painters[painter.type],painter),utils.removeElement(painter.__applied_to,this.id),this},Element.prototype.tween=function(tween){if(!is.tween(tween))throw new AnimationError("Please pass Tween instance to .tween() method");return this.modify(tween)},Element.prototype.removeTween=function(tween){if(!is.tween(tween))throw new AnimationError("Please pass Tween instance to .removeTween() method");return this.removeModifier(tween)},Element.prototype.add=function(arg1,arg2,arg3){if(arg2){var elm=new Element(arg1,arg2);arg3&&elm.changeTransform(arg3),this._addChild(elm)}else if(is.arr(arg1))for(var ei=0,el=elms.length;el>ei;ei++)this._addChild(elms[ei]);else this._addChild(arg1);return this.invalidate(),this},Element.prototype.remove=function(elm){if(!elm)throw new AnimationError(Errors.A.NO_ELEMENT_TO_REMOVE);if(0===this.__safeDetach(elm))throw new AnimationError(Errors.A.NO_ELEMENT);return this.invalidate(),this},Element.prototype._unbind=function(){if(this.parent.__unsafeToRemove||this.__unsafeToRemove)throw new AnimationError(Errors.A.UNSAFE_TO_REMOVE);this.parent=null,this.anim&&this.anim._unregister(this)},Element.prototype.detach=function(){if(0===this.parent.__safeDetach(this))throw new AnimationError(Errors.A.ELEMENT_NOT_ATTACHED)},Element.prototype.makeBandFit=function(){var wband=this.findWrapBand();this.gband=wband,this.lband[1]=wband[1]-wband[0]},Element.prototype.fits=function(ltime){return 0>ltime?!1:t_cmp(ltime,this.lband[1]-this.lband[0])<=0},Element.prototype.gtime=function(ltime){return this.gband[0]+ltime},Element.prototype.ltime=function(gtime){return this.__checkJump(Element.checkRepeatMode(gtime,this.gband,this.mode,this.nrep))},Element.prototype.handlePlayerEvent=function(event,handler){if(!isPlayerEvent(event))throw new Error("This method is intended to assign only player-related handles");this.on(event,handler)},Element.prototype.inform=function(ltime){if(t_cmp(ltime,0)>=0){var duration=this.lband[1]-this.lband[0],cmp=t_cmp(ltime,duration);this.__firedStart||(this.fire(C.X_START,ltime,duration),this.__firedStart=!0),cmp>=0&&(this.__firedStop||(this.fire(C.X_STOP,ltime,duration),this.traverse(function(elm){elm.__firedStop||(elm.fire(C.X_STOP,ltime,duration),elm.__firedStop=!0)}),this.__firedStop=!0))}},Element.prototype.band=function(start,stop){if(!is.defined(start))return this.lband;if(is.arr(start)&&(start=start[0],stop=start[1]),is.defined(stop)||(stop=1/0),this.lband=[start,stop],this.parent){var parent=this.parent;this.gband=[parent.gband[0]+start,parent.gband[0]+stop]}return this},Element.prototype.duration=function(value){return is.defined(value)?(this.gband=[this.gband[0],this.gband[0]+value],this.lband=[this.lband[0],this.lband[0]+value],this):this.lband[1]-this.lband[0]},Element.prototype._max_tpos=function(){return this.gband[1]>=0?this.gband[1]:0},Element.prototype.m_on=function(type,handler){this.modify(new Modifier(function(t){if(this.__evt_st&type)for(var evts=this.evts[type],i=0,el=evts.length;el>i;i++)if(handler.call(this,evts[i],t)===!1)return!1},C.MOD_EVENT))},Element.prototype.findWrapBand=function(){var children=this.children;if(0===children.length)return this.gband;var result=[1/0,0];return this.each(function(child){result=Bands.expand(result,child.gband)}),1/0!==result[0]?result:null},Element.prototype.dispose=function(){this.disposeHandlers(),this.disposeVisuals(),this.each(function(child){child.dispose()})},Element.prototype.disposeVisuals=function(){this.$path&&this.$path.dispose(),this.$text&&this.$text.dispose(),this.$image&&this.$image.dispose(),this.$mpath&&this.$mpath.dispose()},Element.prototype.reset=function(){this.resetEvents(),this.__resetTimeFlags();var elm=this;this.forAllModifiers(function(modifier){modifier.__wasCalled&&(modifier.__wasCalled[elm.id]=!1),is.defined(modifier.__wasCalledAt)&&(modifier.__wasCalledAt[elm.id]=-1)}),this.each(function(elm){elm.reset()})},Element.prototype.each=function(func){var children=this.children;this.__unsafeToRemove=!0;for(var ei=0,el=children.length;el>ei;ei++)func(children[ei]);return this.__unsafeToRemove=!1,this},Element.prototype.traverse=function(func){var children=this.children;this.__unsafeToRemove=!0;for(var ei=0,el=children.length;el>ei;ei++){var elem=children[ei];func(elem),elem.traverse(func)}return this.__unsafeToRemove=!1,this},Element.prototype.iter=function(func,rfunc){return this.__unsafeToRemove=!0,iter(this.children).each(func,rfunc),this.__unsafeToRemove=!1,this},Element.prototype.hasChildren=function(){return this.children.length>0},Element.prototype.deepIterateChildren=function(func,rfunc){this.__unsafeToRemove=!0,iter(this.children).each(function(elem){return elem.deepIterateChildren(func,rfunc),func(elem)},rfunc),this.__unsafeToRemove=!1},Element.prototype.__performDetach=function(){var children=this.children;iter(this.__detachQueue).each(function(elm){(idx=children.indexOf(elm))>=0&&(children.splice(idx,1),elm._unbind())}),this.__detachQueue=[]},Element.prototype.clear=function(){if(this.__unsafeToRemove)throw new AnimErr(Errors.A.UNSAFE_TO_REMOVE);if(this.rendering)this.__detachQueue=this.__detachQueue.concat(this.children);else{var children=this.children;this.children=[],iter(children).each(function(elm){elm._unbind()})}return this},Element.prototype.lock=function(){this.__jumpLock=!0,this.__state=this.extractState(),this.__pstate=this.extractPrevState()},Element.prototype.unlock=function(collect_res){var result=collect_res?this.extractState():void 0;return this.applyState(this.__state),this.applyPrevState(this.__pstate),this.__state=null,this.__pstate=null,this.__jumpLock=!1,result},Element.prototype.extractState=function(){return{x:this.x,y:this.y,sx:this.sx,sy:this.sy,hx:this.hx,hy:this.hy,angle:this.angle,alpha:this.alpha,t:this.t,rt:this.rt,key:this.key}},Element.prototype.extractPrevState=function(){return{x:this._x,y:this._y,sx:this._sx,sy:this._sy,hx:this._hx,hy:this._hy,angle:this._angle,alpha:this._alpha,t:this._t,rt:this._rt,key:this._key}},Element.prototype.applyState=function(s){this.x=s.x,this.y=s.y,this.sx=s.sx,this.sy=s.sy,this.hx=s.hx,this.hy=s.hy,this.angle=s.angle,this.alpha=s.alpha,this.t=s.t,this.rt=s.rt,this.key=s.key},Element.prototype.applyPrevState=function(s){this._x=s.x,this._y=s.y,this._sx=s.sx,this._sy=s.sy,this._hx=s.hx,this._hy=s.hy,this._angle=s.angle,this._alpha=s.alpha,this._t=s.t,this._rt=s.rt,this._key=s.key},Element.prototype.stateAt=function(t){return this.lock(),this.unlock(this.modifiers(t,0,Element.NOEVT_MODIFIERS))},Element.prototype.pos=function(x,y){return is.defined(x)?this.move(x,y):{x:this.x,y:this.y}},Element.prototype.offset=function(){for(var xsum=0,ysum=0,p=this.parent;p;)xsum+=p.x,ysum+=p.y,p=p.parent;return[xsum,ysum]},Element.prototype.invalidate=function(){return this.$my_bounds=null,this.$bounds=null,this.lastBoundsSavedAt=null,this.parent&&this.parent.invalidate(),this},Element.prototype.invalidateVisuals=function(){var subj=this.$path||this.$text||this.$image;subj&&subj.invalidate()},Element.prototype.bounds=function(ltime){if(is.defined(this.lastBoundsSavedAt)&&0==t_cmp(this.lastBoundsSavedAt,ltime))return this.$bounds;var result=this.myBounds().clone();return this.children.length&&this.each(function(child){result.add(child.bounds(ltime))}),result=this.adaptBounds(result),this.lastBoundsSavedAt=ltime,this.$bounds=result},Element.prototype.myBounds=function(){if(this.$my_bounds)return this.$my_bounds;var subj=this.$path||this.$text||this.$image;return this.$my_bounds=subj?subj.bounds():Bounds.NONE},Element.prototype.isEmpty=function(){var my_bounds=this.myBounds();return 0===my_bounds.width&&0===my_bounds.height},Element.prototype.applyVisuals=function(ctx){var subj=this.$path||this.$text||this.$image;
subj&&subj.apply(ctx,this.$fill,this.$stroke,this.$shadow)},Element.prototype.applyAComp=function(ctx){this.composite_op&&(ctx.globalCompositeOperation=C.AC_NAMES[this.composite_op])},Element.prototype.mask=function(elm){return elm?(this.$mask=elm,this):this.$mask},Element.prototype.noMask=function(){return this.$mask=null,this},Element.prototype.ensureHasMaskCanvas=function(){this.__maskCvs&&this.__backCvs||(this.__maskCvs=engine.createCanvas(1,1),this.__maskCtx=engine.getContext(this.__maskCvs,"2d"),this.__backCvs=engine.createCanvas(1,1),this.__backCtx=engine.getContext(this.__backCvs,"2d"))},Element.prototype.removeMaskCanvases=function(){this.__maskCvs&&engine.disposeElement(this.__maskCvs),this.__backCvs&&engine.disposeElement(this.__backCvs),this.__maskCtx=null,this.__backCtx=null},Element.prototype.data=function(val){return is.defined(val)?(this.$data=val,this):this.$data},Element.prototype.toString=function(){var buf=["[ Element "];return buf.push("'"+(this.name||this.id)+"' "),buf.push("]"),buf.join("")},Element.prototype.find=function(name){this.anim.find(name,this)},Element.prototype.clone=function(){var clone=new Element;return clone.name=this.name,clone.children=[].concat(this.children),clone.$modifiers=[].concat(this.$modifiers),clone.$painters=[].concat(this.$painters),clone.level=this.level,Element.transferState(this,clone),Element.transferVisuals(this,clone),Element.transferTime(this,clone),clone.__u_data=this.__u_data,clone},Element.prototype.shallow=function(){var clone=this.clone();clone.children=[];for(var src_children=this.children,trg_children=clone.children,sci=0,scl=src_children.length;scl>sci;sci++){var csrc=src_children[sci],cclone=csrc.shallow();cclone.parent=clone,trg_children.push(cclone)}return clone.$modifiers={},this.forAllModifiers(function(modifier){clone.modify(modifier)}),clone.$painters={},this.forAllPainters(function(painter){clone.paint(painter)}),clone.__u_data=utils.obj_clone(this.__u_data),clone},Element.prototype.asClip=function(band,mode,nrep){return mode!=C.R_ONCE?(this.clip_band=band,this.clip_mode=mode,this.clip_nrep=nrep,this):void 0},Element.prototype._addChild=function(elm){elm.parent=this,elm.level=this.level+1,this.children.push(elm),this.anim&&this.anim._register(elm),Bands.recalc(this)},Element.prototype._stateStr=function(){return"x: "+this.x+" y: "+this.y+"\nsx: "+this.sx+" sy: "+this.sy+"\nangle: "+this.angle+" alpha: "+this.alpha+"\np: "+this.p+" t: "+this.t+" key: "+this.key+"\n"},Element.prototype.__mbefore=function(){},Element.prototype.__mafter=function(){},Element.prototype.__adaptModTime=function(modifier,ltime){var res_time,res_duration,elm=this,elm_duration=elm.lband[1]-elm.lband[0],mod_easing=modifier.$easing,mod_time=modifier.$band||modifier.$time,mod_relative=modifier.relative,mod_is_tween=modifier.is_tween;if(elm.clip_band&&(ltime=Element.checkRepeatMode(ltime,elm.clip_band,elm.clip_mode||C.R_ONCE,elm.clip_nrep),0>ltime))return!1;if(null===mod_time)res_time=ltime,res_duration=elm_duration;else if(is.arr(mod_time)){var mod_duration,mod_band=mod_time;if(mod_relative?(mod_band=[mod_band[0]*elm_duration,mod_band[1]*elm_duration],mod_duration=mod_band[1]-mod_band[0]):mod_duration=mod_band[1]-mod_band[0],res_time=ltime-mod_band[0],res_duration=mod_duration,t_cmp(res_time,0)<0)return null;if(t_cmp(res_time,res_duration)>0)return null}else if(is.num(mod_time)){if(modifier.__wasCalled&&modifier.__wasCalled[elm.id])return null;var tpos=mod_relative?mod_time*elm_duration:mod_time;if(!(t_cmp(ltime,tpos)>=0))return null;modifier.__wasCalled||(modifier.__wasCalled={}),modifier.__wasCalledAt||(modifier.__wasCalledAt={}),modifier.__wasCalled[elm.id]=!0,modifier.__wasCalledAt[elm.id]=ltime,res_time=ltime,res_duration=elm_duration}else res_time=ltime,res_duration=elm_duration;return mod_relative||mod_is_tween?is.finite(res_duration)&&(res_time=t_adjust(res_time)/t_adjust(res_duration),res_duration=t_adjust(res_duration)):(res_time=t_adjust(res_time),res_duration=t_adjust(res_duration)),mod_easing?[mod_easing(res_time,res_duration),res_duration]:[res_time,res_duration]},Element.prototype.__pbefore=function(){},Element.prototype.__pafter=function(){},Element.prototype.__checkJump=function(at){if(this.tf)return this.tf(at);var t=null,duration=this.lband[1]-this.lband[0];if(t=is.defined(this.p)?this.p:null,t=null===t&&null!==this.t&&is.finite(duration)?this.t*duration:t,t=null===t&&is.defined(this.key)?this.keys[this.key]:t,null!==t){if(0>t||t>duration)throw new AnimationError("failed to calculate jump");if(!this.__jumpLock)return this.__lastJump=[at,t],this.p=null,this.t=null,this.key=null,t}return t=null!==t?t:at,is.defined(this.__lastJump)?(is.finite(this.__lastJump[1])?this.__lastJump[1]:0)+(t-this.__lastJump[0]):t},Element.prototype.handle__x=function(type,evt){if(!isPlayerEvent(type)&&type!=C.X_START&&type!=C.X_STOP){if(!this.shown)return!1;this.__saveEvt(type,evt)}return!0},Element.prototype.__saveEvt=function(type,evt){this.__evtCache.push([type,evt])},Element.prototype.__loadEvents=function(){var cache=this.__evtCache,cache_len=cache.length;if(this.resetEvents(),cache_len>0){for(var edata,type,evts,ei=0;cache_len>ei;ei++)edata=cache[ei],type=edata[0],this.__evt_st|=type,evts=this.evts,evts[type]||(evts[type]=[]),evts[type].push(edata[1]);this.__evtCache=[]}},Element.prototype.__preRender=function(gtime,ltime,ctx){for(var cr=this.__frameProcessors,i=0,cl=cr.length;cl>i;i++)if(cr[i].call(this,gtime,ltime,ctx)===!1)return!1;return!0},Element.prototype.__safeDetach=function(what,_cnt){var pos=-1,found=_cnt||0,children=this.children;if((pos=children.indexOf(what))>=0){if(this.rendering||what.rendering)this.__detachQueue.push(what);else{if(this.__unsafeToRemove)throw new AnimationError(Errors.A.UNSAFE_TO_REMOVE);what._unbind(),children.splice(pos,1)}return 1}return this.each(function(ielm){found+=ielm.__safeDetach(what,found)}),found},Element.prototype.__postRender=function(){this.__performDetach()},Element.prototype._hasRemoteResources=function(anim,player){return player.imagesEnabled&&this.$image?!0:this.is(C.ET_AUDIO)&&player.audioEnabled?!0:!1},Element.prototype._collectRemoteResources=function(anim,player){var resources=[];return player.imagesEnabled&&this.$image&&resources.push(this.$image.src),player.audioEnabled&&this.is(C.ET_AUDIO)&&resources.push(this.$audio.url),resources},Element.prototype._loadRemoteResources=function(anim,player){player.imagesEnabled&&this.$image&&this.$image.load(player.id),this.is(C.ET_AUDIO)&&player.audioEnabled&&this.$audio.load(player)},Element.mergeStates=function(src1,src2,trg){trg.x=src1.x+src2.x,trg.y=src1.y+src2.y,trg.sx=src1.sx*src2.sx,trg.sy=src1.sy*src2.sy,trg.hx=src1.hx+src2.hx,trg.hy=src1.hy+src2.hy,trg.angle=src1.angle+src2.angle,trg.alpha=src1.alpha+src2.alpha},Element.transferState=function(src,trg){trg.x=src.x,trg.y=src.y,trg.sx=src.sx,trg.sy=src.sy,trg.hx=src.hx,trg.hy=src.hy,trg.angle=src.angle,trg.alpha=src.alpha,trg.$reg=[].concat(src.$reg),trg.$pivot=[].concat(src.$pivot)},Element.transferVisuals=function(src,trg){trg.$fill=Brush.clone(src.$fill),trg.$stroke=Brush.clone(src.$stroke),trg.$shadow=Brush.clone(src.$shadow),trg.$path=src.$path?src.$path.clone():null,trg.$text=src.$text?src.$text.clone():null,trg.$image=src.$image?src.$image.clone():null,trg.$audio=src.$audio?src.$audio.clone():null,trg.$mask=src.$mask?src.$mask:null,trg.$mpath=src.$mpath?src.$mpath.clone():null,trg.composite_op=src.composite_op},Element.transferTime=function(src,trg){trg.mode=src.mode,trg.nrep=src.nrep,trg.lband=[].concat(src.lband),trg.gband=[].concat(src.gband),trg.keys=[].concat(src.keys),trg.tf=src.tf},Element.getMatrixOf=function(elm,m){var t=m?(m.reset(),m):new Transform;t.translate(elm.x,elm.y),t.rotate(elm.angle),t.shear(elm.hx,elm.hy),t.scale(elm.sx,elm.sy),t.translate(-elm.$reg[0],-elm.$reg[1]);var pivot=elm.$pivot;if(0===pivot[0]&&0===pivot[1])return t;var my_bounds=elm.myBounds();return my_bounds?(t.translate(pivot[0]*my_bounds.width,pivot[1]*my_bounds.height),t):t},Element.getIMatrixOf=function(elm,m){var t=Element.getMatrixOf(elm,m);return t.invert(),t},Element.checkRepeatMode=function(time,band,mode,nrep){if(!is.finite(band[1]))return time-band[0];var durtn,ffits,fits,t;switch(mode){case C.R_ONCE:return time-band[0];case C.R_STAY:return t_cmp(time,band[1])<=0?time-band[0]:band[1]-band[0];case C.R_LOOP:return durtn=band[1]-band[0],0>durtn?-1:(ffits=(time-band[0])/durtn,fits=Math.floor(ffits),0>fits||ffits>nrep?-1:t=time-band[0]-fits*durtn);case C.R_BOUNCE:return durtn=band[1]-band[0],0>durtn?-1:(ffits=(time-band[0])/durtn,fits=Math.floor(ffits),0>fits||ffits>nrep?-1:(t=time-band[0]-fits*durtn,t=fits%2===0?t:durtn-t))}},Element.prototype.addSysModifiers=function(){},Element.prototype.addSysPainters=function(){this.paint(Render.p_applyAComp),this.paint(Render.p_drawVisuals)},Element.prototype.addDebugRender=function(){this.paint(Render.p_drawPivot),this.paint(Render.p_drawReg),this.paint(Render.p_drawName),this.paint(Render.p_drawMPath)},module.exports=Element},{"../../vendor/transform.js":37,"../constants.js":9,"../errors.js":10,"../events.js":11,"../global_opts.js":12,"../graphics/bounds.js":13,"../graphics/brush.js":14,"../graphics/color.js":15,"../loc.js":22,"../log.js":23,"../render.js":28,"../utils.js":33,"./band.js":2,"./modifier.js":5,"./painter.js":6,engine:34}],5:[function(require,module){function Modifier(func,type){return func.id=guid(),func.type=type||C.MOD_USER,func.$data=null,func.$band=func.$band||null,func.$time=is.defined(func.$time)?func.$time:null,func.$easing=func.$easing||null,func.relative=is.defined(func.relative)?func.relative:!1,func.is_tween=func.is_tween||func.type==C.MOD_TWEEN||!1,func[C.MARKERS.MODIFIER_MARKER]=!0,func.band=function(start,stop){return is.defined(start)?(is.arr(start)&&(stop=start[1],start=start[0]),is.defined(stop)||(stop=1/0),this.$band=[start,stop],func):this.$band},func.time=function(value){return is.num(value)?(this.$time=value,this):this.$time},func.easing=function(f,data){return f?(this.$easing=convertEasing(f,data,this.relative||this.is_tween),this):this.$easing},func.data=function(data){return is.defined(data)?(this.$data=data,this):this.$data},func}var C=require("../constants.js"),is=require("../utils.js").is,EasingImpl=require("./easing.js"),guid=require("../utils.js").guid;Modifier.ORDER=[C.MOD_SYSTEM,C.MOD_TWEEN,C.MOD_USER,C.MOD_EVENT],Modifier.FIRST_MOD=C.MOD_SYSTEM,Modifier.LAST_MOD=C.MOD_EVENT,Modifier.ALL_MODIFIERS=[C.MOD_SYSTEM,C.MOD_TWEEN,C.MOD_USER,C.MOD_EVENT],Modifier.NOEVT_MODIFIERS=[C.MOD_SYSTEM,C.MOD_TWEEN,C.MOD_USER];var convertEasing=function(easing,data,relative){if(!easing)return null;var f;return is.str(easing)?(f=EasingImpl[easing](data),relative?f:function(t,len){return f(t/len,len)*len}):is.fun(easing)&&!data?easing:is.fun(easing)&&data?easing(data):easing.type?(f=EasingImpl[easing.type](easing.data||data),relative?f:function(t,len){return f(t/len,len)*len}):easing.f?easing.f(easing.data||data):void 0};module.exports=Modifier},{"../constants.js":9,"../utils.js":33,"./easing.js":3}],6:[function(require,module){function Painter(func,type){return func.id=guid(),func.type=type||C.PNT_USER,func[C.MARKERS.PAINTER_MARKER]=!0,func}var C=require("../constants.js"),guid=require("../utils.js").guid;Painter.ORDER=[C.PNT_SYSTEM,C.PNT_USER,C.PNT_DEBUG],Painter.FIRST_PNT=C.PNT_SYSTEM,Painter.LAST_PNT=C.PNT_DEBUG,Painter.ALL_PAINTERS=[C.PNT_SYSTEM,C.PNT_USER,C.PNT_DEBUG],Painter.NODBG_PAINTERS=[C.PNT_SYSTEM,C.PNT_USER],module.exports=Painter},{"../constants.js":9,"../utils.js":33}],7:[function(require,module){function Tween(tween_type,data){if(!tween_type)throw new Error("Tween type is required to be specified or function passed");var func;is.fun(tween_type)?func=tween_type:(func=Tweens[tween_type](data),func.tween=tween_type),func.is_tween=!0;var mod=Modifier(func,C.MOD_TWEEN);return mod.$data=data,mod.from=function(val){return!is.defined(val)&&this.$data?this.$data[0]:(this.$data||(this.$data=[]),this.$data[0]=val,this)},mod.to=function(val){return!is.defined(val)&&this.$data?this.$data[1]:(this.$data||(this.$data=[]),this.$data[1]=val,this)},mod.data=data_block_fn,mod}var C=require("../constants.js"),is=require("../utils.js").is,Modifier=require("./modifier.js"),AnimationError=require("../errors.js").AnimationError,Brush=require("../graphics/brush.js"),data_block_fn=function(){throw new AnimationError("Data should be passed to tween in a constructor or using from()/to() methods")};Tween.TWEENS_PRIORITY={},Tween.TWEENS_COUNT=0;var Tweens={};Tween.addTween=function(id,func){Tweens[id]=func,Tween.TWEENS_PRIORITY[id]=Tween.TWEENS_COUNT++},Tween.addTween(C.T_TRANSLATE,function(data){return function(t){var p=data.pointAt(t);p&&(this.x=p[0],this.y=p[1],data.length()>0?(this.$mpath=data,this.skippedMovePath=!1):this.skippedMovePath=!0)}}),Tween.addTween(C.T_SCALE,function(data){return function(t){this.sx=data[0][0]*(1-t)+data[1][0]*t,this.sy=data[0][1]*(1-t)+data[1][1]*t}}),Tween.addTween(C.T_ROTATE,function(data){return function(t){this.angle=data[0]*(1-t)+data[1]*t}}),Tween.addTween(C.T_ROT_TO_PATH,function(){return function(t){var path=this.$mpath;path&&(t=this.skippedMovePath?1:t,this.angle=path.tangentAt(t))}}),Tween.addTween(C.T_ALPHA,function(data){return function(t){this.alpha=data[0]*(1-t)+data[1]*t}}),Tween.addTween(C.T_SHEAR,function(data){return function(t){this.hx=data[0][0]*(1-t)+data[1][0]*t,this.hy=data[0][1]*(1-t)+data[1][1]*t}}),Tween.addTween(C.T_FILL,function(data){var interp_func=Brush.interpolateBrushes(data[0],data[1]);return function(t){this.$fill=interp_func(t)}}),Tween.addTween(C.T_STROKE,function(data){var interp_func=Brush.interpolateBrushes(data[0],data[1]);return function(t){this.$stroke=interp_func(t)}}),Tween.addTween(C.T_SHADOW,function(data){var interp_func=Brush.interpolateBrushes(data[0],data[1]);return function(t){this.$shadow=interp_func(t)}}),Tween.addTween(C.T_VOLUME,function(data){return function(t){if(this.$audio.loaded){var volume=data[0]*(1-t)+data[1]*t;this.$audio.setVolume(volume)}}}),module.exports=Tween},{"../constants.js":9,"../errors.js":10,"../graphics/brush.js":14,"../utils.js":33,"./modifier.js":5}],8:[function(require,module){(function(global){var PRIVATE_CONF="__anm_conf",C=require("./constants.js"),conf=global[PRIVATE_CONF]||{logImport:!1,logResMan:!1,logEvents:!1,logLevel:C.L_ERROR|C.L_WARN|C.L_INFO,doNotLoadAudio:!1,doNotLoadImages:!1,doNotRenderShadows:!1,engine:null};global[PRIVATE_CONF]=conf,module.exports=conf}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./constants.js":9}],9:[function(require,module){var C={};C.L_DEBUG=1,C.L_INFO=2,C.L_WARN=4,C.L_ERROR=8,C.MARKERS={},C.MARKERS.MODIFIER_MARKER="__modifier",C.MARKERS.PAINTER_MARKER="__painter",C.NOTHING=-1,C.STOPPED=0,C.PLAYING=1,C.PAUSED=2,C.LOADING=3,C.RES_LOADING=4,C.ERROR=5,C.M_CONTROLS_ENABLED=1,C.M_CONTROLS_DISABLED=2,C.M_INFO_ENABLED=4,C.M_INFO_DISABLED=8,C.M_HANDLE_EVENTS=16,C.M_DO_NOT_HANDLE_EVENTS=32,C.M_DRAW_STILL=64,C.M_DO_NOT_DRAW_STILL=128,C.M_INFINITE_DURATION=256,C.M_FINITE_DURATION=512,C.M_PREVIEW=C.M_CONTROLS_DISABLED|C.M_INFO_DISABLED|C.M_DO_NOT_HANDLE_EVENTS|C.M_DRAW_STILL|C.M_FINITE_DURATION,C.M_DYNAMIC=C.M_CONTROLS_DISABLED|C.M_INFO_DISABLED|C.M_HANDLE_EVENTS|C.M_DO_NOT_DRAW_STILL|C.M_INFINITE_DURATION,C.M_VIDEO=C.M_CONTROLS_ENABLED|C.M_INFO_DISABLED|C.M_DO_NOT_HANDLE_EVENTS|C.M_DRAW_STILL|C.M_FINITE_DURATION,C.M_SANDBOX=C.M_CONTROLS_DISABLED|C.M_INFO_DISABLED|C.M_DO_NOT_HANDLE_EVENTS|C.M_DO_NOT_DRAW_STILL|C.M_FINITE_DURATION,C.LT_ANIMATION=1,C.LT_ELEMENTS=2,C.LT_IMPORT=3,C.LT_URL=4,C.LM_ONREQUEST="onrequest",C.LM_ONPLAY="onplay",C.LM_DEFAULT=C.LM_ONREQUEST,C.ET_EMPTY="empty",C.ET_PATH="path",C.ET_TEXT="text",C.ET_SHEET="image",C.ET_AUDIO="audio",C.R_ONCE=0,C.R_STAY=1,C.R_LOOP=2,C.R_BOUNCE=3,C.C_SRC_OVER=1,C.C_SRC_ATOP=2,C.C_SRC_IN=3,C.C_SRC_OUT=4,C.C_DST_OVER=5,C.C_DST_ATOP=6,C.C_DST_IN=7,C.C_DST_OUT=8,C.C_LIGHTER=9,C.C_DARKER=10,C.C_COPY=11,C.C_XOR=12,C.AC_NAMES=[],C.AC_NAMES[C.C_SRC_OVER]="source-over",C.AC_NAMES[C.C_SRC_ATOP]="source-atop",C.AC_NAMES[C.C_SRC_IN]="source-in",C.AC_NAMES[C.C_SRC_OUT]="source-out",C.AC_NAMES[C.C_DST_OVER]="destination-over",C.AC_NAMES[C.C_DST_ATOP]="destination-atop",C.AC_NAMES[C.C_DST_IN]="destination-in",C.AC_NAMES[C.C_DST_OUT]="destination-out",C.AC_NAMES[C.C_LIGHTER]="lighter",C.AC_NAMES[C.C_DARKER]="darker",C.AC_NAMES[C.C_COPY]="copy",C.AC_NAMES[C.C_XOR]="xor",C.BT_NONE="none",C.BT_FILL="fill",C.BT_STROKE="stroke",C.BT_SHADOW="shadow",C.TA_LEFT="left",C.TA_CENTER="center",C.TA_RIGHT="right",C.BL_TOP="top",C.BL_MIDDLE="middle",C.BL_BOTTOM="bottom",C.BL_ALPHABETIC="alphabetic",C.BL_HANGING="hanging",C.BL_IDEOGRAPHIC="ideographic",C.PC_ROUND="round",C.PC_BUTT="butt",C.PC_MITER="miter",C.PC_SQUARE="square",C.PC_BEVEL="bevel",C.E_PATH="PATH",C.E_FUNC="FUNC",C.E_CSEG="CSEG",C.E_STDF="STDF",C.T_TRANSLATE="TRANSLATE",C.T_SCALE="SCALE",C.T_ROTATE="ROTATE",C.T_ROT_TO_PATH="ROT_TO_PATH",C.T_ALPHA="ALPHA",C.T_SHEAR="SHEAR",C.T_FILL="FILL",C.T_STROKE="STROKE",C.T_VOLUME="VOLUME",C.T_SHADOW="SHADOW",C.MOD_SYSTEM="system",C.MOD_TWEEN="tween",C.MOD_USER="user",C.MOD_EVENT="event",C.PNT_SYSTEM="system",C.PNT_USER="user",C.PNT_DEBUG="debug",module.exports=C},{}],10:[function(require,module){function __errorAs(name){return function(message){Error.captureStackTrace&&Error.captureStackTrace(this,this);var err=new Error(message||"");return err.name=name,err}}module.exports={SystemError:__errorAs("SystemError"),PlayerError:__errorAs("PlayerError"),AnimationError:__errorAs("AnimationError")}},{}],11:[function(require,module){function registerEvent(id,name,value){C[id]=value,C.__enmap[value]=name}function provideEvents(subj,events){subj.prototype._initHandlers=function(evts){return function(){var _hdls={};this.handlers=_hdls;for(var ei=0,el=evts.length;el>ei;ei++)_hdls[evts[ei]]=[]}}(events),subj.prototype.on=function(event,handler){if(!this.handlers)throw new Error("Instance is not initialized with handlers, call __initHandlers in its constructor");if(!this.provides(event))throw new Error("Event '"+C.__enmap[event]+"' not provided by "+this);if(!handler)throw new Error("You are trying to assign undefined handler for event "+event);return this.handlers[event].push(handler),this.handlers[event].length-1},subj.prototype.fire=function(event){if(!this.handlers)throw new Error("Instance is not initialized with handlers, call __initHandlers in its constructor");if(!this.provides(event))throw new Error("Event '"+C.__enmap[event]+"' not provided by "+this);if(!this.disabled){var evt_args=Array.prototype.slice.call(arguments,1);if(!this.handle__x||this.handle__x.apply(this,arguments)){var name=C.__enmap[event];this["handle_"+name]&&this["handle_"+name].apply(this,evt_args);for(var _hdls=this.handlers[event],hi=0,hl=_hdls.length;hl>hi;hi++)_hdls[hi].apply(this,evt_args)}}},subj.prototype.provides=function(evts){return function(event){if(!this.handlers)throw new Error("Instance is not initialized with handlers, call __initHandlers in its constructor");return event?this.handlers.hasOwnProperty(event):evts}}(events),subj.prototype.unbind=function(event,idx){if(!this.handlers)throw new Error("Instance is not initialized with handlers, call __initHandlers in its constructor");if(!this.provides(event))throw new Error("Event "+event+" not provided by "+this);if(!this.handlers[event][idx])throw new Error("No such handler "+idx+" for event "+event);this.handlers[event].splice(idx,1)},subj.prototype.disposeHandlers=function(){if(!this.handlers)throw new Error("Instance is not initialized with handlers, call __initHandlers in its constructor");var _hdls=this.handlers;for(var evt in _hdls)_hdls.hasOwnProperty(evt)&&(_hdls[evt]=[])};for(var makeFireFunc=function(event){return function(evtobj){this.fire(event,evtobj)}},ei=0,el=events.length;el>ei;ei++)subj.prototype["e_"+events[ei]]=makeFireFunc(events[ei])}var C=require("./constants.js");C.__enmap={},registerEvent("S_NEW_PLAYER","new_player","new_player"),registerEvent("S_PLAYER_DETACH","player_detach","player_detach"),registerEvent("X_MCLICK","mclick",1),registerEvent("X_MDCLICK","mdclick",2),registerEvent("X_MUP","mup",4),registerEvent("X_MDOWN","mdown",8),registerEvent("X_MMOVE","mmove",16),registerEvent("X_MOVER","mover",32),registerEvent("X_MOUT","mout",64),registerEvent("XT_MOUSE","mouse",C.X_MCLICK|C.X_MDCLICK|C.X_MUP|C.X_MDOWN|C.X_MMOVE|C.X_MOVER|C.X_MOUT),registerEvent("X_KPRESS","kpress",128),registerEvent("X_KUP","kup",256),registerEvent("X_KDOWN","kdown",1024),registerEvent("XT_KEYBOARD","keyboard",C.X_KPRESS|C.X_KUP|C.X_KDOWN),registerEvent("XT_CONTROL","control",C.XT_KEYBOARD|C.XT_MOUSE),registerEvent("X_DRAW","draw","draw"),registerEvent("X_START","start","x_start"),registerEvent("X_STOP","stop","x_stop"),registerEvent("S_PLAY","play","play"),registerEvent("S_PAUSE","pause","pause"),registerEvent("S_STOP","stop","stop"),registerEvent("S_COMPLETE","complete","complete"),registerEvent("S_REPEAT","repeat","repeat"),registerEvent("S_IMPORT","import","import"),registerEvent("S_LOAD","load","load"),registerEvent("S_RES_LOAD","res_load","res_load"),registerEvent("S_ERROR","error","error"),module.exports={registerEvent:registerEvent,provideEvents:provideEvents}},{"./constants.js":9}],12:[function(require,module){var global_opts={liveDebug:!1,autoFocus:!0,setTabindex:!0};module.exports=global_opts},{}],13:[function(require,module){function Bounds(x,y,width,height){this.x=x,this.y=y,this.width=width,this.height=height}var is=require("../utils.js").is;Bounds.prototype.load=function(other){this.x=other.x,this.y=other.y,this.width=other.width,this.height=other.height},Bounds.prototype.loadDiag=function(x1,y1,x2,y2){var t;x1>x2&&(t=x1,x1=x2,x2=t),y1>y2&&(t=y1,y1=y2,y2=t),this.x=x1,this.y=y1,this.width=x2-x1,this.height=y2-y1},Bounds.prototype.minX=function(){return this.x},Bounds.prototype.minY=function(){return this.y},Bounds.prototype.maxX=function(){return this.x+this.width},Bounds.prototype.maxY=function(){return this.y+this.height},Bounds.prototype.add=function(other){other.exist()&&(this.exist()?this.loadDiag(Math.min(this.minX(),other.minX()),Math.min(this.minY(),other.minY()),Math.max(this.maxX(),other.maxX()),Math.max(this.maxY(),other.maxY())):this.load(other))},Bounds.prototype.addPoint=function(pt){this.loadDiag(Math.min(this.minX(),pt.x),Math.min(this.minY(),pt.y),Math.max(this.maxX(),pt.x),Math.max(this.maxY(),pt.y))},Bounds.prototype.toPoints=function(){return[{x:this.x,y:this.y},{x:this.x+this.width,y:this.y},{x:this.x+this.width,y:this.y+this.height},{x:this.x,y:this.y+this.height}]},Bounds.prototype.exist=function(){return!is.nan(this.x)},Bounds.prototype.clone=function(){return new Bounds(this.x,this.y,this.width,this.height)},Bounds.NONE=new Bounds(0/0,0/0,0/0,0/0),module.exports=Bounds},{"../utils.js":33}],14:[function(require,module){function Brush(value){this.type=C.BT_NONE,value&&Brush.value(value,this)}var Color=require("./color.js"),C=require("../constants.js"),conf=require("../conf.js"),utils=require("../utils.js"),is=utils.is,engine=require("engine"),AnimationError=require("../errors.js").AnimationError;Brush.DEFAULT_CAP=C.PC_ROUND,Brush.DEFAULT_JOIN=C.PC_ROUND,Brush.DEFAULT_FILL="#ffbc05",Brush.DEFAULT_STROKE=Color.TRANSPARENT,Brush.DEFAULT_SHADOW=Color.TRANSPARENT,Brush.prototype.apply=function(ctx){if(this.type!=C.BT_NONE){var style=this._style||(this._style=this.adapt(ctx));if(this.type==C.BT_FILL)ctx.fillStyle=style;else if(this.type==C.BT_STROKE)this.width>0?(ctx.lineWidth=this.width,ctx.strokeStyle=style||Brush.DEFAULT_STROKE,ctx.lineCap=this.cap||Brush.DEFAULT_CAP,ctx.lineJoin=this.join||Brush.DEFAULT_JOIN):Brush.clearStroke(ctx);else if(this.type==C.BT_SHADOW){if(conf.doNotRenderShadows)return;var props=engine.getAnmProps(ctx);if(props.skip_shadows)return;var ratio=engine.PX_RATIO*(props.factor||1);ctx.shadowColor=style,ctx.shadowBlur=this.blurRadius*ratio||0,ctx.shadowOffsetX=this.offsetX*ratio||0,ctx.shadowOffsetY=this.offsetY*ratio||0}}},Brush.prototype.invalidate=function(){this._converted=!1,this._style=null},Brush.prototype.convertColorsToRgba=function(){if(!this._converted){if(this.color&&is.str(this.color))this.color=Color.fromStr(this.color);else if(this.grad)for(var stops=this.grad.stops,i=0,il=stops.length;il>i;i++)is.str(stops[i][1])&&(stops[i][1]=Color.from(stops[i][1]));this._converted=!0}},Brush.prototype.adapt=function(ctx){if(this.color&&is.str(this.color))return this.color;if(this.color)return Color.toRgbaStr(this.color);if(this.grad){var src=this.grad,stops=src.stops,dir=src.dir||[[.5,0],[.5,1]],r=src.r||1;bounds=src.bounds||[0,0,1,1];var grad;grad=is.defined(src.r)?bounds?ctx.createRadialGradient(bounds[0]+dir[0][0]*bounds[2],bounds[1]+dir[0][1]*bounds[3],Math.max(bounds[2],bounds[3])*r[0],bounds[0]+dir[1][0]*bounds[2],bounds[1]+dir[1][1]*bounds[3],Math.max(bounds[2],bounds[3])*r[1]):ctx.createRadialGradient(dir[0][0],dir[0][1],r[0],dir[1][0],dir[1][1],r[1]):bounds?ctx.createLinearGradient(bounds[0]+dir[0][0]*bounds[2],bounds[1]+dir[0][1]*bounds[3],bounds[0]+dir[1][0]*bounds[2],bounds[1]+dir[1][1]*bounds[3]):ctx.createLinearGradient(dir[0][0],dir[0][1],dir[1][0],dir[1][1]);for(var i=0,slen=stops.length;slen>i;i++){var stop=stops[i];grad.addColorStop(stop[0],Color.adapt(stop[1]))}return grad}if(this.pattern){var fill,elm=this.pattern.elm,canvas=engine.createCanvas(this.pattern.w,this.pattern.h,null,1),cctx=canvas.getContext("2d");return elm.pivot(0,0),elm.disabled=!1,elm.render(cctx,0,0),elm.disabled=!0,fill=canvas,ctx.createPattern(fill,this.pattern.repeat)}return null},Brush.prototype.clone=function(){var src=this,trg=new Brush;if(trg.type=src.type,src.color&&is.str(src.color)?trg.color=src.color:src.color&&(trg.color={r:src.color.r,g:src.color.g,b:src.color.b,a:src.color.a||1}),src.grad){var src_grad=src.grad,trg_grad={};for(trg_grad.stops=[],i=0;i<src_grad.stops.length;i++)trg_grad.stops[i]=[].concat(src_grad.stops[i]);for(trg_grad.dir=[],i=0;i<src_grad.dir.length;i++)trg_grad.dir[i]=[].concat(src_grad.dir[i]);src_grad.r&&(trg_grad.r=[].concat(src_grad.r)),trg.grad=trg_grad}return src.hasOwnProperty("width")&&(trg.width=src.width),src.hasOwnProperty("cap")&&(trg.cap=src.cap),src.hasOwnProperty("join")&&(trg.join=src.join),src.hasOwnProperty("blurRadius")&&(trg.blurRadius=src.blurRadius),src.hasOwnProperty("offsetX")&&(trg.offsetX=src.offsetX),src.hasOwnProperty("offsetY")&&(trg.offsetY=src.offsetY),trg},Brush.fill=function(value){var brush=new Brush;return brush.type=C.BT_FILL,is.obj(value)?value.stops?brush.grad=value:value.elm&&(brush.pattern=value):brush.color=value,brush},Brush.stroke=function(color,width,cap,join,mitter){var brush=Brush.fill(color);return brush.type=C.BT_STROKE,brush.width=width||0,brush.cap=cap||Brush.DEFAULT_CAP,brush.join=join||Brush.DEFAULT_JOIN,brush.mitter=mitter,brush},Brush.shadow=function(color,blurRadius,offsetX,offsetY){var brush=Brush.fill(color);return brush.type=C.BT_SHADOW,brush.blurRadius=blurRadius||0,brush.offsetX=offsetX||0,brush.offsetY=offsetY||0,brush},Brush.value=function(value,target){var brush=target||new Brush;if(value)if(is.str(value))brush.type=C.BT_FILL,brush.color=value;else{if(!is.obj(value))throw new AnimationError("Use Brush.fill, Brush.stroke or Brush.shadow to create brush from values");if(is.defined(value.r)&&is.defined(value.g)&&is.defined(value.b))brush.type=C.BT_FILL,brush.color=value;else{if(!value.color&&!value.grad)throw new AnimationError("Unknown type of brush");brush.type=is.defined(value.width)?C.BT_STROKE:is.defined(value.blurRadius)||is.defined(value.offsetX)?C.BT_SHADOW:C.BT_FILL;for(var key in value)value.hasOwnProperty(key)&&(brush[key]=value[key])}}else brush.type=C.BT_NONE},Brush.grad=function(stops,bounds,dir){var new_stops=[];for(var prop in stops)new_stops.push([prop,stops[prop]]);return{grad:{stops:stops,bounds:bounds,dir:dir}}},Brush.rgrad=function(stops,r,bounds,dir){var new_stops=[];for(var prop in stops)new_stops.push([prop,stops[prop]]);return{grad:{r:r,stops:stops,bounds:bounds,dir:dir}}},Brush.qfill=function(ctx,color){ctx.fillStyle=color},Brush.qstroke=function(ctx,color,width){ctx.lineWidth=width||1,ctx.strokeStyle=color,ctx.lineCap=Brush.DEFAULT_CAP,ctx.lineJoin=Brush.DEFAULT_JOIN},Brush.clearFill=function(ctx){ctx.fillStyle=Brush.DEFAULT_FILL},Brush.clearStroke=function(ctx){ctx.strokeStyle=Brush.DEFAULT_STROKE,ctx.lineWidth=0,ctx.lineCap=Brush.DEFAULT_CAP,ctx.lineJoin=Brush.DEFAULT_JOIN},Brush.clearShadow=function(ctx){ctx.shadowColor=Brush.DEFAULT_SHADOW,ctx.shadowBlur=0,ctx.shadowOffsetX=0,ctx.shadowOffsetY=0},Brush.interpolateBrushes=function(from,to){var equal=is.equal(from,to);if(from=from instanceof Brush?from:Brush.value(from),from._converted||from.convertColorsToRgba(),equal)return function(){return from};to=to instanceof Brush?to:Brush.value(to),to._converted||to.convertColorsToRgba();var result=from.clone();return function(t){if(is.defined(from.width)&&is.defined(to.width)&&(result.width=utils.interpolateFloat(from.width,to.width,t)),from.type===C.BT_SHADOW&&(result.offsetX=utils.interpolateFloat(from.offsetX,to.offsetX,t),result.offsetY=utils.interpolateFloat(from.offsetY,to.offsetY,t),result.blurRadius=utils.interpolateFloat(from.blurRadius,to.blurRadius,t)),from.color)result.grad=null,result.color=Color.toRgbaStr(Color.interpolate(from.color,to.color,t));else if(from.grad){result.color=null,result.grad||(result.grad={});var i,trgg=result.grad,fromg=from.grad,tog=to.grad;for(i=0;i<fromg.dir.length;i++)trgg.dir[i]||(trgg.dir[i]=[]),trgg.dir[i][0]=utils.interpolateFloat(fromg.dir[i][0],tog.dir[i][0],t),trgg.dir[i][1]=utils.interpolateFloat(fromg.dir[i][1],tog.dir[i][1],t);for(trgg.stops&&trgg.stops.length===fromg.stops.length||(trgg.stops=[]),i=0;i<fromg.stops.length;i++)trgg.stops[i]||(trgg.stops[i]=[]),trgg.stops[i][0]=utils.interpolateFloat(fromg.stops[i][0],tog.stops[i][0],t),trgg.stops[i][1]=Color.toRgbaStr(Color.interpolate(fromg.stops[i][1],tog.stops[i][1],t));fromg.r?(trgg.r||(trgg.r=[]),trgg.r[0]=utils.interpolateFloat(fromg.r[0],tog.r[0],t),trgg.r[1]=utils.interpolateFloat(fromg.r[1],tog.r[1],t)):trgg.r=null}return result.invalidate(),result}},module.exports=Brush},{"../conf.js":8,"../constants.js":9,"../errors.js":10,"../utils.js":33,"./color.js":15,engine:34}],15:[function(require,module){var utils=require("../utils.js"),is=utils.is,Color={};Color.TRANSPARENT="transparent",Color.HEX_RE=/^#?([a-fA-F\d]{2})([a-fA-F\d]{2})([a-fA-F\d]{2})$/i,Color.HEX_SHORT_RE=/^#?([a-fA-F\d])([a-fA-F\d])([a-fA-F\d])$/i,Color.RGB_RE=/^rgb\s*\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)$/i,Color.RGBA_RE=/^rgba\s*\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*(\d*[.]?\d+)\s*\)$/i,Color.HSL_RE=/^hsl\s*\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*%\s*,\s*([0-9]{1,3})\s*%\s*\)$/i,Color.HSLA_RE=/^hsla\s*\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*%\s*,\s*([0-9]{1,3})\s*%\s*,\s*(\d*[.]?\d+)\s*\)$/i,Color.from=function(test){return is.str(test)?Color.fromStr(test):test.r&&test},Color.fromStr=function(str){return Color.fromHex(str)||Color.fromRgb(str)||Color.fromRgba(str)||Color.fromHsl(str)||{r:0,g:0,b:0,a:0}},Color.fromHex=function(hex){if("#"!==hex[0])return null;var result=Color.HEX_RE.exec(hex);return result?{r:parseInt(result[1],16),g:parseInt(result[2],16),b:parseInt(result[3],16),a:1}:(result=Color.HEX_SHORT_RE.exec(hex),result?{r:parseInt(result[1]+result[1],16),g:parseInt(result[2]+result[2],16),b:parseInt(result[3]+result[3],16),a:1}:null)},Color.fromRgb=function(rgb){if(0!==rgb.indexOf("rgb("))return null;var result=Color.RGB_RE.exec(rgb);return result?{r:parseInt(result[1]),g:parseInt(result[2]),b:parseInt(result[3]),a:1}:null},Color.fromRgba=function(rgba){if(0!==rgba.indexOf("rgba("))return null;var result=Color.RGBA_RE.exec(rgba);return result?{r:parseInt(result[1]),g:parseInt(result[2]),b:parseInt(result[3]),a:parseFloat(result[4])}:null},Color.fromHsl=function(hsl){if(0!==hsl.indexOf("hsl("))return null;var result=Color.HSL_RE.exec(hsl);
return result?Color.fromHslVal(parseInt(result[1])/180*Math.PI,parseInt(result[2])/100,parseInt(result[3])/100):null},Color.fromHsla=function(hsla){if(0!==hsla.indexOf("hsla("))return null;var result=Color.HSLA_RE.exec(hsl);return result?(result=Color.fromHslVal(parseInt(result[1])/180*Math.PI,parseInt(result[2])/100,parseInt(result[3])/100),result.a=parseFloat(result[4]),result):null},Color.fromHslVal=function(hue,sat,light){var t2,hueToRgb=Color.hueToRgb;t2=.5>=light?light*(sat+1):light+sat-light*sat;var t1=2*light-t2;return{r:hueToRgb(t1,t2,hue+2),g:hueToRgb(t1,t2,hue),b:hueToRgb(t1,t2,hue-2),a:1}},Color.hueToRgb=function(t1,t2,hue){return 0>hue&&(hue+=6),hue>=6&&(hue-=6),1>hue?(t2-t1)*hue+t1:3>hue?t2:4>hue?(t2-t1)*(4-hue)+t1:t1},Color.rgb=function(r,g,b){return"rgb("+r+","+g+","+b+")"},Color.rgba=function(r,g,b,a){return"rgba("+r+","+g+","+b+","+(is.defined(a)?a.toFixed(2):1)+")"},Color.hsl=function(h,s,l){return Color.dhsl(h/Math.PI*180,s,l)},Color.dhsl=function(dh,s,l){return"hsl("+Math.floor(dh)+","+Math.floor(100*s)+"%,"+Math.floor(100*l)+"%)"},Color.hsla=function(h,s,l,a){return Color.dhsla(h/Math.PI*180,s,l,a)},Color.dhsla=function(dh,s,l,a){return"hsla("+Math.floor(dh)+","+Math.floor(100*s)+"%,"+Math.floor(100*l)+"%,"+(is.defined(a)?a.toFixed(2):1)+")"},Color.adapt=function(color){return color?is.str(color)?color:is.defined(color.g)?Color.toRgbaStr(color):is.defined(color.h)?Color.toHslaStr(color):void 0:null},Color.toRgbaStr=function(color){return Color.rgba(color.r,color.g,color.b,color.a)},Color.toHslaStr=function(color){return Color.hsla(color.h,color.s,color.l,color.a)},Color.interpolate=function(c1,c2,t){return{r:Math.round(utils.interpolateFloat(c1.r,c2.r,t)),g:Math.round(utils.interpolateFloat(c1.g,c2.g,t)),b:Math.round(utils.interpolateFloat(c1.b,c2.b,t)),a:utils.interpolateFloat(c1.a,c2.a,t)}},module.exports=Color},{"../utils.js":33}],16:[function(require,module){function Path(val){this.segs=[],this.closed=!1,is.str(val)?this.parse(val):is.arr(val)&&(this.segs=val),this.cached_hits={}}var utils=(require("../constants.js"),require("../utils.js")),is=utils.is,segments=require("./segments.js"),MSeg=segments.MSeg,LSeg=segments.LSeg,CSeg=segments.CSeg,Brush=require("./brush.js"),Bounds=require("./bounds.js");Path.prototype.visit=function(visitor,data){for(var segments=this.segs,si=0,sl=segments.length;sl>si;si++)visitor(segments[si],data);return this},Path.prototype.length=function(){if(is.defined(this.cached_len))return this.cached_len;var sum=0,p=this.start();return this.visit(function(segment){sum+=segment.length(p),p=segment.last()}),this.cached_len=sum,sum},Path.prototype.add=function(seg){return this.segs.push(seg),this},Path.prototype.move=function(x,y){return this.add(new MSeg([x,y]))},Path.prototype.line=function(x,y){return this.add(new LSeg([x,y]))},Path.prototype.curve=function(x1,y1,x2,y2,x3,y3){return this.add(new CSeg([x1,y1,x2,y2,x3,y3]))},Path.prototype.close=function(){return this.closed=!0,this},Path.prototype.apply=function(ctx,fill,stroke,shadow){ctx.beginPath();for(var segments=this.segs,si=0,sl=segments.length;sl>si;si++)segments[si].draw(ctx);this.closed&&ctx.closePath(),shadow&&shadow.apply(ctx),fill&&(fill.apply(ctx),ctx.fill()),shadow&&Brush.clearShadow(ctx),stroke&&(stroke.apply(ctx),ctx.stroke())},Path.prototype.parse=function(str){return str&&Path.parse(str,this),this},Path.prototype.hitAt=function(t){if(is.defined(this.cached_hits[t]))return this.cached_hits[t];var plen=this.length();if(0===plen)return null;if(0>t||t>1)return null;var startp=this.start();if(0===t)return this.cached_hits[t]={seg:this.segs[0],start:startp,slen:0,segt:0};var nsegs=this.segs.length;if(0===nsegs)return null;for(var seg,slen,distance=t*plen,p=startp,length=0,si=0;nsegs>si;si++){if(seg=this.segs[si],slen=seg.length(p),length+slen>=distance){var segdist=distance-length;return this.cached_hits[t]={seg:seg,start:p,slen:slen,segt:0!=slen?seg.findT(p,segdist):0}}length+=slen,p=seg.last()}return null},Path.prototype.pointAt=function(t){var hit=this.hitAt(t);return hit?hit.seg.atT(hit.start,hit.segt):this.start()},Path.prototype.tangentAt=function(t){var t=t;this.length()>0&&(0==t&&(t=1e-4),1==t&&(t=.9999));var hit=this.hitAt(t);return hit?hit.seg.tangentAt(hit.start,hit.segt):0},Path.prototype.start=function(){return this.segs.length<1?null:[this.segs[0].pts[0],this.segs[0].pts[1]]},Path.prototype.end=function(){return this.segs.length<1?null:this.segs[this.segs.length-1].last()},Path.prototype.bounds=function(){if(this.$bounds)return this.$bounds;if(this.segs.length<=0)return Bounds.NONE;var minX=this.segs[0].pts[0],maxX=this.segs[0].pts[0],minY=this.segs[0].pts[1],maxY=this.segs[0].pts[1];return this.visit(function(segment){var pi,pts=segment.pts,pnum=pts.length;for(pi=0;pnum>pi;pi+=2)minX=Math.min(minX,pts[pi]),maxX=Math.max(maxX,pts[pi]);for(pi=1;pnum>pi;pi+=2)minY=Math.min(minY,pts[pi]),maxY=Math.max(maxY,pts[pi])}),this.$bounds=new Bounds(minX,minY,maxX-minX,maxY-minY)},Path.prototype.vpoints=function(func){this.visit(function(segment){for(var pts=segment.pts,pnum=pts.length,pi=0;pnum>pi;pi+=2){var res=func(pts[pi],pts[pi+1]);res&&(pts[pi]=res[0],pts[pi+1]=res[1])}})},Path.prototype.shift=function(pt){return this.vpoints(function(x,y){return[x+pt[0],y+pt[1]]}),this},Path.prototype.zoom=function(vals){return this.vpoints(function(x,y){return[x*vals[0],y*vals[1]]}),this},Path.prototype.normalize=function(){var bounds=this.bounds(),w=bounds.width,h=bounds.height,hw=Math.floor(w/2),hh=Math.floor(h/2),min_x=bounds.x,min_y=bounds.y;return this.vpoints(function(x,y){return[x-min_x-hw,y-min_y-hh]}),[hw,hh]},Path.prototype.getPoints=function(){var points=[];return this.visit(function(seg){points=points.concat(seg.pts)}),points},Path.prototype.toString=function(){return"[ Path '"+Path.toSVGString(this)+"' ]"},Path.prototype.clone=function(){var _clone=new Path;return this.visit(function(seg){_clone.add(seg.clone())}),clone.closed=this.closed,_clone},Path.prototype.invalidate=function(){this.cached_len=void 0,this.cached_hits={},this.$bounds=null},Path.prototype.reset=function(){this.segs=[],this.closed=!1},Path.prototype.dispose=function(){},Path.visitStrPath=function(path,visitor,data){for(var cur_pos=0;;){var marker=path[cur_pos];if("Z"===marker)return void visitor(marker,[],data);var pos_data=null;"M"===marker||"L"===marker?pos_data=collectPositions(path,cur_pos,2):"C"===marker&&(pos_data=collectPositions(path,cur_pos,6)),cur_pos+=pos_data[0];var positions=pos_data[1];visitor(marker,positions,data)}},Path.toSVGString=function(path){var buffer=[];return path.visit(encodeVisitor,buffer),buffer.push("Z"),buffer.join(" ")};var collectPositions=function(path,start,count){for(var pos=start+1,positions=[],got=0;got!=count;){var posstr=utils.collect_to(path,pos," ");pos+=posstr.length+1,got++,positions.push(parseFloat(posstr))}return[pos-start,positions]},parserVisitor=function(marker,positions,path){"M"===marker?path.add(new MSeg(positions)):"L"===marker?path.add(new LSeg(positions)):"C"===marker&&path.add(new CSeg(positions))},strApplyVisitor=function(marker,positions,ctx){"M"===marker?ctx.moveTo(positions[0],positions[1]):"L"===marker?ctx.lineTo(positions[0],positions[1]):"C"===marker&&ctx.bezierCurveTo(positions[0],positions[1],positions[2],positions[3],positions[4],positions[5])},encodeVisitor=function(segment,buffer){buffer.push(segment.toString())};Path.parse=function(path,target){return target=target||new Path,target.segs=[],Path.visitStrPath(path,parserVisitor,target),target.str=path,target},Path.parseAndApply=function(ctx,path){Path.visitStrPath(path,strApplyVisitor,ctx)},module.exports=Path},{"../constants.js":9,"../utils.js":33,"./bounds.js":13,"./brush.js":14,"./segments.js":17}],17:[function(require,module){function MSeg(pts){this.pts=pts}function LSeg(pts){this.pts=pts}function CSeg(pts){this.pts=pts}require("../constants.js");MSeg.prototype.draw=function(ctx){ctx.moveTo(this.pts[0],this.pts[1])},MSeg.prototype.length=function(){return 0},MSeg.prototype.findT=function(){return 0},MSeg.prototype.atDist=function(start){return this.atT(start,null)},MSeg.prototype.atT=function(){return[this.pts[0],this.pts[1]]},MSeg.prototype.tangentAt=function(){return 0},MSeg.prototype.last=function(){return[this.pts[0],this.pts[1]]},MSeg.prototype.toString=function(){return"M"+this.pts.join(" ")},MSeg.prototype.clone=function(){return new MSeg(this.pts)},LSeg.prototype.draw=function(ctx){ctx.lineTo(this.pts[0],this.pts[1])},LSeg.prototype.length=function(start){var dx=this.pts[0]-start[0],dy=this.pts[1]-start[1];return Math.sqrt(dx*dx+dy*dy)},LSeg.prototype.findT=function(start,dist){if(0>=dist)return 0;var length=this.length(start);return dist>=length?1:dist/length},LSeg.prototype.atDist=function(start,dist){return this.atT(start,this.findT(start,dist))},LSeg.prototype.atT=function(start,t){var p0x=start[0],p0y=start[1],p1x=this.pts[0],p1y=this.pts[1];return[p0x+(p1x-p0x)*t,p0y+(p1y-p0y)*t]},LSeg.prototype.tangentAt=function(start){return Math.atan2(this.pts[1]-start[1],this.pts[0]-start[0])},LSeg.prototype.last=function(){return[this.pts[0],this.pts[1]]},LSeg.prototype.toString=function(){return"L"+this.pts.join(" ")},LSeg.prototype.clone=function(){return new LSeg(this.pts)},CSeg.prototype.draw=function(ctx){ctx.bezierCurveTo(this.pts[0],this.pts[1],this.pts[2],this.pts[3],this.pts[4],this.pts[5])},CSeg.prototype.length=function(start){return this.findLengthAndT(start,Number.MAX_VALUE)[0]},CSeg.prototype.findT=function(start,dist){return this.findLengthAndT(start,dist)[1]},CSeg.prototype.findLengthAndT=function(start,dist){for(var positions=this.pts,p0x=start[0],p0y=start[1],p1x=positions[0],p1y=positions[1],p2x=positions[2],p2y=positions[3],p3x=positions[4],p3y=positions[5],p0to1=Math.sqrt(Math.pow(p1x-p0x,2)+Math.pow(p1y-p0y,2)),p1to2=Math.sqrt(Math.pow(p2x-p1x,2)+Math.pow(p2y-p1y,2)),p2to3=Math.sqrt(Math.pow(p3x-p2x,2)+Math.pow(p3y-p2y,2)),len=p0to1+p1to2+p2to3+1,dt=1/len,q1=3*dt,q2=q1*dt,q3=dt*dt*dt,q4=2*q2,q5=6*q3,q6x=p0x-2*p1x+p2x,q6y=p0y-2*p1y+p2y,q7x=3*(p1x-p2x)-p0x+p3x,q7y=3*(p1y-p2y)-p0y+p3y,bx=p0x,by=p0y,dbx=(p1x-p0x)*q1+q6x*q2+q3*q7x,dby=(p1y-p0y)*q1+q6y*q2+q3*q7y,ddbx=q6x*q4+q7x*q5,ddby=q6y*q4+q7y*q5,dddbx=q7x*q5,dddby=q7y*q5,length=0,idx=0;len>idx;idx++){var px=bx,py=by;if(bx+=dbx,by+=dby,dbx+=ddbx,dby+=ddby,ddbx+=dddbx,ddby+=dddby,length+=Math.sqrt((bx-px)*(bx-px)+(by-py)*(by-py)),length>=dist)return[length,dt*idx]}return[length,1]},CSeg.prototype.atDist=function(start,dist){return this.atT(start,this.findT(start,dist))},CSeg.prototype.atT=function(start,t){var tt=t*t,ttt=tt*t,t1=1-t,tt1=t1*t1,tt2=tt1*t1,tt3=3*t*tt1,tt4=3*tt*t1;return[start[0]*tt2+this.pts[0]*tt3+this.pts[2]*tt4+this.pts[4]*ttt,start[1]*tt2+this.pts[1]*tt3+this.pts[3]*tt4+this.pts[5]*ttt]},CSeg.prototype.tangentAt=function(start,t){0>t&&(t=0),t>1&&(t=1);var a=3*(1-t)*(1-t),b=6*(1-t)*t,c=3*t*t;return Math.atan2(a*(this.pts[1]-start[1])+b*(this.pts[3]-this.pts[1])+c*(this.pts[5]-this.pts[3]),a*(this.pts[0]-start[0])+b*(this.pts[2]-this.pts[0])+c*(this.pts[4]-this.pts[2]))},CSeg.prototype.last=function(){return[this.pts[4],this.pts[5]]},CSeg.prototype._ensure_params=function(start){this._lstart&&this._lstart[0]===start[0]&&this._lstart[1]===start[1]||(this._lstart=start,this._params=this._calc_params(start))},CSeg.prototype._calc_params=function(start){var pts=this.pts,params=[],p0x=start[0],p0y=start[1],p1x=pts[0],p1y=pts[1],p2x=pts[2],p2y=pts[3],p3x=pts[4],p3y=pts[5];return params[0]=p3x-3*p2x+3*p1x-p0x,params[1]=3*p2x-6*p1x+3*p0x,params[2]=3*p1x-3*p0x,params[3]=p0x,params[4]=p3y-3*p2y+3*p1y-p0y,params[5]=3*p2y-6*p1y+3*p0y,params[6]=3*p1y-3*p0y,params[7]=p0y,params},CSeg.prototype.clone=function(){return new CSeg(this.pts)},CSeg.prototype.toString=function(){return"C"+this.pts.join(" ")},module.exports={MSeg:MSeg,LSeg:LSeg,CSeg:CSeg}},{"../constants.js":9}],18:[function(require,module){function Sheet(src,callback,start_region){this.id=Sheet.instances++,this.src=src,this._dimen=[0,0],this.regions=[[0,0,1,1]],this.regions_f=null,this.cur_region=start_region||0,this.ready=!1,this.wasError=!1,this._image=null,this._callback=callback,this._thumbnail=!1}var conf=require("../conf.js"),log=require("../log.js"),engine=require("engine"),resMan=require("../resource_manager.js"),Bounds=require("./bounds.js");Sheet.instances=0,Sheet.MISSED_SIDE=50;var https=engine.isHttps;Sheet.prototype.load=function(player_id,callback,errback){if(callback=callback||this._callback,this._image)throw new Error("Already loaded");var me=this;return me.src?void resMan.loadOrGet(player_id,me.src,function(notify_success,notify_error){var src=me.src;if(https&&(src=src.replace("http:","https:")),!me._thumbnail&&conf.doNotLoadImages)return void notify_error("Loading images is turned off");var img=new Image,props=engine.getAnmProps(img);img.onload=img.onreadystatechange=function(){props.ready||(this.readyState&&"complete"!==this.readyState&&notify_error(this.readyState),props.ready=!0,img.isReady=!0,notify_success(img))},img.onerror=notify_error,img.addEventListener("error",notify_error,!1);try{img.src=src}catch(e){notify_error(e)}},function(image){me._image=image,me._dimen=[image.width,image.height],me.ready=!0,callback&&callback.call(me,image)},function(err){log.error(err.srcElement||err.path,err.message||err),me.ready=!0,me.wasError=!0,errback&&errback.call(me,err)}):($log.error("Empty source URL for image"),me.ready=!0,me.wasError=!0,void(errback&&errback.call(me,"Empty source")))},Sheet.prototype.updateRegion=function(){if(!(this.cur_region<0)){var region;if(this.region_f)region=this.region_f(this.cur_region);else{var r=this.regions[this.cur_region],d=this._dimen;region=[r[0]*d[0],r[1]*d[1],r[2]*d[0],r[3]*d[1]]}this.region=region}},Sheet.prototype.apply=function(ctx){if(this.ready){if(this.wasError)return void this.applyMissed(ctx);this.updateRegion();var region=this.region;ctx.drawImage(this._image,region[0],region[1],region[2],region[3],0,0,region[2],region[3])}},Sheet.prototype.applyMissed=function(ctx){ctx.save(),ctx.strokeStyle="#900",ctx.lineWidth=1,ctx.beginPath();var side=Sheet.MISSED_SIDE;ctx.moveTo(0,0),ctx.lineTo(side,0),ctx.lineTo(0,side),ctx.lineTo(side,side),ctx.lineTo(0,0),ctx.lineTo(0,side),ctx.lineTo(side,0),ctx.lineTo(side,side),ctx.stroke(),ctx.restore()},Sheet.MISSED_BOUNDS=new Bounds(0,0,Sheet.MISSED_SIDE,Sheet.MISSED_SIDE),Sheet.prototype.bounds=function(){if(this.wasError)return Sheet.MISSED_BOUNDS;if(!this.ready)return Bounds.NONE;this.region||this.updateRegion();var r=this.region;return new Bounds(0,0,r[2],r[3])},Sheet.prototype.clone=function(){return new Sheet(this.src)},Sheet.prototype.invalidate=function(){},Sheet.prototype.reset=function(){},Sheet.prototype.dispose=function(){},module.exports=Sheet},{"../conf.js":8,"../log.js":23,"../resource_manager.js":29,"./bounds.js":13,engine:34}],19:[function(require,module){function Text(lines,font,align,baseline,underlined){this.lines=lines,this.$font=font||Text.DEFAULT_FONT,this.$align=align||Text.DEFAULT_ALIGN,this.baseline=baseline||Text.DEFAULT_BASELINE,this.underlined=is.defined(underlined)?underlined:Text.DEFAULT_UNDERLINE,this.size=-1,this.$bounds=null}var C=require("../constants.js"),is=require("../utils.js").is,engine=(require("../errors.js").SystemError,require("engine")),Brush=require("./brush.js"),Bounds=require("./bounds.js");Text.DEFAULT_FFACE="sans-serif",Text.DEFAULT_FSIZE=24,Text.DEFAULT_FONT=Text.DEFAULT_FSIZE+"px "+Text.DEFAULT_FFACE,Text.DEFAULT_ALIGN=C.TA_LEFT,Text.DEFAULT_BASELINE=C.BL_MIDDLE,Text.DEFAULT_UNDERLINE=!1,Text.__measuring_f=engine.createTextMeasurer(),Text.prototype.apply=function(ctx,fill,stroke,shadow){var bounds=this.bounds(),height=bounds.height/this.lineCount(),underlined=this.underlined;ctx.font=this.$font,ctx.textBaseline=this.baseline||Text.DEFAULT_BASELINE,ctx.textAlign=this.$align||Text.DEFAULT_ALIGN;var y,ascent=this.ascent(height,ctx.textBaseline),x=this.xOffset(bounds.width,ctx.textAlign);if(shadow?shadow.apply(ctx):Brush.clearShadow(ctx),fill?(fill.apply(ctx),y=0,this.visitLines(function(line){ctx.fillText(line,x,y+ascent),y+=height})):Brush.clearFill(ctx),shadow&&Brush.clearShadow(ctx),stroke?(stroke.apply(ctx),y=0,this.visitLines(function(line){ctx.strokeText(line,x,y+ascent),y+=height})):Brush.clearStroke(ctx),underlined&&fill){y=0,Brush.stroke(ctx,fill),ctx.lineWidth=1;var line_bounds=null,line_width=0,me=this;this.visitLines(function(line){line_bounds=Text.bounds(me,line),line_width=line_bounds.width,ctx.beginPath(),ctx.moveTo(x,y+height),ctx.lineTo(line_width,y+height),ctx.stroke(),y+=height})}},Text.prototype.font=function(value){return value?(this.$font=value,this):this.$font},Text.prototype.align=function(value){return value?(this.$align=value,this):this.$align},Text.prototype.bounds=function(){if(this.$bounds)return this.$bounds;var bounds=Text.bounds(this,this.lines);return this.$bounds=bounds},Text.prototype.ascent=function(height,baseline){return baseline==C.BL_MIDDLE?height/2:height},Text.prototype.xOffset=function(width,align){return align==C.TA_LEFT?0:align==C.TA_CENTER?width/2:align==C.TA_RIGHT?width:0},Text.prototype.lineCount=function(){var lines=this.lines;return is.arr(lines)?lines.length:1},Text.prototype.visitLines=function(func){var lines=this.lines;if(is.arr(lines))for(var line,i=0,ilen=lines.length;ilen>i;i++)line=lines[i],func(line);else func(lines.toString())},Text.prototype.clone=function(){var c=new Text(this.lines,this.$font);return this.lines&&Array.isArray(this.lines)&&(c.lines=[].concat(this.lines)),c},Text.prototype.invalidate=function(){this.$bounds=null},Text.prototype.reset=function(){},Text.prototype.dispose=function(){},Text.bounds=function(spec,lines){if(!Text.__measuring_f)throw new SysErr("no Text buffer, bounds call failed");var dimen=Text.__measuring_f(spec,lines);return new Bounds(0,0,dimen[0],dimen[1])},module.exports=Text},{"../constants.js":9,"../errors.js":10,"../utils.js":33,"./bounds.js":13,"./brush.js":14,engine:34}],20:[function(require,module){var importers={};importers.register=function(alias,conf){if(importers[alias])throw new Error("Importer "+alias+" is already registered!");importers[alias]=conf},importers.get=function(alias){return importers[alias]},importers.create=function(alias){return new importers[alias]},importers.isAccessible=function(alias){return"undefined"!=typeof importers[alias]},module.exports=importers},{}],21:[function(require,module){var utils=require("./utils.js"),is=utils.is,loc=require("./loc.js"),Errors=loc.Errors,errors=require("./errors.js"),SystemError=errors.SystemError,PlayerError=errors.PlayerError,C=require("./constants.js"),global_opts=require("./global_opts.js"),engine=require("engine"),Animation=require("./animation/animation.js"),Loader={};Loader.loadFromUrl=function(player,url,importer,callback){if(!JSON)throw new SystemError(Errors.S.NO_JSON_PARSER);mporter=importer||anm.importers.create("animatron");var url_with_params=url.split("?");url=url_with_params[0];var url_params=url_with_params[1],params=url_params&&url_params.length>0?utils.paramsToObj(url_params):{},options=optsFromUrlParams(params);options&&(player._addOpts(options),player._checkOpts());var failure=player.__defAsyncSafe(function(err){throw new SystemError(utils.strf(Errors.P.SNAPSHOT_LOADING_FAILED,[err?err.message||err:"¿Por qué?"]))}),success=function(req){try{Loader.loadFromObj(player,JSON.parse(req.responseText),importer,function(anim){player._applyUrlParamsToAnimation(params),callback&&callback.call(player,anim)})}catch(e){failure(e)}},anm_cookie=engine.getCookie("_animatronauth");engine.ajax(url,success,failure,"GET",anm_cookie?{"Animatron-Security-Token":anm_cookie}:null)},Loader.loadFromObj=function(player,object,importer,callback){if(!importer)throw new PlayerError(Errors.P.NO_IMPORTER_TO_LOAD_WITH);var anim=importer.load(object);player.fire(C.S_IMPORT,importer,anim,object),Loader.loadAnimation(player,anim,callback)},Loader.loadAnimation=function(player,anim,callback){player.anim&&player.anim.dispose(),player.debug&&!global_opts.liveDebug&&anim.visitElems(function(e){e.addDebugRender()}),anim.width&&anim.height?player.forceAnimationSize&&player._resize(anim.width,anim.height):(anim.width=player.width,anim.height=player.height),player.anim=anim,callback&&callback.call(player,anim)},Loader.loadElements=function(player,elms,callback){var anim=new Animation;anim.add(elms),Loader.loadAnimation(player,anim,callback)};var optsFromUrlParams=function(params){function __boolParam(val){return val?0===val?!1:1==val?!0:"false"==val?!1:"true"==val?!0:"off"==val?!1:"on"==val?!0:"no"==val?!1:"yes"==val?!0:void 0:!1}function __extractBool(){for(var variants=arguments,i=0;i<variants.length;i++)if(is.defined(params[variants[i]]))return __boolParam(params[variants[i]]);return void 0}var opts={};return opts.debug=is.defined(params.debug)?__boolParam(params.debug):void 0,opts.muteErrors=__extractBool("me","muterrors"),opts.repeat=__extractBool("r","repeat"),opts.autoPlay=__extractBool("a","auto","autoplay"),opts.mode=params.m||params.mode||void 0,opts.zoom=params.z||params.zoom,opts.speed=params.v||params.speed,opts.width=params.w||params.width,opts.height=params.h||params.height,opts.infiniteDuration=__extractBool("i","inf","infinite"),opts.audioEnabled=__extractBool("s","snd","sound","audio"),opts.controlsEnabled=__extractBool("c","controls"),opts.infoEnabled=__extractBool("info"),opts.loadingMode=params.lm||params.lmode||params.loadingmode||void 0,opts.thumbnail=params.th||params.thumb||void 0,opts.bgColor=params.bg||params.bgcolor,opts.ribbonsColor=params.ribbons||params.ribcolor,opts};module.exports=Loader},{"./animation/animation.js":1,"./constants.js":9,"./errors.js":10,"./global_opts.js":12,"./loc.js":22,"./utils.js":33,engine:34}],22:[function(require,module){var Strings={};Strings.COPYRIGHT="Animatron Player",Strings.LOADING="Loading...",Strings.LOADING_ANIMATION="Loading {0}...";var Errors={};Errors.S={},Errors.P={},Errors.A={},Errors.S.CANVAS_NOT_SUPPORTED="Your browser does not support HTML5 canvas, so we cannot play anything for you.",Errors.S.SAD_SMILEY_HTML='<span style="font-size: 4em;">:(</span><br>'+Errors.S.CANVAS_NOT_SUPPORTED,Errors.S.NO_JSON_PARSER="JSON parser is not accessible",Errors.S.ERROR_HANDLING_FAILED="Error-handling mechanics were broken with error {0}",Errors.S.NO_METHOD_FOR_PLAYER="No method '{0}' exist for player",Errors.P.NO_IMPORTER_TO_LOAD_WITH="Cannot load this project without importer. Please define it",Errors.P.NO_WRAPPER_WITH_ID="No element found with given id: {0}",Errors.P.NO_WRAPPER_WAS_PASSED="No element was passed to player initializer",Errors.P.CANVAS_NOT_VERIFIED="Canvas is not verified by the provider",Errors.P.CANVAS_NOT_PREPARED="Canvas is not prepared, don't forget to call 'init' method",Errors.P.ALREADY_PLAYING="Player is already in playing mode, please call 'stop' or 'pause' before playing again",Errors.P.PAUSING_WHEN_STOPPED="Player is stopped, so it is not allowed to pause",Errors.P.NO_ANIMATION_PASSED="No animation passed to load method",Errors.P.NO_STATE="There's no player state defined, nowhere to draw, please load something in player before calling its playing-related methods",Errors.P.NO_ANIMATION="There's nothing at all to manage with, please load something in player before calling its playing-related methods",Errors.P.COULD_NOT_LOAD_WHILE_PLAYING="Could not load any animation while playing or paused, please stop player before loading",Errors.P.LOAD_WAS_ALREADY_POSTPONED="Load was called while loading process was already in progress",Errors.P.NO_LOAD_CALL_BEFORE_PLAY="No animation was loaded into player before the request to play",Errors.P.BEFOREFRAME_BEFORE_PLAY="Please assign beforeFrame callback before calling play()",Errors.P.AFTERFRAME_BEFORE_PLAY="Please assign afterFrame callback before calling play()",Errors.P.BEFORERENDER_BEFORE_PLAY="Please assign beforeRender callback before calling play()",Errors.P.AFTERRENDER_BEFORE_PLAY="Please assign afterRender callback before calling play()",Errors.P.PASSED_TIME_VALUE_IS_NO_TIME="Given time is not allowed, it is treated as no-time",Errors.P.PASSED_TIME_NOT_IN_RANGE="Passed time ({0}) is not in animation range",Errors.P.DURATION_IS_NOT_KNOWN="Duration is not known",Errors.P.ALREADY_ATTACHED="Player is already attached to this canvas, please use another one",Errors.P.INIT_TWICE="Initialization was called twice",Errors.P.INIT_AFTER_LOAD="Initialization was called after loading a animation",Errors.P.SNAPSHOT_LOADING_FAILED="Snapshot failed to load ({0})",Errors.P.IMPORTER_CONSTRUCTOR_PASSED="You've passed importer constructor to snapshot loader, but not an instance! Probably you used anm.importers.get instead of anm.importers.create.",Errors.A.ELEMENT_IS_REGISTERED="This element is already registered in animation",Errors.A.ELEMENT_IS_NOT_REGISTERED="There is no such element registered in animation",Errors.A.UNSAFE_TO_REMOVE="Unsafe to remove, please use iterator-based looping (with returning false from iterating function) to remove safely",Errors.A.NO_ELEMENT_TO_REMOVE="Please pass some element or use detach() method",Errors.A.NO_ELEMENT="No such element found",Errors.A.ELEMENT_NOT_ATTACHED="Element is not attached to something at all",Errors.A.MODIFIER_NOT_ATTACHED="Modifier wasn't applied to anything",Errors.A.NO_MODIFIER_PASSED="No modifier was passed",Errors.A.NO_PAINTER_PASSED="No painter was passed",Errors.A.MODIFIER_REGISTERED="Modifier was already added to this element",Errors.A.PAINTER_REGISTERED="Painter was already added to this element",Errors.A.RESOURCES_FAILED_TO_LOAD="Some of resources required to play this animation were failed to load",Errors.A.MASK_SHOULD_BE_ATTACHED_TO_ANIMATION="Element to be masked should be attached to animation when rendering",module.exports={Strings:Strings,Errors:Errors}},{}],23:[function(require,module){(function(global){var anmConsole,conf=require("./conf.js"),C=require("./constants.js"),nop=function(){},c=global.console||{log:nop,info:nop,warn:nop,error:nop};global.console&&(anmConsole={log:c.debug||c.log,info:c.info||c.log,warn:c.warn||c.log,error:c.error||c.log},c.log.apply||(anmConsole.log=Function.prototype.bind.call(anmConsole.log,c),anmConsole.info=Function.prototype.bind.call(anmConsole.info,c),anmConsole.warn=Function.prototype.bind.call(anmConsole.warn,c),anmConsole.error=Function.prototype.bind.call(anmConsole.log,c)));var log={debug:function(){conf.logLevel&C.L_DEBUG&&anmConsole.log.apply(c,arguments)},info:function(){conf.logLevel&C.L_INFO&&anmConsole.info.apply(c,arguments)},warn:function(){conf.logLevel&C.L_WARN&&anmConsole.warn.apply(c,arguments)},error:function(){conf.logLevel&C.L_ERROR&&anmConsole.error.apply(c,arguments)}};module.exports=log}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./conf.js":8,"./constants.js":9}],24:[function(require,module){(function(global){function syncStream(node){var buf8=new Uint8Array(node.buf);buf8.indexOf=Array.prototype.indexOf;for(var i=node.sync,b=buf8;;){if(node.retry++,i=b.indexOf(255,i),-1==i||b[i+1]&!0)break;i++}if(-1!=i){var tmp=node.buf.slice(i);return delete node.buf,node.buf=null,node.buf=tmp,node.sync=i,!0}return!1}function audioErrProxy(src,pass_to){return function(err){pass_to(new Error("Failed to load audio file from "+src+" with error code: "+err.currentTarget.error.code))}}function getAudioContext(){if(engine.isLocal)return null;var AudioContext=global.AudioContext||global.webkitAudioContext;if(!AudioContext)return null;if(global.anmAudioContext)return global.anmAudioContext;try{var ctx=new AudioContext;return global.anmAudioContext=ctx}catch(e){return null}}function Audio(url){this.url=url+audioExt,this.loaded=!1,this.playing=!1,this.canPlay=!1,this.volume=1,this.audio=null}var C=require("../constants.js"),engine=require("engine"),ResMan=require("../resource_manager.js"),log=(require("../conf.js"),require("../log.js")),testAudio=engine.createAudio(),oggSupported=!(!testAudio.canPlayType||!testAudio.canPlayType("audio/ogg;").replace(/no/,"")),audioExt=oggSupported?".ogg":".mp3",audioType=oggSupported?"audio/ogg":"audio/mp3",audioContext=getAudioContext();Audio.prototype.load=function(player){var me=this;ResMan.loadOrGet(player.id,me.url,function(notify_success,notify_error){var url=me.url;if(engine.isHttps&&(url=url.replace("http:","https:")),anm.conf.doNotLoadAudio)return void notify_error("Loading audio is turned off");if(audioContext){var node={},decode=function(node,url){try{audioContext.decodeAudioData(node.buf,function(decodedBuffer){notify_success(decodedBuffer)},function(){syncStream(node)&&decode(node,url)})}catch(e){notify_error("Unable to load audio "+url+": "+e.message)}},loadingDone=function(e){var req=e.target;200==req.status?(node.buf=req.response,node.sync=0,node.retry=0,decode(node)):notify_error("Unable to load audio "+url+": "+req.statusText)};node.xhr=new XMLHttpRequest,node.xhr.open("GET",url,!0),node.xhr.responseType="arraybuffer",node.xhr.addEventListener("load",loadingDone,!1),node.xhr.addEventListener("error",audioErrProxy(url,notify_error),!1),node.xhr.send()}else{var el=engine.createAudio();el.setAttribute("preload","auto");var progressListener=function(){var buffered=el.buffered;if(1==buffered.length){if(4===el.readyState)return el.removeEventListener("progress",progressListener,!1),el.removeEventListener("canplay",canPlayListener,!1),void notify_success(el);me.canPlay&&window.chrome&&(el.volume=0,el.currentTime=end,el.play(),el.pause())}else me.canPlay&&1!=buffered.length&&notify_success(el)},canPlayListener=function(e){me.canPlay=!0,progressListener(e)};el.addEventListener("progress",progressListener,!1),el.addEventListener("canplay",canPlayListener,!1),el.addEventListener("error",audioErrProxy(url,notify_error),!1);var addSource=function(audio,url,type){var src=engine.createSource();src.type=type,src.src=url,src.addEventListener("error",notify_error,!1),audio.appendChild(src)};try{engine.appendToBody(el),addSource(el,url,audioType)}catch(e){notify_error(e)}}},function(audio){me.audio=audio,me.loaded=!0,player.muted&&me.mute()},function(err){log.error(err?err.message||err:"Unknown error")})},Audio.prototype.play=function(ltime){if(!this.loaded||this.playing)return!1;this.playing=!0;var current_time=this.offset+ltime;if(audioContext){if(current_time>this.audio.duration)return void(this._audio_is_playing=!1);this._source=audioContext.createBufferSource(),this._source.buffer=this.audio,this._gain=audioContext.createGain(),this._source.connect(this._gain),this._gain.connect(audioContext.destination),this._gain.gain.value=this.volume,this._source.play?this._source.play(0,current_time):this._source.start?this._source.start(0,current_time,this._source.buffer.duration-current_time):this._source.noteGrainOn(0,current_time,this._source.buffer.duration-current_time)}else this.audio.currentTime=current_time,this.audio.volume=this.volume,this.audio.play()},Audio.prototype.stop=function(){if(this.playing){try{audioContext?(this._source.stop?this._source.stop(0):this._source.noteOff(0),this._source=null):(this.audio.pause(),this.audio.volume=0)}catch(err){}this.playing=!1}},Audio.prototype.stopIfNotMaster=function(){this.master||this.stop()},Audio.prototype.setVolume=function(volume){return this.muted?void(this.unmuteVolume=volume):(this.volume=volume,this._gain?this._gain.gain.value=volume:this.audio&&(this.audio.volume=volume),this)},Audio.prototype.mute=function(){this.muted||(this.unmuteVolume=this.volume,this.setVolume(0),this.muted=!0)},Audio.prototype.unmute=function(){this.muted&&(this.muted=!1,this.setVolume(this.unmuteVolume))},Audio.prototype.toggleMute=function(){this.muted?this.unmute():this.mute()},Audio.prototype.connect=function(element){var me=this;element.on(C.X_START,function(){me.play.apply(me,arguments)}),element.on(C.X_STOP,function(){me.stopIfNotMaster()});var stop=function(){me.stop()};element.on(C.S_STOP,stop),element.on(C.S_PAUSE,stop)
},module.exports=Audio}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../conf.js":8,"../constants.js":9,"../log.js":23,"../resource_manager.js":29,engine:34}],25:[function(require,module){var modules={};modules.register=function(alias,conf){if(modules[alias])throw new Error("Module "+alias+" is already registered!");modules[alias]=conf},modules.get=function(alias){return modules[alias]},modules.isAccessible=function(alias){return"undefined"!=typeof modules[alias]},module.exports=modules},{}],26:[function(require,module){function Player(){this.id="",this.state=null,this.anim=null,this.canvas=null,this.ctx=null,this.controls=null,this.__canvasPrepared=!1,this.__instanceNum=++Player.__instances,this.__makeSafe(Player._SAFE_METHODS),this.muted=!1}var C=require("./constants.js"),utils=require("./utils.js"),is=utils.is,global_opts=require("./global_opts.js"),log=(require("./conf.js"),require("./log.js")),events=require("./events.js"),provideEvents=events.provideEvents,loc=require("./loc.js"),Strings=loc.Strings,Errors=loc.Errors,errors=require("./errors.js"),PlayerError=errors.PlayerError,SystemError=errors.SystemError,engine=require("engine"),resourceManager=require("./resource_manager.js"),playerManager=require("./player_manager.js"),Loader=require("./loader.js"),Controls=require("./ui/controls.js"),Animation=require("./animation/animation.js"),Element=require("./animation/element.js"),Render=require("./render.js"),Sheet=require("./graphics/sheet.js");Player.__instances=0,Player.PREVIEW_POS=0,Player.PEFF=0,Player.NO_TIME=-1,Player.DEFAULT_CONFIGURATION={debug:!1,repeat:!1,autoPlay:!1,mode:C.M_VIDEO,zoom:1,speed:1,width:void 0,height:void 0,infiniteDuration:void 0,drawStill:void 0,audioEnabled:!0,audioGlobalVolume:1,imagesEnabled:!0,shadowsEnabled:!0,handleEvents:void 0,controlsEnabled:void 0,infoEnabled:void 0,loadingMode:C.LM_DEFAULT,thumbnail:void 0,bgColor:void 0,ribbonsColor:void 0,forceAnimationSize:!1,muteErrors:!1},Player.EMPTY_BG="rgba(0,0,0,.05)",Player.EMPTY_STROKE="rgba(50,158,192,.5)",Player.EMPTY_STROKE_WIDTH=3,Player._SAFE_METHODS=["init","load","play","stop","pause","drawAt"],Player.prototype.init=function(elm,opts){if(this.canvas||this.wrapper)throw new PlayerError(Errors.P.INIT_TWICE);if(this.anim)throw new PlayerError(Errors.P.INIT_AFTER_LOAD);this._initHandlers(),this._prepare(elm),this._addOpts(Player.DEFAULT_CONFIGURATION),this._addOpts(engine.extractUserOptions(this.canvas)),this._addOpts(engine.extractUserOptions(this.wrapper));try{window&&window.frameElement&&this._addOpts(engine.extractUserOptions(window.frameElement))}catch(e){}return this._addOpts(opts||{}),this._postInit(),this._checkOpts(),playerManager.fire(C.S_NEW_PLAYER,this),this},Player.prototype.load=function(arg1,arg2,arg3,arg4){var player=this,state=player.state;if(state.happens===C.PLAYING||state.happens===C.PAUSED)throw new PlayerError(Errors.P.COULD_NOT_LOAD_WHILE_PLAYING);var duration,importer,callback,object=arg1;if(object&&object.id&&player.anim&&player.anim.id==object.id)return void log.info("Animation with ID="+object.id+" is already loaded in player, skipping the call");var durationPassed=!1;if(arg2&&arg2.IMPORTER_ID||arg3&&arg3.IMPORTER_ID)throw new PlayerError(Errors.P.IMPORTER_CONSTRUCTOR_PASSED);if(is.fun(arg2)?callback=arg2:is.num(arg2)||!arg2?(is.num(arg2)&&(duration=arg2,durationPassed=!0),is.obj(arg3)?(importer=arg3,callback=arg4):is.fun(arg3)&&(callback=arg3)):is.obj(arg2)&&(importer=arg2,callback=arg3),player.loadingMode==C.LM_ONPLAY&&!player._playLock){if(player._postponedLoad)throw new PlayerError(Errors.P.LOAD_WAS_ALREADY_POSTPONED);return player._lastReceivedAnimationId=null,player._postponedLoad=[object,duration,importer,callback],void player.stop()}if(!object)throw player.anim=null,player._reset(),player.stop(),new PlayerError(Errors.P.NO_ANIMATION_PASSED);if(!player.__canvasPrepared)throw new PlayerError(Errors.P.CANVAS_NOT_PREPARED);player._reset(),state.happens=C.LOADING,player.fire(C.S_CHANGE_STATE,C.LOADING);var whenDone=function(result){var anim=player.anim;player.handleEvents&&player.__subscribeDynamicEvents(anim);var remotes=anim._collectRemoteResources(player);remotes.length?(state.happens=C.RES_LOADING,player.fire(C.S_CHANGE_STATE,C.RES_LOADING),player.fire(C.S_RES_LOAD,remotes),anim._loadRemoteResources(player),resourceManager.subscribe(player.id,remotes,[player.__defAsyncSafe(function(){player.anim===result&&(player.state.happens=C.LOADING,player.fire(C.S_CHANGE_STATE,C.LOADING),player.fire(C.S_LOAD,result),player.handleEvents||player.stop(),player._callPostpones(),callback&&callback.call(player,result),player.autoPlay&&(player.state.happens===C.PLAYING&&player.stop(),player.play()))})])):(player.fire(C.S_LOAD,result),player.handleEvents||player.stop(),callback&&callback.call(player,result),player.autoPlay&&(player.state.happens===C.PLAYING&&player.stop(),player.play()))};if(whenDone=player.__defAsyncSafe(whenDone),player.anim&&(player.__unsubscribeDynamicEvents(player.anim),player.anim.traverse(function(elm){elm.removeMaskCanvases()})),object)if(object instanceof Animation)player._loadTarget=C.LT_ANIMATION,Loader.loadAnimation(player,object,whenDone);else if(is.arr(object)||object instanceof Element)player._loadTarget=C.LT_ELEMENTS,Loader.loadElements(player,object,whenDone);else if(is.str(object)){{player.controls}player._loadTarget=C.LT_URL,player._loadSrc=object,Loader.loadFromUrl(player,object,importer,whenDone)}else player._loadTarget=C.LT_IMPORT,Loader.loadFromObj(player,object,importer,whenDone);else player._loadTarget=C.LT_ANIMATION,player.anim=new Animation,whenDone(player.anim);return durationPassed&&(player.anim.duration=duration),player};var __stopAnim=(engine.getRequestFrameFunc(),engine.getCancelFrameFunc());Player.prototype.play=function(from,speed,stopAfter){var player=this;player._ensureHasState();var state=player.state;if(state.happens===C.PLAYING){if(player.infiniteDuration)return;throw new PlayerError(Errors.P.ALREADY_PLAYING)}if(player.loadingMode===C.LM_ONPLAY&&!player._lastReceivedAnimationId){if(player._playLock)return;player._playLock=!0;var loadArgs=player._postponedLoad,playArgs=arguments;if(!loadArgs)throw new PlayerError(Errors.P.NO_LOAD_CALL_BEFORE_PLAY);var loadCallback=loadArgs[3],afterLoad=function(){loadCallback&&loadCallback.call(player,arguments),player._postponedLoad=null,player._playLock=!1,player._lastReceivedAnimationId=player.anim.id,Player.prototype.play.apply(player,playArgs)};return loadArgs[3]=afterLoad,void Player.prototype.load.apply(player,loadArgs)}if(player.loadingMode===C.LM_ONREQUEST&&state.happens===C.RES_LOADING)return void player._postpone("play",arguments);player._ensureHasAnim();var anim=player.anim;if(anim.reset(),state.__lastPlayConf=[from,speed,stopAfter],state.from=from||0,state.time=Player.NO_TIME,state.speed=(speed||1)*(player.speed||1)*(anim.speed||1),state.stop="undefined"!=typeof stopAfter?stopAfter:state.stop,state.duration=player.inifiniteDuration?1/0:anim.duration||(anim.isEmpty()?0:Animation.DEFAULT_DURATION),void 0===state.duration)throw new PlayerError(Errors.P.DURATION_IS_NOT_KNOWN);state.__startTime=Date.now(),state.__redraws=0,state.__rsec=0,state.__prevt=0,state.__supressFrames=!1,state.happens!==C.STOPPED||player.repeating||player.reportStats();var ctx_props=engine.getAnmProps(player.ctx);return ctx_props.factor=this.factor(),state.happens=C.PLAYING,state.__firstReq=Render.loop(player.ctx,player,anim,player.__beforeFrame(anim),player.__afterFrame(anim),player.__userBeforeRender,player.__userAfterRender),player.fire(C.S_CHANGE_STATE,C.PLAYING),player.fire(C.S_PLAY,state.from),player},Player.prototype.stop=function(){var player=this;player._ensureHasState();var state=player.state;if(state.happens===C.RES_LOADING&&player.loadingMode===C.LM_ONREQUEST)return void player._postpone("stop",arguments);(state.happens===C.PLAYING||state.happens===C.PAUSED)&&(state.__supressFrames=!0,__stopAnim(state.__firstReq)),state.time=Player.NO_TIME,state.from=0,state.stop=Player.NO_TIME;var anim=player.anim;return anim||player.loadingMode==C.LM_ONPLAY&&player._postponedLoad?(state.happens=C.STOPPED,player._drawStill(),player.fire(C.S_CHANGE_STATE,C.STOPPED)):state.happens!==C.ERROR&&(state.happens=C.NOTHING,player.controls||player._drawSplash(),player.fire(C.S_CHANGE_STATE,C.NOTHING)),player.fire(C.S_STOP),anim&&anim.reset(),player},Player.prototype.pause=function(){var player=this;if(player.state.happens===C.RES_LOADING&&player.loadingMode===C.LM_ONREQUEST)return void player._postpone("pause",arguments);player._ensureHasState(),player._ensureHasAnim();var state=player.state;if(state.happens===C.STOPPED)throw new PlayerError(Errors.P.PAUSING_WHEN_STOPPED);return state.happens===C.PLAYING&&(state.__supressFrames=!0,__stopAnim(state.__firstReq)),state.time>state.duration&&(state.time=state.duration),state.from=state.time,state.happens=C.PAUSED,player.drawAt(state.time),player.fire(C.S_CHANGE_STATE,C.PAUSED),player.fire(C.S_PAUSE,state.time),player},Player.prototype.onerror=function(callback){return this.__err_handler=callback,this},provideEvents(Player,[C.S_IMPORT,C.S_CHANGE_STATE,C.S_LOAD,C.S_RES_LOAD,C.S_PLAY,C.S_PAUSE,C.S_STOP,C.S_COMPLETE,C.S_REPEAT,C.S_ERROR]),Player.prototype._prepare=function(elm){if(!elm)throw new PlayerError(Errors.P.NO_WRAPPER_PASSED);var wrapper_id,wrapper;if(is.str(elm)){if(wrapper_id=elm,wrapper=engine.getElementById(wrapper_id),!wrapper_id)throw new PlayerError(utils.strf(Errors.P.NO_WRAPPER_WITH_ID,[wrapper_id]))}else elm.id||(elm.id="anm-player-"+Player.__instances),wrapper_id=elm.id,wrapper=elm;var assign_data=engine.assignPlayerToWrapper(wrapper,this,"anm-player-"+Player.__instances);if(this.id=assign_data.id,this.wrapper=assign_data.wrapper,this.canvas=assign_data.canvas,!engine.checkPlayerCanvas(this.canvas))throw new PlayerError(Errors.P.CANVAS_NOT_VERIFIED);this.ctx=engine.getContext(this.canvas,"2d"),this.state=Player.createState(this),this.fire(C.S_CHANGE_STATE,C.NOTHING),this.subscribeEvents(this.canvas),this.__canvasPrepared=!0},Player.prototype._addOpts=function(opts){this.debug=is.defined(opts.debug)?opts.debug:this.debug,this.repeat=is.defined(opts.repeat)?opts.repeat:this.repeat,this.autoPlay=is.defined(opts.autoPlay)?opts.autoPlay:this.autoPlay,this.zoom=opts.zoom||this.zoom,this.speed=opts.speed||this.speed,this.bgColor=opts.bgColor||this.bgColor,this.width=opts.width||this.width,this.height=opts.height||this.height,this.ribbonsColor=opts.ribbonsColor||this.ribbonsColor,this.thumbnailSrc=opts.thumbnail||this.thumbnailSrc,this.loadingMode=is.defined(opts.loadingMode)?opts.loadingMode:this.loadingMode,this.audioEnabled=is.defined(opts.audioEnabled)?opts.audioEnabled:this.audioEnabled,this.globalAudioVolume=is.defined(opts.globalAudioVolume)?opts.globalAudioVolume:this.globalAudioVolume,this.imagesEnabled=is.defined(opts.imagesEnabled)?opts.imagesEnabled:this.imagesEnabled,this.shadowsEnabled=is.defined(opts.shadowsEnabled)?opts.shadowsEnabled:this.shadowsEnabled,this.controlsEnabled=is.defined(opts.controlsEnabled)?opts.controlsEnabled:this.controlsEnabled,this.infoEnabled=is.defined(opts.infoEnabled)?opts.infoEnabled:this.infoEnabled,this.handleEvents=is.defined(opts.handleEvents)?opts.handleEvents:this.handleEvents,this.drawStill=is.defined(opts.drawStill)?opts.drawStill:this.drawStill,this.infiniteDuration=is.defined(opts.infiniteDuration)?opts.infiniteDuration:this.infiniteDuration,this.forceAnimationSize=is.defined(opts.forceAnimationSize)?opts.forceAnimationSize:this.forceAnimationSize,this.muteErrors=is.defined(opts.muteErrors)?opts.muteErrors:this.muteErrors,is.defined(opts.mode)&&this.mode(opts.mode)},Player.prototype._checkOpts=function(){if(this.canvas){if(!this.width||!this.height){var cvs_size=engine.getCanvasSize(this.canvas);this.width=cvs_size[0],this.height=cvs_size[1]}if(this._resize(this.width,this.height),this.bgColor&&engine.setCanvasBackground(this.canvas,this.bgColor),this.anim&&this.handleEvents&&this.__subscribeDynamicEvents(this.anim),this.controlsEnabled&&!this.controls?(this._enableControls(),this.infoEnabled?this._enableInfo():this._disableInfo()):!this.controlsEnabled&&this.controls&&(this._disableInfo(),this._disableControls()),this.ctx){var props=engine.getAnmProps(this.ctx);props.skip_shadows=!this.shadowsEnabled}this.thumbnailSrc&&this.thumbnail(this.thumbnailSrc)}},Player.prototype._postInit=function(){this.stop();var to_load=engine.hasUrlToLoad(this.wrapper);if(to_load.url||(to_load=engine.hasUrlToLoad(this.canvas)),to_load.url){var importer=null;to_load.importer_id&&anm.importers.isAccessible(to_load.importer_id)&&(importer=anm.importers.create(to_load.importer_id)),this.load(to_load.url,importer)}},Player.prototype.mode=function(val){if(!is.defined(val))throw new PlayerError("Please define a mode to set");return this.infiniteDuration=val&C.M_INFINITE_DURATION||void 0,this.handleEvents=val&C.M_HANDLE_EVENTS||void 0,this.controlsEnabled=val&C.M_CONTROLS_ENABLED||void 0,this.infoEnabled=val&C.M_INFO_ENABLED||void 0,this.drawStill=val&C.M_DRAW_STILL||void 0,this},Player.prototype.rect=function(rect){return rect?(this.x=rect.x,this.y=rect.y,this.width=rect.width,this.height=rect.height,this._moveTo(rect.x,rect.y),this._resize(rect.width,rect.height),this):{x:this.x,y:this.y,width:this.width,height:this.height}},Player.prototype.forceRedraw=function(){switch(this.state.happens){case C.STOPPED:this.stop();break;case C.PAUSED:this.anim&&this.drawAt(this.state.time);break;case C.PLAYING:this.anim&&this._stopAndContinue();break;case C.NOTHING:this.controls||this._drawSplash()}},Player.prototype.drawAt=function(time){if(time===Player.NO_TIME)throw new PlayerError(Errors.P.PASSED_TIME_VALUE_IS_NO_TIME);if(this.state.happens===C.RES_LOADING&&this.loadingMode===C.LM_ONREQUEST)return void this._postpone("drawAt",arguments);if(0>time||time>this.anim.duration)throw new PlayerError(utils.strf(Errors.P.PASSED_TIME_NOT_IN_RANGE,[time]));var anim=this.anim,u_before=this.__userBeforeRender,u_after=this.__userAfterRender;anim.reset();var ctx_props=engine.getAnmProps(this.ctx);return ctx_props.factor=this.factor(),anim.__informEnabled=!1,Render.at(time,0,this.ctx,this.anim,this.width,this.height,this.zoom,this.ribbonsColor,u_before,u_after),this},Player.prototype.size=function(width,height){return is.defined(width)?(this.__userSize=[width,height],this._resize(),this):[this.width,this.height]},Player.prototype.factor=function(){return this.anim?this.anim.width===this.width&&this.anim.height===this.height?1:Math.min(this.width/this.anim.width,this.height/this.anim.height):void 0},Player.prototype.factorData=function(){if(!this.anim)return void 0;var result=utils.fit_rects(this.width,this.height,this.anim.width,this.anim.height);return{factor:result[0],anim_rect:result[1],ribbon_one:result[2]||null,ribbon_two:result[3]||null}},Player.prototype.thumbnail=function(url,target_width,target_height){if(!url)return this.thumbnailSrc;var player=this;if(!player.__thumb||player.__thumb.src!=url){if(player.ctx){var ratio=engine.PX_RATIO,ctx=player.ctx;ctx.save(),ctx.clearRect(0,0,player.width*ratio,player.height*ratio),player._drawEmpty(),ctx.restore()}var thumb=new Sheet(url);player.__thumbLoading=!0,thumb.load(player.id,function(){player.__thumbLoading=!1,player.__thumb=thumb,(target_width||target_height)&&(player.__thumbSize=[target_width,target_height]),player.state.happens!==C.PLAYING&&player.state.happens!==C.PAUSED&&player._drawStill()})}},Player.prototype.detach=function(){engine.playerAttachedTo(this.wrapper,this)&&(this.stop(),this.controls&&this.controls.detach(this.wrapper),engine.detachPlayer(this),this.ctx&&engine.clearAnmProps(this.ctx),this._reset(),playerManager.fire(C.S_PLAYER_DETACH,this))},Player.prototype.attachedTo=function(canvas_or_wrapper){return engine.playerAttachedTo(canvas_or_wrapper,this)},Player.prototype.isAttached=function(){return engine.playerAttachedTo(this.wrapper,this)},Player.attachedTo=function(canvas_or_wrapper,player){return engine.playerAttachedTo(canvas_or_wrapper,player)},Player.prototype.invalidate=function(){this.controls&&this.controls.update(this.canvas)},Player.__invalidate=function(player){return function(){player.invalidate()}},Player.prototype.beforeFrame=function(callback){if(this.state.happens===C.PLAYING)throw new PlayerError(Errors.P.BEFOREFRAME_BEFORE_PLAY);this.__userBeforeFrame=callback},Player.prototype.afterFrame=function(callback){if(this.state.happens===C.PLAYING)throw new PlayerError(Errors.P.AFTERFRAME_BEFORE_PLAY);this.__userAfterFrame=callback},Player.prototype.beforeRender=function(callback){if(this.state.happens===C.PLAYING)throw new PlayerError(Errors.P.BEFORENDER_BEFORE_PLAY);this.__userBeforeRender=callback},Player.prototype.afterRender=function(callback){if(this.state.happens===C.PLAYING)throw new PlayerError(Errors.P.AFTERRENDER_BEFORE_PLAY);this.__userAfterRender=callback},Player.prototype.subscribeEvents=function(canvas){var doRedraw=Player.__invalidate(this);engine.subscribeWindowEvents({load:doRedraw}),engine.subscribeCanvasEvents(canvas,{mouseover:function(player){return function(){return global_opts.autoFocus&&player.handleEvents&&player.canvas&&player.canvas.focus(),!0}}(this),mouseout:function(player){return function(){return global_opts.autoFocus&&player.handleEvents&&player.canvas&&player.canvas.blur(),!0}}(this)})},Player.prototype.toggleMute=function(){this.muted=!this.muted,this.anim&&this.anim.traverse(function(el){el.$audio&&el.$audio.toggleMute()})},Player.prototype._drawEmpty=function(){var ctx=this.ctx,w=this.width,h=this.height;ctx.save();var ratio=engine.PX_RATIO;ctx.fillStyle=Player.EMPTY_BG,ctx.fillRect(0,0,w*ratio,h*ratio),ctx.strokeStyle=Player.EMPTY_STROKE,ctx.lineWidth=Player.EMPTY_STROKE_WIDTH,ctx.strokeRect(0,0,w*ratio,h*ratio),ctx.restore()},Player.prototype._drawStill=function(){var player=this,state=player.state,anim=player.anim;player.drawStill?player.__thumb?player._drawThumbnail():anim&&player.drawAt(!player.infiniteDuration&&is.finite(anim.duration)?anim.duration*Player.PREVIEW_POS:state.from):player._drawEmpty()},Player.prototype._drawThumbnail=function(){var thumb_bounds=this.__thumbSize||this.__thumb.bounds(),thumb_width=thumb_bounds.width,thumb_height=thumb_bounds.height,player_width=this.width,player_height=this.height,px_ratio=engine.PX_RATIO,ctx=this.ctx;if(ctx.save(),1!=px_ratio&&ctx.scale(px_ratio,px_ratio),thumb_width==player_width&&thumb_height==player_height)this.__thumb.apply(ctx);else{var f_rects=utils.fit_rects(player_width,player_height,thumb_width,thumb_height),factor=f_rects[0],thumb_rect=f_rects[1],rect1=f_rects[2],rect2=f_rects[3];(rect1||rect2)&&(ctx.fillStyle=this.ribbonsColor||"#000",rect1&&ctx.fillRect(rect1[0],rect1[1],rect1[2],rect1[3]),rect2&&ctx.fillRect(rect2[0],rect2[1],rect2[2],rect2[3])),thumb_rect&&(ctx.beginPath(),ctx.rect(thumb_rect[0],thumb_rect[1],thumb_rect[2],thumb_rect[3]),ctx.clip(),ctx.translate(thumb_rect[0],thumb_rect[1])),1!=factor&&ctx.scale(factor,factor),this.__thumb.apply(ctx)}ctx.restore()},Player.prototype._drawSplash=function(){return this.controls||this.__thumbLoading?void 0:this.__thumb&&this.drawStill?void this._drawThumbnail():void 0},Player.prototype._drawLoadingSplash=function(text){if(!this.controls){this._drawSplash();var ctx=this.ctx;ctx.save(),ctx.setTransform(1,0,0,1,0,0),ctx.fillStyle="#006",ctx.font="12px sans-serif",ctx.fillText(text||Strings.LOADING,20,25),ctx.restore()}},Player.prototype._drawLoadingProgress=function(){},Player.prototype._stopDrawingLoadingCircles=function(){this.controls||this._drawEmpty()},Player.prototype._drawErrorSplash=function(e){if(this.canvas&&this.ctx&&!this.controls){this._drawSplash();var ctx=this.ctx;ctx.save(),ctx.setTransform(1,0,0,1,0,0),ctx.fillStyle="#006",ctx.font="14px sans-serif",ctx.fillText(Strings.ERROR+(e?": "+(e.message||typeof Error):"")+".",20,25),ctx.restore()}},Player.prototype.toString=function(){return"[ Player '"+this.id+"' ]"},Player.prototype._reset=function(){var state=this.state;this.loadingMode===C.LM_ONREQUEST&&state.happens===C.RES_LOADING&&(this._clearPostpones(),resourceManager.cancel(this.id)),state.happens=C.NOTHING,state.from=0,state.time=Player.NO_TIME,state.duration=void 0,this.fire(C.S_CHANGE_STATE,C.NOTHING),this.controls&&this.controls.reset(),this.ctx.clearRect(0,0,this.width*engine.PX_RATIO,this.height*engine.PX_RATIO)},Player.prototype._stopAndContinue=function(){var state=this.state,last_conf=state.__lastPlayConf,stoppedAt=state.time;this.stop(),this.play(stoppedAt,last_conf[1],last_conf[2])},Player.prototype._moveTo=function(x,y){engine.setCanvasPosition(this.canvas,x,y)},Player.prototype._resize=function(width,height){var cvs=this.canvas,new_size=this.__userSize||[width,height],cur_size=engine.getCanvasParameters(cvs);if(!cur_size||cur_size[0]!==new_size[0]||cur_size[1]!==new_size[1]){if(new_size[0]&&new_size[1]||(new_size=cur_size),engine.setCanvasSize(cvs,new_size[0],new_size[1]),this.width=new_size[0],this.height=new_size[1],engine.updateCanvasOverlays(cvs),this.ctx){var ctx_props=engine.getAnmProps(this.ctx);ctx_props.factor=this.factor()}return this.controls&&this.controls.handleAreaChange(),this.forceRedraw(),new_size}},Player.prototype._restyle=function(bg){engine.setCanvasBackground(this.canvas,bg),this.forceRedraw()},Player.prototype._enableControls=function(){this.controls||(this.controls=new Controls(this)),this.controls.enable()},Player.prototype._disableControls=function(){this.controls&&(this.controls.disable(),this.controls=null)},Player.prototype._enableInfo=function(){this.controls&&this.controls.enableInfo()},Player.prototype._disableInfo=function(){this.controls&&this.controls.disableInfo()},Player.prototype.__subscribeDynamicEvents=function(anim){if(global_opts.setTabindex&&engine.setTabIndex(this.canvas,this.__instanceNum),anim){var subscribed=!1;if(this.__boundTo)for(var i=0,ix=this.__boundTo,il=ix.length;il>i;i++)anim.id===ix[i][0]&&this.canvas===ix[i][1]&&(subscribed=!0);else this.__boundTo=[];subscribed||(this.__boundTo.push([anim.id,this.canvas]),anim.subscribeEvents(this.canvas))}},Player.prototype.__unsubscribeDynamicEvents=function(anim){if(global_opts.setTabindex&&engine.setTabIndex(this.canvas,void 0),anim){if(!this.__boundTo)return;for(var toRemove=-1,i=0,ix=this.__boundTo,il=ix.length;il>i;i++)anim.id===ix[i][0]&&(toRemove=i,anim.unsubscribeEvents(ix[i][1]));toRemove>=0&&this.__boundTo.splice(toRemove,1)}},Player.prototype._ensureHasState=function(){if(!this.state)throw new PlayerError(Errors.P.NO_STATE)},Player.prototype._ensureHasAnim=function(){if(!this.anim)throw new PlayerError(Errors.P.NO_ANIMATION)},Player.prototype.__beforeFrame=function(anim){return function(player,state,anim,callback){return function(time){return anim.clearAllLaters(),state.happens!==C.PLAYING?!1:state.stop!==Player.NO_TIME&&time>=state.from+state.stop||is.finite(state.duration)&&time>state.duration+Player.PEFF?(player.fire(C.S_COMPLETE),state.time=0,anim.reset(),player.stop(),player.repeat||anim.repeat?(player.repeating=!0,player.play(),player.fire(C.S_REPEAT)):!player.infiniteDuration&&is.finite(state.duration)&&player.drawAt(state.duration),!1):(callback&&callback(time,player.ctx),!0)}}(this,this.state,anim,this.__userBeforeFrame)},Player.prototype.__afterFrame=function(anim){return function(player,state,anim,callback){return function(time){return callback&&callback(time),anim.invokeAllLaters(),!0}}(this,this.state,anim,this.__userAfterFrame)},Player.prototype.__onerror=function(err){var player=this,doMute=player.muteErrors;doMute=doMute&&!(err instanceof SystemError);try{player.state&&(player.state.happens=C.ERROR),player.__lastError=err,player.fire(C.S_CHANGE_STATE,C.ERROR),player.fire(C.S_ERROR,err),player.anim=null}catch(e){throw new SystemError(utils.strf(Errors.S.ERROR_HANDLING_FAILED,[err.message||err]))}try{!player.state||player.state.happens==C.NOTHING&&player.state.happens==C.STOPPED||player.__unsafe_stop()}catch(e){}if(doMute=this.__err_handler&&this.__err_handler(err)||doMute,!doMute){try{this._drawErrorSplash(err)}catch(e){}throw err}},Player.prototype.__callSafe=function(f){try{return f.call(this)}catch(err){this.__onerror(err)}},Player.prototype.__defSafe=function(method_f){var player=this;return function(){var args=arguments;if(this.__safe_ctx)return method_f.apply(player,args);this.__safe_ctx=!0;try{var ret_val=player.__callSafe(function(){return method_f.apply(player,args)});return this.__safe_ctx=!1,ret_val}catch(err){throw this.__safe_ctx=!1,err}}},Player.prototype.__defAsyncSafe=function(func){var player=this;return function(){var args=arguments;try{var ret_val=player.__callSafe(function(){return func.apply(player,args)});return ret_val}catch(err){throw err}}},Player.prototype.__makeSafe=function(methods){for(var player=this,i=0,il=methods.length;il>i;i++){var method=methods[i];if(!player[method])throw new SystemError(utils.strf(Errors.S.NO_METHOD_FOR_PLAYER,[method]));player["__unsafe_"+method]=player[method],player[method]=player.__defSafe(player[method])}},Player.prototype.handle__x=function(type){return this.anim&&this.anim.fire(type,this),!0},Player.prototype._clearPostpones=function(){this._queue=[]},Player.prototype._postpone=function(method,args){this._queue||(this._queue=[]),this._queue.push([method,args])},Player.prototype._callPostpones=function(){if(this._queue&&this._queue.length)for(var spec,q=this._queue,i=0,il=q.length;il>i;i++)spec=q[i],this[spec[0]].apply(this,spec[1]);this._queue=[]};var prodHost="animatron.com",testHost="animatron-test.com",prodStatUrl="//api."+prodHost+"/stats/report/",testStatUrl="//api."+testHost+"/stats/report/";Player.prototype.reportStats=function(){if(this.anim&&this.anim.meta&&this.anim.meta._anm_id){this.statImg||(this.statImg=engine.createStatImg());var loadSrc=this._loadSrc,id=this.anim.meta._anm_id,locatedAtTest=!1,locatedAtProd=!1;if(loadSrc)locatedAtTest=-1!==loadSrc.indexOf(testHost),locatedAtProd=-1!==loadSrc.indexOf(prodHost);else if(window&&window.location){var hostname=window.location.hostname;locatedAtTest=-1!==hostname.indexOf(testHost),locatedAtProd=-1!==hostname.indexOf(prodHost)}locatedAtTest?this.statImg.src=testStatUrl+id+"?"+Math.random():locatedAtProd&&(this.statImg.src=prodStatUrl+id+"?"+Math.random())}},Player.createState=function(){return{happens:C.NOTHING,time:Player.NO_TIME,from:0,stop:Player.NO_TIME,afps:0,speed:1,duration:void 0,__startTime:-1,__redraws:0,__rsec:0}},Player.forSnapshot=function(elm_id,snapshot_url,importer,callback,alt_opts){var player=new Player;return player.init(elm_id,alt_opts),player.load(snapshot_url,importer,callback),player},Player.prototype._applyUrlParamsToAnimation=function(params){is.defined(params.t)?(this.state.happens===C.PLAYING&&this.stop(),this.play(params.t/100)):is.defined(params.from)?(this.state.happens===C.PLAYING&&this.stop(),this.play(params.from/100)):is.defined(params.p)?(this.state.happens===C.PLAYING&&this.stop(),this.play(params.p/100).pause()):is.defined(params.at)&&(this.state.happens===C.PLAYING&&this.stop(),this.play(params.at/100).pause())},module.exports=Player},{"./animation/animation.js":1,"./animation/element.js":4,"./conf.js":8,"./constants.js":9,"./errors.js":10,"./events.js":11,"./global_opts.js":12,"./graphics/sheet.js":18,"./loader.js":21,"./loc.js":22,"./log.js":23,"./player_manager.js":27,"./render.js":28,"./resource_manager.js":29,"./ui/controls.js":30,"./utils.js":33,engine:34}],27:[function(require,module){function PlayerManager(){this.hash={},this.instances=[],this._initHandlers()}var events=require("./events.js"),C=require("./constants.js");events.provideEvents(PlayerManager,[C.S_NEW_PLAYER,C.S_PLAYER_DETACH]),PlayerManager.prototype.handle__x=function(evt,player){return evt==C.S_NEW_PLAYER&&(this.hash[player.id]=player,this.instances.push(player)),!0},PlayerManager.prototype.getPlayer=function(cvs_id){return this.hash[cvs_id]},module.exports=new PlayerManager},{"./constants.js":9,"./events.js":11}],28:[function(require,module){function r_loop(ctx,player,anim,before,after,before_render,after_render){var pl_state=player.state;if(pl_state.happens===C.PLAYING){var msec=Date.now()-pl_state.__startTime,sec=msec/1e3,time=sec*pl_state.speed+pl_state.from,dt=time-pl_state.__prevt;if(pl_state.time=time,pl_state.__dt=dt,pl_state.__prevt=time,!(before&&!before(time)||(0===pl_state.__rsec&&(pl_state.__rsec=msec),msec-pl_state.__rsec>=1e3&&(pl_state.afps=pl_state.__redraws,pl_state.__rsec=msec,pl_state.__redraws=0),pl_state.__redraws++,r_at(time,dt,ctx,anim,player.width,player.height,player.zoom,player.ribbonsColor,before_render,after_render),player.debug&&r_fps(ctx,pl_state.afps,time),after&&!after(time)||pl_state.__supressFrames)))return nextFrame(function(){r_loop(ctx,player,anim,before,after,before_render,after_render)})}}function r_at(time,dt,ctx,anim,width,height,zoom,rib_color,before,after){ctx.save();var ratio=engine.PX_RATIO;1!==ratio&&ctx.scale(ratio,ratio),width=0|width,height=0|height;var size_differs=width!=anim.width||height!=anim.height;if(size_differs)r_with_ribbons(ctx,width,height,anim.width,anim.height,rib_color,function(){try{ctx.clearRect(0,0,anim.width,anim.height),before&&before(time,ctx),1!=zoom&&ctx.scale(zoom,zoom),anim.render(ctx,time,dt),after&&after(time,ctx)}finally{ctx.restore()}});else try{ctx.clearRect(0,0,anim.width,anim.height),before&&before(time,ctx),1!=zoom&&ctx.scale(zoom,zoom),anim.render(ctx,time,dt),after&&after(time,ctx)}finally{ctx.restore()}}function r_with_ribbons(ctx,pw,ph,aw,ah,color,draw_f){var f_rects=fit_rects(pw,ph,aw,ah),factor=f_rects[0],anim_rect=f_rects[1],rect1=f_rects[2],rect2=f_rects[3];ctx.save(),(rect1||rect2)&&(ctx.save(),ctx.fillStyle=color||"#000",rect1&&(ctx.clearRect(rect1[0],rect1[1],rect1[2],rect1[3]),ctx.fillRect(rect1[0],rect1[1],rect1[2],rect1[3])),rect2&&(ctx.clearRect(rect2[0],rect2[1],rect2[2],rect2[3]),ctx.fillRect(rect2[0],rect2[1],rect2[2],rect2[3])),ctx.restore()),anim_rect&&(ctx.beginPath(),ctx.rect(anim_rect[0],anim_rect[1],anim_rect[2],anim_rect[3]),ctx.clip(),ctx.translate(anim_rect[0],anim_rect[1])),1!=factor&&ctx.scale(factor,factor),draw_f(factor),ctx.restore()}function r_fps(ctx,fps,time){ctx.fillStyle="#999",ctx.font="20px sans-serif",ctx.fillText(Math.floor(fps),8,20),ctx.font="10px sans-serif",ctx.fillText(Math.floor(1e3*time)/1e3,8,35)}var C=require("./constants.js"),Painter=require("./animation/painter.js"),Modifier=require("./animation/modifier.js"),Brush=require("./graphics/brush.js"),engine=require("engine"),nextFrame=engine.getRequestFrameFunc(),fit_rects=require("./utils.js").fit_rects,Render={};Render.loop=r_loop,Render.at=r_at,Render.drawFPS=r_fps,Render.p_drawVisuals=new Painter(function(ctx){this.applyVisuals(ctx)},C.PNT_SYSTEM),Render.p_applyAComp=new Painter(function(ctx){this.applyAComp(ctx)},C.PNT_SYSTEM),Render.p_drawPivot=new Painter(function(ctx,pivot){if(pivot=pivot||this.$pivot){var my_bounds=this.myBounds(),stokeStyle=this.isEmpty()?"#600":"#f00";ctx.save(),bounds&&ctx.translate(pivot[0]*my_bounds.width,pivot[1]*my_bounds.height),ctx.beginPath(),ctx.lineWidth=1,ctx.strokeStyle=stokeStyle,ctx.moveTo(0,-10),ctx.lineTo(0,0),ctx.moveTo(3,0),ctx.arc(0,0,3,0,2*Math.PI,!0),ctx.closePath(),ctx.stroke(),ctx.restore()}},C.PNT_DEBUG),Render.p_drawReg=new Painter(function(ctx,reg){(reg=reg||this.$reg)&&(ctx.save(),ctx.lineWidth=1,ctx.strokeStyle="#00f",ctx.fillStyle="rgba(0,0,255,.3)",ctx.translate(reg[0],reg[1]),ctx.beginPath(),ctx.moveTo(-4,-4),ctx.lineTo(4,-4),ctx.lineTo(4,4),ctx.lineTo(-4,4),ctx.lineTo(-4,-4),ctx.closePath(),ctx.stroke(),ctx.beginPath(),ctx.moveTo(0,-10),ctx.lineTo(0,0),ctx.moveTo(3,0),ctx.closePath(),ctx.stroke(),ctx.restore())},C.PNT_DEBUG),Render.p_drawName=new Painter(function(ctx,name){(name=name||this.name)&&(ctx.save(),ctx.fillStyle="#666",ctx.font="12px sans-serif",ctx.fillText(name,0,10),ctx.restore())},C.PNT_DEBUG),Render.p_drawMPath=new Painter(function(ctx,mPath){(mPath=mPath||this.$mpath)&&(ctx.save(),Brush.qstroke(ctx,"#600",2),ctx.beginPath(),mPath.apply(ctx),ctx.closePath(),ctx.stroke(),ctx.restore())
},C.PNT_DEBUG),Render.m_checkBand=new Modifier(function(time,duration,band){return band[0]>duration*time?!1:band[1]<duration*time?!1:void 0},C.MOD_SYSTEM),module.exports=Render},{"./animation/modifier.js":5,"./animation/painter.js":6,"./constants.js":9,"./graphics/brush.js":14,"./utils.js":33,engine:34}],29:[function(require,module){function rmLog(str){conf.logResMan&&log.debug(str)}function ResourceManager(){this._cache={},this._errors={},this._waiting={},this._subscriptions={},this._url_to_subjects={}}var conf=require("./conf.js"),log=require("./log.js"),is=require("./utils.js").is;ResourceManager.prototype.subscribe=function(subject_id,urls,callbacks){if(!subject_id)throw new Error("Subject ID is empty");if(this._subscriptions[subject_id])throw new Error("This subject ('"+subject_id+"') is already subscribed to a bunch of resources, please group them in one.");var filteredUrls=[];rmLog("subscribing "+callbacks.length+" to "+urls.length+" urls: "+urls);for(var i=0;i<urls.length;i++)urls[i]&&(filteredUrls.push(urls[i]),this._url_to_subjects[urls[i]]||(this._url_to_subjects[urls[i]]=[]),this._url_to_subjects[urls[i]].push(subject_id));this._subscriptions[subject_id]=[filteredUrls,is.arr(callbacks)?callbacks:[callbacks]],this.check()},ResourceManager.prototype.loadOrGet=function(subject_id,url,loader,onComplete,onError){var me=this;if(!subject_id)throw new Error("Subject ID is empty");if(!url)throw new Error("Given URL is empty");if(rmLog("request to load "+url),me._cache[url]){rmLog("> already received, trigerring success");var result=me._cache[url];onComplete&&onComplete(result),me.trigger(url,result)}else me._errors[url]?(rmLog("> failed to load before, notifying with error"),onError&&onError(me._errors[url])):me._waiting[subject_id]&&me._waiting[subject_id]&&me._waiting[subject_id][url]?(rmLog("> someone is already waiting for it, subscribing"),me.subscribe(subject_id+(new Date).getTime()+Math.random(),[url],function(res){res[0]?onComplete(res[0]):onError(res[0])})):(rmLog("> not cached, requesting"),me._waiting[subject_id]||(me._waiting[subject_id]={}),me._waiting[subject_id][url]=loader,loader(function(result){result=result||!0,rmLog("file at "+url+" succeeded to load, triggering success"),me.trigger(url,result),onComplete&&onComplete(result),me.check()},function(err){rmLog("file at "+url+" failed to load, triggering error"),me.error(url,err),onError&&onError(err),me.check()}))},ResourceManager.prototype.trigger=function(url,value){if(this._cache[url]||this._errors[url])return void this.check();rmLog("triggering success for url "+url);var subjects=this._url_to_subjects[url];if(subjects)for(var i=0,il=subjects.length;il>i;i++)this._waiting[subjects[i]]&&delete this._waiting[subjects[i]][url];this._cache[url]=value},ResourceManager.prototype.error=function(url,err){if(this._cache[url]||this._errors[url])return void this.check();rmLog("triggering error for url "+url);var subjects=this._url_to_subjects[url];if(subjects)for(var i=0,il=subjects.length;il>i;i++)this._waiting[subjects[i]]&&delete this._waiting[subjects[i]][url];this._errors[url]=err},ResourceManager.prototype.has=function(url){return"undefined"!=typeof this._cache[url]},ResourceManager.prototype.check=function(){rmLog("checking subscriptions");var subscriptions=this._subscriptions,cache=this._cache,errors=this._errors,to_remove=null;for(var subject_id in subscriptions){rmLog("subscription group '"+subject_id+"'");var u,urls=subscriptions[subject_id][0],callbacks=subscriptions[subject_id][1],error_count=0,success_count=0;for(u=0,ul=urls.length;ul>u;u++)errors[urls[u]]&&error_count++,cache[urls[u]]&&success_count++;if(rmLog("success: "+success_count+", errors: "+error_count+", ready: "+(success_count+error_count===urls.length)),success_count+error_count===urls.length){var ready=[];for(u=0,ul=urls.length;ul>u;u++)ready.push(cache[urls[u]]||errors[urls[u]]);rmLog("notifying subscribers that "+urls+" are all ready");for(var k=0,kl=callbacks.length;kl>k;k++)callbacks[k](ready,error_count);to_remove||(to_remove=[]),to_remove.push(subject_id)}}if(to_remove)for(var i=0,il=to_remove.length;il>i;i++)rmLog("removing notified subscribers for subject '"+to_remove[i]+"' from queue"),delete subscriptions[to_remove[i]]},ResourceManager.prototype.cancel=function(subject_id){if(!subject_id)throw new Error("Subject ID is empty");if(this._waiting[subject_id]){var urls=this._subscriptions[subject_id][0];if(urls)for(var u=0,ul=urls.length;ul>u;u++)delete this._waiting[subject_id][urls[u]]}delete this._subscriptions[subject_id]},ResourceManager.prototype.clear=function(){this._cache={},this._errors={},this._waiting={},this._loaders={},this._subscriptions={}},module.exports=new ResourceManager},{"./conf.js":8,"./log.js":23,"./utils.js":33}],30:[function(require,module){function Controls(player){this.player=player,this.canvas=null,this.ctx=null,this.bounds=[],this.theme=null,this.info=null,this._initHandlers(),this.state={happens:C.NOTHING,mpos:{x:0,y:0},alpha:1,click:!1,changed:!0,time:0,gtime:0,fadeTimer:0,fadeMode:FADE_NONE,mouseInteractedAt:0}}var provideEvents=require("../events.js").provideEvents,C=require("../constants.js"),engine=require("engine"),utils=(require("./infoblock.js"),require("../loc.js").Strings,require("../utils.js")),FADE_NONE=(utils.is,0),FADE_IN=1,FADE_OUT=2,theme=Controls.DEFAULT_THEME=require("./controls_theme.json");Controls.THEME=Controls.DEFAULT_THEME,Controls.LAST_ID=0,provideEvents(Controls,[C.X_DRAW]),Controls.prototype.update=function(parent){var cvs=this.canvas;cvs?engine.updateOverlay(parent,cvs):(cvs=engine.addCanvasOverlay("ctrls-"+Controls.LAST_ID,parent,[0,0,1,1],function(cvs){engine.registerAsControlsElement(cvs,parent)}),Controls.LAST_ID++,this.id=cvs.id,this.canvas=cvs,this.ctx=engine.getContext(cvs,"2d"),this.subscribeEvents(cvs),this.changeTheme(Controls.THEME),this.setupRenderLoop()),this.handleAreaChange(),this.info&&this.info.update(parent),BACK_GRAD=null},Controls.prototype.subscribeEvents=function(){var me=this;me.player.on(C.S_STATE_CHANGE,function(state){me.state.happens=state,me.state.changed=!0}),engine.subscribeCanvasEvents(me.canvas,{mouseenter:function(e){me.handleMouseEnter(e)},mousemove:function(e){me.handleMouseMove(e)},mouseleave:function(){me.handleMouseLeave()},mousedown:function(e){me.handleClick(),engine.preventDefault(e)},click:engine.preventDefault,dblclick:engine.preventDefault})},Controls.prototype.checkMouseTimeout=function(gtime){if(this.state.mouseInteracted)this.state.mouseInteractedAt=gtime,this.state.mouseInteracted=!1,this.state.autoHidden=!1,this.show();else if(!this.state.autoHidden){var idleTime=gtime-this.state.mouseInteractedAt;idleTime>this.theme.fadeTimes.idle&&(this.state.happens===C.PLAYING||this.state.happens===C.PAUSED)&&!Controls.isInProgressArea(this.state.mpos,this.bounds[2],this.bounds[3])&&(this.hide(),this.state.autoHidden=!0)}},Controls.prototype.checkFade=function(dt){var state=this.state,fadeMode=state.fadeMode,fadeModifier=!1,alpha=state.alpha;return fadeMode!==FADE_NONE&&(fadeModifier=!0,state.fadeTimer-=dt,alpha=fadeMode===FADE_IN?Math.min(1,1-state.fadeTimer/theme.fadeTimes.fadein):Math.max(0,state.fadeTimer/theme.fadeTimes.fadeout),state.alpha=alpha,state.fadeTimer<=0&&(state.fadeTimer=0,state.fadeMode=FADE_NONE)),fadeModifier},Controls.prototype.render=function(gtime){this.checkMouseTimeout(gtime);{var dt=gtime-this.state.gtime;this.state.gtime}if(this.state.gtime=gtime,this.bounds&&this.state.changed){this.rendering=!0;var fadeModifier=this.checkFade(dt),state=this.state,player=this.player,s=state.happens,coords=state.mpos,time=state.time=player.state.time,ctx=this.ctx,theme=this.theme,duration=this.player.state.duration,progress=time/(0!==duration?duration:1),w=this.bounds[2],h=this.bounds[3],ratio=engine.PX_RATIO;ctx.save(),ctx.setTransform(1,0,0,1,0,0),1!=ratio&&ctx.scale(ratio,ratio),ctx.clearRect(0,0,w,h),ctx.globalAlpha=state.alpha,s===C.PLAYING?duration&&(drawProgress(ctx,theme,w,h,progress),drawTinyPause(ctx,w,h),drawTime(ctx,theme,w,h,time,duration,progress,coords),drawVolumeBtn(ctx,w,h,player.muted)):s===C.STOPPED?(drawBack(ctx,theme,w,h),drawPlay(ctx,theme,w,h,this.focused),state.changed=!1):s===C.PAUSED?(drawBack(ctx,theme,w,h),drawPlay(ctx,theme,w,h,this.focused),duration&&(drawProgress(ctx,theme,w,h,progress),drawTinyPlay(ctx,w,h),drawTime(ctx,theme,w,h,time,duration,progress,coords),drawVolumeBtn(ctx,w,h,player.muted)),state.changed=!1):s===C.NOTHING?(drawNoAnimation(ctx,theme,w,h,this.focused),state.changed=!1):s===C.LOADING||s===C.RES_LOADING?(drawBack(ctx,theme,w,h),drawLoadingProgress(ctx,w,h,gtime/100%60/60)):s===C.ERROR&&(drawBack(ctx,theme,w,h),drawError(ctx,theme,w,h,player.__lastError,this.focused),state.changed=!1),ctx.restore(),this.fire(C.X_DRAW),this.info&&(s!==C.NOTHING?(this._infoShown=!0,this.info.render()):this._infoShown=!1),state.changed|=fadeModifier,this.rendering=!1}},Controls.prototype.react=function(){if(!this.hidden){{var p=this.player,s=this.state.happens,btnWidth=theme.progress.buttonWidth;theme.bottomControls.height}if(s!==C.NOTHING&&s!==C.LOADING&&s!==C.ERROR){var coords=this.state.mpos,w=this.bounds[2],h=this.bounds[3];if(Controls.isInProgressArea(coords,w,h)){if(coords.x>btnWidth&&coords.x<w-btnWidth)return time=utils.roundTo(p.state.duration*(coords.x-btnWidth)/(w-2*btnWidth),1),time>p.anim.duration&&(time=p.anim.duration),s===C.PLAYING?p.pause().play(time):p.play(time).pause(),void(this.state.time=time);if(coords.x>w-btnWidth)return void p.toggleMute()}return s===C.STOPPED?void p.play(0):s===C.PAUSED?void p.play(this.state.time):s===C.PLAYING?void p.pause():void 0}}},Controls.prototype.handleAreaChange=function(){this.player&&this.player.canvas&&(this.bounds=engine.getCanvasBounds(this.canvas))},Controls.prototype.handleMouseMove=function(evt){this.state.mouseInteracted=!0;var pos=engine.getEventPosition(evt,this.canvas);this.state.mpos.x=pos[0],this.state.mpos.y=pos[1],(this.state.happens===C.PLAYING||this.state.happens===C.PAUSED)&&(Controls.isInProgressArea(this.state.mpos,this.bounds[2],this.bounds[3])?(this.state.changed=!0,this.state.mouseInProgressArea=!0):(this.state.mouseInProgressArea&&(this.state.changed=!0),this.state.mouseInProgressArea=!1))},Controls.prototype.handleClick=function(){this.state.changed=!0,this.state.mouseInteracted=!0,this.show(),this.react()},Controls.prototype.handleMouseEnter=function(){this.show(),this.forceNextRedraw()},Controls.prototype.handleMouseLeave=function(){(this.state.happens===C.PLAYING||this.state.happens===C.PAUSED)&&this.hide()},Controls.prototype.hide=function(){0!==this.state.alpha&&this.state.fadeMode!==FADE_OUT&&(this.state.fadeMode=FADE_OUT,this.state.fadeTimer=theme.fadeTimes.fadeout-this.state.fadeTimer,this.state.changed=!0)},Controls.prototype.show=function(){1!==this.state.alpha&&this.state.fadeMode!==FADE_IN&&(this.state.fadeMode=FADE_IN,this.state.fadeTimer=theme.fadeTimes.fadein-this.state.fadeTimer,this.state.changed=!0)},Controls.prototype.reset=function(){this.info&&this.info.reset()},Controls.prototype.detach=function(parent){this.stopRenderLoop(),engine.detachElement(parent,this.canvas),this.info&&this.info.detach(parent),this.ctx&&engine.clearAnmProps(this.ctx)},Controls.prototype.changeTheme=function(to){this.theme=to,this.state.changed=!0},Controls.prototype.forceNextRedraw=function(){this.state.changed=!0},Controls.prototype.enable=function(){this.update(this.player.canvas)},Controls.prototype.disable=function(){this.hide(),this.detach(this.player.wrapper)},Controls.prototype.enableInfo=function(){},Controls.prototype.disableInfo=function(){};var nextFrame=engine.getRequestFrameFunc(),stopAnim=engine.getCancelFrameFunc(),getRenderFunc=function(controls){var renderFunc=function(t){controls.render.call(controls,t),nextFrame(renderFunc)};return renderFunc};Controls.prototype.setupRenderLoop=function(){this.renderFunc=getRenderFunc(this),nextFrame(this.renderFunc)},Controls.prototype.stopRenderLoop=function(){stopAnim(this.renderFunc)},Controls.isInProgressArea=function(mpos,w,h){return mpos.y<=h&&mpos.y>=h-theme.bottomControls.height};var drawBack=function(ctx,theme,w,h){ctx.save();var cx=w/2,cy=h/2;ctx.beginPath(),ctx.fillStyle=theme.circle.color,ctx.arc(cx,cy,theme.circle.radius,0,2*Math.PI),ctx.fill(),ctx.restore()},drawProgress=function(ctx,theme,w,h,progress){ctx.save();var btnWidth=theme.progress.buttonWidth,bottomHeight=theme.bottomControls.height;ctx.fillStyle=theme.progress.backColor,ctx.fillRect(0,h-bottomHeight,w,bottomHeight),ctx.fillStyle=theme.progress.inactiveColor,ctx.fillRect(btnWidth,h-10,w-2*btnWidth,5);var progressWidth=Math.round(progress*(w-2*btnWidth));ctx.fillStyle=theme.progress.activeColor,ctx.fillRect(btnWidth,h-10,progressWidth,5),ctx.restore()},drawPlay=function(ctx,theme,w,h){ctx.save();var cx=w/2,cy=h/2;ctx.strokeStyle="transparent",ctx.fillStyle=theme.button.color,ctx.beginPath(),ctx.moveTo(cx-12,cy-20),ctx.lineTo(cx-12,cy+20),ctx.lineTo(cx+18,cy),ctx.lineTo(cx-12,cy-20),ctx.closePath(),ctx.fill(),ctx.restore()},drawTinyPause=function(ctx,w,h){ctx.save();var cx=0,cy=h-theme.bottomControls.height;ctx.fillStyle=theme.button.color,ctx.fillRect(cx+9,cy+3,3,9),ctx.fillRect(cx+15,cy+3,3,9),ctx.restore()},drawTinyPlay=function(ctx,w,h){ctx.save();var cx=0,cy=h-theme.bottomControls.height;ctx.strokeStyle="transparent",ctx.fillStyle=theme.button.color,ctx.beginPath(),ctx.moveTo(cx+9,cy+3),ctx.lineTo(cx+18,cy+7),ctx.lineTo(cx+9,cy+11),ctx.lineTo(cx+9,cy+3),ctx.closePath(),ctx.fill(),ctx.restore()},drawVolumeBtn=function(ctx,w,h,muted){ctx.save();var cx=w-theme.progress.buttonWidth,cy=h-theme.bottomControls.height;if(ctx.strokeStyle="transparent",ctx.lineWidth=1,ctx.fillStyle=theme.button.color,ctx.beginPath(),ctx.translate(cx,cy),ctx.moveTo(3,6),ctx.lineTo(6,6),ctx.lineTo(12,3),ctx.lineTo(12,12),ctx.lineTo(6,9),ctx.lineTo(3,9),ctx.lineTo(3,6),ctx.closePath(),ctx.fill(),ctx.lineWidth=1,ctx.strokeStyle=theme.button.color,ctx.beginPath(),muted)ctx.moveTo(15,5),ctx.lineTo(21,10),ctx.moveTo(15,10),ctx.lineTo(21,5),ctx.stroke();else for(var i=0;3>i;i++)ctx.beginPath(),ctx.moveTo(15+3*i,3),ctx.bezierCurveTo(18+3*i,7,18+3*i,8,15+3*i,12),ctx.stroke();ctx.restore()},drawLoadingProgress=function(ctx,w,h,hilite_pos){var cx=w/2,cy=h/2,segment=Math.ceil(90*hilite_pos),twoPi=2*Math.PI,segmentPos=twoPi/90*segment;segmentAngle=twoPi/8,ctx.translate(cx,cy),ctx.strokeStyle=theme.loading.inactiveColor,ctx.lineWidth=2,ctx.beginPath(),ctx.arc(0,0,36,0,twoPi),ctx.stroke(),ctx.closePath(),ctx.beginPath(),ctx.strokeStyle=theme.loading.activeColor,ctx.arc(0,0,36,segmentPos,segmentPos+segmentAngle),ctx.stroke(),ctx.closePath()},drawNoAnimation=function(){},drawError=function(ctx,theme,w,h,error){ctx.save();var cx=w/2,cy=h/2;ctx.translate(cx,cy),ctx.rotate(Math.PI/4),ctx.strokeStyle="transparent",ctx.fillStyle=theme.button.color,ctx.fillRect(-25,-3,50,6),ctx.fillRect(-3,-25,6,50),ctx.restore(),drawText(ctx,theme,w/2,h/2*(1+theme.circle.radius),1.2*theme.font.statussize,error&&error.message?utils.ell_text(error.message,theme.error.statuslimit):error,theme.error.color)},drawTime=function(ctx,theme,w,h,time,duration,progress,coords){var btnWidth=theme.progress.buttonWidth,inArea=Controls.isInProgressArea(coords,w,h)&&coords.x>btnWidth&&coords.x<w-btnWidth;inArea&&(progress=(coords.x-btnWidth)/(w-2*btnWidth),time=Math.round(duration*progress));var progressPos=btnWidth+Math.round(progress*(w-2*btnWidth));ctx.beginPath(),ctx.fillStyle=theme.progress.backColor,ctx.strokeStyle="transparent",ctx.clearRect(0,h-40,w,20);var x=Math.min(Math.max(1,progressPos-17),w-35),r=3,y=h-40,rw=34,rh=20;drawRoundedRect(ctx,x,y,rw,rh,r),ctx.moveTo(x+rw/2-3,y+rh),ctx.lineTo(x+rw/2,y+rh+3),ctx.lineTo(x+rw/2+3,y+rh),ctx.closePath(),ctx.fill(),drawText(ctx,theme,x+17,h-30,8,utils.fmt_time(time))},drawText=function(ctx,theme,x,y,size,text,color,align){ctx.save(),ctx.font=theme.font.weight+" "+Math.floor(size||15)+"pt "+theme.font.face,ctx.textAlign=align||"center",ctx.textBaseline="middle",ctx.fillStyle=color||theme.font.color,ctx.fillText(text,x,y),ctx.restore()},drawRoundedRect=function(ctx,x,y,w,h,radius){var r=x+w,b=y+h;ctx.moveTo(x+radius,y),ctx.lineTo(r-radius,y),ctx.quadraticCurveTo(r,y,r,y+radius),ctx.lineTo(r,y+h-radius),ctx.quadraticCurveTo(r,b,r-radius,b),ctx.lineTo(x+radius,b),ctx.quadraticCurveTo(x,b,x,b-radius),ctx.lineTo(x,y+radius),ctx.quadraticCurveTo(x,y,x+radius,y)};module.exports=Controls},{"../constants.js":9,"../events.js":11,"../loc.js":22,"../utils.js":33,"./controls_theme.json":31,"./infoblock.js":32,engine:34}],31:[function(require,module){module.exports={font:{face:"Arial, sans-serif",weight:"bold",timesize:13.5,statussize:8.5,infosize_a:10,infosize_b:8,color:"white"},circle:{radius:40,color:"rgba(0,0,0,0.7)"},bottomControls:{height:15},progress:{backColor:"rgba(0,0,0,0.7)",activeColor:"white",inactiveColor:"rgba(255,255,255,0.5)",buttonWidth:27},button:{color:"white"},loading:{activeColor:"white",inactiveColor:"rgba(255,255,255,0.5)"},fadeTimes:{fadein:300,fadeout:300,idle:2500},error:{statusLimit:40,color:"darkred"}}},{}],32:[function(require,module){function InfoBlock(){}module.exports=InfoBlock},{}],33:[function(require,module){(function(global){function StopIteration(){}function iter(a){if(a.__iter)return a.__iter.reset(),a.__iter;var pos=0,len=a.length;return a.__iter={next:function(){if(len>pos)return a[pos++];throw pos=0,new StopIteration},hasNext:function(){return len>pos},remove:function(){return len--,a.splice(--pos,1)},reset:function(){pos=0,len=a.length},get:function(){return a[pos]},each:function(f,rf){for(this.reset();this.hasNext();)f(this.next())===!1&&(rf?rf(this.remove()):this.remove())}}}function fmt_time(time){if(!is.finite(time))return"∞";var absTime=Math.abs(time),h=Math.floor(absTime/3600),m=Math.floor((absTime-3600*h)/60),s=Math.floor(absTime-3600*h-60*m);return(0>time?"-":"")+(h>0?(10>h?"0"+h:h)+":":"")+(10>m?"0"+m:m)+":"+(10>s?"0"+s:s)}function ell_text(text,max_len){if(!text)return"";var len=text.length;if(max_len>=len)return text;var semilen=Math.floor(len/2)-2;return text.slice(0,semilen)+"..."+text.slice(len-semilen)}function compareFloat(n1,n2,precision){0!==precision&&(precision=precision||2);var multiplier=Math.pow(10,precision);return Math.round(n1*multiplier)==Math.round(n2*multiplier)}function roundTo(n,precision){if(!precision)return Math.round(n);var multiplier=Math.pow(10,precision);return Math.round(n*multiplier)/multiplier}function interpolateFloat(a,b,t){return a*(1-t)+b*t}function paramsToObj(pstr){for(var pair,o={},ps=pstr.split("&"),i=ps.length;i--;)pair=ps[i].split("="),o[pair[0]]=pair[1];return o}function obj_clone(what){var dest={};for(var prop in what)dest[prop]=what[prop];return dest}function mrg_obj(src,backup,trg){if(!backup)return src;var res=trg||{};for(var prop in backup)res[prop]=is.defined(src[prop])?src[prop]:backup[prop];return res}function strf(str,subst){var args=subst;return str.replace(/{(\d+)}/g,function(match,number){return is.defined(args[number])?args[number]:match})}function collect_to(str,start,ch){for(var result="",i=start;str[i]!==ch;i++){if(i===str.length)throw new SystemError("Reached end of string");result+=str[i]}return result}function guid(){return Math.random().toString(36).substring(2,10)+Math.random().toString(36).substring(2,10)}function fit_rects(pw,ph,aw,ah){var xw=pw/aw,xh=ph/ah,factor=Math.min(xw,xh),hcoord=(pw-aw*factor)/2,vcoord=(ph-ah*factor)/2;if(1!=xw||1!=xh){var anim_rect=[hcoord,vcoord,aw*factor,ah*factor];return 0!==hcoord?[factor,anim_rect,[0,0,hcoord,ph],[hcoord+aw*factor,0,hcoord,ph]]:0!==vcoord?[factor,anim_rect,[0,0,aw,vcoord],[0,vcoord+ah*factor,aw,vcoord]]:[factor,anim_rect]}return[1,[0,0,aw,ah]]}function removeElement(obj,element){if(is.arr(obj)){var index=array.indexOf(element);index>-1&&array.splice(index,1)}else obj[element]=null}var C=require("./constants.js"),SystemError=require("./errors.js").SystemError,is={};is.defined=function(v){return!("undefined"==typeof v||null===v||void 0===v)},is.finite=global.isFinite,is.nan=global.isNaN,is.arr=Array.isArray,is.int=function(n){return is.num(n)&&Math.floor(n)==n},is.num=function(n){return n=global.parseFloat(n),!is.nan(n)&&is.finite(n)},is.fun=function(f){return"function"==typeof f},is.obj=function(o){return"object"==typeof o},is.str=function(s){return"string"==typeof s},is.not_empty=function(obj){return Object.keys?Object.keys(obj).length>0:Object.getOwnPropertyNames(obj).length>0},is.modifier=function(f){return f.hasOwnProperty(C.MARKERS.MODIFIER_MARKER)},is.painter=function(f){return f.hasOwnProperty(C.MARKERS.PAINTER_MARKER)},is.tween=function(f){return f.is_tween&&is.modifier(f)},is.equal=function(x,y){if(x===y)return!0;if(!(x instanceof Object&&y instanceof Object))return!1;if(x.constructor!==y.constructor)return!1;for(var p in x)if(x.hasOwnProperty(p)){if(!y.hasOwnProperty(p))return!1;if(x[p]!==y[p]){if("object"!=typeof x[p])return!1;if(!is.equal(x[p],y[p]))return!1}}for(p in y)if(y.hasOwnProperty(p)&&!x.hasOwnProperty(p))return!1;return!0},module.exports={fmt_time:fmt_time,ell_text:ell_text,compareFloat:compareFloat,roundTo:roundTo,interpolateFloat:interpolateFloat,paramsToObj:paramsToObj,obj_clone:obj_clone,mrg_obj:mrg_obj,strf:strf,collect_to:collect_to,guid:guid,fit_rects:fit_rects,is:is,iter:iter,removeElement:removeElement}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./constants.js":9,"./errors.js":10}],34:[function(require,module){(function(global){for(var $doc=window.document,MARKER_ATTR="anm-player",AUTO_MARKER_ATTR="anm-player-target",URL_ATTR="anm-url",SNAPSHOT_URL_ATTR="anm-src",IMPORTER_ATTR="anm-importer",$DE={},requestAnimationFrame=global.requestAnimationFrame,cancelAnimationFrame=global.cancelAnimationFrame,lastTime=0,vendors=["ms","moz","webkit","o"],x=0;x<vendors.length&&!global.requestAnimationFrame;++x)requestAnimationFrame=global[vendors[x]+"RequestAnimationFrame"],cancelAnimationFrame=global[vendors[x]+"CancelAnimationFrame"]||global[vendors[x]+"CancelRequestAnimationFrame"];requestAnimationFrame||(requestAnimationFrame=function(callback){var currTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currTime-lastTime)),id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);return lastTime=currTime+timeToCall,id}),cancelAnimationFrame||(cancelAnimationFrame=function(id){clearTimeout(id)}),$DE.getRequestFrameFunc=function(){return requestAnimationFrame},$DE.getCancelFrameFunc=function(){return cancelAnimationFrame},$DE.PX_RATIO=window.devicePixelRatio||1,$DE.ajax=function(url,callback,errback,method,headers){var req;if(req=isIE9?new window.XDomainRequest:new window.XMLHttpRequest,!req)throw new Error("Failed to create XMLHttp instance");var whenDone=function(){if(4==req.readyState)if(200==req.status)callback&&callback(req);else{var error=new Error("AJAX request for "+url+" returned "+req.status+" instead of 200");if(!errback)throw error;errback(error,req)}};if(req.onreadystatechange=whenDone,isIE9&&(req.onload=function(){callback(req)},req.onerror=function(){errback&&errback(new Error("XDomainRequest Error"),req)}),req.open(method||"GET",url,!0),headers&&!isIE9)for(var header in headers)req.setRequestHeader(header,headers[header]);req.send(null)},$DE.getCookie=function(name){var i,s=$doc.cookie;if(s)for(i=0,s=s.split("; ");i<s.length;i++)if(s[i]=s[i].split("=",2),unescape(s[i][0])==name)return unescape(s[i][1]);return null},$DE.onDocReady=function(callback){if("complete"===$doc.readyState)return void callback();var listener;$doc.addEventListener?listener=$doc.addEventListener("DOMContentLoaded",function(){$doc.removeEventListener("DOMContentLoaded",listener,!1),callback()},!1):$doc.attachEvent&&(listener=function(){"complete"===$doc.readyState&&($doc.detachEvent("onreadystatechange",listener),callback())},$doc.attachEvent("onreadystatechange",listener))},$DE.__stylesTag=null,$DE.WRAPPER_CLASS="anm-wrapper",$DE.WRAPPER_INSTANCE_CLASS_PREFIX="anm-wrapper-",$DE.PLAYER_CLASS="anm-player",$DE.PLAYER_INSTANCE_CLASS_PREFIX="anm-player-",$DE.CONTROLS_CLASS="anm-controls",$DE.CONTROLS_INSTANCE_CLASS_PREFIX="anm-controls-",$DE.INFO_CLASS="anm-controls",$DE.INFO_INSTANCE_CLASS_PREFIX="anm-controls-",$DE.styling={wrapperGeneral:function(rule){rule.style.position="relative"},wrapperInstance:function(){},playerGeneral:function(){},playerInstance:function(){},controlsGeneral:function(rule){rule.style.position="absolute",rule.style.left=0,rule.style.top=0,rule.style.verticalAlign="top",rule.style.zIndex=100,rule.style.cursor="pointer",rule.style.backgroundColor="rgba(0, 0, 0, 0)"},controlsInstance:function(){},infoGeneral:function(rule){rule.style.position="relative",rule.style.verticalAlign="top",rule.style.zIndex=110,rule.style.cursor="pointer",rule.style.backgroundColor="rgba(0, 0, 0, 0)",rule.style.opacity=1},infoInstance:function(){}},$DE.ensureGlobalStylesInjected=function(){if(!$DE.__stylesTag){var stylesTag=$DE.createStyle(),head=$doc.getElementsByTagName("head")[0];if(!head)throw new Error("anm.Player requires <head> tag to exist in the document to inject CSS there");head.appendChild(stylesTag),$DE.__stylesTag=stylesTag}},$DE.injectElementStyles=function(elm,general_class,instance_class){var styles=$DE.__stylesTag.sheet,rules=styles.cssRules||styles.rules;elm.classList?(elm.classList.add(general_class),elm.classList.add(instance_class)):elm.className?elm.className+=general_class+" "+instance_class:elm.className=general_class+" "+instance_class;var props=$DE.getAnmProps(elm);props.gen_class=general_class,props.inst_class=instance_class;var general_rule_idx=(styles.insertRule||styles.addRule).call(styles,"."+general_class+"{}",rules.length),instance_rule_idx=(styles.insertRule||styles.addRule).call(styles,"."+instance_class+"{}",rules.length),elm_rules=[rules[general_rule_idx],rules[instance_rule_idx]];return props.gen_rule=elm_rules[0],props.inst_rule=elm_rules[1],elm_rules},$DE.__textBuf=null,$DE.createTextMeasurer=function(){var buff=$DE.__textBuf;return buff||$DE.onDocReady(function(){var div=$doc.createElement("div"),span=$doc.createElement("span");div.style.visibility="hidden",div.style.position="absolute",div.style.top=-1e4+"px",div.style.left=-1e4+"px",div.appendChild(span),$doc.body.appendChild(div),$DE.__textBuf=span,buff=$DE.__textBuf}),function(text,lines_arg){var has_arg="undefined"!=typeof lines_arg,lines=has_arg?lines_arg:text.lines;if(buff.style.font=text.$font,buff.style.whiteSpace="pre",Array.isArray(text.lines)){for(var maxWidth=0,height=0,i=0,ilen=lines.length;ilen>i;i++)buff.textContent=lines[i]||" ",maxWidth=Math.max(buff.offsetWidth,maxWidth),height+=buff.offsetHeight;return[maxWidth,height]}return buff.textContent=text.lines.toString()||"",[buff.offsetWidth,buff.offsetHeight]}},$DE.getElementById=function(id){return $doc.getElementById(id)},$DE.findElementPosition=function(elm){if(elm.getBoundingClientRect){var rect=elm.getBoundingClientRect();return[rect.left,rect.top]}var curleft=0,curtop=0;do curleft+=elm.offsetLeft,curtop+=elm.offsetTop;while(elm=elm.offsetParent);return[curleft,curtop]},$DE.findScrollAwarePosition=function(elm){var curleft=0,curtop=0;if(elm.getBoundingClientRect){var rect=elm.getBoundingClientRect();do curleft+=elm!==$doc.body?elm.scrollLeft:$doc.documentElement.scrollLeft,curtop+=elm!==$doc.body?elm.scrollTop:$doc.documentElement.scrollTop;while(elm=elm.offsetParent);return[rect.left-curleft,rect.top-curtop]}do curleft+=elm.offsetLeft-(elm!==$doc.body?elm.scrollLeft:$doc.documentElement.scrollLeft),curtop+=elm.offsetTop-(elm!==$doc.body?elm.scrollTop:$doc.documentElement.scrollTop);while(elm=elm.offsetParent);return[curleft,curtop]},$DE.moveElementTo=function(elm,x,y){var props=$DE.hasAnmProps(elm);(props&&props.inst_rule||elm).style.left=0===x?"0":x+"px",(props&&props.inst_rule||elm).style.top=0===y?"0":y+"px"},$DE.__trashBin=null,$DE.disposeElement=function(elm){var trashBin=$DE.__trashBin;trashBin||(trashBin=$doc.createElement("div"),trashBin.id="trash-bin",trashBin.style.display="none",$doc.body.appendChild(trashBin),$DE.__trashBin=trashBin),trashBin.appendChild(elm),trashBin.innerHTML=""},$DE.detachElement=function(parent,child){(parent||child.parentNode).removeChild(child)},$DE.showElement=function(elm){var props=$DE.hasAnmProps(elm);(props&&props.inst_rule||elm).style.visibility="visible"},$DE.hideElement=function(elm){var props=$DE.hasAnmProps(elm);(props&&props.inst_rule||elm).style.visibility="hidden"},$DE.clearChildren=function(elm){for(;elm.firstChild;)elm.removeChild(elm.firstChild)},$DE.createCanvas=function(width,height,bg,ratio){var cvs=$doc.createElement("canvas");return $DE.setCanvasSize(cvs,width,height,ratio),bg&&$DE.setCanvasBackground(cvs,bg),cvs},$DE.assignPlayerToWrapper=function(wrapper,player){if(!wrapper)throw new Error("Element passed to anm.Player initializer does not exists.");anm.utils.is.str(wrapper)&&(wrapper=$doc.getElementById(wrapper));var canvasWasPassed="canvas"==wrapper.tagName||"CANVAS"==wrapper.tagName;canvasWasPassed&&window.console&&console.warn("NB: A <canvas> tag was passed to the anm.Player as an element to attach to. This is not a recommended way since version 1.2; this <canvas> will be moved inside a <div>-wrapper because of it, so it may break document flow and/or CSS styles. Please pass any container such as <div> to a Player instead of <canvas> to fix it.");var state_before=wrapper.cloneNode(!1),canvas=canvasWasPassed?wrapper:$doc.createElement("canvas");if(wrapper=canvasWasPassed?$doc.createElement("div"):wrapper,wrapper.getAttribute(MARKER_ATTR))throw new Error("Player is already attached to element '"+(wrapper.id||canvas.id)+"'.");wrapper.setAttribute(MARKER_ATTR,!0),wrapper.hasAttribute(AUTO_MARKER_ATTR)&&wrapper.removeAttribute(AUTO_MARKER_ATTR),canvas.hasAttribute(AUTO_MARKER_ATTR)&&canvas.removeAttribute(AUTO_MARKER_ATTR);var prev_cvs_id=canvas.id;canvas.id="",wrapper.id||(wrapper.id=prev_cvs_id),canvas.id=wrapper.id+"-cvs";var props=$DE.getAnmProps(canvas);props.wrapper=wrapper,props.was_before=state_before;var id=wrapper.id;if(props.id=id,canvasWasPassed){var parent=canvas.parentNode||$doc.body;if(!parent)throw new Error("Provided canvas tag has no parent");parent.replaceChild(wrapper,canvas),wrapper.appendChild(canvas)}else wrapper.appendChild(canvas);$DE.ensureGlobalStylesInjected();var wrapper_rules=$DE.injectElementStyles(wrapper,$DE.WRAPPER_CLASS,$DE.WRAPPER_INSTANCE_CLASS_PREFIX+(id||"no-id")),cvs_rules=$DE.injectElementStyles(canvas,$DE.PLAYER_CLASS,$DE.PLAYER_INSTANCE_CLASS_PREFIX+(id||"no-id"));return $DE.styling.playerGeneral(cvs_rules[0]),$DE.styling.playerInstance(cvs_rules[1]),$DE.styling.wrapperGeneral(wrapper_rules[0]),$DE.styling.wrapperInstance(wrapper_rules[1]),$DE.subscribeWrapperToStateChanges(wrapper,player),{wrapper:wrapper,canvas:canvas,id:id}},$DE.playerAttachedTo=function(elm){if($DE.hasAnmProps(elm)){var props=$DE.getAnmProps(elm);if(props.wrapper)return props.wrapper.hasAttribute(MARKER_ATTR)}return elm.hasAttribute(MARKER_ATTR)},$DE.findPotentialPlayers=function(){return $doc.querySelectorAll("["+AUTO_MARKER_ATTR+"]")},$DE.hasAnmProps=function(elm){return elm.__anm},$DE.getAnmProps=function(elm){return elm.__anm||(elm.__anm={}),elm.__anm},$DE.clearAnmProps=function(elm){if(elm&&elm.__anm){var __anm=elm.__anm;if(__anm.gen_class&&__anm.inst_class){for(var styles=$DE.__stylesTag.sheet,rules=styles.cssRules||styles.rules,to_remove=[],i=0,il=rules.length;il>i;i++)(rules[i].selectorText=="."+__anm.gen_class||rules[i].selectorText=="."+__anm.inst_class)&&to_remove.push(i);for(;to_remove.length;)(styles.deleteRule||styles.removeRule).call(styles,to_remove.pop())}__anm.gen_class&&elm.classList&&elm.classList.remove(__anm.gen_class),__anm.inst_class&&elm.classList&&elm.classList.remove(__anm.inst_class),delete elm.__anm}},$DE.detachPlayer=function(player){var canvas=player.canvas,wrapper=player.wrapper;wrapper&&wrapper.removeAttribute(MARKER_ATTR);var parent_node=wrapper.parentNode||$doc.body,next_node=wrapper.nextSibling,props=$DE.getAnmProps(canvas);
$DE.clearChildren(wrapper),props.was_before&&(parent_node.removeChild(wrapper),parent_node.insertBefore(props.was_before,next_node)),$DE.clearAnmProps(wrapper),$DE.clearAnmProps(canvas),player.controls&&($DE.clearAnmProps(player.controls.canvas),player.controls.info&&$DE.clearAnmProps(player.controls.info.canvas)),player.statImg&&$DE.detachElement(null,player.statImg)},$DE.getContext=function(cvs,type){return cvs.getContext(type)},$DE.extractUserOptions=function(elm){function __boolAttr(val){return"undefined"==typeof val?void 0:null===val?null:"0"==val?!1:"1"==val?!0:"false"==val?!1:"true"==val?!0:"off"==val?!1:"on"==val?!0:"no"==val?!1:"yes"==val?!0:void 0}var ratio=$DE.PX_RATIO,width=elm.getAttribute("anm-width");width||(width=elm.hasAttribute("width")?elm.getAttribute("width")/ratio:void 0);var height=elm.getAttribute("anm-height");return height||(height=elm.hasAttribute("height")?elm.getAttribute("height")/ratio:void 0),{debug:__boolAttr(elm.getAttribute("anm-debug")),mode:elm.getAttribute("anm-mode"),repeat:__boolAttr(elm.getAttribute("anm-repeat")),zoom:elm.getAttribute("anm-zoom"),speed:elm.getAttribute("anm-speed"),width:width,height:height,autoPlay:__boolAttr(elm.getAttribute("anm-autoplay")||elm.getAttribute("anm-auto-play")),bgColor:elm.getAttribute("anm-bgcolor")||elm.getAttribute("anm-bg-color"),ribbonsColor:elm.getAttribute("anm-ribbons")||elm.getAttribute("anm-ribcolor")||elm.getAttribute("anm-rib-color"),drawStill:__boolAttr(elm.getAttribute("anm-draw-still")||elm.getAttribute("anm-draw-thumbnail")||elm.getAttribute("anm-draw-thumb")),imagesEnabled:__boolAttr(elm.getAttribute("anm-images")||elm.getAttribute("anm-images-enabled")),shadowsEnabled:__boolAttr(elm.getAttribute("anm-shadows")||elm.getAttribute("anm-shadows-enabled")),audioEnabled:__boolAttr(elm.getAttribute("anm-audio")||elm.getAttribute("anm-audio-enabled")),controlsEnabled:__boolAttr(elm.getAttribute("anm-controls")||elm.getAttribute("anm-controls-enabled")),infoEnabled:__boolAttr(elm.getAttribute("anm-info")||elm.getAttribute("anm-info-enabled")),handleEvents:__boolAttr(elm.getAttribute("anm-events")||elm.getAttribute("anm-handle-events")),infiniteDuration:__boolAttr(elm.getAttribute("anm-infinite")||elm.getAttribute("anm-infinite-duration")),forceSceneSize:__boolAttr(elm.getAttribute("anm-scene-size")||elm.getAttribute("anm-force-scene-size")),inParent:void 0,muteErrors:__boolAttr(elm.getAttribute("anm-mute-errors")),loadingMode:elm.getAttribute("anm-loading-mode"),thumbnail:elm.getAttribute("anm-thumbnail")}},$DE.checkPlayerCanvas=function(){return!0},$DE.hasUrlToLoad=function(elm){return{url:elm.getAttribute(URL_ATTR)||elm.getAttribute(SNAPSHOT_URL_ATTR),importer_id:elm.getAttribute(IMPORTER_ATTR)}},$DE.setTabIndex=function(cvs,idx){cvs.setAttribute("tabindex",idx)},$DE.getCanvasParameters=function(cvs){if(!$DE.hasAnmProps(cvs))return null;var props=$DE.getAnmProps(cvs);return props.width&&props.height?[props.width,props.height,$DE.PX_RATIO]:null},$DE.getCanvasSize=function(cvs){if(cvs.getBoundingClientRect){var rect=cvs.getBoundingClientRect();return[rect.width,rect.height]}return[cvs.getAttribute("clientWidth")||cvs.clientWidth,cvs.getAttribute("clientHeight")||cvs.clientHeight]},$DE.getCanvasPosition=function(cvs){return $DE.findScrollAwarePosition(cvs)},$DE.getCanvasBounds=function(cvs){var params=$DE.getCanvasParameters(cvs);if(!params)return null;var pos=$DE.getCanvasPosition(cvs);return[pos[0],pos[1],params[0],params[1],params[2]]},$DE.setCanvasSize=function(cvs,width,height,ratio){ratio=ratio||$DE.PX_RATIO;var _w=0|width,_h=0|height,props=$DE.getAnmProps(cvs);return props.ratio=ratio,props.width=_w,props.height=_h,cvs.style.width||((props.inst_rule||cvs).style.width=_w+"px"),cvs.style.height||((props.inst_rule||cvs).style.height=_h+"px"),cvs.setAttribute("width",_w*(ratio||1)),cvs.setAttribute("height",_h*(ratio||1)),$DE._saveCanvasPos(cvs),[_w,_h]},$DE.setCanvasPosition=function(cvs,x,y){var props=$DE.getAnmProps(cvs);props.usr_x=x,props.usr_y=y,$DE._saveCanvasPos(cvs)},$DE.setCanvasBackground=function(cvs,bg){($DE.getAnmProps(cvs).inst_rule||cvs).style.backgroundColor=bg},$DE._saveCanvasPos=function(cvs){var gcs=$doc.defaultView&&$doc.defaultView.getComputedStyle,cpl=gcs?parseInt(gcs(cvs,null).paddingLeft,10)||0:0,cpt=gcs?parseInt(gcs(cvs,null).paddingTop,10)||0:0,cbl=gcs?parseInt(gcs(cvs,null).borderLeftWidth,10)||0:0,cbt=gcs?parseInt(gcs(cvs,null).borderTopWidth,10)||0:0,html=$doc.body.parentNode,htol=html.offsetLeft,htot=html.offsetTop,elm=cvs,ol=cpl+cbl+htol,ot=cpt+cbt+htot;if(void 0!==elm.offsetParent)do ol+=elm.offsetLeft,ot+=elm.offsetTop;while(elm=elm.offsetParent);ol+=cpl+cbl+htol,ot+=cpt+cbt+htot;var props=$DE.getAnmProps(cvs);props.offset_left=ol||props.usr_x,props.offset_top=ot||props.usr_y},$DE.addCanvasOverlay=function(id,player_cvs,conf,callback){var p_props=$DE.getAnmProps(player_cvs),holder=p_props.wrapper||player_cvs.parentNode||$doc.body,x=conf[0],y=conf[1],w=conf[2],h=conf[3],pconf=$DE.getCanvasSize(player_cvs),pw=pconf[0],ph=pconf[1],p_style=window.getComputedStyle?window.getComputedStyle(player_cvs):player_cvs.currentStyle,x_shift=parseFloat(p_style.getPropertyValue("border-left-width")),y_shift=parseFloat(p_style.getPropertyValue("border-top-width")),new_w=w*pw,new_h=h*ph,cvs=$doc.createElement("canvas");cvs.id=p_props.id?"__"+p_props.id+"_"+id:"__anm_"+id;var props=$DE.getAnmProps(cvs);callback&&callback(cvs,player_cvs),$DE.setCanvasSize(cvs,new_w,new_h);var new_x=x*new_w+x_shift,new_y=y*new_h-y_shift;return $DE.moveElementTo(cvs,new_x,new_y),(holder||$doc.body).insertBefore(cvs,player_cvs.nextSibling),props.ref_canvas=player_cvs,p_props.overlays||(p_props.overlays=[]),p_props.overlays.push(cvs),cvs},$DE.updateCanvasOverlays=function(player_cvs){var p_props=$DE.getAnmProps(player_cvs),overlays=p_props.overlays;if(overlays)for(var i=0,il=overlays.length;il>i;i++)$DE.updateOverlay(player_cvs,overlays[i],p_props)},$DE.updateOverlay=function(player_cvs,overlay,p_props){p_props=p_props||$DE.getAnmProps(player_cvs),$DE.setCanvasSize(overlay,p_props.width,p_props.height)},$DE.registerAsControlsElement=function(elm,player){var rules=$DE.injectElementStyles(elm,$DE.CONTROLS_CLASS,$DE.CONTROLS_INSTANCE_CLASS_PREFIX+(player.id||"no-id"));$DE.styling.controlsGeneral(rules[0]),$DE.styling.controlsInstance(rules[1])},$DE.registerAsInfoElement=function(elm,player){var rules=$DE.injectElementStyles(elm,$DE.INFO_CLASS,$DE.INFO_INSTANCE_CLASS_PREFIX+(player.id||"no-id"));$DE.styling.infoGeneral(rules[0]),$DE.styling.infoInstance(rules[1])},$DE.getEventPosition=function(evt,elm){if(elm){var shift=$DE.findElementPosition(elm);return[evt.clientX-shift[0],evt.clientY-shift[1]]}return[evt.x,evt.y]},$DE.subscribeWindowEvents=function(handlers){for(var type in handlers)window.addEventListener(type,handlers[type],!1)},$DE.subscribeCanvasEvents=function(cvs,handlers){for(var type in handlers)cvs.addEventListener(type,handlers[type],!1)},$DE.unsubscribeCanvasEvents=function(cvs,handlers){for(var type in handlers)cvs.removeEventListener(type,handlers[type])},$DE.keyEvent=function(e){return{key:null!==e.keyCode?e.keyCode:e.which,ch:e.charCode}},$DE.mouseEvent=function(e,cvs){return{pos:$DE.getEventPosition(e,cvs)}},$DE.preventDefault=function(evt){evt.stopPropagation(),evt.preventDefault()};var _kevt=$DE.keyEvent,_mevt=$DE.mouseEvent;$DE.subscribeAnimationToEvents=function(cvs,anim,map){if(!cvs.__anm.subscribed||!cvs.__anm.subscribed[anim.id]){cvs.__anm.handlers||(cvs.__anm.handlers={}),cvs.__anm.subscribed||(cvs.__anm.subscribed={});var handlers=cvs.__anm.subscribed[anim.id]||{mouseup:function(evt){anim.fire(map.mouseup,_mevt(evt,cvs))},mousedown:function(evt){anim.fire(map.mousedown,_mevt(evt,cvs))},mousemove:function(evt){anim.fire(map.mousemove,_mevt(evt,cvs))},mouseover:function(evt){anim.fire(map.mouseover,_mevt(evt,cvs))},mouseout:function(evt){anim.fire(map.mouseout,_mevt(evt,cvs))},click:function(evt){anim.fire(map.click,_mevt(evt,cvs))},dblclick:function(evt){anim.fire(map.dblclick,_mevt(evt,cvs))},keyup:function(evt){anim.fire(map.keyup,_kevt(evt))},keydown:function(evt){anim.fire(map.keydown,_kevt(evt))},keypress:function(evt){anim.fire(map.keypress,_kevt(evt))}};cvs.__anm.handlers[anim.id]=handlers,cvs.__anm.subscribed[anim.id]=!0,$DE.subscribeCanvasEvents(cvs,handlers)}},$DE.unsubscribeAnimationFromEvents=function(cvs,anim){if(cvs.__anm.handlers&&cvs.__anm.subscribed&&cvs.__anm.subscribed[anim.id]){var handlers=cvs.__anm.handlers[anim.id];handlers&&$DE.unsubscribeCanvasEvents(cvs,handlers)}},$DE.subscribeWrapperToStateChanges=function(wrapper,player){if(wrapper.classList){var C=anm.constants;player.on(C.S_CHANGE_STATE,function(new_state){var css_classes=[];switch(new_state){case C.NOTHING:css_classes=["anm-state-nothing"];break;case C.STOPPED:css_classes=["anm-state-stopped"];break;case C.PLAYING:css_classes=["anm-state-playing"];break;case C.PAUSED:css_classes=["anm-state-paused"];break;case C.LOADING:css_classes=["anm-state-loading"];break;case C.RES_LOADING:css_classes=["anm-state-loading","anm-state-resources-loading"];break;case C.ERROR:css_classes=["anm-state-error"]}if(css_classes.length){var i,il,classList=wrapper.classList;if(player.__prev_classes&&player.__prev_classes.length){var prev_classes=player.__prev_classes;for(i=0,il=prev_classes.length;il>i;i++)classList.remove(prev_classes[i])}else classList.contains("anm-state-nothing")&&classList.remove("anm-state-nothing");for(i=0,il=css_classes.length;il>i;i++)classList.add(css_classes[i]);player.__prev_classes=css_classes}})}},$DE.createStatImg=function(){var img=$doc.createElement("img");return img.style.position="absolute",img.style.top="-9999px",img.style.left="-9999px",img.style.visibility="hidden",$doc.body.appendChild(img),img},$DE.createStyle=function(){var style=document.createElement("style");return style.type="text/css",style},$DE.createAudio=function(){return document.createElement("audio")},$DE.createSource=function(){return document.createElement("source")},$DE.appendToBody=function(element){document.body.appendChild(element)};var testCanvas=document.createElement("canvas");$DE.canvasSupported=!(!testCanvas.getContext||!testCanvas.getContext("2d"));var https=window.location&&"https:"===window.location.protocol;$DE.isHttps=https;var local=window.location&&"file:"===window.location.protocol;$DE.isLocal=local;var isIE9=-1!==navigator.userAgent.indexOf("MSIE 9.0");return $DE.isIE9=isIE9,module.exports=$DE,$DE}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],35:[function(require,module){(function(global){function findAndInitPotentialPlayers(){for(var matches=engine.findPotentialPlayers(),i=0,il=matches.length;il>i;i++)anm.createPlayer(matches[i])}var PUBLIC_NAMESPACE="anm",constants=require("./anm/constants.js"),engine=require("engine"),Player=require("./anm/player.js");engine.onDocReady(findAndInitPotentialPlayers);var Element=require("./anm/animation/element.js"),Sheet=require("./anm/graphics/sheet.js"),segments=require("./anm/graphics/segments.js"),anm={global:global,constants:constants,C:constants,modules:require("./anm/modules.js"),importers:require("./anm/importers.js"),conf:require("./anm/conf.js"),log:require("./anm/log.js"),engine:engine,events:require("./anm/events.js"),resource_manager:require("./anm/resource_manager.js"),player_manager:require("./anm/player_manager.js"),loc:require("./anm/loc.js"),errors:require("./anm/errors.js"),utils:require("./anm/utils.js"),Player:Player,Animation:require("./anm/animation/animation.js"),Element:Element,Clip:Element,Path:require("./anm/graphics/path.js"),Text:require("./anm/graphics/text.js"),Sheet:Sheet,Image:Sheet,Modifier:require("./anm/animation/modifier.js"),Painter:require("./anm/animation/painter.js"),Brush:require("./anm/graphics/brush.js"),Color:require("./anm/graphics/color.js"),Tween:require("./anm/animation/tween.js"),Audio:require("./anm/media/audio.js"),MSeg:segments.MSeg,LSeg:segments.LSeg,CSeg:segments.CSeg,createPlayer:function(elm,opts){if(!engine.canvasSupported)return document.getElementById(elm).innerHTML=anm.loc.Errors.S.SAD_SMILEY_HTML,null;var p=new Player;return p.init(elm,opts),p},createImporter:function(importer){return window.console&&console.warn("anm.createImporter is deprecated and will be removed soon. Please use anm.importers.create instead"),anm.importers.create(importer)}};global[PUBLIC_NAMESPACE]=anm,module.exports=anm}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./anm/animation/animation.js":1,"./anm/animation/element.js":4,"./anm/animation/modifier.js":5,"./anm/animation/painter.js":6,"./anm/animation/tween.js":7,"./anm/conf.js":8,"./anm/constants.js":9,"./anm/errors.js":10,"./anm/events.js":11,"./anm/graphics/brush.js":14,"./anm/graphics/color.js":15,"./anm/graphics/path.js":16,"./anm/graphics/segments.js":17,"./anm/graphics/sheet.js":18,"./anm/graphics/text.js":19,"./anm/importers.js":20,"./anm/loc.js":22,"./anm/log.js":23,"./anm/media/audio.js":24,"./anm/modules.js":25,"./anm/player.js":26,"./anm/player_manager.js":27,"./anm/resource_manager.js":29,"./anm/utils.js":33,engine:34}],36:[function(require,module){var FontDetector=function(){function detect(font){var detected=!1;for(var index in baseFonts){s.style.fontFamily=font+","+baseFonts[index],h.appendChild(s);var matched=s.offsetWidth!=defaultWidth[baseFonts[index]]||s.offsetHeight!=defaultHeight[baseFonts[index]];h.removeChild(s),detected=detected||matched}return detected}var baseFonts=["monospace","sans-serif","serif"],testString="mmmmmmmmmmlli",testSize="72px",h=document.getElementsByTagName("body")[0],s=document.createElement("span");s.style.fontSize=testSize,s.style.position="absolute",s.style.top="-9999px",s.style.left="-9999px",s.innerHTML=testString;var defaultWidth={},defaultHeight={};for(var index in baseFonts)s.style.fontFamily=baseFonts[index],h.appendChild(s),defaultWidth[baseFonts[index]]=s.offsetWidth,defaultHeight[baseFonts[index]]=s.offsetHeight,h.removeChild(s);this.detect=detect};"undefined"!=typeof module&&(module.exports=FontDetector)},{}],37:[function(require,module){/*
 * Storing Transform Matrix
 * ===========================================
 * Last updated September 2011 by Simon Sarris
 * www.simonsarris.com
 * sarris@acm.org
 *
 * Free to use and distribute at will
 * So long as you are nice to people, etc
 *
 * (slightly modified by shaman.sir@gmail.com) */
function Transform(){this.m=[1,0,0,1,0,0]}Transform.prototype.reset=function(){this.m=[1,0,0,1,0,0]},Transform.prototype.multiply=function(matrix){var m11=this.m[0]*matrix.m[0]+this.m[2]*matrix.m[1],m12=this.m[1]*matrix.m[0]+this.m[3]*matrix.m[1],m21=this.m[0]*matrix.m[2]+this.m[2]*matrix.m[3],m22=this.m[1]*matrix.m[2]+this.m[3]*matrix.m[3],dx=this.m[0]*matrix.m[4]+this.m[2]*matrix.m[5]+this.m[4],dy=this.m[1]*matrix.m[4]+this.m[3]*matrix.m[5]+this.m[5];this.m[0]=m11,this.m[1]=m12,this.m[2]=m21,this.m[3]=m22,this.m[4]=dx,this.m[5]=dy},Transform.prototype.invert=function(){var d=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),m0=this.m[3]*d,m1=-this.m[1]*d,m2=-this.m[2]*d,m3=this.m[0]*d,m4=d*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),m5=d*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);this.m[0]=m0,this.m[1]=m1,this.m[2]=m2,this.m[3]=m3,this.m[4]=m4,this.m[5]=m5},Transform.prototype.rotate=function(rad){var c=Math.cos(rad),s=Math.sin(rad),m11=this.m[0]*c+this.m[2]*s,m12=this.m[1]*c+this.m[3]*s,m21=this.m[0]*-s+this.m[2]*c,m22=this.m[1]*-s+this.m[3]*c;this.m[0]=m11,this.m[1]=m12,this.m[2]=m21,this.m[3]=m22},Transform.prototype.rotateDegrees=function(angle){var rad=angle*Math.PI/180,c=Math.cos(rad),s=Math.sin(rad),m11=this.m[0]*c+this.m[2]*s,m12=this.m[1]*c+this.m[3]*s,m21=this.m[0]*-s+this.m[2]*c,m22=this.m[1]*-s+this.m[3]*c;this.m[0]=m11,this.m[1]=m12,this.m[2]=m21,this.m[3]=m22},Transform.prototype.translate=function(x,y){this.m[4]+=this.m[0]*x+this.m[2]*y,this.m[5]+=this.m[1]*x+this.m[3]*y},Transform.prototype.scale=function(sx,sy){this.m[0]*=sx,this.m[1]*=sx,this.m[2]*=sy,this.m[3]*=sy},Transform.prototype.transformPoint=function(x,y){return{x:x*this.m[0]+y*this.m[2]+this.m[4],y:x*this.m[1]+y*this.m[3]+this.m[5]}},Transform.prototype.shear=function(hx,hy){var m11=this.m[0]+this.m[2]*hy,m12=this.m[1]+this.m[3]*hy,m21=this.m[0]*hx+this.m[2],m22=this.m[1]*hx+this.m[3];this.m[0]=m11,this.m[1]=m12,this.m[2]=m21,this.m[3]=m22},Transform.prototype.apply=function(ctx){var m=this.m;ctx.transform(m[0],m[1],m[2],m[3],m[4],m[5])},Transform.prototype.clone=function(){var cl=new Transform;return cl.m[0]=this.m[0],cl.m[1]=this.m[1],cl.m[2]=this.m[2],cl.m[3]=this.m[3],cl.m[4]=this.m[4],cl.m[5]=this.m[5],cl},Transform.prototype.inverted=function(){var clone=this.clone();return clone.invert(),clone},"undefined"!=typeof module&&(module.exports=Transform)},{}]},{},[35]);var AnimatronImporter=function(){function _reportError(e){$log.error(e)}function BitStream(int8array){this.buf=int8array,this.pos=0,this.bitPos=0,this.bitsBuf=0}function Base64Decoder(){}function ValueCache(){this.hash2val={}}function __MYSELF(){}var cur_import_id,IMPORTER_ID="ANM",C=anm.constants,Animation=anm.Animation,Element=anm.Element,Path=anm.Path,Text=anm.Text,Brush=anm.Brush,Tween=(anm.Bands,anm.Tween),MSeg=anm.MSeg,LSeg=anm.LSeg,CSeg=anm.CSeg,Audio=anm.Audio,is=anm.utils.is,$log=anm.log,Import={};Import._find=function(idx,src){var res=src[idx];return res||_reportError("Element with index "+idx+" was not found"+(src?" among "+src.length+" elements.":".")),src[idx]},Import._type=function(src){return src[0]},Import.project=function(prj){anm.conf.logImport&&$log.debug(prj),cur_import_id=anm.utils.guid(),anm.lastImportedProject=prj,anm.lastImportId=cur_import_id;var scenes_ids=prj.anim.scenes;scenes_ids.length||_reportError("No scenes found in given project");var root=new Animation,elems=prj.anim.elements,last_scene_band=[0,0];root.__import_id=cur_import_id,root.meta=Import.meta(prj),root.fonts=Import.fonts(prj),Import.root=root,Import.anim(prj,root),prj.meta.duration&&(root.duration=prj.meta.duration);prj.anim;Import._paths=prj.anim.paths,Import._path_cache=new ValueCache;for(var node_res,traverseFunc=function(elm){var e_gband_before=elm.gband;elm.gband=[last_scene_band[1]+e_gband_before[0],last_scene_band[1]+e_gband_before[1]]},i=0,il=scenes_ids.length;il>i;i++){var node_src=Import._find(scenes_ids[i],elems);if(Import._type(node_src)!=TYPE_SCENE&&_reportError("Given Scene ID "+scenes_ids[i]+" points to something else"),node_res=Import.node(node_src,elems,null,root),node_res.gband[0]!=node_res.gband[1]){if(i>0){var gband_before=node_res.gband;node_res.gband=[last_scene_band[1]+gband_before[0],last_scene_band[1]+gband_before[1]],node_res.lband=node_res.gband,node_res.traverse(traverseFunc)}last_scene_band=node_res.gband,root.add(node_res)}}return scenes_ids.length>0&&(node_res.gband=[last_scene_band[0],1/0],node_res.lband=node_res.gband),Import._paths=void 0,Import._path_cache=void 0,root},Import.meta=function(prj){var _m=prj.meta;return{title:_m.name,author:_m.author,copyright:_m.copyright,version:_m.version,description:_m.description,duration:_m.duration,created:_m.created,modified:_m.modified,_anm_id:_m.id}},Import.fonts=function(prj){return prj.anim.fonts},Import.anim=function(prj,trg){var _a=prj.anim;trg.fps=_a.framerate,trg.width=_a.dimension?Math.floor(_a.dimension[0]):void 0,trg.height=_a.dimension?Math.floor(_a.dimension[1]):void 0,trg.bgfill=_a.background?Import.fill(_a.background):void 0,trg.zoom=_a.zoom||1,trg.speed=_a.speed||1,!_a.loop||_a.loop!==!0&&"true"!==_a.loop||(trg.repeat=!0)};var TYPE_UNKNOWN=0,TYPE_CLIP=1,TYPE_SCENE=2,TYPE_TEXT=4,TYPE_IMAGE=8,TYPE_GROUP=9,TYPE_AUDIO=14,TYPE_VIDEO=26,TYPE_LAYER=255;Import.node=function(src,all,parent,anim){var type=Import._type(src),trg=null;return type==TYPE_CLIP||type==TYPE_SCENE||type==TYPE_GROUP?trg=Import.branch(type,src,all,anim):type!=TYPE_UNKNOWN&&(trg=Import.leaf(type,src,parent,anim)),trg&&(trg._anm_type=type,Import.callCustom(trg,src,type)),trg};var L_ROT_TO_PATH=1;L_VISIBLE=4,Import.branch=function(type,src,all,anim){var trg=new Element;trg.name=src[1];var _layers=type==TYPE_SCENE?src[3]:src[2],_layers_targets=[];type==TYPE_SCENE?(trg.gband=[0,src[2]],trg.lband=[0,src[2]]):(trg.gband=[0,1/0],trg.lband=[0,1/0]);for(var li=_layers.length;li--;){var lsrc=_layers[li],nsrc=Import._find(lsrc[0],all);if(nsrc){var ltrg=Import.node(nsrc,all,trg,anim);ltrg.name||(ltrg.name=lsrc[1]);var flags=lsrc[6];ltrg.disabled=!(flags&L_VISIBLE);var b=Import.band(lsrc[2]);if(ltrg.lband=b,ltrg.gband=b,ltrg.$pivot=[0,0],ltrg.$reg=lsrc[4]||[0,0],lsrc[7]){for(var translates,tweens=lsrc[7],ti=0,tl=tweens.length;tl>ti;ti++){var t=Import.tween(tweens[ti]);t&&(t.tween==C.T_TRANSLATE&&(translates||(translates=[]),translates.push(t)),ltrg.tween(t))}if(translates&&flags&L_ROT_TO_PATH){var rtp_tween;for(ti=0,til=translates.length;til>ti;ti++)rtp_tween=new Tween(C.T_ROT_TO_PATH),translates[ti].$band&&rtp_tween.band(translates[ti].$band),translates[ti].$easing&&rtp_tween.easing(translates[ti].$easing),ltrg.tween(rtp_tween)}translates=[]}if(lsrc[5]?(ltrg.mode=Import.mode(lsrc[5][0]),lsrc[5].length>1&&(ltrg.nrep=lsrc[5][1]||1/0)):ltrg.mode=Import.mode(null),ltrg._anm_type==TYPE_CLIP&&ltrg.mode!=C.R_ONCE&&(ltrg.asClip([0,ltrg.lband[1]-ltrg.lband[0]],ltrg.mode,ltrg.nrep),ltrg.lband=[ltrg.lband[0],1/0],ltrg.gband=[ltrg.gband[0],1/0],ltrg.mode=C.R_STAY,ltrg.nrep=1/0),lsrc[3]){var mask=ltrg,togo=lsrc[3],targets_n=_layers_targets.length;for(togo>targets_n&&(_reportError("No layers collected to apply mask, expected "+togo+", got "+targets_n),togo=targets_n);togo;){var masked=_layers_targets[targets_n-togo];masked.mask(mask),togo--}}else trg.add(ltrg),_layers_targets.push(ltrg);Import.callCustom(ltrg,lsrc,TYPE_LAYER),ltrg.$audio&&ltrg.$audio.master&&(ltrg.lband=[ltrg.lband[0],1/0],ltrg.gband=[ltrg.gband[0],1/0],trg.remove(ltrg),anim.add(ltrg))}}return trg},Import.leaf=function(type,src){var trg=new Element;return type==TYPE_IMAGE?trg.$image=Import.sheet(src):type==TYPE_TEXT?trg.$text=Import.text(src):type==TYPE_AUDIO?(trg.type=C.ET_AUDIO,trg.$audio=Import.audio(src),trg.$audio.connect(trg)):type==TYPE_VIDEO||(trg.$path=Import.path(src)),(trg.$path||trg.$text)&&(trg.$fill=Import.fill(src[1]),trg.$stroke=Import.stroke(src[2]),trg.$shadow=Import.shadow(src[3])),trg},Import.callCustom=function(trg,src,type){if(Element._customImporters&&Element._customImporters.length)for(var importers=Element._customImporters,i=0,il=importers.length;il>i;i++)importers[i].call(trg,src,type,IMPORTER_ID,cur_import_id)},Import.band=function(src){return src&&src.length?1==src.length?[src[0],1/0]:2==src.length?src:void _reportError("Unknown format of band: "+src):[0,1/0]},Import.path=function(src){var path=Import._pathDecode(src[4]);if(path)return new Path(path)},Import._pathDecode=function(src){if(is.str(src))return src;if(!is.num(src)||-1==src)return null;var encoded=Import._paths[src];if(encoded){var val=Import._path_cache.get(encoded);return val?[].concat(val.segs):(val=Import._decodeBinaryPath(encoded))?(Import._path_cache.put(encoded,val),val.segs):null}},Import._decodeBinaryPath=function(encoded){var path=new Path;if(encoded){encoded=encoded.replace(/\s/g,"");try{var decoded=Base64Decoder.decode(encoded),s=new BitStream(decoded),base=[0,0];if(!s)return _reportError('Unable to decode Path "'+encoded+'"'),null;for(var _do=!0;_do;){var p,type=s.readBits(2);switch(type){case 0:p=Import._pathReadPoint(s,[],base),base=p,path.add(new MSeg(p));break;case 1:p=Import._pathReadPoint(s,[],base),base=p,path.add(new LSeg(p));break;case 2:p=Import._pathReadPoint(s,[],base),Import._pathReadPoint(s,p),Import._pathReadPoint(s,p),base=[p[p.length-2],p[p.length-1]],path.add(new CSeg(p));break;case 3:_do=!1;break;default:_do=!1,_reportError('Unknown type "'+type+' for path "'+encoded+'"')}}}catch(err){return _reportError('Unable to decode Path "'+encoded+'"'),null}}return path},Import._pathReadPoint=function(stream,target,base){var l=stream.readBits(5);if(0>=l)throw new Error("Failed to decode path, wrong length (<= 0)");var x=stream.readSBits(l),y=stream.readSBits(l),b_x=base?base[0]:target.length?target[target.length-2]:0,b_y=base?base[1]:target.length?target[target.length-1]:0;return target.push(b_x+x/1e3),target.push(b_y+y/1e3),target};var TEXT_UNDERLINE=1,TEXT_MID_BASELINE=2;Import.text=function(src){var lines=is.arr(src[6])?src:src[6].split("\n");return new Text(lines.length>1?lines:lines[0],src[4],src[5],src[7]&TEXT_MID_BASELINE?"middle":"bottom",src[7]&TEXT_UNDERLINE?!0:!1)},Import.sheet=function(src){var sheet=new anm.Sheet(src[1]);return src[2]&&(sheet._dimen=src[2]),sheet},Import.tween=function(src){var type=Import.tweentype(src[0]);if(null===type)return null;var tween=new Tween(type,Import.tweendata(type,src[3])).band(Import.band(src[1])),easing=Import.easing(src[2]);return easing&&tween.easing(easing),tween},Import.tweentype=function(src){return 0===src?C.T_ALPHA:1===src?C.T_ROTATE:2===src?C.T_SCALE:3===src?C.T_SHEAR:4===src?C.T_TRANSLATE:7===src?C.T_VOLUME:9===src?C.T_FILL:10===src?C.T_STROKE:11===src?C.T_SHADOW:void 0},Import.tweendata=function(type,src){if(null===src)return null;if(type===C.T_TRANSLATE)return Import.pathval(src);if(type===C.T_ROTATE||type===C.T_ALPHA){if(2==src.length)return src;if(1==src.length)return[src[0],src[0]]}if(type===C.T_SCALE||type===C.T_SHEAR){if(4==src.length)return[[src[0],src[1]],[src[2],src[3]]];if(2==src.length)return[[src[0],src[1]],[src[0],src[1]]];if(1==src.length)return[[src[0],src[0]],[src[0],src[0]]]}if(type===C.T_FILL)return[Import.fill(src[0]),Import.fill(src[1])];if(type===C.T_STROKE)return[Import.stroke(src[0]),Import.stroke(src[1])];if(type===C.T_SHADOW)return[Import.shadow(src[0]),Import.shadow(src[1])];if(type===C.T_VOLUME){if(2==src.length)return src;if(1==src.length)return[src[0],src[0]]}},Import.easing=function(src){return src?is.str(src)?{type:C.E_PATH,data:Import.pathval("M0 0 "+src+" Z")}:is.num(src)?{type:C.E_STDF,data:src}:void 0:null},Import.mode=function(src){return src?0===src?C.R_ONCE:1===src?C.R_LOOP:2===src?C.R_BOUNCE:3===src?C.R_STAY:void 0:C.R_ONCE},Import.fill=function(src){return src?is.str(src)?Brush.fill(src):is.arr(src)?Brush.fill(is.arr(src[0])?Import.grad(src):Import.pattern(src)):void _reportError("Unknown type of brush"):Brush.fill("transparent")},Import.stroke=function(src){if(!src)return null;var fill;return is.str(src[1])?fill=src[1]:is.arr(src[1])&&(fill=is.arr(src[1][0])?Import.grad(src[1]):Import.pattern(src[1])),Brush.stroke(fill,src[0],src[2]||C.PC_ROUND,src[3]||C.PC_ROUND,src[4])},Import.shadow=function(src){return src?Brush.shadow(src[3],src[2],src[0],src[1]):null},Import.grad=function(src){var pts=src[0],colors=src[1],offsets=src[2];colors.length!=offsets.length&&_reportError("Number of colors do not corresponds to number of offsets in gradient");for(var stops=[],i=0;i<offsets.length;i++)stops.push([offsets[i],colors[i]]);return 4==pts.length?{dir:[[pts[0],pts[1]],[pts[2],pts[3]]],stops:stops}:6==pts.length?{r:[pts[2],pts[5]],dir:[[pts[0],pts[1]],[pts[3],pts[4]]],stops:stops}:void _reportError("Unknown type of gradient with "+pts.length+" points")};var repeats=["no-repeat","repeat","repeat-x","repeat-y"];Import.pattern=function(src){var el=anm.lastImportedProject.anim.elements[src[0]],elm=Import.leaf(Import._type(el),el);return elm.alpha=src[5],elm.disabled=!0,Import.root.add(elm),{elm:elm,repeat:repeats[src[1]],w:src[2],h:src[3],bounds:src[4]}},Import.pathval=function(src){return new Path(Import._pathDecode(src))},Import.audio=function(src){var audio=new Audio(src[1]);return audio.offset=src[2],audio.master=src[3],audio},BitStream.prototype.readBits=function(n){for(var v=0;;){var s=n-this.bitPos;if(!(s>0))return s=-s,v|=this.bitBuf>>s,this.bitPos=s,this.bitBuf&=(1<<s)-1,v;v|=this.bitBuf<<s,n-=this.bitPos,this.bitBuf=this.readUByte(),this.bitPos=8}},BitStream.prototype.readUByte=function(){return 255&this.buf[this.pos++]},BitStream.prototype.readSBits=function(n){var v=this.readBits(n);return 0!==(v&1<<n-1)&&(v|=-1<<n),v},Base64Decoder.decode=function(str){return Base64Decoder.str2ab(Base64Decoder._decode(str))};var Int8Array=window.Int8Array||Array;return Base64Decoder.str2ab=function(str){for(var result=new Int8Array(str.length),i=0,strLen=str.length;strLen>i;i++)result[i]=str.charCodeAt(i);return result},Base64Decoder._decode=function(data){if(window.atob)return atob(data);var o1,o2,o3,h1,h2,h3,h4,bits,b64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i=0,ac=0,dec="",tmp_arr=[];if(!data)return data;data+="";do h1=b64.indexOf(data.charAt(i++)),h2=b64.indexOf(data.charAt(i++)),h3=b64.indexOf(data.charAt(i++)),h4=b64.indexOf(data.charAt(i++)),bits=h1<<18|h2<<12|h3<<6|h4,o1=bits>>16&255,o2=bits>>8&255,o3=255&bits,tmp_arr[ac++]=64==h3?String.fromCharCode(o1):64==h4?String.fromCharCode(o1,o2):String.fromCharCode(o1,o2,o3);while(i<data.length);return dec=tmp_arr.join("")},ValueCache.prototype.put=function(str,val){this.hash2val[this.hash(str)]=val},ValueCache.prototype.get=function(str){return this.hash2val[this.hash(str)]},ValueCache.prototype.hash=function(str){var i,char,hash=0;if(0===str.length)return hash;for(i=0,l=str.length;l>i;i++)char=str.charCodeAt(i),hash=(hash<<5)-hash+char,hash|=0;return hash},__MYSELF.prototype.load=Import.project,__MYSELF.Import=Import,__MYSELF.IMPORTER_ID=IMPORTER_ID,__MYSELF}();anm.importers.register("animatron",AnimatronImporter);var Player=anm.Player,E=anm.Element,is=anm.utils.is,log=anm.log;E._customImporters.push(function(source,type,importer){if("ANM"===importer)switch(type){case 2:source[4]&&is.not_empty(source[4])&&log.warn("Scripting from Animatron Editor is temporarily not supported");case 255:source[8]&&is.not_empty(source[8])&&log.warn("Scripting from Animatron Editor is temporarily not supported")}});var conf={};anm.modules.register("scripting",conf),anm.modules.register("shapes",{});var E=anm.Element,Path=anm.Path,MSeg=anm.MSeg,LSeg=anm.LSeg,CSeg=anm.CSeg;E.prototype.rect=function(x,y,width,height){var path=new Path;return path.add(new MSeg([x,y])),path.add(new LSeg([x+width,y])),path.add(new LSeg([x+width,y+height])),path.add(new LSeg([x,y+height])),path.add(new LSeg([x,y])),this.path(path)};

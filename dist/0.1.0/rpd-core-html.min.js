/* RPD v0.1.0
 http://shamansir.github.io/rpd
 LICENSE: MIT (c) 2015 Anton Kotenko <shaman.sir@gmail.com> */

var Rpd=function(){function h(a){this.name=a;this.targets=Kefir.emitter();this.renderers=Kefir.emitter();a={"model/new":function(a){return{model:a}},"node/add":function(a){return{node:a}},"node/remove":function(a){return{node:a}}};this.event=G(a);this.events=J(a,this.event);Kefir.combine([this.events,this.targets.scan(P),this.renderers.scan(P)]).onValue(function(a){var b=a[0],d=a[2];K(a[1],function(a){K(d,function(x){x(a,b)})})});this.event["model/new"].emit(this)}function l(a,b){this.type=a||"core/empty";
this.id=H();var k=C(r[this.type]);k||D("Node type "+this.type+" is not registered!");this.def=k;this.name=b||k.name||"Unnamed";this.def=k;this.render=L(k.render);var d=this,k={"node/turn-on":function(a){return{node:d}},"node/ready":function(a){return{node:d}},"node/process":function(a){return{inlets:a[0],outlets:a[1],node:d}},"node/turn-off":function(a){return{node:d}},"inlet/add":function(a){return{inlet:a}},"inlet/remove":function(a){return{inlet:a}},"outlet/add":function(a){return{outlet:a}},"outlet/remove":function(a){return{outlet:a}}};
this.event=G(k);this.events=J(k,this.event);y[E]?y[E].addNode(this):D("No model started!");if(this.def.handle)this.events.onValue(function(a){if(d.def.handle[a.type])d.def.handle[a.type](a)});if(this.def.process){var e=this.def.process,d=this;Kefir.combine([this.event["inlet/add"].flatMap(function(a){var b=a.event["inlet/update"].map(function(b){return{inlet:a.alias,value:b}});d.def.tune&&(b=d.def.tune(b));return b}).scan(function(a,b){var x=b.inlet,d,c;if(a)return d=a.prev,c=a.cur,d[x]=c[x],c[x]=
b.value,a;d={};c={};c[x]=b.value;return{prev:d,cur:c}},null),this.event["outlet/add"].scan(function(a,b){a=a||{};a[b.alias]=b;return a},null)]).onValue(function(a){var b=a[0]||{prev:{},cur:{}};a=a[1]||{};var x=e(b.cur,b.prev);d.event["node/process"].emit([b.cur,x,b.prev]);for(var c in x)a[c]&&a[c].send(x[c])})}if(this.def.inlets){this.inlets={};for(var c in this.def.inlets)k=this.def.inlets[c],k=this.addInlet(k.type,c,k.name,k.default,k.hidden,k.readonly),this.inlets[c]=k}if(this.def.outlets)for(c in this.outlets=
{},this.def.outlets)k=this.def.outlets[c],k=this.addOutlet(k.type,c,k.name,k.default),this.outlets[c]=k;this.def.prepare&&this.def.prepare(this.inlets,this.outlets);this.event["node/ready"].emit(this)}function b(a,b,d,e,f,h,A){this.type=a||"core/bool";this.id=H();var g=C(c[this.type]);g||D("Inlet type "+this.type+" is not registered!");this.def=g;(this.alias=d||e||g.alias)||D("Inlet should have either alias or name");this.name=e||this.alias||g.name||"Unnamed";this.node=b;this.hidden=h||!1;this.readonly=
N(A||g.readonly)?A||g.readonly:!0;this.default=N(f)?f:g.default;this.value=Kefir.bus();this.render=L(g.render);var E=this;a={"inlet/update":function(a){return{inlet:E,value:a}}};this.event=G(a);var l=this.event["inlet/update"];b=l.merge(this.value);g.tune&&(b=g.tune(b));g.accept&&(b=b.flatten(function(a){if(g.accept(a))return[a];l.error();return[]}));g.adapt&&(b=b.map(g.adapt));this.event["inlet/update"]=b.onValue(function(){});this.events=J(a,this.event)}function g(a,b,d,e,f){this.type=a||"core/bool";
this.id=H();(a=C(c[this.type]))||D("Outlet type "+this.type+" is not registered!");this.def=a;(this.alias=d||e||a.alias)||D("Outlet should have either alias or name");this.name=e||this.alias||a.name||"Unnamed";this.node=b;this.default=N(f)?f:a.default;this.value=Kefir.bus();this.render=L(a.render);var g=this;b={"outlet/update":function(a){return{outlet:g,value:a}},"outlet/connect":function(a){return{outlet:g,link:a}},"outlet/disconnect":function(a){return{outlet:g,link:a}}};this.event=G(b);this.event["outlet/update"]=
this.event["outlet/update"].merge(this.value).onValue(function(){});this.events=J(b,this.event);Kefir.sampledBy([this.event["outlet/update"]],[this.event["outlet/connect"]]).onValue(function(a){g.value.emit(a[0])})}function w(a,b,c,e,g){this.type=a||"core/value";this.id=H();(a=C(d[this.type]))||D("Link type "+this.type+" is not registered!");this.def=a;this.name=g||a.name||"";this.outlet=b;this.inlet=c;this.adapter=e||a.adapt||void 0;var f=this;this.receiver=b.node.id!==c.node.id?function(a){return function(b){a.pass(b)}}(f):
function(a){setTimeout(function(){f.pass(a)},0)};b={"link/enable":function(){return{link:f}},"link/disable":function(){return{link:f}},"link/pass":function(a){return{link:f,value:a}},"link/adapt":function(a){return{link:f,before:a[0],after:a[1]}}};this.event=G(b);this.events=J(b,this.event);this.enabled=Kefir.merge([this.event["link/disable"].mapTo(!1),this.event["link/enable"].mapTo(!0)]).toProperty(!0);this.event["link/pass"].filterBy(this.enabled).onValue(function(a){c.receive(f.adapt(a))});Kefir.sampledBy([this.event["link/pass"]],
[this.event["link/enable"]]).onValue(function(a){f.pass(a[0])})}function N(a){return"undefined"!==typeof a}function C(a){return a?"function"===typeof a?a():a:null}function L(a){if(!a)return{};var b={},d;for(d in a)b[d]=C(a[d]);return b}function G(a){var b={},d;for(d in a)b[d]=Kefir.emitter();return b}function J(a,b){var d=Kefir.pool(),c;for(c in a)(function(a,c){d.plug(b[a].map(function(b){b=c(b);b.type=a;return b}))})(c,a[c]);return d}function D(a,b){b=b||Error(a);console&&(console.error?console.error(b):
console.log(b));throw b;}function H(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}function P(a,b){return[b,Array.isArray(a)?a:[a,null]]}function K(a,b){a&&(Array.isArray(a)?(b(a[0]),K(a[1],b)):b(a))}function O(a,b,d){for(var c=[],e=0,f=b.length;e<f;e++)c.push(b[e](d));return function(b,d){a(b,d);for(var e=0,f=c.length;e<f;e++)c[e](b,d)}}var r={},d={},c={},f={},e={},E=-1,y=[];h.prototype.attachTo=function(a){this.targets.emit(a);return this};h.prototype.addNode=function(a){this.events.plug(a.events);
this.event["node/add"].emit(a);a.turnOn();return this};h.prototype.removeNode=function(a){a.turnOff();this.event["node/remove"].emit(a);this.events.unplug(a.events);return this};h.prototype.renderWith=function(a,b){if(!f[a])throw Error("Renderer "+a+" is not registered");var d=f[a](b);e[a]&&e[a].length?this.renderers.emit(O(d,e[a]),b):this.renderers.emit(d);return this};h.start=function(a){a=new h(a);y.push(a);E++;return a};l.prototype.turnOn=function(){this.event["node/turn-on"].emit(this)};l.prototype.turnOff=
function(){this.event["node/turn-off"].emit(this)};l.prototype.addInlet=function(a,d,c,e,f,g){a=new b(a,this,d,c,e,f,g);this.events.plug(a.events);this.event["inlet/add"].emit(a);a.toDefault();return a};l.prototype.addOutlet=function(a,b,d,c){a=new g(a,this,b,d,c);this.events.plug(a.events);this.event["outlet/add"].emit(a);return a};l.prototype.removeInlet=function(a){this.event["inlet/remove"].emit(a);this.events.unplug(a.events)};l.prototype.removeOutlet=function(a){this.event["outlet/remove"].emit(a);
this.events.unplug(a.events)};b.prototype.receive=function(a){this.value.emit(a)};b.prototype.stream=function(a){this.value.plug(a)};b.prototype.toDefault=function(){N(this.default)&&this.default instanceof Kefir.Stream?this.stream(this.default):this.receive(this.default)};g.prototype.connect=function(a,b){var d=new w(null,this,a,b);this.events.plug(d.events);this.value.onValue(d.receiver);this.event["outlet/connect"].emit(d);return d};g.prototype.disconnect=function(a){this.event["outlet/disconnect"].emit(a);
this.value.offValue(a.receiver);this.events.unplug(a.events)};g.prototype.send=function(a){this.value.emit(this.adapt?this.adapt(a):a)};g.prototype.stream=function(a){this.value.plug(this.adapt?a.map(this.adapt):a)};w.prototype.pass=function(a){this.event["link/pass"].emit(a)};w.prototype.adapt=function(a){if(this.adapter){var b=this.adapter(a);this.event["link/adapt"].emit([a,b]);return b}this.event["link/adapt"].emit([a,a]);return a};w.prototype.enable=function(){this.event["link/enable"].emit()};
w.prototype.disable=function(){this.event["link/disable"].emit()};w.prototype.disconnect=function(){this.outlet.disconnect(this)};return{Model:h,Node:l,Inlet:b,Outlet:g,Link:w,nodetype:function(a,b){r[a]=b},linktype:function(a,b){d[a]=b},channeltype:function(a,b){c[a]=b},renderer:function(a,b){f[a]=b},subrenderer:function(a,b){e[a]||(e[a]=[]);e[a].push(b)},noderenderer:function(a,b,d){if(!r[a])throw Error("Node type "+a+" is not registered");r[a].render||(r[a].render={});r[a].render[b]=d},channelrenderer:function(a,
b,d){if(!c[a])throw Error("Channel type "+a+" is not registered");c[a].render||(c[a].render={});c[a].render[b]=d},allNodeTypes:r,currentModel:function(){return y[E]}}}();(function(){function h(d){function c(a){a.preventDefault();a.stopPropagation()}function f(a){return{x:a.clientX,y:a.clientY}}function e(a){a=a.getBoundingClientRect();return{x:a.left,y:a.top}}function h(a){return function(b){return{pos:b,target:a}}}function y(a){return!a}function a(a,b,d,e){Kefir.fromEvent(a,"click").tap(c).mapTo(e||!1).scan(y).onValue(function(a){a?b():d()})}function r(a,d,u,e,m){m=b("div","rpd-value-editor");var q=Kefir.emitter(),f=Kefir.emitter();d.disableEditor=f;a.render.html.edit(m,
a,q).onValue(function(b){a.receive(b)});Kefir.sampledBy([a.event["inlet/update"]],[Kefir.merge([Kefir.fromEvent(e,"click").tap(c).mapTo(!0),Kefir.fromEvent(u,"click").merge(f).mapTo(!1)]).toProperty(!1).skipDuplicates()]).map(function(a){return{lastValue:a[0],startEditing:a[1],cancelEditing:!a[1]}}).onValue(function(a){a.startEditing?(d.link&&d.link.disable(),q.emit(a.lastValue),e.classList.add("rpd-editor-enabled")):a.cancelEditing&&e.classList.remove("rpd-editor-enabled")});e.classList.add("rpd-editor-disabled");
e.appendChild(m)}function k(a,b){if(b)for(var d in b)(function(b,d){a.event["inlet/add"].filter(function(a){return a.alias===d}).onValue(function(a){b.default&&a.receive(b.default());if(b.valueOut)b.valueOut.onValue(function(b){a.receive(b)})})})(b[d],d)}function H(a,b){for(var d,c,m,q=0,f=b.length;q<f;q++)d=b[q].link,c=b[q].elm,m=B[d.inlet.id].connectorElm,d=M[d.outlet.id].connectorElm,m=e(m),d=e(d),L(c,d.x,d.y,m.x,m.y)}function K(a,b,d,g){d.classList.add("rpd-drag-handle");var m;Kefir.fromEvent(d,
"mousedown").map(f).flatMap(function(a){g.classList.add("rpd-dragging");var d=e(g),u=a.x-d.x,n=a.y-d.y;m=null;g.style.zIndex=1;return Kefir.fromEvent(b,"mousemove").tap(c).takeUntilBy(Kefir.fromEvent(b,"mouseup")).map(f).map(function(a){return{x:a.x-u,y:a.y-n}}).onEnd(function(){g.classList.remove("rpd-dragging");g.style.zIndex=0;if(m)for(var a=0,b=m.length;a<b;a++)m[a].elm.style.zIndex=2})}).onValue(function(b){g.style.left=b.x+"px";g.style.top=b.y+"px";m||(m=G(a,I,function(a){a.elm.style.zIndex=
3}));H(a,m)})}function P(d,e){var u={},f=[],m,q,z,h;for(m in e)z=m.split("/"),q=z[0],h=z[1],f.push([z,q,h]),u[q]||(u[q]={}),u[q][h]=e[m];var n=b("dl","rpd-nodelist"),v,Q,p,k,R;for(q in u){p=g("dd","rpd-toolkit-name",q);n.appendChild(p);z=b("dt");Q=b("dl","rpd-toolkit");f=u[q];for(h in f)m=q+"/"+h,v=f[h],k=g("dd","rpd-node-title",h),R=g("span","rpd-add-node","+ Add"),k.appendChild(R),v=g("dd","rpd-node-description",v.description||"No Description"),Q.appendChild(k),Q.appendChild(v),v.classList.add("rpd-collapsed"),
function(b){a(k,function(){b.classList.add("rpd-collapsed")},function(){b.classList.remove("rpd-collapsed")})}(v),function(a){Kefir.fromEvent(R,"click").tap(c).onValue(function(){new Rpd.Node(a)})}(m);z.appendChild(Q);n.appendChild(z);(function(b){a(p,function(){b.classList.add("rpd-collapsed")},function(){b.classList.remove("rpd-collapsed")},!0)})(Q)}d.appendChild(n);var t=b("span","rpd-collapse-nodelist");t.innerText=t.textContent=">>";a(t,function(){t.classList.add("rpd-collapsed");t.innerText=
t.textContent="<<";n.classList.add("rpd-collapsed")},function(){t.classList.remove("rpd-collapsed");t.innerText=t.textContent=">>";n.classList.remove("rpd-collapsed")},!0);d.appendChild(t)}var A,M,B,I,p=l(d,D),O=function(){var a,b,d,g,m,q,z,k=function(a){return function(){return B[a.id].link}};return{init:function(c){z=c;a=Kefir.fromEvent(c,"click");b=Kefir.pool();d=Kefir.pool();g=Kefir.emitter();m=Kefir.emitter();q=Kefir.merge([g.mapTo(!0),m.mapTo(!1)]).toProperty(!1)},subscribeOutlet:function(n,
k){d.plug(Kefir.fromEvent(k,"click").map(f).map(h(n)));Kefir.fromEvent(k,"click").tap(c).filterBy(d.awaiting(q)).map(f).onValue(function(c){g.emit();var q=e(k),h=C(q.x,q.y,c.x,c.y,p.linkWidth);z.appendChild(h);return Kefir.fromEvent(z,"mousemove").takeUntilBy(Kefir.merge([b,d.mapTo(!1),a.mapTo(!1)]).take(1).onValue(function(a){if(a){a=a.target;var b=B[a.id].link;b&&b.outlet.disconnect(b);n.connect(a)}})).map(f).onValue(function(a){L(h,q.x,q.y,a.x,a.y)}).onEnd(function(){z.removeChild(h);m.emit()})})},
subscribeInlet:function(n,v){b.plug(Kefir.fromEvent(v,"click").map(f).map(h(n)));Kefir.fromEvent(v,"click").tap(c).filterBy(b.awaiting(q)).filter(k(n)).onValue(function(c){var q=B[n.id].link,h=q.outlet;h.disconnect(q);g.emit();var k=e(M[h.id].connectorElm),t=C(k.x,k.y,c.x,c.y,p.linkWidth);z.appendChild(t);return Kefir.fromEvent(z,"mousemove").takeUntilBy(Kefir.merge([b,d.mapTo(!1),a.mapTo(!1)]).take(1).onValue(function(a){if(a){a=a.target;var b=B[a.id].link;b&&b.outlet.disconnect(b);h.connect(a)}})).map(f).onValue(function(a){L(t,
k.x,k.y,a.x,a.y)}).onEnd(function(){z.removeChild(t);m.emit()})})}}}();return{"model/new":function(a,b){A={};M={};B={};I={};a.classList.add("rpd-model");p.layout&&a.classList.add("rpd-layout-"+p.layout);p.valuesOnHover?a.classList.add("rpd-values-on-hover"):a.classList.add("rpd-values-always-shown");p.showBoxes&&a.classList.add("rpd-show-boxes");a.style.height=document.documentElement.clientHeight+"px";Kefir.fromEvent(a,"resize").onValue(function(){a.style.height=document.documentElement.clientHeight+
"px"});O.init(a);p.renderNodeList&&P(a,Rpd.allNodeTypes);Kefir.fromEvent(a,"selectstart").onValue(function(a){a.preventDefault()})},"node/add":function(a,d){var u=d.node,e=b("div","rpd-node-box"),m=b("table","rpd-node"),f,h,F,n,v;if("quartz"==p.layout){f=b("thead","rpd-title");h=b("tr");n=b("tr","rpd-remove-button");v=b("th");v.innerText=v.textContent="x";n.appendChild(v);f.appendChild(n);var l=b("th");l.setAttribute("colspan",3);l.appendChild(g("span","rpd-name",u.name));p.showTypes&&l.appendChild(g("span",
"rpd-type",u.type));h.appendChild(l);f.appendChild(h);var E=b("tbody","rpd-content"),y=b("tr"),l=b("td","rpd-inlets");n=b("table");var r=b("tbody");h=r;n.appendChild(r);l.appendChild(n);n=b("div");r=b("td","rpd-body");F=b("table");var t=b("tr"),w=b("td");w.appendChild(n);t.appendChild(w);F.appendChild(t);r.appendChild(F);var t=b("td","rpd-outlets"),w=b("table"),x=b("tbody");F=x;w.appendChild(x);t.appendChild(w);y.appendChild(l);y.appendChild(r);y.appendChild(t);E.appendChild(y);m.appendChild(f);m.appendChild(E)}else"pd"==
p.layout&&(v=b("tr","rpd-inlets"),l=b("td"),n=b("table"),h=r=b("tbody"),n.appendChild(r),l.appendChild(n),v.appendChild(l),m.appendChild(v),n=b("tr","rpd-remove-button"),v=b("td"),v.innerText=v.textContent="x",n.appendChild(v),m.appendChild(n),y=b("tr","rpd-content"),l=b("td","rpd-title"),l.appendChild(g("span","rpd-name",u.name)),p.showTypes&&l.appendChild(g("span","rpd-type",u.type)),y.appendChild(l),r=b("td","rpd-body"),n=b("div"),F=b("table"),t=b("tr"),w=b("td"),w.appendChild(n),t.appendChild(w),
F.appendChild(t),r.appendChild(F),y.appendChild(r),m.appendChild(y),f=b("tr","rpd-outlets"),t=b("td"),w=b("table"),F=x=b("tbody"),w.appendChild(x),t.appendChild(w),f.appendChild(t),m.appendChild(f),f=l);m.classList.add("rpd-"+u.type.replace("/","-"));e.style.zIndex=0;J(u,e,m,p.boxSize,[a.offsetWidth,a.offsetHeight]);e.appendChild(m);a.appendChild(e);A[u.id]={box:e,elm:m,body:n,inletsTrg:h,outletsTrg:F};u.render.html&&u.render.html.first&&k(u,u.render.html.first(n));p.nodesMovingAllowed&&K(u,a,f,e);
Kefir.fromEvent(v,"click").tap(c).onValue(function(){Rpd.currentModel().removeNode(u)})},"node/process":function(a,b){var d=b.node;d.render.html&&d.render.html.always&&d.render.html.always(A[d.id].body,b.inlets,b.outlets)},"node/remove":function(a,b){for(var d=b.node,c=A[d.id],e=G(d,I),f,g=0,h=e.length;g<h;g++)f=e[g],f.link.outlet.disconnect(f.link);a.removeChild(c.box);A[d.id]=null},"inlet/add":function(a,d){var c=d.inlet;if(!c.hidden){var e=A[c.node.id].inletsTrg,f,h,k;"quartz"==p.layout?(f=b("tr",
"rpd-inlet rpd-stale"),k=b("td","rpd-connector"),valueHolder=b("td","rpd-value-holder"),h=b("span","rpd-value"),valueHolder.appendChild(h),f.appendChild(k),f.appendChild(valueHolder),f.appendChild(g("td","rpd-name",c.name)),p.showTypes&&f.appendChild(g("td","rpd-type",c.type))):"pd"==p.layout&&(f=b("td","rpd-inlet rpd-stale"),k=b("span","rpd-connector"),valueHolder=b("span","rpd-value-holder"),h=b("span","rpd-value"),valueHolder.appendChild(h),f.appendChild(k),f.appendChild(g("span","rpd-name",c.name)),
f.appendChild(valueHolder),p.showTypes&&f.appendChild(g("span","rpd-type",c.type)));f.classList.add("rpd-"+c.type.replace("/","-"));e.appendChild(f);var l={elm:f,valueElm:h,connectorElm:k,disableEditor:null,link:null};B[c.id]=l;c.readonly&&f.classList.add("rpd-readonly");!c.readonly&&c.render.html&&c.render.html.edit&&r(c,l,a,valueHolder,h);c.event["inlet/update"].onError(function(){w(l,f,p.effectTime)});O.subscribeInlet(c,k)}},"inlet/update":function(a,b){var d=b.inlet;if(!d.hidden){var c=B[d.id],
f=c.elm,e=c.valueElm,g=d.def.show?d.def.show(b.value):b.value;e.innerText=e.textContent=g;d.render.html&&d.render.html.show?d.render.html.show(e,b.value,g):e.innerText=e.textContent=g;N(c,f,p.effectTime)}},"outlet/add":function(a,d){var c=d.outlet,f=A[c.node.id].outletsTrg,e,h,k;"quartz"==p.layout?(e=b("tr","rpd-outlet rpd-stale"),k=b("td","rpd-connector"),h=b("td","rpd-value"),p.showTypes&&e.appendChild(g("td","rpd-type",c.type)),e.appendChild(g("td","rpd-name",c.name)),e.appendChild(h),e.appendChild(k)):
"pd"==p.layout&&(e=b("td","rpd-outlet rpd-stale"),k=b("span","rpd-connector"),h=b("span","rpd-value"),e.appendChild(k),e.appendChild(g("span","rpd-name",c.name)),e.appendChild(h),p.showTypes&&e.appendChild(g("span","rpd-type",c.type)));e.classList.add("rpd-"+c.type.replace("/","-"));f.appendChild(e);M[c.id]={elm:e,valueElm:h,connectorElm:k,links:{}};O.subscribeOutlet(c,k)},"outlet/update":function(a,b){var d=b.outlet,c=M[d.id],e=c.elm,f=c.valueElm;f.innerText=f.textContent=b.value;d.render.html&&
d.render.html.show?d.render.html.show(f,b.value):f.innerText=f.textContent=d.def.show?d.def.show(b.value):b.value;N(c,e,p.effectTime)},"outlet/connect":function(b,d){var c=d.link,e=c.outlet,f=M[e.id],g=B[c.inlet.id],h=f.connectorElm,k=g.connectorElm;f.links[e.id]=c;if(g.link)throw Error("Inlet is already connected to a link");g.link=c;g.disableEditor&&g.disableEditor.emit();e=h.getBoundingClientRect();k=k.getBoundingClientRect();k=C(e.left,e.top,k.left,k.top,p.linkWidth);I[c.id]={elm:k,link:c};a(k,
function(){c.enable()},function(){c.disable()});b.appendChild(k)},"outlet/disconnect":function(a,b){var d=b.link,c=I[d.id].elm,e=B[d.inlet.id];M[d.outlet.id].links[d.id]=null;e.link=null;I[d.id]=null;a.removeChild(c)},"link/enable":function(a,b){I[b.link.id].elm.classList.remove("rpd-disabled")},"link/disable":function(a,b){I[b.link.id].elm.classList.add("rpd-disabled")}}}function l(b,c){if(b){var f={},e;for(e in c)f[e]=c[e];for(e in b)f[e]=b[e];return f}return c}function b(b,c){var f=document.createElement(b);
c&&(f.className=c);return f}function g(b,c,f){b=document.createElement(b);c&&(b.className=c);b.innerText=b.textContent=f;return b}function w(b,c,f){c.classList.add("rpd-error");b.errRemoveTimeout&&clearTimeout(b.errRemoveTimeout);b.errRemoveTimeout=setTimeout(function(){c.classList.remove("rpd-error");b.errRemoveTimeout=null},f||1)}function N(b,c,f){c.classList.remove("rpd-stale");c.classList.add("rpd-fresh");b.updRemoveTimeout&&clearTimeout(b.updRemoveTimeout);b.updRemoveTimeout=setTimeout(function(){c.classList.remove("rpd-fresh");
c.classList.add("rpd-stale");b.updRemoveTimeout=null},f||1)}function C(d,c,f,e,g){var h=Math.sqrt((d-f)*(d-f)+(c-e)*(c-e));f=Math.atan2(e-c,f-d);e=b("span","rpd-link");e.style.position="absolute";e.style.zIndex=2;e.style.width=Math.floor(h)+"px";e.style.left=d+"px";e.style.top=c+"px";e.style.transformOrigin="left top";e.style.webkitTransformOrigin="left top";e.style.transform="rotateZ("+f+"rad)";e.style.webkitTransform="rotateZ("+f+"rad)";g&&(e.style.height=g+"px");return e}function L(b,c,f,e,g){var h=
Math.sqrt((c-e)*(c-e)+(f-g)*(f-g));e=Math.atan2(g-f,e-c);b.style.left=c+"px";b.style.top=f+"px";b.style.width=Math.floor(h)+"px";b.style.transform="rotateZ("+e+"rad)";b.style.webkitTransform="rotateZ("+e+"rad)"}function G(b,c,f){var e=[],g,h,a;for(a in c)c[a]&&(g=c[a],h=g.link,h.inlet.node.id===b.id||h.outlet.node.id===b.id)&&(e.push(g),f&&f(g,h));return e}function J(b,c,f,e,g){var h=(b.def.width||H)*e[0],a=r.length?r[r.length-1]:null;b=[a?a[0]:0,a?a[1]+a[3]+O*e[1]:0,h,(b.def.height||P)*e[1]];b[1]+
e[1]>g[1]&&(b[0]=b[0]+h+K*e[0],b[1]=0);r.push(b);c.style.left=Math.floor(b[0])+"px";c.style.top=Math.floor(b[1])+"px";f.style.minWidth=Math.floor(b[2])+"px";f.style.minHeight=Math.floor(b[3])+"px";r.push(b)}var D={layout:"quartz",valuesOnHover:!1,showTypes:!1,showBoxes:!1,nodesMovingAllowed:!0,renderNodeList:!0,nodeListCollapsed:!0,boxSize:[100,40],linkWidth:null,effectTime:1E3},H=1,P=1,K=.5,O=1,r=[];Rpd.HtmlRenderer=h;Rpd.renderer("html",function(b){var c=h(b);return function(b,d){if(c[d.type])c[d.type](b,
d)}})})();Rpd.nodetype("core/empty",{name:"Empty",handle:{"inlet/add":function(){throw Error("Empty node can not have any inlets");},"outlet/add":function(){throw Error("Empty node can not have any outlets");}}});Rpd.nodetype("core/custom",{name:"Custom"});
Rpd.nodetype("core/sum-of-three",{name:"Sum of Three",width:1.8,inlets:{a:{type:"core/number",name:"A"},b:{type:"core/number",name:"B"},c:{type:"core/number",name:"C"}},outlets:{sum:{type:"core/number",name:"\u2211"}},process:function(h){return{sum:(h.a||0)+(h.b||0)+(h.c||0)}}});
Rpd.nodetype("core/sum-of-three-with-body",{name:"Sum of Three w/Body",width:1.8,inlets:{a:{type:"core/number",name:"A",default:1},b:{type:"core/number",name:"B"},c:{type:"core/number",name:"C",hidden:!0}},outlets:{sum:{type:"core/number",name:"\u2211"}},process:function(h){return{sum:(h.a||0)+(h.b||0)+(h.c||0)}}});Rpd.channeltype("core/bool",{default:!1,adapt:function(h){return h?!0:!1}});Rpd.channeltype("core/number",{default:0,readonly:!1,adapt:function(h){return parseFloat(h)}});
Rpd.linktype("core/value",{});Rpd.noderenderer("core/sum-of-three","html",{always:function(h,l,b){h.innerHTML="\u2211 ("+(l.a||"?")+", "+(l.b||"?")+", "+(l.c||"?")+") = "+(b.sum||"?")}});
Rpd.noderenderer("core/sum-of-three-with-body","html",function(){var h;return{first:function(l){var b=document.createElement("input");b.style.display="block";b.type="number";b.min=0;b.max=10;l.appendChild(b);h=document.createElement("span");l.appendChild(h);return{c:{default:function(){return b.value=0},valueOut:Kefir.fromEvent(b,"change").map(function(){return b.value})}}},always:function(l,b,g){h.innerHTML=h.textContent="\u2211 ("+(b.a||"0")+", "+(b.b||"0")+", "+(b.c||"0")+") = "+(g.sum||"?")}}});
Rpd.channelrenderer("core/number","html",{edit:function(h,l,b){var g=document.createElement("input");g.type="number";b.onValue(function(b){g.value=b});h.appendChild(g);return Kefir.fromEvent(g,"change").map(function(){return g.value})}});

/* RPD v0.1.0
 http://shamansir.github.io/rpd
 LICENSE: MIT (c) 2015 Anton Kotenko <shaman.sir@gmail.com> */

var Rpd=function(){function a(b){this.name=b;this.targets=Kefir.emitter();this.renderers=Kefir.emitter();b={"model/new":function(b){return{model:b}},"node/add":function(b){return{node:b}},"node/remove":function(b){return{node:b}}};this.event=E(b);this.events=H(b,this.event);Kefir.combine([this.events,this.targets.scan(O),this.renderers.scan(O)]).onValue(function(b){var c=b[0],a=b[2];I(b[1],function(b){I(a,function(a){a(b,c)})})});this.event["model/new"].emit(this)}function d(b,c){this.type=b||"core/empty";
this.id=F();var a=u(q[this.type]);a||B("Node type "+this.type+" is not registered!");this.def=a;this.name=c||a.name||"Unnamed";this.def=a;this.render=J(a.render);var f=this,a={"node/turn-on":function(b){return{node:f}},"node/ready":function(b){return{node:f}},"node/process":function(b){return{inlets:b[0],outlets:b[1],node:f}},"node/turn-off":function(b){return{node:f}},"inlet/add":function(b){return{inlet:b}},"inlet/remove":function(b){return{inlet:b}},"outlet/add":function(b){return{outlet:b}},"outlet/remove":function(b){return{outlet:b}}};
this.event=E(a);this.events=H(a,this.event);m[h]?m[h].addNode(this):B("No model started!");if(this.def.handle)this.events.onValue(function(b){if(f.def.handle[b.type])f.def.handle[b.type](b)});if(this.def.process){var g=this.def.process,f=this;Kefir.combine([this.event["inlet/add"].flatMap(function(b){var a=b.event["inlet/update"].map(function(a){return{inlet:b.alias,value:a}});f.def.tune&&(a=f.def.tune(a));return a}).scan(function(b,a){var c=a.inlet,D,f;if(b)return D=b.prev,f=b.cur,D[c]=f[c],f[c]=
a.value,b;D={};f={};f[c]=a.value;return{prev:D,cur:f}},null),this.event["outlet/add"].scan(function(b,a){b=b||{};b[a.alias]=a;return b},null)]).onValue(function(b){var a=b[0]||{prev:{},cur:{}};b=b[1]||{};var c=g(a.cur,a.prev);f.event["node/process"].emit([a.cur,c,a.prev]);for(var D in c)b[D]&&b[D].send(c[D])})}if(this.def.inlets){this.inlets={};for(var k in this.def.inlets)a=this.def.inlets[k],a=this.addInlet(a.type,k,a.name,a.default,a.hidden,a.readonly),this.inlets[k]=a}if(this.def.outlets)for(k in this.outlets=
{},this.def.outlets)a=this.def.outlets[k],a=this.addOutlet(a.type,k,a.name,a.default),this.outlets[k]=a;this.def.prepare&&this.def.prepare(this.inlets,this.outlets);this.event["node/ready"].emit(this)}function c(b,a,c,f,g,d,l){this.type=b||"core/bool";this.id=F();var e=u(k[this.type]);e||B("Inlet type "+this.type+" is not registered!");this.def=e;(this.alias=c||f||e.alias)||B("Inlet should have either alias or name");this.name=f||this.alias||e.name||"Unnamed";this.node=a;this.hidden=d||!1;this.readonly=
M(l||e.readonly)?l||e.readonly:!0;this.default=M(g)?g:e.default;this.value=Kefir.bus();this.render=J(e.render);var h=this;b={"inlet/update":function(b){return{inlet:h,value:b}}};this.event=E(b);var m=this.event["inlet/update"];a=m.merge(this.value);e.tune&&(a=e.tune(a));e.accept&&(a=a.flatten(function(b){if(e.accept(b))return[b];m.error();return[]}));e.adapt&&(a=a.map(e.adapt));this.event["inlet/update"]=a.onValue(function(){});this.events=H(b,this.event)}function e(b,a,c,f,g){this.type=b||"core/bool";
this.id=F();(b=u(k[this.type]))||B("Outlet type "+this.type+" is not registered!");this.def=b;(this.alias=c||f||b.alias)||B("Outlet should have either alias or name");this.name=f||this.alias||b.name||"Unnamed";this.node=a;this.default=M(g)?g:b.default;this.value=Kefir.bus();this.render=J(b.render);var e=this;a={"outlet/update":function(b){return{outlet:e,value:b}},"outlet/connect":function(b){return{outlet:e,link:b}},"outlet/disconnect":function(b){return{outlet:e,link:b}}};this.event=E(a);this.event["outlet/update"]=
this.event["outlet/update"].merge(this.value).onValue(function(){});this.events=H(a,this.event);Kefir.sampledBy([this.event["outlet/update"]],[this.event["outlet/connect"]]).onValue(function(b){e.value.emit(b[0])})}function z(b,a,c,g,k){this.type=b||"core/value";this.id=F();(b=u(f[this.type]))||B("Link type "+this.type+" is not registered!");this.def=b;this.name=k||b.name||"";this.outlet=a;this.inlet=c;this.adapter=g||b.adapt||void 0;var e=this;this.receiver=a.node.id!==c.node.id?function(b){return function(a){b.pass(a)}}(e):
function(b){setTimeout(function(){e.pass(b)},0)};a={"link/enable":function(){return{link:e}},"link/disable":function(){return{link:e}},"link/pass":function(b){return{link:e,value:b}},"link/adapt":function(b){return{link:e,before:b[0],after:b[1]}}};this.event=E(a);this.events=H(a,this.event);this.enabled=Kefir.merge([this.event["link/disable"].mapTo(!1),this.event["link/enable"].mapTo(!0)]).toProperty(!0);this.event["link/pass"].filterBy(this.enabled).onValue(function(b){c.receive(e.adapt(b))});Kefir.sampledBy([this.event["link/pass"]],
[this.event["link/enable"]]).onValue(function(b){e.pass(b[0])})}function M(b){return"undefined"!==typeof b}function u(b){return b?"function"===typeof b?b():b:null}function J(b){if(!b)return{};var a={},c;for(c in b)a[c]=u(b[c]);return a}function E(b){var a={},c;for(c in b)a[c]=Kefir.emitter();return a}function H(b,a){var c=Kefir.pool(),f;for(f in b)(function(b,f){c.plug(a[b].map(function(a){a=f(a);a.type=b;return a}))})(f,b[f]);return c}function B(b,a){a=a||Error(b);console&&(console.error?console.error(a):
console.log(a));throw a;}function F(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}function O(b,a){return[a,Array.isArray(b)?b:[b,null]]}function I(b,a){b&&(Array.isArray(b)?(a(b[0]),I(b[1],a)):a(b))}function P(b,a,c){for(var f=[],e=0,g=a.length;e<g;e++)f.push(a[e](c));return function(a,c){b(a,c);for(var e=0,g=f.length;e<g;e++)f[e](a,c)}}var q={},f={},k={},l={},g={},h=-1,m=[];a.prototype.attachTo=function(b){this.targets.emit(b);return this};a.prototype.addNode=function(b){this.events.plug(b.events);
this.event["node/add"].emit(b);b.turnOn();return this};a.prototype.removeNode=function(b){b.turnOff();this.event["node/remove"].emit(b);this.events.unplug(b.events);return this};a.prototype.renderWith=function(b,a){if(!l[b])throw Error("Renderer "+b+" is not registered");var c=l[b](a);g[b]&&g[b].length?this.renderers.emit(P(c,g[b]),a):this.renderers.emit(c);return this};a.start=function(b){b=new a(b);m.push(b);h++;return b};d.prototype.turnOn=function(){this.event["node/turn-on"].emit(this)};d.prototype.turnOff=
function(){this.event["node/turn-off"].emit(this)};d.prototype.addInlet=function(b,a,f,e,g,k){b=new c(b,this,a,f,e,g,k);this.events.plug(b.events);this.event["inlet/add"].emit(b);b.toDefault();return b};d.prototype.addOutlet=function(b,a,c,f){b=new e(b,this,a,c,f);this.events.plug(b.events);this.event["outlet/add"].emit(b);return b};d.prototype.removeInlet=function(b){this.event["inlet/remove"].emit(b);this.events.unplug(b.events)};d.prototype.removeOutlet=function(b){this.event["outlet/remove"].emit(b);
this.events.unplug(b.events)};c.prototype.receive=function(b){this.value.emit(b)};c.prototype.stream=function(b){this.value.plug(b)};c.prototype.toDefault=function(){M(this.default)&&this.default instanceof Kefir.Stream?this.stream(this.default):this.receive(this.default)};e.prototype.connect=function(b,a){var c=new z(null,this,b,a);this.events.plug(c.events);this.value.onValue(c.receiver);this.event["outlet/connect"].emit(c);return c};e.prototype.disconnect=function(b){this.event["outlet/disconnect"].emit(b);
this.value.offValue(b.receiver);this.events.unplug(b.events)};e.prototype.send=function(b){this.value.emit(this.adapt?this.adapt(b):b)};e.prototype.stream=function(b){this.value.plug(this.adapt?b.map(this.adapt):b)};z.prototype.pass=function(b){this.event["link/pass"].emit(b)};z.prototype.adapt=function(b){if(this.adapter){var a=this.adapter(b);this.event["link/adapt"].emit([b,a]);return a}this.event["link/adapt"].emit([b,b]);return b};z.prototype.enable=function(){this.event["link/enable"].emit()};
z.prototype.disable=function(){this.event["link/disable"].emit()};z.prototype.disconnect=function(){this.outlet.disconnect(this)};return{Model:a,Node:d,Inlet:c,Outlet:e,Link:z,nodetype:function(b,a){q[b]=a},linktype:function(b,a){f[b]=a},channeltype:function(b,a){k[b]=a},renderer:function(b,a){l[b]=a},subrenderer:function(b,a){g[b]||(g[b]=[]);g[b].push(a)},noderenderer:function(b,a,c){if(!q[b])throw Error("Node type "+b+" is not registered");q[b].render||(q[b].render={});q[b].render[a]=c},channelrenderer:function(b,
a,c){if(!k[b])throw Error("Channel type "+b+" is not registered");k[b].render||(k[b].render={});k[b].render[a]=c},allNodeTypes:q,currentModel:function(){return m[h]}}}();(function(){function a(a){function k(b){b.preventDefault();b.stopPropagation()}function l(b){return{x:b.clientX,y:b.clientY}}function g(b){b=b.getBoundingClientRect();return{x:b.left,y:b.top}}function h(b){return function(a){return{pos:a,target:b}}}function m(b){return!b}function b(b,a,c,f){Kefir.fromEvent(b,"click").tap(k).mapTo(f||!1).scan(m).onValue(function(b){b?a():c()})}function q(b,a,C,f,x){x=c("div","rpd-value-editor");var e=Kefir.emitter(),g=Kefir.emitter();a.disableEditor=g;b.render.html.edit(x,
b,e).onValue(function(a){b.receive(a)});Kefir.sampledBy([b.event["inlet/update"]],[Kefir.merge([Kefir.fromEvent(f,"click").tap(k).mapTo(!0),Kefir.fromEvent(C,"click").merge(g).mapTo(!1)]).toProperty(!1).skipDuplicates()]).map(function(b){return{lastValue:b[0],startEditing:b[1],cancelEditing:!b[1]}}).onValue(function(b){b.startEditing?(a.link&&a.link.disable(),e.emit(b.lastValue),f.classList.add("rpd-editor-enabled")):b.cancelEditing&&f.classList.remove("rpd-editor-enabled")});f.classList.add("rpd-editor-disabled");
f.appendChild(x)}function F(b,a){if(a)for(var c in a)(function(a,c){b.event["inlet/add"].filter(function(b){return b.alias===c}).onValue(function(b){a.default&&b.receive(a.default());if(a.valueOut)a.valueOut.onValue(function(a){b.receive(a)})})})(a[c],c)}function I(b,a){for(var c,f,x,e=0,k=a.length;e<k;e++)c=a[e].link,f=a[e].elm,x=w[c.inlet.id].connectorElm,c=L[c.outlet.id].connectorElm,x=g(x),c=g(c),J(f,c.x,c.y,x.x,x.y)}function O(b,a,c,f){c.classList.add("rpd-drag-handle");var e;Kefir.fromEvent(c,
"mousedown").map(l).flatMap(function(b){f.classList.add("rpd-dragging");var c=g(f),C=b.x-c.x,d=b.y-c.y;e=null;f.style.zIndex=1;return Kefir.fromEvent(a,"mousemove").tap(k).takeUntilBy(Kefir.fromEvent(a,"mouseup")).map(l).map(function(b){return{x:b.x-C,y:b.y-d}}).onEnd(function(){f.classList.remove("rpd-dragging");f.style.zIndex=0;if(e)for(var b=0,a=e.length;b<a;b++)e[b].elm.style.zIndex=2})}).onValue(function(a){f.style.left=a.x+"px";f.style.top=a.y+"px";e||(e=E(b,G,function(b){b.elm.style.zIndex=
3}));I(b,e)})}function P(a,f){var C={},g=[],x,p,d,l;for(x in f)d=x.split("/"),p=d[0],l=d[1],g.push([d,p,l]),C[p]||(C[p]={}),C[p][l]=f[x];var A=c("dl","rpd-nodelist"),r,Q,n,h,y;for(p in C){n=e("dd","rpd-toolkit-name",p);A.appendChild(n);d=c("dt");Q=c("dl","rpd-toolkit");g=C[p];for(l in g)x=p+"/"+l,r=g[l],h=e("dd","rpd-node-title",l),y=e("span","rpd-add-node","+ Add"),h.appendChild(y),r=e("dd","rpd-node-description",r.description||"No Description"),Q.appendChild(h),Q.appendChild(r),r.classList.add("rpd-collapsed"),
function(a){b(h,function(){a.classList.add("rpd-collapsed")},function(){a.classList.remove("rpd-collapsed")})}(r),function(b){Kefir.fromEvent(y,"click").tap(k).onValue(function(){new Rpd.Node(b)})}(x);d.appendChild(Q);A.appendChild(d);(function(a){b(n,function(){a.classList.add("rpd-collapsed")},function(){a.classList.remove("rpd-collapsed")},!0)})(Q)}a.appendChild(A);var t=c("span","rpd-collapse-nodelist");t.innerText=t.textContent=">>";b(t,function(){t.classList.add("rpd-collapsed");t.innerText=
t.textContent="<<";A.classList.add("rpd-collapsed")},function(){t.classList.remove("rpd-collapsed");t.innerText=t.textContent=">>";A.classList.remove("rpd-collapsed")},!0);a.appendChild(t)}var K,L,w,G,n=d(a,B),R=function(){var b,a,c,f,e,d,N,v=function(b){return function(){return w[b.id].link}};return{init:function(g){N=g;b=Kefir.fromEvent(g,"click");a=Kefir.pool();c=Kefir.pool();f=Kefir.emitter();e=Kefir.emitter();d=Kefir.merge([f.mapTo(!0),e.mapTo(!1)]).toProperty(!1)},subscribeOutlet:function(A,
v){c.plug(Kefir.fromEvent(v,"click").map(l).map(h(A)));Kefir.fromEvent(v,"click").tap(k).filterBy(c.awaiting(d)).map(l).onValue(function(k){f.emit();var d=g(v),p=u(d.x,d.y,k.x,k.y,n.linkWidth);N.appendChild(p);return Kefir.fromEvent(N,"mousemove").takeUntilBy(Kefir.merge([a,c.mapTo(!1),b.mapTo(!1)]).take(1).onValue(function(b){if(b){b=b.target;var a=w[b.id].link;a&&a.outlet.disconnect(a);A.connect(b)}})).map(l).onValue(function(b){J(p,d.x,d.y,b.x,b.y)}).onEnd(function(){N.removeChild(p);e.emit()})})},
subscribeInlet:function(A,r){a.plug(Kefir.fromEvent(r,"click").map(l).map(h(A)));Kefir.fromEvent(r,"click").tap(k).filterBy(a.awaiting(d)).filter(v(A)).onValue(function(d){var k=w[A.id].link,p=k.outlet;p.disconnect(k);f.emit();var v=g(L[p.id].connectorElm),h=u(v.x,v.y,d.x,d.y,n.linkWidth);N.appendChild(h);return Kefir.fromEvent(N,"mousemove").takeUntilBy(Kefir.merge([a,c.mapTo(!1),b.mapTo(!1)]).take(1).onValue(function(b){if(b){b=b.target;var a=w[b.id].link;a&&a.outlet.disconnect(a);p.connect(b)}})).map(l).onValue(function(b){J(h,
v.x,v.y,b.x,b.y)}).onEnd(function(){N.removeChild(h);e.emit()})})}}}();return{"model/new":function(b,a){K={};L={};w={};G={};b.classList.add("rpd-model");n.layout&&b.classList.add("rpd-layout-"+n.layout);n.valuesOnHover?b.classList.add("rpd-values-on-hover"):b.classList.add("rpd-values-always-shown");n.showBoxes&&b.classList.add("rpd-show-boxes");b.style.height=document.documentElement.clientHeight+"px";Kefir.fromEvent(b,"resize").onValue(function(){b.style.height=document.documentElement.clientHeight+
"px"});R.init(b);n.renderNodeList&&P(b,Rpd.allNodeTypes);Kefir.fromEvent(b,"selectstart").onValue(function(b){b.preventDefault()})},"node/add":function(b,a){var f=a.node,g=c("div","rpd-node-box"),d=c("table","rpd-node"),p,l,v,h,r;if("quartz"==n.layout){p=c("thead","rpd-title");l=c("tr");h=c("tr","rpd-remove-button");r=c("th");r.innerText=r.textContent="x";h.appendChild(r);p.appendChild(h);var m=c("th");m.setAttribute("colspan",3);m.appendChild(e("span","rpd-name",f.name));n.showTypes&&m.appendChild(e("span",
"rpd-type",f.type));l.appendChild(m);p.appendChild(l);var z=c("tbody","rpd-content"),q=c("tr"),m=c("td","rpd-inlets");h=c("table");var y=c("tbody");l=y;h.appendChild(y);m.appendChild(h);h=c("div");y=c("td","rpd-body");v=c("table");var t=c("tr"),u=c("td");u.appendChild(h);t.appendChild(u);v.appendChild(t);y.appendChild(v);var t=c("td","rpd-outlets"),u=c("table"),w=c("tbody");v=w;u.appendChild(w);t.appendChild(u);q.appendChild(m);q.appendChild(y);q.appendChild(t);z.appendChild(q);d.appendChild(p);d.appendChild(z)}else"pd"==
n.layout&&(r=c("tr","rpd-inlets"),m=c("td"),h=c("table"),l=y=c("tbody"),h.appendChild(y),m.appendChild(h),r.appendChild(m),d.appendChild(r),h=c("tr","rpd-remove-button"),r=c("td"),r.innerText=r.textContent="x",h.appendChild(r),d.appendChild(h),q=c("tr","rpd-content"),m=c("td","rpd-title"),m.appendChild(e("span","rpd-name",f.name)),n.showTypes&&m.appendChild(e("span","rpd-type",f.type)),q.appendChild(m),y=c("td","rpd-body"),h=c("div"),v=c("table"),t=c("tr"),u=c("td"),u.appendChild(h),t.appendChild(u),
v.appendChild(t),y.appendChild(v),q.appendChild(y),d.appendChild(q),p=c("tr","rpd-outlets"),t=c("td"),u=c("table"),v=w=c("tbody"),u.appendChild(w),t.appendChild(u),p.appendChild(t),d.appendChild(p),p=m);d.classList.add("rpd-"+f.type.replace("/","-"));g.style.zIndex=0;H(f,g,d,n.boxSize,[b.offsetWidth,b.offsetHeight]);g.appendChild(d);b.appendChild(g);K[f.id]={box:g,elm:d,body:h,inletsTrg:l,outletsTrg:v};f.render.html&&f.render.html.first&&F(f,f.render.html.first(h));n.nodesMovingAllowed&&O(f,b,p,g);
Kefir.fromEvent(r,"click").tap(k).onValue(function(){Rpd.currentModel().removeNode(f)})},"node/process":function(b,a){var c=a.node;c.render.html&&c.render.html.always&&c.render.html.always(K[c.id].body,a.inlets,a.outlets)},"node/remove":function(b,a){for(var c=a.node,f=K[c.id],e=E(c,G),g,d=0,k=e.length;d<k;d++)g=e[d],g.link.outlet.disconnect(g.link);b.removeChild(f.box);K[c.id]=null},"inlet/add":function(b,a){var f=a.inlet;if(!f.hidden){var g=K[f.node.id].inletsTrg,d,k,l;"quartz"==n.layout?(d=c("tr",
"rpd-inlet rpd-stale"),l=c("td","rpd-connector"),valueHolder=c("td","rpd-value-holder"),k=c("span","rpd-value"),valueHolder.appendChild(k),d.appendChild(l),d.appendChild(valueHolder),d.appendChild(e("td","rpd-name",f.name)),n.showTypes&&d.appendChild(e("td","rpd-type",f.type))):"pd"==n.layout&&(d=c("td","rpd-inlet rpd-stale"),l=c("span","rpd-connector"),valueHolder=c("span","rpd-value-holder"),k=c("span","rpd-value"),valueHolder.appendChild(k),d.appendChild(l),d.appendChild(e("span","rpd-name",f.name)),
d.appendChild(valueHolder),n.showTypes&&d.appendChild(e("span","rpd-type",f.type)));d.classList.add("rpd-"+f.type.replace("/","-"));g.appendChild(d);var h={elm:d,valueElm:k,connectorElm:l,disableEditor:null,link:null};w[f.id]=h;f.readonly&&d.classList.add("rpd-readonly");!f.readonly&&f.render.html&&f.render.html.edit&&q(f,h,b,valueHolder,k);f.event["inlet/update"].onError(function(){z(h,d,n.effectTime)});R.subscribeInlet(f,l)}},"inlet/update":function(b,a){var c=a.inlet;if(!c.hidden){var f=w[c.id],
d=f.elm,e=f.valueElm,g=c.def.show?c.def.show(a.value):a.value;e.innerText=e.textContent=g;c.render.html&&c.render.html.show?c.render.html.show(e,a.value,g):e.innerText=e.textContent=g;M(f,d,n.effectTime)}},"outlet/add":function(b,a){var f=a.outlet,d=K[f.node.id].outletsTrg,g,k,l;"quartz"==n.layout?(g=c("tr","rpd-outlet rpd-stale"),l=c("td","rpd-connector"),k=c("td","rpd-value"),n.showTypes&&g.appendChild(e("td","rpd-type",f.type)),g.appendChild(e("td","rpd-name",f.name)),g.appendChild(k),g.appendChild(l)):
"pd"==n.layout&&(g=c("td","rpd-outlet rpd-stale"),l=c("span","rpd-connector"),k=c("span","rpd-value"),g.appendChild(l),g.appendChild(e("span","rpd-name",f.name)),g.appendChild(k),n.showTypes&&g.appendChild(e("span","rpd-type",f.type)));g.classList.add("rpd-"+f.type.replace("/","-"));d.appendChild(g);L[f.id]={elm:g,valueElm:k,connectorElm:l,links:{}};R.subscribeOutlet(f,l)},"outlet/update":function(b,a){var c=a.outlet,f=L[c.id],g=f.elm,d=f.valueElm;d.innerText=d.textContent=a.value;c.render.html&&
c.render.html.show?c.render.html.show(d,a.value):d.innerText=d.textContent=c.def.show?c.def.show(a.value):a.value;M(f,g,n.effectTime)},"outlet/connect":function(a,c){var f=c.link,d=f.outlet,g=L[d.id],e=w[f.inlet.id],k=g.connectorElm,l=e.connectorElm;g.links[d.id]=f;if(e.link)throw Error("Inlet is already connected to a link");e.link=f;e.disableEditor&&e.disableEditor.emit();d=k.getBoundingClientRect();l=l.getBoundingClientRect();l=u(d.left,d.top,l.left,l.top,n.linkWidth);G[f.id]={elm:l,link:f};b(l,
function(){f.enable()},function(){f.disable()});a.appendChild(l)},"outlet/disconnect":function(b,a){var c=a.link,f=G[c.id].elm,d=w[c.inlet.id];L[c.outlet.id].links[c.id]=null;d.link=null;G[c.id]=null;b.removeChild(f)},"link/enable":function(b,a){G[a.link.id].elm.classList.remove("rpd-disabled")},"link/disable":function(b,a){G[a.link.id].elm.classList.add("rpd-disabled")}}}function d(a,c){if(a){var d={},g;for(g in c)d[g]=c[g];for(g in a)d[g]=a[g];return d}return c}function c(a,c){var d=document.createElement(a);
c&&(d.className=c);return d}function e(a,c,d){a=document.createElement(a);c&&(a.className=c);a.innerText=a.textContent=d;return a}function z(a,c,d){c.classList.add("rpd-error");a.errRemoveTimeout&&clearTimeout(a.errRemoveTimeout);a.errRemoveTimeout=setTimeout(function(){c.classList.remove("rpd-error");a.errRemoveTimeout=null},d||1)}function M(a,c,d){c.classList.remove("rpd-stale");c.classList.add("rpd-fresh");a.updRemoveTimeout&&clearTimeout(a.updRemoveTimeout);a.updRemoveTimeout=setTimeout(function(){c.classList.remove("rpd-fresh");
c.classList.add("rpd-stale");a.updRemoveTimeout=null},d||1)}function u(a,d,e,g,h){var m=Math.sqrt((a-e)*(a-e)+(d-g)*(d-g));e=Math.atan2(g-d,e-a);g=c("span","rpd-link");g.style.position="absolute";g.style.zIndex=2;g.style.width=Math.floor(m)+"px";g.style.left=a+"px";g.style.top=d+"px";g.style.transformOrigin="left top";g.style.webkitTransformOrigin="left top";g.style.transform="rotateZ("+e+"rad)";g.style.webkitTransform="rotateZ("+e+"rad)";h&&(g.style.height=h+"px");return g}function J(a,c,d,e,h){var m=
Math.sqrt((c-e)*(c-e)+(d-h)*(d-h));e=Math.atan2(h-d,e-c);a.style.left=c+"px";a.style.top=d+"px";a.style.width=Math.floor(m)+"px";a.style.transform="rotateZ("+e+"rad)";a.style.webkitTransform="rotateZ("+e+"rad)"}function E(a,c,d){var e=[],h,m,b;for(b in c)c[b]&&(h=c[b],m=h.link,m.inlet.node.id===a.id||m.outlet.node.id===a.id)&&(e.push(h),d&&d(h,m));return e}function H(a,c,d,e,h){var m=(a.def.width||F)*e[0],b=q.length?q[q.length-1]:null;a=[b?b[0]:0,b?b[1]+b[3]+P*e[1]:0,m,(a.def.height||O)*e[1]];a[1]+
e[1]>h[1]&&(a[0]=a[0]+m+I*e[0],a[1]=0);q.push(a);c.style.left=Math.floor(a[0])+"px";c.style.top=Math.floor(a[1])+"px";d.style.minWidth=Math.floor(a[2])+"px";d.style.minHeight=Math.floor(a[3])+"px";q.push(a)}var B={layout:"quartz",valuesOnHover:!1,showTypes:!1,showBoxes:!1,nodesMovingAllowed:!0,renderNodeList:!0,nodeListCollapsed:!0,boxSize:[100,40],linkWidth:null,effectTime:1E3},F=1,O=1,I=.5,P=1,q=[];Rpd.HtmlRenderer=a;Rpd.renderer("html",function(c){var d=a(c);return function(a,c){if(d[c.type])d[c.type](a,
c)}})})();Rpd.nodetype("core/empty",{name:"Empty",handle:{"inlet/add":function(){throw Error("Empty node can not have any inlets");},"outlet/add":function(){throw Error("Empty node can not have any outlets");}}});Rpd.nodetype("core/custom",{name:"Custom"});
Rpd.nodetype("core/sum-of-three",{name:"Sum of Three",width:1.8,inlets:{a:{type:"core/number",name:"A"},b:{type:"core/number",name:"B"},c:{type:"core/number",name:"C"}},outlets:{sum:{type:"core/number",name:"\u2211"}},process:function(a){return{sum:(a.a||0)+(a.b||0)+(a.c||0)}}});
Rpd.nodetype("core/sum-of-three-with-body",{name:"Sum of Three w/Body",width:1.8,inlets:{a:{type:"core/number",name:"A",default:1},b:{type:"core/number",name:"B"},c:{type:"core/number",name:"C",hidden:!0}},outlets:{sum:{type:"core/number",name:"\u2211"}},process:function(a){return{sum:(a.a||0)+(a.b||0)+(a.c||0)}}});Rpd.channeltype("core/bool",{default:!1,adapt:function(a){return a?!0:!1}});Rpd.channeltype("core/number",{default:0,readonly:!1,adapt:function(a){return parseFloat(a)}});
Rpd.linktype("core/value",{});Rpd.noderenderer("core/sum-of-three","html",{always:function(a,d,c){a.innerHTML="\u2211 ("+(d.a||"?")+", "+(d.b||"?")+", "+(d.c||"?")+") = "+(c.sum||"?")}});
Rpd.noderenderer("core/sum-of-three-with-body","html",function(){var a;return{first:function(d){var c=document.createElement("input");c.style.display="block";c.type="number";c.min=0;c.max=10;d.appendChild(c);a=document.createElement("span");d.appendChild(a);return{c:{default:function(){return c.value=0},valueOut:Kefir.fromEvent(c,"change").map(function(){return c.value})}}},always:function(d,c,e){a.innerHTML=a.textContent="\u2211 ("+(c.a||"0")+", "+(c.b||"0")+", "+(c.c||"0")+") = "+(e.sum||"?")}}});
Rpd.channelrenderer("core/number","html",{edit:function(a,d,c){var e=document.createElement("input");e.type="number";c.onValue(function(a){e.value=a});a.appendChild(e);return Kefir.fromEvent(e,"change").map(function(){return e.value})}});Rpd.channeltype("pd/t-num",{show:function(a){return a?a.value:"?"}});Rpd.channeltype("pd/spinner",{adapt:function(a){return{value:a,time:Date.now()}}});Rpd.channeltype("pd/t-wave",{});Rpd.channeltype("pd/t-obj",{show:function(a){return a?"[Some]":"[None]"}});
Rpd.nodetype("pd/number",{name:"num",inlets:{"in":{type:"pd/t-num",default:T(0)},spinner:{type:"pd/spinner",default:T(0),hidden:!0}},outlets:{out:{type:"pd/t-num"}},process:function(a){return a.spinner?50>Date.now()-a.spinner.time?{out:a.spinner.value}:{out:a.in}:{out:a.in}}});
Rpd.nodetype("pd/osc",{name:"osc",inlets:{wave:{type:"pd/t-wave",default:"sin"},freq:{type:"pd/t-num",default:T(440)}},outlets:{sound:{type:"pd/t-obj"}},process:function(a){return a.wave&&a.freq?{sound:T("osc",{wave:a.wave,freq:a.freq})}:null}});Rpd.nodetype("pd/wave",{name:"wave",inlets:{wave:{type:"pd/t-wave",default:"sin",hidden:!0}},outlets:{wave:{type:"pd/t-wave"}},process:function(a){return{wave:a.wave}}});Rpd.nodetype("pd/plot",{name:"plot",inlets:{sound:{type:"pd/t-obj",default:null}},process:function(){}});
Rpd.nodetype("pd/play",function(){var a;return{name:"play",inlets:{sound:{type:"pd/t-obj",default:null}},tune:function(a){return a.throttle(50)},process:function(d,c){c.sound&&c.sound.pause();d.sound&&(a=d.sound,d.sound.play())},handle:{"node/turn-off":function(){a&&a.pause()}}}});Rpd.noderenderer("pd/number","html",function(){var a;return{first:function(d){var c=document.createElement("span");a=attachSpinner(c,0);d.appendChild(c);return{spinner:{default:function(){a.emit(0);return T(0)},valueOut:a.map(function(a){return T(parseFloat(a))})}}},always:function(d,c){c.spinner&&c.in&&50<Date.now()-c.spinner.time&&a.emit(c.in.value)}}});Rpd.noderenderer("pd/osc","html",{always:function(a,d){a.innerText=a.textContent=d.wave+"/"+d.freq}});
Rpd.noderenderer("pd/wave","html",{first:function(a){var d=document.createElement("select");d.appendChild(createOption("sin"));d.appendChild(createOption("saw"));d.appendChild(createOption("tri"));d.appendChild(createOption("pulse"));d.appendChild(createOption("fami"));a.appendChild(d);return{wave:{default:function(){return d.value="sin"},valueOut:Kefir.fromEvent(d,"change").map(function(){return d.options[d.selectedIndex].value})}}}});
Rpd.noderenderer("pd/plot","html",function(){var a;return{first:function(d){a=document.createElement("canvas");a.width=100;a.height=100;d.appendChild(a)},always:function(d,c){c.sound&&c.sound.plot({target:a})}}});function createOption(a,d){var c=document.createElement("option");c.value=a;c.innerText=c.textContent=a;d&&(c.selected="selected");return c}function extractPos(a){return{x:a.clientX,y:a.clientY}}function stopPropagation(a){a.stopPropagation()}
function attachSpinner(a,d){a.classList.add("rpd-pd-spinner");var c=d=d||0,e=Kefir.emitter();e.onValue(function(d){c=d;a.innerText=a.textContent=d});e.emit(d);Kefir.fromEvent(a,"mousedown").map(extractPos).flatMap(function(a){var d=c;return Kefir.fromEvent(document.body,"mousemove").map(extractPos).takeUntilBy(Kefir.fromEvent(document.body,"mouseup")).onValue(function(c){e.emit(d+(c.x-a.x))})}).onEnd(function(){});return e};

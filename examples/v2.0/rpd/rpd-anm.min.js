/**
 * rpd - RPD is a minimal framework for building Node-Based User Interfaces, powered by Reactive Programming
 * Built at Sat, 12 Dec 2015 08:56:43 GMT
 *
 * @version v0.2.0
 * @link http://shamansir.github.io/rpd
 * @author Ulric Wilfred <shaman.sir@gmail.com>
 * @license MIT
 * 
 * Selected Renderers: html
 * Selected Styles: pd
 * Selected Toolkits: anm, core
 * Selected I/O Modules: [None]
 * d3.js or d3_tiny.js: d3_tiny.js
 *
 * User Styles: [None]
 * User Toolkits: [None]
 *
 * Command: gulp --root . --renderer html --style pd --toolkit anm --toolkit core --target-name rpd-anm --compilation simple
 */
(function(a){var d=a.Kefir;"undefined"===typeof d&&"undefined"!==typeof require&&(d=require("../vendor/kefir.min.js"));if(!d)throw Error("Kefir.js (https://github.com/rpominov/kefir) is required for Rpd to work");var b=function(){function a(c){return function(){return c}}function f(c){this.id=u();this.name=c;var a=this;c={"patch/is-ready":[],"patch/enter":[],"patch/exit":[],"patch/set-inputs":["inputs"],"patch/set-outputs":["outputs"],"patch/project":["node","target"],"patch/refer":["node","target"],
"patch/add-node":["node"],"patch/remove-node":["node"]};this.event=w(c);this.events=v(c,this.event,"patch",this);this.renderQueue=d.emitter();c=d.combine([this.events],[this.renderQueue.scan(function(c,g){var b=g.alias,d=g.target,e=g.config,l=c[b];l||(l={},l.produce=J[b](a),l.handlers=[],c[b]=l);if(l.produce){var p=l.produce(d,e);p&&l.handlers.push("function"===typeof p?p:function(c){if(p[c.type])p[c.type](c)})}return c},{})]);c=c.bufferBy(this.renderQueue).take(1).flatten().concat(c);c.onValue(function(c){var g=
c[0];c=c[1];for(var a=Object.keys(c),b,d=0,y=a.length;d<y;d++){b=c[a[d]];b=b.handlers;for(var e=0,l=b.length;e<l;e++)b[e](C(r(g),a[d]))}});this.projections=d.emitter();d.combine([this.projections],[this.event["patch/set-inputs"],this.event["patch/set-outputs"]]).onValue(function(c){var g=c[0],b=c[1];c=c[2];for(var d,e=0;e<b.length;e++)d=g.addInlet(b[e].type,b[e].name),d.event["inlet/update"].onValue(function(c){return function(g){c.receive(g)}}(b[e]));for(e=0;e<c.length;e++)b=g.addOutlet(c[e].type,
c[e].name),c[e].event["outlet/update"].onValue(function(c){return function(g){c.send(g)}}(b));a.event["patch/project"].emit({node:g,target:g.patch});g.patch.event["patch/refer"].emit({node:g,target:a})});this.nodesToRemove=d.emitter();this.event["patch/is-ready"].emit()}function h(c,a,b,g){this.type=c||"core/empty";this.id=u();var e=z(x[this.type],this);e||D("Node type "+this.type+" is not registered!");this.def=e;this.name=b||e.name||c;this.patch=a;this.render=p(A[this.type],this);c={"node/turn-on":[],
"node/is-ready":[],"node/process":["inlets","outlets"],"node/turn-off":[],"node/add-inlet":["inlet"],"node/remove-inlet":["inlet"],"node/add-outlet":["outlet"],"node/remove-outlet":["outlet"],"node/move":["position"]};this.event=w(c);this.events=v(c,this.event,"node",this);g&&g(this);var l=this;if(this.def.handle)this.events.onValue(function(c){if(l.def.handle[c.type])l.def.handle[c.type](c)});if(this.def.process){var k=this.def.process;g=d.combine([this.event["node/add-inlet"].flatMap(function(c){var g=
c.event["inlet/update"].map(function(g){return{inlet:c,value:g}});l.def.tune&&(g=l.def.tune(g));return g})],[this.event["node/add-outlet"].scan(function(c,g){c[g.alias]=g;return c},{})]);g=g.bufferBy(this.event["node/is-ready"]).take(1).flatten().concat(g);g=g.scan(function(c,g){var a=g[0].inlet,b=a.alias;c.inlets.prev[b]=c.inlets.cur[b];c.inlets.cur[b]=g[0].value;c.outlets=g[1];c.source=a;return c},{inlets:{prev:{},cur:{}},outlets:{}}).changes();g=g.filter(function(c){return!c.source.cold});g.onValue(function(c){var g=
k.bind(l)(c.inlets.cur,c.inlets.prev);l.event["node/process"].emit({inlets:c.inlets.cur,outlets:g});c=c.outlets;for(var a in g)c[a]&&(g[a]instanceof d.Stream?c[a].stream(g[a]):c[a].send(g[a]))})}if(this.def.inlets){this.inlets={};for(var f in this.def.inlets)g=this.def.inlets[f],g=this.addInlet(g.type,f,g.name,g.default,g.hidden,g.readonly,g.cold),this.inlets[f]=g}if(this.def.outlets)for(f in this.outlets={},this.def.outlets)g=this.def.outlets[f],g=this.addOutlet(g.type,f,g.name,g.default),this.outlets[f]=
g;this.def.prepare&&this.def.prepare(this.inlets,this.outlets);this.event["node/is-ready"].emit()}function l(c,a,b,g,e,l,f,k){this.type=c||"core/any";this.id=u();var h=z(E[this.type],this);h||D("Channel type "+this.type+" is not registered!");this.def=h;(this.alias=b||h.alias||g)||D("Inlet should have either alias or name");this.name=g||h.name||this.alias||c;this.node=a;this.hidden=l||!1;this.readonly=q(f||h.readonly)?f||h.readonly:!0;this.cold=k||!1;this.default=q(e)?e:h.default;this.value=d.pool();
this.render=p(F[this.type],this);c={"inlet/update":["value"]};this.event=w(c);var m=this.event["inlet/update"];a=m.merge(this.value);h.tune&&(a=h.tune(a));h.accept&&(a=a.flatten(function(c){if(h.accept(c))return[c];m.error();return[]}));h.adapt&&(a=a.map(h.adapt));this.event["inlet/update"]=a.onValue(function(){});this.events=v(c,this.event,"inlet",this)}function m(c,a,b,g,e){this.type=c||"core/any";this.id=u();var l=z(E[this.type],this);l||D("Channel type "+this.type+" is not registered!");this.def=
l;(this.alias=b||l.alias||g)||D("Outlet should have either alias or name");this.name=g||this.alias||l.name||c;this.node=a;this.default=q(e)?e:l.default;this.value=d.pool();this.render=p(F[this.type],this);c={"outlet/update":["value"],"outlet/connect":["link","inlet"],"outlet/disconnect":["link"]};this.event=w(c);a=this.event["outlet/update"].merge(this.value);this.event["outlet/update"]=a.onValue(function(c){});this.events=v(c,this.event,"outlet",this);var f=this;d.combine([this.event["outlet/connect"]],
[this.event["outlet/update"]]).onValue(function(c){f.value.plug(d.constant(c[1]))})}function k(c,b,l){this.id=u();this.name=l||"";this.outlet=c;this.inlet=b;this.value=d.emitter();var g=this;this.receiver=c.node.id!==b.node.id?function(c){g.pass(c)}:function(c){setTimeout(function(){g.pass(c)},0)};c={"link/enable":[],"link/disable":[],"link/pass":["value"]};this.event=w(c);l=this.event["link/pass"].merge(this.value);this.event["link/pass"]=l.onValue(function(c){});this.events=v(c,this.event,"link",
this);this.enabled=d.merge([this.event["link/disable"].map(a(!1)),this.event["link/enable"].map(a(!0))]).toProperty(a(!0));this.event["link/pass"].filterBy(this.enabled).onValue(function(c){b.receive(c)});d.combine([this.event["link/enable"]],[this.event["link/pass"]]).onValue(function(c){g.pass(c[1])})}function r(c){for(var a={},b=Object.keys(c),g=0,e=b.length;g<e;g++)a[b[g]]=c[b[g]];return a}function q(c){return"undefined"!==typeof c}function z(c,a){return c?"function"===typeof c?c(a):c:null}function p(c,
a){if(!c)return{};var b={},g;for(g in c)b[g]=z(c[g],a);return b}function w(c){var a={};c=Object.keys(c);for(var b=0,g;b<c.length;b++)g=c[b],a[g]=d.emitter();return a}function H(c,a){if(0===a.length)return function(){return{type:c}};if(1===a.length)return function(b){var g={};g.type=c;g[a[0]]=b;return g};if(1<a.length)return function(a){a=r(a);a.type=c;return a}}function v(c,a,b,g){for(var e=d.pool(),l=Object.keys(c),f=0;f<l.length;f++)e.plug(a[l[f]].map(H(l[f],c[l[f]])).map(function(c){c[b]=g;return c}));
return e}function D(c,a){throw a||Error(c);}function u(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}function C(c,a){var b=c.type;if("patch/add-node"===b||"node/process"===b)c.render=c.node.render[a]||{};else if("node/add-inlet"===b||"inlet/update"===b)c.render=c.inlet.render[a]||{};else if("node/add-outlet"===b||"outlet/update"===b)c.render=c.outlet.render[a]||{};return c}(function(){d.emitter=function(){var c,a=d.stream(function(a){c=a;return function(){c=void 0}});a.emit=
function(a){c&&c.emit(a);return this};a.error=function(a){c&&c.error(a);return this};a.end=function(){c&&c.end();return this};a.emitEvent=function(a){c&&c.emitEvent(a);return this};return a.setName("emitter")}})();var x={},E={},A={},F={},I={},B={},J={},L={"network/add-patch":["patch"]},G=w(L),t=v(L,G,"network",b);G["network/add-patch"].onValue(function(c){t.plug(c.events)});var n=d.emitter();f.prototype.render=function(c,a,b){c=Array.isArray(c)?c:[c];a=Array.isArray(a)?a:[a];for(var g=0,e=c.length,
d;g<e;g++)for(var l=0,f=a.length,p;l<f;l++){d=c[g];p=a[l];if(!J[d])throw Error("Renderer "+d+" is not registered");this.renderQueue.emit({alias:d,target:p,config:b})}return this};f.prototype.addNode=function(c,a){var b=this;return new h(c,this,a,function(c){b.events.plug(c.events);b.event["patch/add-node"].emit(c);c.turnOn()})};f.prototype.removeNode=function(c){c.turnOff();this.event["patch/remove-node"].emit(c);this.events.unplug(c.events)};f.prototype.enter=function(){this.event["patch/enter"].emit();
return this};f.prototype.exit=function(){this.event["patch/exit"].emit();return this};f.prototype.inputs=function(c){this.event["patch/set-inputs"].emit(c)};f.prototype.outputs=function(c){this.event["patch/set-outputs"].emit(c)};f.prototype.project=function(c){this.projections.emit(c)};h.prototype.turnOn=function(){this.event["node/turn-on"].emit()};h.prototype.turnOff=function(){this.event["node/turn-off"].emit()};h.prototype.addInlet=function(c,a,b,g,e,d,f){c=new l(c,this,a,b,g,e,d,f);this.events.plug(c.events);
this.event["node/add-inlet"].emit(c);c.toDefault();return c};h.prototype.addOutlet=function(c,a,b,g){c=new m(c,this,a,b,g);this.events.plug(c.events);this.event["node/add-outlet"].emit(c);c.toDefault();return c};h.prototype.removeInlet=function(c){this.event["node/remove-inlet"].emit(c);this.events.unplug(c.events)};h.prototype.removeOutlet=function(c){this.event["node/remove-outlet"].emit(c);this.events.unplug(c.events)};h.prototype.move=function(c,a){this.event["node/move"].emit([c,a]);return this};
l.prototype.receive=function(c){this.value.plug(d.constant(c))};l.prototype.stream=function(c){this.value.plug(c)};l.prototype.toDefault=function(){q(this.default)&&(this.default instanceof d.Stream?this.stream(this.default):this.receive(this.default))};l.prototype.allows=function(c){if(c.type===this.type)return!0;if(!this.def.allow&&c.type!==this.type)return!1;if(this.def.allow){var a=!1;this.def.allow.forEach(function(b){c.type===b&&(a=!0)});return a}return!0};m.prototype.connect=function(c){if(!c.allows(this))throw Error("Outlet of type "+
this.type+" is not allowed to connect to inlet of type "+c.type);var a=new k(this,c);this.events.plug(a.events);this.value.onValue(a.receiver);this.event["outlet/connect"].emit({link:a,inlet:c});return a};m.prototype.disconnect=function(c){this.event["outlet/disconnect"].emit(c);this.value.offValue(c.receiver);this.events.unplug(c.events);return this};m.prototype.send=function(c){this.value.plug(d.constant(c))};m.prototype.stream=function(c){this.value.plug(c)};m.prototype.toDefault=function(){q(this.default)&&
(this.default instanceof d.Stream?this.stream(this.default):this.send(this.default))};k.prototype.pass=function(c){this.value.emit(c)};k.prototype.enable=function(){this.event["link/enable"].emit()};k.prototype.disable=function(){this.event["link/disable"].emit()};k.prototype.disconnect=function(){this.outlet.disconnect(this)};return{VERSION:"v2.0",_:{Patch:f,Node:h,Inlet:l,Outlet:m,Link:k},unit:a,not:function(c){return!c},event:G,events:t,addPatch:function(c){c=new f(c);G["network/add-patch"].emit(c);
return c},render:function(c,a,b){n.emit([c,a,b]);var g=function(g){g.render(c,a,b)};G["network/add-patch"].onValue(g);return function(){G["network/add-patch"].offValue(g)}},nodetype:function(c,a){x[c]=a||{}},channeltype:function(c,a){E[c]=a||{}},nodedescription:function(c,a){I[c]=a},renderer:function(c,a){J[c]=a},styles:B,style:function(c,a,b){B[c]||(B[c]={});B[c][a]=b},noderenderer:function(c,a,b){if(!x[c])throw Error("Node type "+c+" is not registered");A[c]||(A[c]={});A[c][a]=b},channelrenderer:function(c,
a,b){if(!E[c])throw Error("Channel type "+c+" is not registered");F[c]||(F[c]={});F[c][a]=b},"import":{},"export":{},allNodeTypes:x,allNodeDescriptions:I,getStyle:function(c,a){if(!c)throw Error("Unknown style requested: "+c);if(!B[c])throw Error("Style '"+c+"' is not registered");var b=B[c][a];if(!b)throw Error("Style '"+c+"' has no definition for '"+a+"' renderer");return b},short_uid:u}}();"function"===typeof define&&define.amd?(define([],function(){return b}),a.Rpd=b):"object"===typeof module&&
"object"===typeof exports?(module.exports=b,b.Rpd=b):a.Rpd=b})(this);var d3_tiny=function(){function a(a,e,d){for(var h="function"===typeof e?e:function(){return e},l=a.selection,m=0,k=l.length;m<k;m++)d(l[m],h.bind(l[m])(m));return a}function d(a,e,d){e=e||document;selection="string"===typeof a?d?Array.prototype.slice.call(e.querySelectorAll(a),0):[e.querySelector(a)]:a instanceof Node?[a]:Array.isArray(a)?a:[a];this.namespace=1===selection.length&&selection[0]?selection[0].namespaceURI:null;this.selection=selection}d.prototype.empty=function(){return 1===this.selection.length&&
!this.selection[0]||!this.selection.length?!0:!1};d.prototype.attr=function(b,d){return"undefined"===typeof d&&1===this.selection.length?this.selection[0].getAttribute(b):a(this,d,function(a,d){a.setAttributeNS(null,b,d)})};d.prototype.property=function(b,d){return"undefined"===typeof d&&1===this.selection.length?this.selection[0][b]:a(this,d,function(a,d){a[b]=d})};d.prototype.style=function(b,d){"-"===b[0]&&(b=b.slice(1));b=b.replace(/-([a-z])/g,function(a){return a[1].toUpperCase()});return a(this,
d,function(a,d){a.style[b]=d})};d.prototype.text=function(b){return"undefined"===typeof b&&1===this.selection.length?this.selection[0].textContent||this.selection[0].innerText:a(this,b,function(a,b){a.innerText=a.textContent=b})};d.prototype.classed=function(b,d){return"object"===typeof b?a(this,Object.keys(b),function(a,d){for(var e=0,m=d.length;e<m;e++)a.classList.toggle(d[e],b[d[e]])}):a(this,d,function(a,d){a.classList.toggle(b,d)})};d.prototype.select=function(a){return new d(a,this.selection[0])};
d.prototype.selectAll=function(a){return new d(a,this.selection[0],!0)};d.prototype.append=function(b){var e=[];a(this,"string"===typeof b?document.createElementNS(this.namespace,b):b,function(a,b){a.appendChild(b);e.push(b)});return new d(e)};d.prototype.remove=function(){return a(this,function(){return null},function(a){a.parentElement.removeChild(a)})};d.prototype.node=function(a){return this.selection[a||0]};d.prototype.on=function(b,d){return a(this,function(){return d},function(a,d){a.addEventListener(b,
d)})};d.prototype.data=function(b){return b?a(this,b,function(a,b){a.__data__=b}):this.node().__data__};d.prototype.call=function(a){a(this);return this};return{ns:{prefix:{svg:"http://www.w3.org/2000/svg",html:"http://www.w3.org/1999/xhtml"}},select:function(a,e){return new d(a,e)},selectAll:function(a,e){return new d(a,e,!0)}}}();Rpd.Render=function(){function a(a){this.currentPatch=null;this.getPatchByHash=a;var b=this;Kefir.fromEvents(window,"hashchange").map(function(){return window.location.hash?window.location.hash.slice(1):null}).filter(function(a){return!(b.currentPatch&&a===b.currentPatch.id)}).map(b.getPatchByHash).filter(function(a){return null!=a}).onValue(function(a){b.currentPatch&&b.currentPatch.exit();a.enter()})}function d(a){this.nodeRects=[];this.edgePadding=a.edgePadding||{horizontal:30,vertical:20};this.boxPadding=
a.boxPadding||{horizontal:20,vertical:30}}function b(a,b){this.root=a;this.style=b}function e(a,b){this.link=a;this.style=b;this.element=this.styledLink=null}function f(){this.vlinks=[]}function h(a){a.stopPropagation();return a}function l(a){return{x:a.clientX,y:a.clientY}}function m(a,b,d,e){Kefir.fromEvents(a,"click").map(h).map(k(e||!1)).scan(Rpd.not).onValue(function(a){a?b():d()})}var k=Rpd.unit,r=d3_tiny||r;a.prototype.switch=function(a){a&&(this.currentPatch=a,0<=document.title.indexOf("\u2014")?
document.title=document.title.replace(/\u2014.+$/,"\u2014 "+a.name||"[Unnamed]"):document.title+=" \u2014 "+a.name||"[Unnamed]",window.location.hash=a.id)};d.DEFAULT_LIMITS=[1E3,1E3];d.prototype.nextPosition=function(a,b,e){e=e||d.DEFAULT_LIMITS;a=this.nodeRects;var l=this.boxPadding,k=this.edgePadding,f=b.width;b=b.height;var h=a.length?a[a.length-1]:null,h={x:h?h.x:k.horizontal,y:h?h.y+h.height+l.vertical:k.vertical,width:f,height:b};h.y+b+k.vertical>e.height&&(h.x=h.x+f+l.horizontal,h.y=k.vertical);
a.push(h);return{x:h.x,y:h.y}};b.prototype.add=function(a,b){var d=this.root,e=this.style,k=b.start,f=b.end,m=b.drag;Kefir.fromEvents(a.node(),"mousedown").map(l).map(e.getLocalPos).flatMap(function(b){var m=k(),w=b.x-m.x,r=b.y-m.y;b=Kefir.fromEvents(d.node(),"mousemove").map(h).takeUntilBy(Kefir.merge([Kefir.fromEvents(d.node(),"mouseup"),Kefir.fromEvents(a.node(),"mouseup")])).map(l).map(e.getLocalPos).map(function(a){return{x:a.x-w,y:a.y-r}}).toProperty(function(){return m});b.last().onValue(f);
return b}).onValue(m)};e.prototype.construct=function(a){if(this.styledLink)throw Error("VLink is already constructed");this.styledLink=a=this.style.createLink(this.link);this.element=r.select(a.element);return this};e.prototype.rotate=function(a,b,d,e){this.styledLink.rotate(a,b,d,e);return this};e.prototype.rotateI=function(a,b,d){var e=this.style,e=e.getLocalPos(e.getInletPos(d));return this.rotate(a,b,e.x,d.y)};e.prototype.rotateO=function(a,b,d){var e=this.style;a=e.getLocalPos(e.getOutletPos(a));
return this.rotate(a.x,a.y,b,d)};e.prototype.rotateOI=function(a,b){var d=this.style,e=d.getLocalPos(d.getOutletPos(a)),d=d.getLocalPos(d.getInletPos(b));return this.rotate(e.x,e.y,d.x,d.y)};e.prototype.update=function(){if(this.link){var a=this.link;this.rotateOI(a.outlet,a.inlet);return this}};e.prototype.appendTo=function(a){a.append(this.element.node());return this};e.prototype.removeFrom=function(a){this.element.remove();return this};e.prototype.noPointerEvents=function(){this.styledLink.noPointerEvents&&
this.styledLink.noPointerEvents();return this};e.prototype.listenForClicks=function(){var a=this.link;m(this.element.node(),function(){a.enable()},function(){a.disable()});return this};e.prototype.enable=function(){this.element.classed("rpd-disabled",!1)};e.prototype.disable=function(){this.element.classed("rpd-disabled",!0)};e.prototype.get=function(){return this.link};e.prototype.getElement=function(){return this.element.node()};f.prototype.clear=function(){this.vlinks=[]};f.prototype.add=function(a){this.vlinks.push(a);
return a};f.prototype.remove=function(a){this.vlinks=this.vlinks.filter(function(b){return b!==a})};f.prototype.forEach=function(a){this.vlinks.forEach(a)};f.prototype.updateAll=function(){this.forEach(function(a){a.update()})};f.prototype.count=function(){return this.vlinks.length};f.prototype.getLast=function(){return this.count()?this.vlinks[this.vlinks.length-1]:null};var q=function(){var a={};return function(b,d,e){d.classed("rpd-error",!0);a[b]&&clearTimeout(a[b]);a[b]=setTimeout(function(){d.classed("rpd-error",
!1);a[b]=null},e||1)}}(),z=function(){var a={};return function(b,d,e){d.classed("rpd-stale",!1);d.classed("rpd-fresh",!0);a[b]&&clearTimeout(a[b]);a[b]=setTimeout(function(){d.classed("rpd-fresh",!1);d.classed("rpd-stale",!0);a[b]=null},e||1)}}();return{Navigation:a,Placing:d,DragAndDrop:b,VLink:e,VLinks:f,mergeConfig:function(a,b){if(a){var d={};Object.keys(b).forEach(function(a){d[a]=b[a]});Object.keys(a).forEach(function(b){d[b]=a[b]});return d}return b},preventDefault:function(a){a.preventDefault();
return a},stopPropagation:h,extractPos:l,addTarget:function(a){return function(b){return{pos:b,target:a}}},addClickSwitch:m,addValueErrorEffect:q,addValueUpdateEffect:z,subscribeUpdates:function(a,b){b&&Object.keys(b).forEach(function(d){(function(b,d){a.event["node/add-inlet"].filter(function(a){return a.alias===d}).onValue(function(d){a.event["node/is-ready"].onValue(function(){b.default&&d.receive(b.default());if(b.valueOut)b.valueOut.onValue(function(a){d.receive(a)})})})})(b[d],d)})}}}();Rpd.style("pd","html",function(a){function d(a){a=a.getBoundingClientRect();return{x:a.left,y:a.top}}var b=b||d3_tiny,e,f={},h={};return{edgePadding:{horizontal:20,vertical:40},boxPadding:{horizontal:20,vertical:80},createRoot:function(a,d){return{element:b.select(document.createElement("div")).classed("rpd-patch",!0).node()}},createNode:function(d,e,k){var f=b.select(document.createElement("table")).attr("class","rpd-node");f.append("tr").attr("class","rpd-inlets").append("td").append("table").append("tbody").append("tr").append("div").attr("class",
"rpd-inlets-target");f.append("tr").attr("class","rpd-remove-button").append("td").text("x");f.append("tr").attr("class","rpd-content").call(function(b){b.append("td").attr("class","rpd-title").classed("rpd-header",!0).classed("rpd-drag-handle",!0).call(function(b){b.append("span").attr("class","rpd-name").text(d.name);a.showTypes&&b.append("span").attr("class","rpd-type").text(d.type);b.attr("title",k?k+" ("+d.type+")":d.type)});b.append("td").attr("class","rpd-body").append("div").append("table").append("tbody").append("tr").append("td").append("div").attr("class",
"rpd-process-target")});f.append("tr").attr("class","rpd-outlets").append("td").append("table").append("tbody").append("tr").append("div").attr("class","rpd-outlets-target");return{element:f.node(),size:e.size?{width:e.size.width||30,height:e.size.height||20}:{width:30,height:20}}},createInlet:function(d,e){var k=b.select(document.createElement("td")).attr("class","rpd-inlet").call(function(b){b.append("span").attr("class","rpd-connector");b.append("span").attr("class","rpd-name").text(d.name);b.append("span").attr("class",
"rpd-value-holder").append("span").attr("class","rpd-value");a.showTypes&&b.append("span").attr("class","rpd-type").text(d.type)});f[d.id]=k.select(".rpd-connector");return{element:k.node()}},createOutlet:function(d,e){var k=b.select(document.createElement("td")).attr("class","rpd-outlet").call(function(b){b.append("span").attr("class","rpd-connector");b.append("span").attr("class","rpd-name").text(d.name);b.append("span").attr("class","rpd-value");a.showTypes&&b.append("span").attr("class","rpd-type").text(d.type)});
h[d.id]=k.select(".rpd-connector");return{element:k.node()}},createLink:function(a){var d=b.select(document.createElement("span")).attr("class","rpd-link").style("position","absolute").style("transform-origin","left top").style("-webkit-transform-origin","left top");return{element:d.node(),rotate:function(a,b,e,l){var f=Math.sqrt((a-e)*(a-e)+(b-l)*(b-l));e=Math.atan2(l-b,e-a);d.style("left",a+"px").style("top",b+"px").style("width",Math.floor(f)+"px").style("transform","rotateZ("+e+"rad)").style("-webkit-transform",
"rotateZ("+e+"rad)")}}},getInletPos:function(a){return d(f[a.id].node())},getOutletPos:function(a){return d(h[a.id].node())},getLocalPos:function(a){if(!e)return a;var b=d(e.node());return{x:a.x+b.x,y:a.y+b.y}},onPatchSwitch:function(a,d){e=b.select(d)}}});(function(){function a(a){return function(d,f){var t=D(f,h),n=Rpd.getStyle(t.style,"html")(t);d=l.select(d).classed("rpd-network",!0);var c,y,K;return{"patch/is-ready":function(g){var e=l.select(document.documentElement);c=l.select(n.createRoot(a,d).element).style("height",e.property("clientHeight")+"px");c.classed("rpd-style-"+t.style,!0).classed("rpd-values-"+(t.valuesOnHover?"on-hover":"always-shown"),!0).classed("rpd-show-boxes",t.showBoxes);k.patches[a.id]=c.data({patch:g.patch});k.patchToPlacing[a.id]=
new m.Placing(n);k.patchToLinks[a.id]=new v;y=new w(c,n,t);t.nodeMovingAllowed&&(K=new m.DragAndDrop(c,n));t.renderNodeList&&b(c,z,p);Kefir.fromEvents(window,"resize").map(function(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}).onValue(function(a){c.style("height",a+"px")});Kefir.fromEvents(c.node(),"selectstart").onValue(u)},"patch/enter":function(a){q=a.patch;r.switch(a.patch);var c=k.patches[a.patch.id];d.append(c.node());k.patchToLinks[a.patch.id].updateAll();
if(n.onPatchSwitch)n.onPatchSwitch(q,c.node())},"patch/exit":function(a){q=null;c.remove()},"patch/refer":function(c){var b=k.nodes[c.node.id];b.select(".rpd-node").classed("rpd-patch-reference",!0);b.data().processTarget.text("["+(c.target.name||c.target.id)+"]");Kefir.fromEvents(b.data().processTarget.node(),"click").onValue(function(a,c){return function(){a.exit();c.enter()}}(a,c.target))},"patch/add-node":function(a){var c=a.node,b=a.patch,d=a.render,e=l.select(document.createElement("div")).attr("class",
"rpd-node-box"),f=n.createNode(c,d,p[c.type]),h=e.append(f.element);h.classed("rpd-"+c.type.slice(0,c.type.indexOf("/"))+"-toolkit-node",!0).classed("rpd-"+c.type.replace("/","-"),!0);e.style("z-index",0);k.nodes[c.id]=e.data({inletsTarget:h.select(".rpd-inlets-target"),outletsTarget:h.select(".rpd-outlets-target"),processTarget:h.select(".rpd-process-target"),pos:{x:0,y:0}});var m=new v;k.nodeToLinks[c.id]=m;if(t.nodeMovingAllowed){var y=h.select(".rpd-drag-handle");y.empty()||K.add(y,{start:function(){e.classed("rpd-dragging",
!0);e.style("z-index",1);return e.data().pos},drag:function(a){e.style("left",a.x+"px");e.style("top",a.y+"px");m.forEach(function(a){a.element.style("z-index",3);a.update()})},end:function(a){c.move(a.x,a.y);e.classed("rpd-dragging",!1);e.style("z-index",0);m.forEach(function(a){a.element.style("z-index",2)})}})}d.prepare&&d.prepare.bind(c)(k.patches[b.id].node(),k.patches[q.id].node());d.first&&B(c,d.first.bind(c)(h.select(".rpd-process-target").node()));if(d.always)c.event["node/process"].throttle(100).onValue(function(){m.updateAll()});
d=k.patches[q.id];f=f.size;nodePos=k.patchToPlacing[a.patch.id].nextPosition(c,f,{width:d.node().offsetWidth,height:d.node().offsetHeight});h.select(".rpd-body").style("min-width",Math.floor(f.width)+"px");h.select(".rpd-body").style("height",Math.floor(f.height)+"px");c.move(nodePos.x,nodePos.y);a=h.select(".rpd-remove-button");if(!a.empty())Kefir.fromEvents(a.node(),"click").map(C).onValue(function(){b.removeNode(c)});k.patches[b.id].append(e.node())},"patch/remove-node":function(a){a=a.node;var c=
k.nodes[a.id];k.nodeToLinks[a.id].forEach(function(a){a.get().disconnect()});c.remove();if(n.onNodeRemove)n.onNodeRemove(a);k.nodes[a.id]=null;k.nodeToLinks[a.id]=null},"node/move":function(a){var c=k.nodes[a.node.id];a=a.position;c.style("left",Math.floor(a[0])+"px");c.style("top",Math.floor(a[1])+"px");c.data().pos={x:a[0],y:a[1]}},"node/process":function(a){var c=a.node,b=a.render;if(b.always){var d=k.nodes[c.id].data().processTarget.node();b.always.bind(c)(d,a.inlets,a.outlets)}},"node/add-inlet":function(a){var b=
a.inlet;if(!b.hidden){var d=k.nodes[a.node.id].data().inletsTarget;a=a.render;var f=l.select(n.createInlet(b,a).element);f.classed("rpd-"+b.type.replace("/","-"),!0);f.classed({"rpd-stale":!0,"rpd-readonly":b.readonly,"rpd-cold":b.cold});var h=null;!b.readonly&&a.edit&&(h=new e(b,a,c,f.select(".rpd-value-holder"),f.select(".rpd-value"),l.select(document.createElement("div"))),f.select(".rpd-value-holder").append(h.editorElm.node()));k.inlets[b.id]=f.data({connector:f.select(".rpd-connector"),value:f.select(".rpd-value"),
vlinks:new v,editor:h});b.event["inlet/update"].onError(function(){F(b.id,f,t.effectTime)});y.subscribeInlet(b,f.select(".rpd-connector"));d.append(f.node())}},"node/add-outlet":function(a){var c=a.outlet,b=k.nodes[a.node.id].data().outletsTarget;a=l.select(n.createOutlet(c,a.render).element);a.classed("rpd-"+c.type.replace("/","-"),!0);a.classed("rpd-stale",!0);k.outlets[c.id]=a.data({connector:a.select(".rpd-connector"),value:a.select(".rpd-value"),vlinks:new v});y.subscribeOutlet(c,a.select(".rpd-connector"));
b.append(a.node())},"node/remove-inlet":function(a){a=a.inlet;k.inlets[a.id].data().vlinks.forEach(function(a){a.get().disconnect()});k.inlets[a.id].remove();if(n.onInletRemove)n.onInletRemove(a);k.inlets[a.id]=null},"node/remove-outlet":function(a){a=a.outlet;k.outlets[a.id].data().vlinks.forEach(function(a){a.get().disconnect()});k.outlets[a.id].remove();if(n.onOutletRemove)n.onOutletRemove(a);k.outlets[a.id]=null},"inlet/update":function(a){var c=a.inlet;if(!c.hidden){var b=a.render,d=k.inlets[c.id],
e=d.data().value;if(!e.empty()){var f=c.def.show?c.def.show(a.value):a.value;b.show?b.show.bind(c)(e.node(),a.value,f):e.text(f)}I(c.id,d,t.effectTime)}},"outlet/update":function(a){var c=a.outlet,b=a.render,d=k.outlets[c.id],e=d.data().value;if(!e.empty()){var f=c.def.show?c.def.show(a.value):a.value;b.show?b.show.bind(c)(e.node(),a.value,f):e.text(f)}I(c.id,d,t.effectTime)},"outlet/connect":function(b){b=b.link;var d=b.outlet,e=b.inlet,f=k.inlets[e.id],h=k.outlets[d.id].data(),f=f.data();if(!t.inletAcceptsMultipleLinks&&
1===f.vlinks.count())throw Error("Inlet is already connected to a link");f.editor&&f.editor.disable();var m=new H(b,n);m.construct(t.linkWidth).rotateOI(d,e);l.select(m.getElement()).style("z-index",2).classed("rpd-"+e.type.replace("/","-"),!0).classed("rpd-"+d.type.replace("/","-"),!0);k.links[b.id]=m;h.vlinks.add(m);f.vlinks.add(m);k.nodeToLinks[d.node.id].add(m);d.node.id!==e.node.id&&k.nodeToLinks[e.node.id].add(m);k.patchToLinks[a.id].add(m);m.listenForClicks();m.appendTo(c)},"outlet/disconnect":function(b){b=
b.link;var d=k.links[b.id],e=b.outlet,f=b.inlet,l=k.outlets[e.id].data(),h=k.inlets[f.id].data();k.links[b.id]=null;l.vlinks.remove(d);h.vlinks.remove(d);k.nodeToLinks[e.node.id].remove(d);e.node.id!==f.node.id&&k.nodeToLinks[f.node.id].remove(d);k.patchToLinks[a.id].remove(d);d.removeFrom(c)},"link/enable":function(a){var c=k.inlets[a.link.inlet.id].data();c.editor&&c.editor.disable();k.links[a.link.id].enable()},"link/disable":function(a){k.links[a.link.id].disable()}}}}function d(a,b){return Kefir.merge([a.map(f(!0)),
b.map(f(!1))]).toProperty(f(!1))}function b(a,b,d){var e={};Object.keys(b).forEach(function(a){var d=a.split("/"),f=d[0],d=d[1];e[f]||(e[f]={});e[f][d]=b[a]});var f=l.select(document.createElement("dl")).attr("class","rpd-nodelist");Object.keys(e).forEach(function(a){var b=f.append("dd").attr("class","rpd-toolkit-name").text(a);f.append("dt").append("dl").attr("class","rpd-toolkit").data({titleElm:b,nodeTypes:e[a],toolkit:a}).call(function(a){var c=a.data().titleElm;A(c.node(),function(){a.classed("rpd-collapsed",
!0)},function(){a.classed("rpd-collapsed",!1)},!0)}).call(function(a){var c=a.data().toolkit,b=a.data().nodeTypes;Object.keys(b).forEach(function(b){var e=c+"/"+b;b=a.append("dd").attr("class","rpd-node-title").text(b);b.append("span").attr("class","rpd-add-node").text("+ Add").data(e).call(function(a){Kefir.fromEvents(a.node(),"click").map(C).onValue(function(){q.addNode(a.data())})});a.append("dd").attr("class","rpd-node-description").data({titleElm:b}).text(d[e]||"[No Description]").classed("rpd-collapsed",
!0).call(function(a){A(a.data().titleElm.node(),function(){a.classed("rpd-collapsed",!0)},function(){a.classed("rpd-collapsed",!1)})})})})});a.append(f.node());a.append(l.select(document.createElement("span")).attr("class","rpd-collapse-nodelist").text(">>").call(function(a){A(a.node(),function(){a.classed("rpd-collapsed",!0).text("<<");f.classed("rpd-collapsed",!0)},function(){a.classed("rpd-collapsed",!1).text(">>");f.classed("rpd-collapsed",!1)},!0)}).node())}function e(a,b,d,e,l,c){var h=Kefir.emitter(),
m=Kefir.emitter();this.disableEditor=m;this.editorElm=c;this.valueElm=l;c.classed("rpd-value-editor",!0);b.edit.bind(a)(c.node(),a,h).onValue(function(c){a.receive(c)});Kefir.combine([Kefir.merge([Kefir.fromEvents(e.node(),"click").map(C).map(f(!0)),Kefir.fromEvents(d.node(),"click").merge(m).map(f(!1))]).toProperty(f(!1)).skipDuplicates()],[a.event["inlet/update"]]).map(function(a){return{lastValue:a[1],startEditing:a[0],cancelEditing:!a[0]}}).onValue(function(c){if(c.startEditing){var b=k.inlets[a.id].data();
b.link&&b.link.disable();h.emit(c.lastValue);e.classed("rpd-editor-enabled",!0)}else c.cancelEditing&&(l.classed("rpd-edited",!0),e.classed("rpd-editor-enabled",!1))});e.classed("rpd-editor-disabled",!0)}var f=Rpd.unit,h={style:"quartz",valuesOnHover:!1,showTypes:!1,showBoxes:!1,nodeMovingAllowed:!0,renderNodeList:!0,nodeListCollapsed:!0,inletAcceptsMultipleLinks:!1,effectTime:1E3},l=l||d3_tiny,m=Rpd.Render,k={patches:{},nodes:{},inlets:{},outlets:{},links:{},patchToPlacing:{},patchToLinks:{},nodeToLinks:{}},
r=new m.Navigation(function(a){return function(b){return a.patches[b].data().patch}}(k)),q,z=Rpd.allNodeTypes,p=Rpd.allNodeDescriptions,w=function(){function a(c){return k.inlets[c.id].data().vlinks}function b(c){return function(){return 0<a(c).count()}}function e(a){1===a.count()&&(a=a.getLast().link,a.outlet.disconnect(a))}function h(a,b){a.forEach(function(a){a.link.outlet.id===b.id&&b.disconnect(a.link)})}function m(a,b,e){this.root=a;this.style=b;this.config=e;this.rootClicks=Kefir.fromEvents(this.root.node(),
"click");this.inletClicks=Kefir.pool();this.outletClicks=Kefir.pool();this.startLink=Kefir.emitter();this.finishLink=Kefir.emitter();this.doingLink=d(this.startLink,this.finishLink)}m.prototype.subscribeOutlet=function(b,k){var m=this.root,g=this.style,n=this.config,r=this.rootClicks,p=this.outletClicks,q=this.inletClicks,v=this.startLink,w=this.finishLink,u=this.doingLink;p.plug(Kefir.fromEvents(k.node(),"click").map(x).map(E(b)));Kefir.fromEvents(k.node(),"click").map(C).filterBy(d(p,u)).map(x).onValue(function(d){v.emit();
var k=(new H(null,g)).construct(n.linkWidth).rotateO(b,d.x,d.y).noPointerEvents().appendTo(m);l.select(k.getElement()).style("z-index",2).classed("rpd-"+b.type.replace("/","-"),!0);Kefir.fromEvents(m.node(),"mousemove").takeUntilBy(Kefir.merge([q,p.map(f(!1)),r.map(f(!1))]).take(1).onValue(function(d){if(d){d=d.target;var f=a(d);n.inletAcceptsMultipleLinks?h(f,b):e(f);b.connect(d)}})).map(x).onValue(function(a){k.rotateO(b,a.x,a.y)}).onEnd(function(){k.removeFrom(m);w.emit()})})};m.prototype.subscribeInlet=
function(c,k){var m=this.root,g=this.style,n=this.config,r=this.rootClicks,p=this.outletClicks,q=this.inletClicks,v=this.startLink,w=this.finishLink,u=this.doingLink;q.plug(Kefir.fromEvents(k.node(),"click").map(x).map(E(c)));Kefir.fromEvents(k.node(),"click").map(C).filterBy(d(q,u)).filter(b(c)).onValue(function(b){var d=a(c).getLast().link,k=d.outlet;k.disconnect(d);v.emit();var u=(new H(null,g)).construct(n.linkWidth).rotateO(k,b.x,b.y).noPointerEvents().appendTo(m);l.select(u.getElement()).style("z-index",
2).classed("rpd-"+c.type.replace("/","-"),!0).classed("rpd-"+k.type.replace("/","-"),!0);Kefir.fromEvents(m.node(),"mousemove").takeUntilBy(Kefir.merge([q,p.map(f(!1)),r.map(f(!1))]).take(1).onValue(function(b){if(b){b=b.target;var c=a(b);n.inletAcceptsMultipleLinks?h(c,k):e(c);k.connect(b)}})).map(x).map(g.getLocalPos).onValue(function(a){u.rotateO(k,a.x,a.y)}).onEnd(function(){u.removeFrom(m);w.emit()})})};return m}();e.prototype.disable=function(){this.valueElm.classed("rpd-edited",!1);this.disableEditor.emit()};
var H=m.VLink,v=m.VLinks,D=m.mergeConfig,u=m.preventDefault,C=m.stopPropagation,x=m.extractPos,E=m.addTarget,A=m.addClickSwitch,F=m.addValueErrorEffect,I=m.addValueUpdateEffect,B=m.subscribeUpdates;Rpd.HtmlRenderer=a;Rpd.renderer("html",a)})();function Spread(a,d){this.type=a;this.iter_f=d}Spread.prototype.iterator=function(){return Spread._makeIterator(this.iter_f)};Spread.prototype.stream=function(a){return Spread._makeStream(this.iter_f,a)};Spread.prototype.empty=function(){return this.is(Spread.EMPTY)};Spread.prototype.is=function(a){return this.type===a};Spread.prototype.toString=function(){return"["+this.type+"]"};Spread._makeIterator=function(a){return a()};
Spread._makeStream=function(a,d){var b=a();return d?d.map(b).takeWhile(function(a){return a!==Spread.STOP}):Kefir.stream(function(a){for(var d;(d=b())!==Spread.STOP;)a.emit(d);a.end()})};Spread.is=function(a,d){return a&&a instanceof Spread?a.is(d):!1};
Spread.join=function(a,d,b){return new Spread(d,function(){for(var d=0;d<a.length;d++)if(!a[d]||a[d].empty())return function(){return Spread.STOP};for(var f=[],h=[],d=0;d<a.length;d++)f.push(a[d].iterator()),h.push(!1);var l=a.length;return function(){for(var d=[],e=0;e<f.length;e++){var r=f[e]();if(r===Spread.STOP){if(!h[e]&&(l--,!l))return Spread.STOP;h[e]=!0;f[e]=a[e].iterator();r=f[e]()}d.push(r)}return b?b.apply(null,d):d}})};
Spread.adapt=function(a,d){return"undefined"===typeof a?Spread.empty():Array.isArray(a)?Spread.fromArray(a,d):a instanceof Spread?a:Spread.fromValue(a,d)};Spread.empty=function(){return new Spread(Spread.EMPTY,function(){return function(){return Spread.STOP}})};Spread.fromValue=function(a,d){return new Spread(d,function(){var b=!1;return function(){if(b)return Spread.STOP;b=!0;return a}})};
Spread.fromArray=function(a,d){return new Spread(d,function(){var b=0;return function(){return b<a.length?a[b++]:Spread.STOP}})};Spread.of=function(a,d){return"undefined"===typeof a?Spread.empty():Array.isArray(a)?Spread.fromArray(a,d):Spread.fromValue(a,d)};Spread.MAX_REPEATS=1E3;Spread.STOP="_STOP_";Spread.EMPTY="Empty";Spread.UNKNOWN="Empty";Spread.NUMBERS="Numbers";Spread.VECTORS="Vectors";Spread.COLORS="Colors";Spread.ELEMENTS="Elements";Spread.FORCES="Forces";
function minMaxSpread(a,d,b){var e=Math.min(a,d)||0,f=Math.max(a,d)||0;b=1<b?b:1;return new Spread(Spread.NUMBERS,function(){if(e!==f){var a=(f-e)/(b-1),d=e,m=0;return function(){if(m<b){var e=d;d+=a;m++;return e}return Spread.STOP}}var k=b;return function(){if(!k)return Spread.STOP;k--;return e}})}function Vector(a,d){this.x=a||0;this.y=d||0}Vector.prototype.toString=function(){return"("+this.x.toFixed(3)+";"+this.y.toFixed(3)+")"};function S(a){return function(d){return Spread.adapt(d,a)}}function stringify(a){return a.toString()}function accept(a){return function(d){return Spread.is(d,a)}}var NUMBERS=Spread.NUMBERS,VECTORS=Spread.VECTORS,COLORS=Spread.COLORS,ELEMENTS=Spread.ELEMENTS,FORCES=Spread.FORCES;Rpd.channeltype("anm/numbers",{adapt:S(NUMBERS),show:stringify});Rpd.channeltype("anm/vectors",{adapt:S(VECTORS),show:stringify,accept:accept(VECTORS)});Rpd.channeltype("anm/colors",{adapt:S(COLORS),show:stringify,accept:accept(COLORS)});
Rpd.channeltype("anm/elements",{adapt:S(ELEMENTS),show:stringify,accept:accept(ELEMENTS)});Rpd.channeltype("anm/force",{show:function(a){return a?"[Force]":"None"},accept:function(a){return"function"===typeof a}});Rpd.channeltype("anm/shapetype");
Rpd.nodetype("anm/spread",{name:"spread",inlets:{min:{type:"core/number",default:0},max:{type:"core/number",default:1},count:{type:"core/number",default:5}},outlets:{spread:{type:"anm/numbers"}},process:function(a){return{spread:minMaxSpread(a.min,a.max,a.count)}}});
Rpd.nodetype("anm/color",{name:"color",inlets:{red:{type:"anm/numbers",default:1},green:{type:"anm/numbers",default:1},blue:{type:"anm/numbers",default:1},alpha:{type:"anm/numbers",default:1}},outlets:{color:{type:"anm/colors"}},process:function(a){return{color:Spread.join([a.red,a.green,a.blue,a.alpha],COLORS,function(a,b,e,f){return"rgba("+(a?Math.round(255*a):0)+","+(b?Math.round(255*b):0)+","+(e?Math.round(255*e):0)+","+(f||0)+")"})}}});
Rpd.nodetype("anm/vector",{name:"vector",inlets:{x:{type:"anm/numbers",default:0},y:{type:"anm/numbers",default:0}},outlets:{vector:{type:"anm/vectors"}},process:function(a){return{vector:Spread.join([a.x,a.y],VECTORS,function(a,b){return new Vector(a,b)})}}});
Rpd.nodetype("anm/primitive",{name:"primitive",inlets:{pos:{type:"anm/vectors",default:Spread.of(new Vector(0,0),VECTORS)},color:{type:"anm/colors",default:Spread.of("rgba(255,60,60,1)",COLORS)},size:{type:"anm/vectors",default:Spread.of(new Vector(15,15),VECTORS)},angle:{type:"anm/numbers",default:Spread.of(0,NUMBERS)},type:{type:"anm/shapetype",default:"rect",hidden:!0}},outlets:{shape:{type:"anm/elements"}},process:function(a){if(a.type)return{shape:Spread.join([a.pos,a.color,a.size,a.angle],ELEMENTS,
function(d,b,e,f,h){return function(l){l.move(d.x,d.y);l.rotate(Math.PI/180*f);switch(a.type){case "dot":l.dot();break;case "rect":l.rect(e.x,e.y);break;case "oval":l.oval(e.x,e.y);break;case "triangle":l.triangle(e.x,e.y)}l.fill(b)}})}}});
Rpd.nodetype("anm/particles",{name:"particles",inlets:{particle:{type:"anm/elements"},force:{type:"anm/force",default:function(a){}}},outlets:{system:{type:"anm/elements"}},process:function(a){new Vector(0,0);new Vector(242,5);new Vector(0,-150);return{system:Spread.join([a.particle,Spread.of(a.force,FORCES)],ELEMENTS,function(a){return function(b){a(b);return function(a,b){}}})}}});Rpd.nodetype("anm/render",function(){return{name:"render",inlets:{what:{type:"anm/elements"}},process:function(){}}});Rpd.noderenderer("anm/color","html",renderSpread("color",function(a,d){a.style.backgroundColor=d}));Rpd.noderenderer("anm/spread","html",renderSpread("spread",function(a,d){a.innerText=a.textContent=d.toFixed(3)}));Rpd.noderenderer("anm/vector","html",renderSpread("vector",function(a,d){a.innerText=a.textContent=d.toString()}));
Rpd.noderenderer("anm/primitive","html",function(){var a;return{first:function(d){a=document.createElement("select");a.appendChild(createOption("dot"));a.appendChild(createOption("rect"));a.appendChild(createOption("oval"));a.appendChild(createOption("triangle"));d.appendChild(a);return{type:{default:function(){return a.value="rect"},valueOut:Kefir.fromEvents(a,"change").map(function(){return a.options[a.selectedIndex].value})}}},always:function(d,b,e){a.value=b.type}}});
var RENDER_WIDTH=140,RENDER_HEIGHT=140;
Rpd.noderenderer("anm/render","html",function(){var a;return{first:function(d){var b=document.createElement("div");d.appendChild(b);a=anm.createPlayer(b,{width:RENDER_WIDTH,height:RENDER_HEIGHT,controlsEnabled:!1,repeat:!0,infiniteDuration:!0})},always:function(d,b,e){if(b.what){a.stop();a.anim&&(a.anim=null);var f=new anm.Element;f.sx=.25;f.sy=.25;f.x=RENDER_WIDTH/2;f.y=RENDER_HEIGHT/2;b.what.stream().onValue(function(a){var b=new anm.Element,d=a(b);d&&b.modify(function(a,b){d(a,b)});f.add(b)});
a.load(f);a.play()}}}});Rpd.channelrenderer("anm/colors","html",{show:function(a,d,b){a.innerText=a.textContent=d.toString();a.style.backgroundColor="transparent";a.classList.remove("rpd-anm-one-color")}});function renderSpread(a,d){return function(){var b;return{first:function(a){b=document.createElement("div");a.appendChild(b)},always:function(e,f,h){clearNode(b);var l;h[a].stream().onValue(function(a){l=document.createElement("span");d(l,a);b.appendChild(l)})}}}}
function createOption(a,d){var b=document.createElement("option");b.value=a;b.innerText=b.textContent=a;d&&(b.selected="selected");return b}function clearNode(a){for(;a.firstChild;)a.removeChild(a.firstChild)};Rpd.nodedescription("core/custom","May have any number of inlets and outlets, a target for extension.");Rpd.nodetype("core/custom",{name:"Custom"});Rpd.channeltype("core/number",{default:0,readonly:!1,accept:function(a){if(Infinity===a)return!0;a=parseFloat(a);return!isNaN(a)&&isFinite(a)},adapt:function(a){return parseFloat(a)}});
Rpd.channeltype("core/time",{default:1E3,accept:function(a){a=parseFloat(a);return!isNaN(a)&&isFinite(a)},adapt:function(a){return parseFloat(a)},show:function(a){return Math.floor(a/10)/100+"s"}});Rpd.nodetype("core/number",{name:"number",inlets:{"user-value":{type:"core/number",default:0,hidden:!0}},outlets:{out:{type:"core/number"}},process:function(a){return{out:a["user-value"]}}});
Rpd.nodetype("core/random",function(){var a=0;return{name:"random",inlets:{min:{type:"core/number",default:0},max:{type:"core/number",default:100},period:{type:"core/time",default:1E3}},outlets:{out:{type:"core/number"}},process:function(d){if(d.hasOwnProperty("period"))return a++,{out:Kefir.withInterval(d.period,function(a){a.emit(Math.floor(d.min+Math.random()*(d.max-d.min)))}).takeWhile(function(b){return function(){return b===a}}(a))}}}});
Rpd.nodetype("core/bounded-number",{name:"bounded number",inlets:{min:{type:"core/number",default:0},max:{type:"core/number",default:Infinity},spinner:{type:"core/number",default:0,hidden:!0}},outlets:{out:{type:"core/number"}},process:function(a){if(a.hasOwnProperty("spinner"))return{out:a.spinner}}});Rpd.channeltype("core/any",{});Rpd.channeltype("core/boolean",{default:!1,readonly:!1,adapt:function(a){return a?!0:!1}});(function(){function a(a){return{x:a.clientX,y:a.clientY}}function d(b,d,f){this.element=b;this.min=d||0;this.max=isNaN(f)?Infinity:f;this.value=this.min;var h=this;this.incoming=Kefir.emitter();Kefir.fromEvents(b,"mousedown").map(a).flatMap(function(b){var d=h.value;return Kefir.fromEvents(document.body,"mousemove").map(a).takeUntilBy(Kefir.fromEvents(document.body,"mouseup")).map(function(a){return d+(a.x-b.x)}).onValue(function(a){h.incoming.emit(a)})}).onEnd(function(){});this.changes=this.incoming.map(function(a){return h.setValue(a)})}
Rpd.noderenderer("core/number","html",{first:function(a){var d=document.createElement("input");d.style.display="block";d.type="number";d.min=0;d.max=1E3;a.appendChild(d);return{"user-value":{default:function(){return d.value=0},valueOut:Kefir.fromEvents(d,"change").map(function(){return d.value})}}}});Rpd.channelrenderer("core/boolean","html",{edit:function(a,d,f){var h=document.createElement("input");h.type="checkbox";f.onValue(function(a){h.checked=a?!0:!1});a.appendChild(h);return Kefir.fromEvents(h,
"change").map(function(){return h.checked}).toProperty(function(){return!1})}});Rpd.channelrenderer("core/number","html",{edit:function(a,d,f){var h=document.createElement("input");h.type="number";f.onValue(function(a){h.value=a});a.appendChild(h);return Kefir.fromEvents(h,"change").map(function(){return h.value})}});Rpd.noderenderer("core/bounded-number","html",function(){var a,e;return{first:function(f){a=document.createElement("span");a.classList.add("rpd-core-spinner");e=new d(a);var h=e.getChangesStream();
f.appendChild(a);return{spinner:{valueOut:h.map(function(a){return parseFloat(a)})}}},always:function(d,h){e.updateBounds(h.min,h.max);a.innerText=a.textContent=e.setValue(h.spinner)}}});d.prototype.setValue=function(a){this.value=a;return this.checkValue()};d.prototype.checkValue=function(){if(isNaN(this.value)||this.value<this.min)this.value=this.min,this.incoming.emit(this.min);this.value>this.max&&(this.value=this.max,this.incoming.emit(this.max));return this.value};d.prototype.updateBounds=function(a,
d){this.min=a||0;this.max=isNaN(d)?Infinity:d;return this.checkValue()};d.prototype.getChangesStream=function(){return this.changes}})();

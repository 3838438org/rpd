/**
 * rpd - RPD is a minimal framework for building Node-Based User Interfaces, powered by Reactive Programming
 * Built at Sat, 12 Dec 2015 09:16:44 GMT
 *
 * @version v0.2.0
 * @link http://shamansir.github.io/rpd
 * @author Ulric Wilfred <shaman.sir@gmail.com>
 * @license MIT
 * 
 * Selected Renderers: svg
 * Selected Styles: realpd
 * Selected Toolkits: pd
 * Selected I/O Modules: [None]
 * d3.js or d3_tiny.js: d3_tiny.js
 *
 * User Styles: [None]
 * User Toolkits: [None]
 *
 * Command: gulp --root . --renderer svg --style realpd --toolkit pd --target-name rpd-pd --compilation simple
 */
(function(k){var c=k.Kefir;"undefined"===typeof c&&"undefined"!==typeof require&&(c=require("../vendor/kefir.min.js"));if(!c)throw Error("Kefir.js (https://github.com/rpominov/kefir) is required for Rpd to work");var b=function(){function l(e){return function(){return e}}function h(e){this.id=A();this.name=e;var d=this;e={"patch/is-ready":[],"patch/enter":[],"patch/exit":[],"patch/set-inputs":["inputs"],"patch/set-outputs":["outputs"],"patch/project":["node","target"],"patch/refer":["node","target"],
"patch/add-node":["node"],"patch/remove-node":["node"]};this.event=n(e);this.events=x(e,this.event,"patch",this);this.renderQueue=c.emitter();e=c.combine([this.events],[this.renderQueue.scan(function(e,g){var a=g.alias,b=g.target,f=g.config,n=e[a];n||(n={},n.produce=H[a](d),n.handlers=[],e[a]=n);if(n.produce){var c=n.produce(b,f);c&&n.handlers.push("function"===typeof c?c:function(d){if(c[d.type])c[d.type](d)})}return e},{})]);e=e.bufferBy(this.renderQueue).take(1).flatten().concat(e);e.onValue(function(d){var e=
d[0];d=d[1];for(var g=Object.keys(d),a,b=0,n=g.length;b<n;b++){a=d[g[b]];a=a.handlers;for(var f=0,c=a.length;f<c;f++)a[f](B(q(e),g[b]))}});this.projections=c.emitter();c.combine([this.projections],[this.event["patch/set-inputs"],this.event["patch/set-outputs"]]).onValue(function(e){var g=e[0],a=e[1];e=e[2];for(var b,f=0;f<a.length;f++)b=g.addInlet(a[f].type,a[f].name),b.event["inlet/update"].onValue(function(d){return function(e){d.receive(e)}}(a[f]));for(f=0;f<e.length;f++)a=g.addOutlet(e[f].type,
e[f].name),e[f].event["outlet/update"].onValue(function(d){return function(e){d.send(e)}}(a));d.event["patch/project"].emit({node:g,target:g.patch});g.patch.event["patch/refer"].emit({node:g,target:d})});this.nodesToRemove=c.emitter();this.event["patch/is-ready"].emit()}function k(e,d,J,a){this.type=e||"core/empty";this.id=A();var f=u(z[this.type],this);f||C("Node type "+this.type+" is not registered!");this.def=f;this.name=J||f.name||e;this.patch=d;this.render=g(D[this.type],this);e={"node/turn-on":[],
"node/is-ready":[],"node/process":["inlets","outlets"],"node/turn-off":[],"node/add-inlet":["inlet"],"node/remove-inlet":["inlet"],"node/add-outlet":["outlet"],"node/remove-outlet":["outlet"],"node/move":["position"]};this.event=n(e);this.events=x(e,this.event,"node",this);a&&a(this);var b=this;if(this.def.handle)this.events.onValue(function(d){if(b.def.handle[d.type])b.def.handle[d.type](d)});if(this.def.process){var l=this.def.process;a=c.combine([this.event["node/add-inlet"].flatMap(function(d){var e=
d.event["inlet/update"].map(function(e){return{inlet:d,value:e}});b.def.tune&&(e=b.def.tune(e));return e})],[this.event["node/add-outlet"].scan(function(d,e){d[e.alias]=e;return d},{})]);a=a.bufferBy(this.event["node/is-ready"]).take(1).flatten().concat(a);a=a.scan(function(d,e){var g=e[0].inlet,a=g.alias;d.inlets.prev[a]=d.inlets.cur[a];d.inlets.cur[a]=e[0].value;d.outlets=e[1];d.source=g;return d},{inlets:{prev:{},cur:{}},outlets:{}}).changes();a=a.filter(function(d){return!d.source.cold});a.onValue(function(d){var e=
l.bind(b)(d.inlets.cur,d.inlets.prev);b.event["node/process"].emit({inlets:d.inlets.cur,outlets:e});d=d.outlets;for(var g in e)d[g]&&(e[g]instanceof c.Stream?d[g].stream(e[g]):d[g].send(e[g]))})}if(this.def.inlets){this.inlets={};for(var v in this.def.inlets)a=this.def.inlets[v],a=this.addInlet(a.type,v,a.name,a.default,a.hidden,a.readonly,a.cold),this.inlets[v]=a}if(this.def.outlets)for(v in this.outlets={},this.def.outlets)a=this.def.outlets[v],a=this.addOutlet(a.type,v,a.name,a.default),this.outlets[v]=
a;this.def.prepare&&this.def.prepare(this.inlets,this.outlets);this.event["node/is-ready"].emit()}function m(e,d,a,f,b,v,l,k){this.type=e||"core/any";this.id=A();var h=u(F[this.type],this);h||C("Channel type "+this.type+" is not registered!");this.def=h;(this.alias=a||h.alias||f)||C("Inlet should have either alias or name");this.name=f||h.name||this.alias||e;this.node=d;this.hidden=v||!1;this.readonly=r(l||h.readonly)?l||h.readonly:!0;this.cold=k||!1;this.default=r(b)?b:h.default;this.value=c.pool();
this.render=g(E[this.type],this);e={"inlet/update":["value"]};this.event=n(e);var m=this.event["inlet/update"];d=m.merge(this.value);h.tune&&(d=h.tune(d));h.accept&&(d=d.flatten(function(d){if(h.accept(d))return[d];m.error();return[]}));h.adapt&&(d=d.map(h.adapt));this.event["inlet/update"]=d.onValue(function(){});this.events=x(e,this.event,"inlet",this)}function f(e,d,a,f,b){this.type=e||"core/any";this.id=A();var l=u(F[this.type],this);l||C("Channel type "+this.type+" is not registered!");this.def=
l;(this.alias=a||l.alias||f)||C("Outlet should have either alias or name");this.name=f||this.alias||l.name||e;this.node=d;this.default=r(b)?b:l.default;this.value=c.pool();this.render=g(E[this.type],this);e={"outlet/update":["value"],"outlet/connect":["link","inlet"],"outlet/disconnect":["link"]};this.event=n(e);d=this.event["outlet/update"].merge(this.value);this.event["outlet/update"]=d.onValue(function(d){});this.events=x(e,this.event,"outlet",this);var h=this;c.combine([this.event["outlet/connect"]],
[this.event["outlet/update"]]).onValue(function(d){h.value.plug(c.constant(d[1]))})}function a(e,d,g){this.id=A();this.name=g||"";this.outlet=e;this.inlet=d;this.value=c.emitter();var a=this;this.receiver=e.node.id!==d.node.id?function(d){a.pass(d)}:function(d){setTimeout(function(){a.pass(d)},0)};e={"link/enable":[],"link/disable":[],"link/pass":["value"]};this.event=n(e);g=this.event["link/pass"].merge(this.value);this.event["link/pass"]=g.onValue(function(d){});this.events=x(e,this.event,"link",
this);this.enabled=c.merge([this.event["link/disable"].map(l(!1)),this.event["link/enable"].map(l(!0))]).toProperty(l(!0));this.event["link/pass"].filterBy(this.enabled).onValue(function(e){d.receive(e)});c.combine([this.event["link/enable"]],[this.event["link/pass"]]).onValue(function(d){a.pass(d[1])})}function q(e){for(var d={},g=Object.keys(e),a=0,f=g.length;a<f;a++)d[g[a]]=e[g[a]];return d}function r(e){return"undefined"!==typeof e}function u(e,d){return e?"function"===typeof e?e(d):e:null}function g(e,
d){if(!e)return{};var g={},a;for(a in e)g[a]=u(e[a],d);return g}function n(e){var d={};e=Object.keys(e);for(var g=0,a;g<e.length;g++)a=e[g],d[a]=c.emitter();return d}function v(e,d){if(0===d.length)return function(){return{type:e}};if(1===d.length)return function(g){var a={};a.type=e;a[d[0]]=g;return a};if(1<d.length)return function(d){d=q(d);d.type=e;return d}}function x(e,d,g,a){for(var f=c.pool(),b=Object.keys(e),n=0;n<b.length;n++)f.plug(d[b[n]].map(v(b[n],e[b[n]])).map(function(d){d[g]=a;return d}));
return f}function C(e,d){throw d||Error(e);}function A(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}function B(e,d){var g=e.type;if("patch/add-node"===g||"node/process"===g)e.render=e.node.render[d]||{};else if("node/add-inlet"===g||"inlet/update"===g)e.render=e.inlet.render[d]||{};else if("node/add-outlet"===g||"outlet/update"===g)e.render=e.outlet.render[d]||{};return e}(function(){c.emitter=function(){var e,d=c.stream(function(d){e=d;return function(){e=void 0}});d.emit=
function(d){e&&e.emit(d);return this};d.error=function(d){e&&e.error(d);return this};d.end=function(){e&&e.end();return this};d.emitEvent=function(d){e&&e.emitEvent(d);return this};return d.setName("emitter")}})();var z={},F={},D={},E={},I={},G={},H={},y={"network/add-patch":["patch"]},t=n(y),w=x(y,t,"network",b);t["network/add-patch"].onValue(function(e){w.plug(e.events)});var K=c.emitter();h.prototype.render=function(e,d,g){e=Array.isArray(e)?e:[e];d=Array.isArray(d)?d:[d];for(var a=0,f=e.length,
b;a<f;a++)for(var n=0,c=d.length,l;n<c;n++){b=e[a];l=d[n];if(!H[b])throw Error("Renderer "+b+" is not registered");this.renderQueue.emit({alias:b,target:l,config:g})}return this};h.prototype.addNode=function(e,d){var g=this;return new k(e,this,d,function(d){g.events.plug(d.events);g.event["patch/add-node"].emit(d);d.turnOn()})};h.prototype.removeNode=function(e){e.turnOff();this.event["patch/remove-node"].emit(e);this.events.unplug(e.events)};h.prototype.enter=function(){this.event["patch/enter"].emit();
return this};h.prototype.exit=function(){this.event["patch/exit"].emit();return this};h.prototype.inputs=function(e){this.event["patch/set-inputs"].emit(e)};h.prototype.outputs=function(e){this.event["patch/set-outputs"].emit(e)};h.prototype.project=function(e){this.projections.emit(e)};k.prototype.turnOn=function(){this.event["node/turn-on"].emit()};k.prototype.turnOff=function(){this.event["node/turn-off"].emit()};k.prototype.addInlet=function(e,d,g,a,b,f,n){e=new m(e,this,d,g,a,b,f,n);this.events.plug(e.events);
this.event["node/add-inlet"].emit(e);e.toDefault();return e};k.prototype.addOutlet=function(e,d,g,a){e=new f(e,this,d,g,a);this.events.plug(e.events);this.event["node/add-outlet"].emit(e);e.toDefault();return e};k.prototype.removeInlet=function(e){this.event["node/remove-inlet"].emit(e);this.events.unplug(e.events)};k.prototype.removeOutlet=function(e){this.event["node/remove-outlet"].emit(e);this.events.unplug(e.events)};k.prototype.move=function(e,d){this.event["node/move"].emit([e,d]);return this};
m.prototype.receive=function(e){this.value.plug(c.constant(e))};m.prototype.stream=function(e){this.value.plug(e)};m.prototype.toDefault=function(){r(this.default)&&(this.default instanceof c.Stream?this.stream(this.default):this.receive(this.default))};m.prototype.allows=function(e){if(e.type===this.type)return!0;if(!this.def.allow&&e.type!==this.type)return!1;if(this.def.allow){var d=!1;this.def.allow.forEach(function(g){e.type===g&&(d=!0)});return d}return!0};f.prototype.connect=function(e){if(!e.allows(this))throw Error("Outlet of type "+
this.type+" is not allowed to connect to inlet of type "+e.type);var d=new a(this,e);this.events.plug(d.events);this.value.onValue(d.receiver);this.event["outlet/connect"].emit({link:d,inlet:e});return d};f.prototype.disconnect=function(e){this.event["outlet/disconnect"].emit(e);this.value.offValue(e.receiver);this.events.unplug(e.events);return this};f.prototype.send=function(e){this.value.plug(c.constant(e))};f.prototype.stream=function(e){this.value.plug(e)};f.prototype.toDefault=function(){r(this.default)&&
(this.default instanceof c.Stream?this.stream(this.default):this.send(this.default))};a.prototype.pass=function(e){this.value.emit(e)};a.prototype.enable=function(){this.event["link/enable"].emit()};a.prototype.disable=function(){this.event["link/disable"].emit()};a.prototype.disconnect=function(){this.outlet.disconnect(this)};return{VERSION:"v2.0",_:{Patch:h,Node:k,Inlet:m,Outlet:f,Link:a},unit:l,not:function(e){return!e},event:t,events:w,addPatch:function(e){e=new h(e);t["network/add-patch"].emit(e);
return e},render:function(e,d,g){K.emit([e,d,g]);var a=function(a){a.render(e,d,g)};t["network/add-patch"].onValue(a);return function(){t["network/add-patch"].offValue(a)}},nodetype:function(e,d){z[e]=d||{}},channeltype:function(e,d){F[e]=d||{}},nodedescription:function(e,d){I[e]=d},renderer:function(e,d){H[e]=d},styles:G,style:function(e,d,g){G[e]||(G[e]={});G[e][d]=g},noderenderer:function(e,d,g){if(!z[e])throw Error("Node type "+e+" is not registered");D[e]||(D[e]={});D[e][d]=g},channelrenderer:function(e,
d,g){if(!F[e])throw Error("Channel type "+e+" is not registered");E[e]||(E[e]={});E[e][d]=g},"import":{},"export":{},allNodeTypes:z,allNodeDescriptions:I,getStyle:function(e,d){if(!e)throw Error("Unknown style requested: "+e);if(!G[e])throw Error("Style '"+e+"' is not registered");var g=G[e][d];if(!g)throw Error("Style '"+e+"' has no definition for '"+d+"' renderer");return g},short_uid:A}}();"function"===typeof define&&define.amd?(define([],function(){return b}),k.Rpd=b):"object"===typeof module&&
"object"===typeof exports?(module.exports=b,b.Rpd=b):k.Rpd=b})(this);var d3_tiny=function(){function k(b,c,h){for(var k="function"===typeof c?c:function(){return c},m=b.selection,f=0,a=m.length;f<a;f++)h(m[f],k.bind(m[f])(f));return b}function c(b,c,h){c=c||document;selection="string"===typeof b?h?Array.prototype.slice.call(c.querySelectorAll(b),0):[c.querySelector(b)]:b instanceof Node?[b]:Array.isArray(b)?b:[b];this.namespace=1===selection.length&&selection[0]?selection[0].namespaceURI:null;this.selection=selection}c.prototype.empty=function(){return 1===this.selection.length&&
!this.selection[0]||!this.selection.length?!0:!1};c.prototype.attr=function(b,c){return"undefined"===typeof c&&1===this.selection.length?this.selection[0].getAttribute(b):k(this,c,function(c,l){c.setAttributeNS(null,b,l)})};c.prototype.property=function(b,c){return"undefined"===typeof c&&1===this.selection.length?this.selection[0][b]:k(this,c,function(c,l){c[b]=l})};c.prototype.style=function(b,c){"-"===b[0]&&(b=b.slice(1));b=b.replace(/-([a-z])/g,function(b){return b[1].toUpperCase()});return k(this,
c,function(c,l){c.style[b]=l})};c.prototype.text=function(b){return"undefined"===typeof b&&1===this.selection.length?this.selection[0].textContent||this.selection[0].innerText:k(this,b,function(b,c){b.innerText=b.textContent=c})};c.prototype.classed=function(b,c){return"object"===typeof b?k(this,Object.keys(b),function(c,l){for(var k=0,f=l.length;k<f;k++)c.classList.toggle(l[k],b[l[k]])}):k(this,c,function(c,k){c.classList.toggle(b,k)})};c.prototype.select=function(b){return new c(b,this.selection[0])};
c.prototype.selectAll=function(b){return new c(b,this.selection[0],!0)};c.prototype.append=function(b){var l=[];k(this,"string"===typeof b?document.createElementNS(this.namespace,b):b,function(b,c){b.appendChild(c);l.push(c)});return new c(l)};c.prototype.remove=function(){return k(this,function(){return null},function(b){b.parentElement.removeChild(b)})};c.prototype.node=function(b){return this.selection[b||0]};c.prototype.on=function(b,c){return k(this,function(){return c},function(c,k){c.addEventListener(b,
k)})};c.prototype.data=function(b){return b?k(this,b,function(b,c){b.__data__=c}):this.node().__data__};c.prototype.call=function(b){b(this);return this};return{ns:{prefix:{svg:"http://www.w3.org/2000/svg",html:"http://www.w3.org/1999/xhtml"}},select:function(b,k){return new c(b,k)},selectAll:function(b,k){return new c(b,k,!0)}}}();Rpd.Render=function(){function k(g){this.currentPatch=null;this.getPatchByHash=g;var a=this;Kefir.fromEvents(window,"hashchange").map(function(){return window.location.hash?window.location.hash.slice(1):null}).filter(function(g){return!(a.currentPatch&&g===a.currentPatch.id)}).map(a.getPatchByHash).filter(function(g){return null!=g}).onValue(function(g){a.currentPatch&&a.currentPatch.exit();g.enter()})}function c(g){this.nodeRects=[];this.edgePadding=g.edgePadding||{horizontal:30,vertical:20};this.boxPadding=
g.boxPadding||{horizontal:20,vertical:30}}function b(g,a){this.root=g;this.style=a}function l(g,a){this.link=g;this.style=a;this.element=this.styledLink=null}function h(){this.vlinks=[]}function p(g){g.stopPropagation();return g}function m(g){return{x:g.clientX,y:g.clientY}}function f(g,b,c,f){Kefir.fromEvents(g,"click").map(p).map(a(f||!1)).scan(Rpd.not).onValue(function(g){g?b():c()})}var a=Rpd.unit,q=d3_tiny||q;k.prototype.switch=function(g){g&&(this.currentPatch=g,0<=document.title.indexOf("\u2014")?
document.title=document.title.replace(/\u2014.+$/,"\u2014 "+g.name||"[Unnamed]"):document.title+=" \u2014 "+g.name||"[Unnamed]",window.location.hash=g.id)};c.DEFAULT_LIMITS=[1E3,1E3];c.prototype.nextPosition=function(g,a,b){b=b||c.DEFAULT_LIMITS;g=this.nodeRects;var f=this.boxPadding,k=this.edgePadding,l=a.width;a=a.height;var h=g.length?g[g.length-1]:null,h={x:h?h.x:k.horizontal,y:h?h.y+h.height+f.vertical:k.vertical,width:l,height:a};h.y+a+k.vertical>b.height&&(h.x=h.x+l+f.horizontal,h.y=k.vertical);
g.push(h);return{x:h.x,y:h.y}};b.prototype.add=function(g,a){var b=this.root,c=this.style,f=a.start,k=a.end,h=a.drag;Kefir.fromEvents(g.node(),"mousedown").map(m).map(c.getLocalPos).flatMap(function(a){var n=f(),h=a.x-n.x,l=a.y-n.y;a=Kefir.fromEvents(b.node(),"mousemove").map(p).takeUntilBy(Kefir.merge([Kefir.fromEvents(b.node(),"mouseup"),Kefir.fromEvents(g.node(),"mouseup")])).map(m).map(c.getLocalPos).map(function(g){return{x:g.x-h,y:g.y-l}}).toProperty(function(){return n});a.last().onValue(k);
return a}).onValue(h)};l.prototype.construct=function(g){if(this.styledLink)throw Error("VLink is already constructed");this.styledLink=g=this.style.createLink(this.link);this.element=q.select(g.element);return this};l.prototype.rotate=function(g,a,b,c){this.styledLink.rotate(g,a,b,c);return this};l.prototype.rotateI=function(g,a,b){var c=this.style,c=c.getLocalPos(c.getInletPos(b));return this.rotate(g,a,c.x,b.y)};l.prototype.rotateO=function(a,b,c){var f=this.style;a=f.getLocalPos(f.getOutletPos(a));
return this.rotate(a.x,a.y,b,c)};l.prototype.rotateOI=function(a,b){var c=this.style,f=c.getLocalPos(c.getOutletPos(a)),c=c.getLocalPos(c.getInletPos(b));return this.rotate(f.x,f.y,c.x,c.y)};l.prototype.update=function(){if(this.link){var a=this.link;this.rotateOI(a.outlet,a.inlet);return this}};l.prototype.appendTo=function(a){a.append(this.element.node());return this};l.prototype.removeFrom=function(a){this.element.remove();return this};l.prototype.noPointerEvents=function(){this.styledLink.noPointerEvents&&
this.styledLink.noPointerEvents();return this};l.prototype.listenForClicks=function(){var a=this.link;f(this.element.node(),function(){a.enable()},function(){a.disable()});return this};l.prototype.enable=function(){this.element.classed("rpd-disabled",!1)};l.prototype.disable=function(){this.element.classed("rpd-disabled",!0)};l.prototype.get=function(){return this.link};l.prototype.getElement=function(){return this.element.node()};h.prototype.clear=function(){this.vlinks=[]};h.prototype.add=function(a){this.vlinks.push(a);
return a};h.prototype.remove=function(a){this.vlinks=this.vlinks.filter(function(b){return b!==a})};h.prototype.forEach=function(a){this.vlinks.forEach(a)};h.prototype.updateAll=function(){this.forEach(function(a){a.update()})};h.prototype.count=function(){return this.vlinks.length};h.prototype.getLast=function(){return this.count()?this.vlinks[this.vlinks.length-1]:null};var r=function(){var a={};return function(b,c,f){c.classed("rpd-error",!0);a[b]&&clearTimeout(a[b]);a[b]=setTimeout(function(){c.classed("rpd-error",
!1);a[b]=null},f||1)}}(),u=function(){var a={};return function(b,c,f){c.classed("rpd-stale",!1);c.classed("rpd-fresh",!0);a[b]&&clearTimeout(a[b]);a[b]=setTimeout(function(){c.classed("rpd-fresh",!1);c.classed("rpd-stale",!0);a[b]=null},f||1)}}();return{Navigation:k,Placing:c,DragAndDrop:b,VLink:l,VLinks:h,mergeConfig:function(a,b){if(a){var c={};Object.keys(b).forEach(function(a){c[a]=b[a]});Object.keys(a).forEach(function(b){c[b]=a[b]});return c}return b},preventDefault:function(a){a.preventDefault();
return a},stopPropagation:p,extractPos:m,addTarget:function(a){return function(b){return{pos:b,target:a}}},addClickSwitch:f,addValueErrorEffect:r,addValueUpdateEffect:u,subscribeUpdates:function(a,b){b&&Object.keys(b).forEach(function(c){(function(b,c){a.event["node/add-inlet"].filter(function(a){return a.alias===c}).onValue(function(c){a.event["node/is-ready"].onValue(function(){b.default&&c.receive(b.default());if(b.valueOut)b.valueOut.onValue(function(a){c.receive(a)})})})})(b[c],c)})}}}();Rpd.style("realpd","svg",function(){function k(c){return document.createElementNS(b.ns.prefix.svg,c)}function c(b){b=b.getBoundingClientRect();return{x:b.left,y:b.top}}var b=b||d3_tiny;return function(l){function h(b){var c=a[b.id],k=c.length;if(!(1>=k)){var h=f[b.id].node().getBBox().width;c.forEach(function(a,b){r[a.id].attr("transform","translate("+(h/(k-1)*b-7/(k-1)*b)+",0)")})}}function p(a,b){var c=q[a.id],k=c.length;if(!(1>=k)){var h=f[a.id].node().getBBox().width;c.forEach(function(a,b){u[a.id].attr("transform",
"translate("+(h/(k-1)*b-7/(k-1)*b)+",0)")})}}var m,f={},a={},q={},r={},u={};return{createRoot:function(a,c){return{element:b.select(k("g")).classed("rpd-patch",!0).node()}},createNode:function(c,h,l){h=h.size?{width:h.size.width||50,height:h.size.height||18}:{width:18,height:18};l=b.select(k("g")).attr("class","rpd-node");l.classed("rpd-"+c.type.slice(0,c.type.indexOf("/"))+"-toolkit-node",!0).classed("rpd-"+c.type.replace("/","-"),!0);var m=0===c.type.indexOf("pd/");m||l.append("rect").classed("rpd-background").classed("rpd-drag-handle",
!0).attr("width",h.width).attr("height",h.height);l.append("g").classed("rpd-process",!0).classed("rpd-drag-handle",m);l.append("g").classed("rpd-inlets",!0);l.append("g").classed("rpd-outlets",!0).attr("transform","translate(0,16)");f[c.id]=l.select(".rpd-process");a[c.id]=[];q[c.id]=[];return{element:l.node(),size:h}},createInlet:function(c,f){var l=b.select(k("g")).attr("class","rpd-inlet");l.append("g").attr("class","rpd-connector").append("rect").attr("width",7).attr("height",2);r[c.id]=l;a[c.node.id].push(c);
h(c.node);return{element:l.node()}},createOutlet:function(a,c){var f=b.select(k("g")).attr("class","rpd-outlet");f.append("g").attr("class","rpd-connector").append("rect").attr("width",7).attr("height",2);u[a.id]=f;q[a.node.id].push(a);p(a.node);return{element:f.node()}},createLink:function(a){var c=b.select(k("line")).attr("class","rpd-link");return{element:c.node(),rotate:function(a,b,f,g){c.attr("x1",a).attr("y1",b).attr("x2",f).attr("y2",g)},noPointerEvents:function(){c.style("pointer-events",
"none")}}},getInletPos:function(a){a=c(r[a.id].select(".rpd-connector").node());return{x:a.x+3,y:a.y+1}},getOutletPos:function(a){a=c(u[a.id].select(".rpd-connector").node());return{x:a.x+3,y:a.y+1}},getLocalPos:function(a){if(!m)return a;var b=c(m.node());return{x:a.x-b.x,y:a.y-b.y}},onPatchSwitch:function(a,c){m=b.select(c)},onInletRemove:function(b){var c=b.node.id;a[c]=a[c].filter(function(a){return a.id!==b.id})},onOutletRemove:function(a){var b=a.node.id;q[b]=q[b].filter(function(b){return b.id!==
a.id})}}}}());(function(){function k(a){return document.createElementNS(m.ns.prefix.svg,a)}function c(b){return function(c,h){var y=x(h,p),t=Rpd.getStyle(y.style,"svg")(y);c=m.select(c).classed("rpd-network",!0);var w,z,e;return{"patch/is-ready":function(d){var h=m.select(document.documentElement);w=m.select(k("svg")).attr("width",h.property("clientWidth")).attr("height",h.property("clientHeight"));w.append("rect").attr("class","rpd-background").attr("width",h.property("clientWidth")).attr("height",h.property("clientHeight"));
var l=w.append(t.createRoot(b,c).element).classed("rpd-style-"+y.style,!0).classed("rpd-values-"+(y.valuesOnHover?"on-hover":"always-shown"),!0).classed("rpd-show-boxes",y.showBoxes).data(d.patch);a.patches[b.id]=w.data({root:l,width:h.property("clientWidth"),height:h.property("clientHeight"),patch:d.patch});a.patchToPlacing[b.id]=new f.Placing(t);a.patchToLinks[b.id]=new v;z=new g(w,t,y);y.nodeMovingAllowed&&(e=new f.DragAndDrop(w,t));Kefir.fromEvents(w.node(),"selectstart").onValue(C);Kefir.fromEvents(window,
"resize").map(function(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}).onValue(function(a){w.attr("height",a);w.data().height=a})},"patch/enter":function(d){r=d.patch;q.switch(d.patch);var b=a.patches[d.patch.id];c.append(b.node());a.patchToLinks[d.patch.id].updateAll();if(t.onPatchSwitch)t.onPatchSwitch(r,b.node())},"patch/exit":function(a){r=null;w.remove()},"patch/refer":function(d){var e=a.nodes[d.node.id];e.select(".rpd-node").classed("rpd-patch-reference",
!0);e.data().processTarget.append(k("text")).text("["+(d.target.name||d.target.id)+"]");Kefir.fromEvents(e.data().processTarget.node(),"click").onValue(function(a,d){return function(){a.exit();d.enter()}}(b,d.target))},"patch/add-node":function(d){var c=d.node,f=d.render;d=a.patchToPlacing[d.patch.id];var g=a.patches[r.id].data(),h=m.select(k("g")).attr("class","rpd-node-box"),l=t.createNode(c,f,u[c.type]),q=h.append(l.element);a.nodes[c.id]=h.data({inletsTarget:q.select(".rpd-inlets"),outletsTarget:q.select(".rpd-outlets"),
processTarget:q.select(".rpd-process"),position:n,size:l.size});var n=d.nextPosition(c,l.size,{width:g.width,height:g.height});c.move(n.x,n.y);var x=new v;a.nodeToLinks[c.id]=x;if(y.nodeMovingAllowed){var w=q.select(".rpd-shadow"),n=q.select(".rpd-drag-handle");n.empty()||e.add(n,{start:function(){q.classed("rpd-dragging",!0);w.empty()||w.attr("x",7).attr("y",8);return h.data().position},drag:function(a){h.attr("transform","translate("+a.x+","+a.y+")");x.forEach(function(a){a.update()})},end:function(a){c.move(a.x,
a.y);w.empty()||w.attr("x",5).attr("y",6);q.classed("rpd-dragging",!1)}})}f.prepare&&f.prepare.bind(c)(a.patches[b.id].node(),a.patches[r.id].node());f.first&&E(c,f.first.bind(c)(q.select(".rpd-process").node()));if(f.always)c.event["node/process"].throttle(100).onValue(function(){x.updateAll()});if(!q.select(".rpd-remove-button").empty())Kefir.fromEvents(q.select(".rpd-remove-button path").node(),"click").map(A).onValue(function(){b.removeNode(c)});a.patches[c.patch.id].data().root.append(h.node())},
"patch/remove-node":function(d){d=d.node;var b=a.nodes[d.id];a.nodeToLinks[d.id].forEach(function(a){a.get().disconnect()});b.remove();if(t.onNodeRemove)t.onNodeRemove(d);a.nodes[d.id]=null;a.nodeToLinks[d.id]=null},"node/move":function(d){var b=a.nodes[d.node.id];d=d.position;b.attr("transform","translate("+Math.floor(d[0])+","+Math.floor(d[1])+")");b.data().position={x:d[0],y:d[1]}},"node/process":function(d){var b=d.node,e=d.render;if(e.always){var c=a.nodes[b.id].data().processTarget.node();e.always.bind(b)(c,
d.inlets,d.outlets)}},"node/add-inlet":function(d){var b=d.inlet;if(!b.hidden){var e=a.nodes[d.node.id].data().inletsTarget;d=d.render;var c;c=m.select(t.createInlet(b,d).element);c.classed("rpd-"+b.type.replace("/","-"),!0);c.classed({"rpd-stale":!0,"rpd-readonly":b.readonly,"rpd-cold":b.cold});var f=null;!b.readonly&&d.edit&&(f=new l(b,d,w,c.select(".rpd-value-holder"),c.select(".rpd-value"),m.select(k("g"))),c.select(".rpd-value-holder").append(f.editorElm.node()));a.inlets[b.id]=c.data({connector:c.select(".rpd-connector"),
value:c.select(".rpd-value"),vlinks:new v,editor:f});b.event["inlet/update"].onError(function(){F(b.id,c,y.effectTime)});z.subscribeInlet(b,c.select(".rpd-connector"));e.append(c.node())}},"node/add-outlet":function(d){var b=d.outlet,c=a.nodes[d.node.id].data().outletsTarget;d=m.select(t.createOutlet(b,d.render).element);d.classed("rpd-"+b.type.replace("/","-"),!0);d.classed("rpd-stale",!0);a.outlets[b.id]=d.data({connector:d.select(".rpd-connector"),value:d.select(".rpd-value"),vlinks:new v});z.subscribeOutlet(b,
d.select(".rpd-connector"));c.append(d.node())},"node/remove-inlet":function(d){d=d.inlet;a.inlets[d.id].data().vlinks.forEach(function(a){a.get().disconnect()});a.inlets[d.id].remove();if(t.onInletRemove)t.onInletRemove(d);a.inlets[d.id]=null},"node/remove-outlet":function(d){d=d.outlet;a.outlets[d.id].data().vlinks.forEach(function(a){a.get().disconnect()});a.outlets[d.id].remove();if(t.onOutletRemove)t.onOutletRemove(d);a.outlets[d.id]=null},"inlet/update":function(d){var b=d.inlet;if(!b.hidden){var c=
d.render,e=a.inlets[b.id],f=e.data().value;if(!f.empty()){var g=b.def.show?b.def.show(d.value):d.value;c.show?c.show.bind(b)(f.node(),d.value,g):f.text(g)}D(b.id,e,y.effectTime)}},"outlet/update":function(d){var b=d.outlet,c=d.render,e=a.outlets[b.id],f=e.data().value;if(!f.empty()){var g=b.def.show?b.def.show(d.value):d.value;c.show?c.show.bind(b)(f.node(),d.value,g):f.text(g)}D(b.id,e,y.effectTime)},"outlet/connect":function(d){d=d.link;var c=d.outlet,e=d.inlet,f=a.inlets[e.id],g=a.outlets[c.id].data(),
f=f.data();if(!y.inletAcceptsMultipleLinks&&1===f.vlinks.count())throw Error("Inlet is already connected to a link");f.editor&&f.editor.disable();var h=new n(d,t);h.construct(y.linkWidth).rotateOI(c,e);m.select(h.getElement()).classed("rpd-"+e.type.replace("/","-"),!0).classed("rpd-"+c.type.replace("/","-"),!0);a.links[d.id]=h;g.vlinks.add(h);f.vlinks.add(h);a.nodeToLinks[c.node.id].add(h);c.node.id!==e.node.id&&a.nodeToLinks[e.node.id].add(h);a.patchToLinks[b.id].add(h);h.listenForClicks();h.appendTo(w)},
"outlet/disconnect":function(d){d=d.link;var c=a.links[d.id],e=d.outlet,f=d.inlet,g=a.outlets[e.id].data(),h=a.inlets[f.id].data();a.links[d.id]=null;g.vlinks.remove(c);h.vlinks.remove(c);a.nodeToLinks[e.node.id].remove(c);e.node.id!==f.node.id&&a.nodeToLinks[f.node.id].remove(c);a.patchToLinks[b.id].remove(c);c.removeFrom(w)},"link/enable":function(b){var c=a.inlets[b.link.inlet.id].data();c.editor&&c.editor.disable();a.links[b.link.id].enable()},"link/disable":function(b){a.links[b.link.id].disable()}}}}
function b(a,b){return Kefir.merge([a.map(h(!0)),b.map(h(!1))]).toProperty(h(!1))}function l(b,c,f,g,k,l){var m=Kefir.emitter(),e=Kefir.emitter();this.disableEditor=e;this.editorElm=l;this.valueElm=k;l.classed("rpd-value-editor",!0);c.edit.bind(b)(l.node(),b,m).onValue(function(a){b.receive(a)});Kefir.combine([Kefir.merge([Kefir.fromEvents(g.node(),"click").map(A).map(h(!0)),Kefir.fromEvents(f.node(),"click").merge(e).map(h(!1))]).toProperty(h(!1)).skipDuplicates()],[b.event["inlet/update"]]).map(function(a){return{lastValue:a[1],
startEditing:a[0],cancelEditing:!a[0]}}).onValue(function(c){if(c.startEditing){var e=a.inlets[b.id].data();e.link&&e.link.disable();m.emit(c.lastValue);g.classed("rpd-editor-enabled",!0)}else c.cancelEditing&&(k.classed("rpd-edited",!0),g.classed("rpd-editor-enabled",!1))});g.classed("rpd-editor-disabled",!0)}var h=Rpd.unit,p={style:"quartz",valuesOnHover:!1,showBoxes:!1,nodeMovingAllowed:!0,renderNodeList:!0,nodeListCollapsed:!0,inletAcceptsMultipleLinks:!1,effectTime:1E3},m=m||d3_tiny,f=Rpd.Render,
a={patches:{},nodes:{},inlets:{},outlets:{},links:{},patchToPlacing:{},patchToLinks:{},nodeToLinks:{}},q=new f.Navigation(function(a){return function(b){return a.patches[b].data().patch}}(a)),r,u=Rpd.allNodeDescriptions,g=function(){function c(b){return a.inlets[b.id].data().vlinks}function f(a){return function(){return 0<c(a).count()}}function g(a){1===a.count()&&(a=a.getLast().link,a.outlet.disconnect(a))}function k(a,b){a.forEach(function(a){a.link.outlet.id===b.id&&b.disconnect(a.link)})}function l(a,
c,e){this.root=a;this.style=c;this.config=e;this.rootClicks=Kefir.fromEvents(this.root.node(),"click");this.inletClicks=Kefir.pool();this.outletClicks=Kefir.pool();this.startLink=Kefir.emitter();this.finishLink=Kefir.emitter();this.doingLink=b(this.startLink,this.finishLink)}l.prototype.subscribeOutlet=function(a,f){var e=this.root,d=this.style,l=this.config,q=this.rootClicks,r=this.outletClicks,x=this.inletClicks,p=this.startLink,v=this.finishLink,u=this.doingLink;r.plug(Kefir.fromEvents(f.node(),
"click").map(B).map(z(a)));Kefir.fromEvents(f.node(),"click").map(A).filterBy(b(r,u)).map(B).onValue(function(b){p.emit();var f=(new n(null,d)).construct(l.linkWidth).rotateO(a,b.x,b.y).noPointerEvents().appendTo(e);m.select(f.getElement()).classed("rpd-"+a.type.replace("/","-"),!0);Kefir.fromEvents(e.node(),"mousemove").takeUntilBy(Kefir.merge([x,r.map(h(!1)),q.map(h(!1))]).take(1).onValue(function(b){if(b){b=b.target;var d=c(b);l.inletAcceptsMultipleLinks?k(d,a):g(d);a.connect(b)}})).map(B).map(d.getLocalPos).onValue(function(b){f.rotateO(a,
b.x,b.y)}).onEnd(function(){f.removeFrom(e);v.emit()})})};l.prototype.subscribeInlet=function(a,l){var e=this.root,d=this.style,q=this.config,r=this.rootClicks,x=this.outletClicks,p=this.inletClicks,v=this.startLink,u=this.finishLink,t=this.doingLink;p.plug(Kefir.fromEvents(l.node(),"click").map(B).map(z(a)));Kefir.fromEvents(l.node(),"click").map(A).filterBy(b(p,t)).filter(f(a)).onValue(function(b){var f=c(a).getLast().link,l=f.outlet;l.disconnect(f);v.emit();var z=(new n(null,d)).construct(q.linkWidth).rotateO(l,
b.x,b.y).noPointerEvents().appendTo(e);m.select(z.getElement()).classed("rpd-"+a.type.replace("/","-"),!0).classed("rpd-"+l.type.replace("/","-"),!0);Kefir.fromEvents(e.node(),"mousemove").takeUntilBy(Kefir.merge([p,x.map(h(!1)),r.map(h(!1))]).take(1).onValue(function(a){if(a){a=a.target;var b=c(a);q.inletAcceptsMultipleLinks?k(b,l):g(b);l.connect(a)}})).map(B).map(d.getLocalPos).onValue(function(a){z.rotateO(l,a.x,a.y)}).onEnd(function(){z.removeFrom(e);u.emit()})})};return l}();l.prototype.disable=
function(){this.valueElm.classed("rpd-edited",!1);this.disableEditor.emit()};var n=f.VLink,v=f.VLinks,x=f.mergeConfig,C=f.preventDefault,A=f.stopPropagation,B=f.extractPos,z=f.addTarget,F=f.addValueErrorEffect,D=f.addValueUpdateEffect,E=f.subscribeUpdates;Rpd.SvgRenderer=c;Rpd.renderer("svg",c)})();var PdView=function(){function k(a){this.inEditMode=Kefir.merge([n.map(h(!0)),v.map(h(!1))]).toProperty(h(!1));f=l.select(document.createElement("input")).attr("type","text").attr("class","rpd-pd-text-editor").style("width","300px").style("height",a.height+1+"px").node();document.addEventListener("DOMContentLoaded",function(){l.select(document.body).append(l.select(f).style("display","none").style("position","absolute").node())})}function c(a){return{x:a.clientX,y:a.clientY}}function b(a,b){this.element=
a;this.value=0;var f=this,g=Kefir.emitter();g.onValue(function(a){f.value=a});Kefir.fromEvents(a,"mousedown").filterBy(b).map(m).map(c).flatMap(function(a){var b=f.value;return Kefir.fromEvents(document.body,"mousemove").map(c).takeUntilBy(Kefir.fromEvents(document.body,"mouseup")).map(function(c){return b+(a.y-c.y)}).onValue(function(a){g.emit(a)})}).onEnd(function(){});this.changes=g}var l=l||d3_tiny,h=Rpd.unit,p=Rpd.not,m=Rpd.Render.stopPropagation,f,a=Kefir.emitter(),q=Kefir.emitter(),r=null,
u=Kefir.emitter(),g=Kefir.emitter(),n=Kefir.emitter(),v=Kefir.emitter();k.prototype.addSelection=function(a){Kefir.fromEvents(a,"click").filterBy(this.inEditMode.map(p)).map(m).onValue(function(){u.emit();r&&l.select(r).classed("rpd-pd-selected",!1);r=a;l.select(a).classed("rpd-pd-selected",!0);Kefir.fromEvents(document.body,"click").take(1).onValue(function(){l.select(a).classed("rpd-pd-selected",!1);r=null;g.emit()})})};k.prototype.addEditor=function(b,c,g){var h=l.select(c),k=l.select(f);Kefir.fromEvents(b,
"click").filterBy(this.inEditMode.map(p)).map(m).map(function(){return h.text()}).onValue(function(b){a.emit();var l=c.getBoundingClientRect();k.classed("rpd-pd-selected",!0).style("top",l.top-5+"px").style("left",l.left-1+"px");k.node().value=b||"";f.setSelectionRange(0,f.value.length);h.text("").style("display","none");k.style("display","block").node().focus();Kefir.merge([Kefir.fromEvents(document.body,"click"),Kefir.fromEvents(f,"keydown").map(function(a){return a.keyCode}).filter(function(a){return 13===
a}),u]).take(1).onValue(function(){var a=k.node().value;f.blur();h.text(a);k.node().value="";k.style("display","none").classed("rpd-pd-selected",!1);h.style("display","block");q.emit();g&&g(a)})})};k.prototype.addEditModeSwitch=function(a,b){Kefir.fromEvents(a,"click").map(m).map(h(!0)).scan(Rpd.not).onValue(function(a){a?n.emit():v.emit();l.select(b).classed("rpd-pd-enabled",a)})};k.prototype.addNodeAppender=function(a,b,c){Kefir.fromEvents(a,"click").map(m).onValue(function(){c.addNode(b)})};k.prototype.addValueSend=
function(a,b,c,f){var g;Kefir.fromEvents(a,"click").filterBy(this.inEditMode).map(m).onValue(function(){g&&clearTimeout(g);l.select(a).classed("rpd-pd-send-value",!0);g=setTimeout(function(){l.select(a).classed("rpd-pd-send-value",!1)},300);b.webPdObject.inlets[0].message(f())})};k.prototype.addSpinner=function(a){return new b(a,this.inEditMode)};k.prototype.measureText=function(a){a=a.node().getBBox();return{width:a.width,height:a.height}};b.prototype.getChangesStream=function(){return this.changes};
return k}(),PdModel=function(){function k(b,a){this.patch=b;this.webPdPatch=a;this.nodeToInlets={};this.nodeToOutlets={};this.webPdDummy={patch:a}}var c=window.Pd||null;if(!c)throw Error("Building PD Model requires WebPd present");var b=function(){return function(b,a,h){try{return b.webPdPatch.createObject(a,h)}catch(k){return k instanceof c.core.errors.UnkownObjectError||console.error(k,a,h),null}}}(),l=Kefir.emitter(),h=Kefir.emitter();h.toProperty();l.map(function(c){return{node:c.node,patch:c.node.patch,
command:c.command,arguments:c.arguments,object:b(c.node.patch,c.command,c.arguments)}}).onValue(function(b){h.emit(b)});var p=Pd.core.portlets.DspInlet,m=Pd.core.portlets.DspOutlet;k.prototype.connectToWebPd=function(b,a,h,k){if(b&&!h||b&&b.length!==h.length)throw Error("inlets number not matches to WebPd inlets number");if(a&&!k||a&&a.length!==k.length)throw Error("outlets number not matches to WebPd outlets number");b&&h&&b.forEach(function(a,b){if("pd/dsp"!==a.type){var c=h[b];if(!c)throw Error("Failed to find WebPd inlet corresponding to inlet "+
b);a.event["inlet/update"].onValue(function(a){c.message(a.get())})}});if(a&&k){var l=this.webPdDummy;a.forEach(function(a,b){if("pd/dsp"!==a.type){var f=new c.core.portlets.Inlet(l);f.message=function(b){a.send(PdValue.from(b))};if(k[b])k[b].connect(f);else throw Error("Failed to find WebPd outlet corresponding to outlet "+b);}})}};k.prototype.applyDefinition=function(b,a,c,h){c=this.nodeToInlets[b.id];var k=this.nodeToOutlets[b.id];c&&(c.forEach(function(a){b.removeInlet(a)}),this.nodeToInlets[b.id]=
null);k&&(k.forEach(function(a){b.removeOutlet(a)}),this.nodeToOutlets[b.id]=null);if(h){c=h.outlets||{};var g=[],l=[];(h.inlets||{}).forEach(function(a,c){g.push(b.addInlet(a instanceof p?"pd/dsp":"pd/value",c.toString()))});c.forEach(function(a,c){l.push(b.addOutlet(a instanceof m?"pd/dsp":"pd/value",c.toString()))});this.nodeToInlets[b.id]=g.length?g:null;this.nodeToOutlets[b.id]=l.length?l:null;this.connectToWebPd(g,l,h.inlets,h.outlets,"<"+b.id+"> "+(h.prefix||a||b.type))}};k.prototype.requestResolve=
function(b,a,c){l.emit({node:b,command:a,arguments:c})};k.prototype.whenResolved=function(b,a){h.filter(function(a){return a.node.id===b.id}).onValue(a)};k.prototype.initMessage=function(b,a){b.inlets.init.receive(PdValue.from(a))};k.getReceivingInlet=function(b){return b.inlets.receive};k.getSendingOutlet=function(b){return b.outlets.send};k.TYPE_MAP={obj:"pd/object",msg:"pd/message",floatatom:"pd/number",symbolatom:"pd/symbol",text:"pd/comment",bng:"pd/bang",tgl:"pd/toggle",nbx:null,vsl:null,hsl:null,
vradio:null,hradio:null,vu:null,cnv:null,graph:null,array:null};return k}();PdValue=function(){function k(c){this.value=c}k.prototype.get=function(){return this.value};k.prototype.isBang=function(){return"bang"===this.value[0]};k.isPdValue=function(c){return c instanceof k};k.from=function(c){return new k(c)};k.bang=function(){return new k(["bang"])};return k}();function nop(){}Rpd.channeltype("pd/value",{accept:function(k){return PdValue.isPdValue(k)}});Rpd.channeltype("pd/dsp",{});Rpd.nodetype("pd/object",function(k){var c,b=k.patch?k.patch.model:null;b&&b.whenResolved(k,function(b){c=b.definition?b.definition.process:null});return{inlets:{command:{type:"pd/value",hidden:!0}},process:function(){return c?c.apply(this,arguments):null}}});Rpd.nodetype("pd/comment",{inlets:{text:{type:"pd/value",hidden:!0}}});
Rpd.nodetype("pd/number",{inlets:{receive:{type:"pd/value"},spinner:{type:"pd/value",hidden:!0}},outlets:{send:{type:"pd/value"}},process:nop});Rpd.nodetype("pd/symbol",{inlets:{receive:{type:"pd/value"}},outlets:{send:{type:"pd/value"}}});Rpd.nodetype("pd/message",function(){return{inlets:{receive:{type:"pd/value"},init:{type:"pd/value",hidden:!0}},outlets:{send:{type:"pd/value"}},process:nop}});Rpd.nodetype("pd/bang",{inlets:{receive:{type:"pd/value"}},outlets:{send:{type:"pd/value"}},process:nop});
Rpd.nodetype("pd/toggle",{inlets:{receive:{type:"pd/value"}},outlets:{send:{type:"pd/value"}}});Rpd.nodetype("pd/toolbar",{});Rpd.nodetype("pd/edit-switch",{});(function(){function k(b){return document.createElementNS(c.ns.prefix.svg,b)}var c=c||d3_tiny,b={width:50,height:18},l=new PdView(b);Rpd.noderenderer("pd/number","svg",function(){var h,p,m;return{size:b,first:function(f){h=c.select(k("path")).attr("d","M 0,0 h "+(b.width-5)+" l 5 5 v "+(b.height-5)+" h "+-b.width+" v "+-b.height+" z");p=c.select(k("text")).attr("x",2).attr("y",b.height/2).text("0");m=l.addSpinner(p.node());var a=m.getChangesStream();l.addSelection(f);c.select(f).call(function(a){a.append(h.node());
a.append(p.node())});return{receive:{valueOut:a.map(function(a){return PdValue.from([parseFloat(a)])})}}},always:function(b,a){p.text((a.receive||a.spinner).get())}}});Rpd.noderenderer("pd/symbol","svg",function(){var h,p;return{size:b,first:function(m){h=c.select(k("path")).attr("d","M 0,0 h "+(b.width-5)+" l 5 5 v "+(b.height-5)+" h "+-b.width+" v "+-b.height+" z");p=c.select(k("text")).attr("x",2).attr("y",b.height/2).text("symbol");l.addSelection(m);c.select(m).call(function(b){b.append(h.node());
b.append(p.node())})}}});Rpd.noderenderer("pd/message","svg",function(){var h,p,m,f=!1;return{size:b,first:function(a){h=c.select(k("path")).attr("d","M 0,0 h "+b.width+" l -4 4 v "+(b.height-8)+" l 4 4 h "+-b.width+" v "+-b.height+" z");p=c.select(k("text")).attr("x",2).attr("y",b.height/2);p.text("");l.addSelection(a);l.addEditor(a,p.node(),function(a){m=PdValue.from(a.split(" "))});l.addValueSend(a,this,"receive",function(){return m.get()});c.select(a).call(function(a){a.append(h.node());a.append(p.node())})},
always:function(a,b){b.init&&!f?(m=b.init,p.text(m.get().join(" ")),f=!0):b.receive&&!b.receive.isBang()&&(m=b.receive)}}});Rpd.noderenderer("pd/comment","svg",function(){return{size:b,first:function(h){var p=c.select(k("rect")).attr("width",b.width).attr("height",b.height),m=c.select(k("text")).attr("y",b.height/2).text("comment");l.addSelection(h);l.addEditor(h,m.node());c.select(h).call(function(b){b.append(p.node());b.append(m.node())})}}});Rpd.noderenderer("pd/object","svg",function(){return{size:b,
first:function(h){var p=this,m=p.patch?p.patch.model:null,f=c.select(k("rect")).classed("rpd-pd-erratic",!0);f.attr("width",b.width).attr("height",b.height);var a=c.select(k("text")).attr("x",2).attr("y",b.height/2);l.addSelection(h);l.addEditor(h,a.node(),function(a){m&&(a=a.split(" "),m.requestResolve(p,a[0],a.slice(1)))});if(m){var q;m.whenResolved(p,function(b){var c=b.command+(b.arguments.length?" "+b.arguments.join(" "):"");if(!q||c!==q){a.text(c);var g=l.measureText(a);f.attr("width",g.width+
6);f.classed("rpd-pd-erratic",!b.object);m.applyDefinition(b.node,b.command,b.arguments,b.object);q=c}})}c.select(h).call(function(b){b.append(f.node());b.append(a.node())})}}});Rpd.noderenderer("pd/toggle","svg",function(){var h,p=b.height,m=b.height;return{size:b,first:function(b){h=c.select(k("rect"));h.attr("width",p).attr("height",m);l.addSelection(b);c.select(b).append(h.node())}}});Rpd.noderenderer("pd/bang","svg",function(){var h,p,m=b.height,f=b.height;return{size:b,first:function(a){h=c.select(k("rect")).attr("width",
m).attr("height",f);p=c.select(k("circle")).attr("cx",m/2).attr("cy",m/2).attr("r",m/2);l.addSelection(a);l.addValueSend(a,this,"receive",function(){return{}});c.select(a).call(function(a){a.append(h.node());a.append(p.node())})}}});Rpd.noderenderer("pd/toolbar","svg",function(b){var p=PdModel.TYPE_MAP;return{size:{width:400,height:70},first:function(m){var f=c.select(k("g")).classed("rpd-pd-toolbar-group",!0);f.append("rect").classed("rpd-pd-toolbar-border",!0).attr("height",70).attr("width",400).attr("rx",
5).attr("ry",5);f.append("g").call(function(a){a.attr("transform","translate(12, 35)").classed("rpd-pd-edit-mode",!0);var b=c.select(k("circle")).attr("r",7),f=c.select(k("circle")).attr("r",5);a.append(b.node());a.append(f.node()).style("pointer-events","none");f=c.select(k("text")).attr("x",10).text("Edit mode");a.append(f.node());l.addEditModeSwitch(b.node(),a.node());l.addEditModeSwitch(f.node(),a.node())});f.append("g").call(function(a){a.attr("transform","translate(95, 0)").classed("rpd-pd-buttons",
!0);var f,m;Object.keys(p).forEach(function(u,g){f=g%4*75;m=17.5*Math.floor(g/4);var n=c.select(k("g")).attr("transform","translate("+f+","+m+")").classed("rpd-pd-accessible",p[u]?!0:!1);n.append("rect").attr("width",75).attr("height",17.5);n.append("text").attr("x",10).attr("y",8.75).text(u);p[u]&&l.addNodeAppender(n.node(),p[u],b.patch);a.append(n.node())})});c.select(m).append(f.node())}}});Rpd.noderenderer("pd/edit-switch","svg",function(b){return{first:function(b){var h=c.select(k("g")).classed("rpd-pd-edit-switch-group",
!0),f=c.select(k("circle")).attr("r",7),a=c.select(k("circle")).attr("r",5);h.append(f.node());h.append(a.node()).style("pointer-events","none");a=c.select(k("text")).attr("x",10).text("Edit mode");h.append(a.node());l.addEditModeSwitch(f.node(),h.node());l.addEditModeSwitch(a.node(),h.node());c.select(b).append(h.node())}}})})();

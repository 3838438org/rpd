/**
 * rpd - RPD is a minimal framework for building Node-Based User Interfaces, powered by Reactive Programming
 * Built at Sat, 12 Dec 2015 09:14:43 GMT
 *
 * @version v0.2.0
 * @link http://shamansir.github.io/rpd
 * @author Ulric Wilfred <shaman.sir@gmail.com>
 * @license MIT
 * 
 * Selected Renderers: svg
 * Selected Styles: realpd
 * Selected Toolkits: pd
 * Selected I/O Modules: pd
 * d3.js or d3_tiny.js: d3_tiny.js
 *
 * User Styles: [None]
 * User Toolkits: [None]
 *
 * Command: gulp --root . --renderer svg --style realpd --toolkit pd --io pd --target-name rpd-pd-file --compilation simple
 */
(function(k){var c=k.Kefir;"undefined"===typeof c&&"undefined"!==typeof require&&(c=require("../vendor/kefir.min.js"));if(!c)throw Error("Kefir.js (https://github.com/rpominov/kefir) is required for Rpd to work");var b=function(){function l(d){return function(){return d}}function h(d){this.id=z();this.name=d;var e=this;d={"patch/is-ready":[],"patch/enter":[],"patch/exit":[],"patch/set-inputs":["inputs"],"patch/set-outputs":["outputs"],"patch/project":["node","target"],"patch/refer":["node","target"],
"patch/add-node":["node"],"patch/remove-node":["node"]};this.event=n(d);this.events=x(d,this.event,"patch",this);this.renderQueue=c.emitter();d=c.combine([this.events],[this.renderQueue.scan(function(d,g){var a=g.alias,b=g.target,f=g.config,n=d[a];n||(n={},n.produce=G[a](e),n.handlers=[],d[a]=n);if(n.produce){var c=n.produce(b,f);c&&n.handlers.push("function"===typeof c?c:function(e){if(c[e.type])c[e.type](e)})}return d},{})]);d=d.bufferBy(this.renderQueue).take(1).flatten().concat(d);d.onValue(function(e){var d=
e[0];e=e[1];for(var g=Object.keys(e),a,b=0,n=g.length;b<n;b++){a=e[g[b]];a=a.handlers;for(var f=0,c=a.length;f<c;f++)a[f](A(q(d),g[b]))}});this.projections=c.emitter();c.combine([this.projections],[this.event["patch/set-inputs"],this.event["patch/set-outputs"]]).onValue(function(d){var g=d[0],a=d[1];d=d[2];for(var b,f=0;f<a.length;f++)b=g.addInlet(a[f].type,a[f].name),b.event["inlet/update"].onValue(function(e){return function(d){e.receive(d)}}(a[f]));for(f=0;f<d.length;f++)a=g.addOutlet(d[f].type,
d[f].name),d[f].event["outlet/update"].onValue(function(e){return function(d){e.send(d)}}(a));e.event["patch/project"].emit({node:g,target:g.patch});g.patch.event["patch/refer"].emit({node:g,target:e})});this.nodesToRemove=c.emitter();this.event["patch/is-ready"].emit()}function k(d,e,J,a){this.type=d||"core/empty";this.id=z();var f=t(w[this.type],this);f||B("Node type "+this.type+" is not registered!");this.def=f;this.name=J||f.name||d;this.patch=e;this.render=g(C[this.type],this);d={"node/turn-on":[],
"node/is-ready":[],"node/process":["inlets","outlets"],"node/turn-off":[],"node/add-inlet":["inlet"],"node/remove-inlet":["inlet"],"node/add-outlet":["outlet"],"node/remove-outlet":["outlet"],"node/move":["position"]};this.event=n(d);this.events=x(d,this.event,"node",this);a&&a(this);var b=this;if(this.def.handle)this.events.onValue(function(e){if(b.def.handle[e.type])b.def.handle[e.type](e)});if(this.def.process){var l=this.def.process;a=c.combine([this.event["node/add-inlet"].flatMap(function(e){var d=
e.event["inlet/update"].map(function(d){return{inlet:e,value:d}});b.def.tune&&(d=b.def.tune(d));return d})],[this.event["node/add-outlet"].scan(function(e,d){e[d.alias]=d;return e},{})]);a=a.bufferBy(this.event["node/is-ready"]).take(1).flatten().concat(a);a=a.scan(function(e,d){var g=d[0].inlet,a=g.alias;e.inlets.prev[a]=e.inlets.cur[a];e.inlets.cur[a]=d[0].value;e.outlets=d[1];e.source=g;return e},{inlets:{prev:{},cur:{}},outlets:{}}).changes();a=a.filter(function(e){return!e.source.cold});a.onValue(function(e){var d=
l.bind(b)(e.inlets.cur,e.inlets.prev);b.event["node/process"].emit({inlets:e.inlets.cur,outlets:d});e=e.outlets;for(var g in d)e[g]&&(d[g]instanceof c.Stream?e[g].stream(d[g]):e[g].send(d[g]))})}if(this.def.inlets){this.inlets={};for(var u in this.def.inlets)a=this.def.inlets[u],a=this.addInlet(a.type,u,a.name,a.default,a.hidden,a.readonly,a.cold),this.inlets[u]=a}if(this.def.outlets)for(u in this.outlets={},this.def.outlets)a=this.def.outlets[u],a=this.addOutlet(a.type,u,a.name,a.default),this.outlets[u]=
a;this.def.prepare&&this.def.prepare(this.inlets,this.outlets);this.event["node/is-ready"].emit()}function m(d,e,a,f,b,u,l,k){this.type=d||"core/any";this.id=z();var h=t(E[this.type],this);h||B("Channel type "+this.type+" is not registered!");this.def=h;(this.alias=a||h.alias||f)||B("Inlet should have either alias or name");this.name=f||h.name||this.alias||d;this.node=e;this.hidden=u||!1;this.readonly=r(l||h.readonly)?l||h.readonly:!0;this.cold=k||!1;this.default=r(b)?b:h.default;this.value=c.pool();
this.render=g(D[this.type],this);d={"inlet/update":["value"]};this.event=n(d);var m=this.event["inlet/update"];e=m.merge(this.value);h.tune&&(e=h.tune(e));h.accept&&(e=e.flatten(function(e){if(h.accept(e))return[e];m.error();return[]}));h.adapt&&(e=e.map(h.adapt));this.event["inlet/update"]=e.onValue(function(){});this.events=x(d,this.event,"inlet",this)}function f(d,e,a,f,b){this.type=d||"core/any";this.id=z();var l=t(E[this.type],this);l||B("Channel type "+this.type+" is not registered!");this.def=
l;(this.alias=a||l.alias||f)||B("Outlet should have either alias or name");this.name=f||this.alias||l.name||d;this.node=e;this.default=r(b)?b:l.default;this.value=c.pool();this.render=g(D[this.type],this);d={"outlet/update":["value"],"outlet/connect":["link","inlet"],"outlet/disconnect":["link"]};this.event=n(d);e=this.event["outlet/update"].merge(this.value);this.event["outlet/update"]=e.onValue(function(e){});this.events=x(d,this.event,"outlet",this);var h=this;c.combine([this.event["outlet/connect"]],
[this.event["outlet/update"]]).onValue(function(e){h.value.plug(c.constant(e[1]))})}function a(d,e,g){this.id=z();this.name=g||"";this.outlet=d;this.inlet=e;this.value=c.emitter();var a=this;this.receiver=d.node.id!==e.node.id?function(e){a.pass(e)}:function(e){setTimeout(function(){a.pass(e)},0)};d={"link/enable":[],"link/disable":[],"link/pass":["value"]};this.event=n(d);g=this.event["link/pass"].merge(this.value);this.event["link/pass"]=g.onValue(function(e){});this.events=x(d,this.event,"link",
this);this.enabled=c.merge([this.event["link/disable"].map(l(!1)),this.event["link/enable"].map(l(!0))]).toProperty(l(!0));this.event["link/pass"].filterBy(this.enabled).onValue(function(d){e.receive(d)});c.combine([this.event["link/enable"]],[this.event["link/pass"]]).onValue(function(e){a.pass(e[1])})}function q(d){for(var e={},g=Object.keys(d),a=0,f=g.length;a<f;a++)e[g[a]]=d[g[a]];return e}function r(d){return"undefined"!==typeof d}function t(d,e){return d?"function"===typeof d?d(e):d:null}function g(d,
e){if(!d)return{};var g={},a;for(a in d)g[a]=t(d[a],e);return g}function n(d){var e={};d=Object.keys(d);for(var g=0,a;g<d.length;g++)a=d[g],e[a]=c.emitter();return e}function u(d,e){if(0===e.length)return function(){return{type:d}};if(1===e.length)return function(g){var a={};a.type=d;a[e[0]]=g;return a};if(1<e.length)return function(e){e=q(e);e.type=d;return e}}function x(d,e,g,a){for(var f=c.pool(),b=Object.keys(d),n=0;n<b.length;n++)f.plug(e[b[n]].map(u(b[n],d[b[n]])).map(function(e){e[g]=a;return e}));
return f}function B(d,e){throw e||Error(d);}function z(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}function A(d,e){var g=d.type;if("patch/add-node"===g||"node/process"===g)d.render=d.node.render[e]||{};else if("node/add-inlet"===g||"inlet/update"===g)d.render=d.inlet.render[e]||{};else if("node/add-outlet"===g||"outlet/update"===g)d.render=d.outlet.render[e]||{};return d}(function(){c.emitter=function(){var d,e=c.stream(function(e){d=e;return function(){d=void 0}});e.emit=
function(e){d&&d.emit(e);return this};e.error=function(e){d&&d.error(e);return this};e.end=function(){d&&d.end();return this};e.emitEvent=function(e){d&&d.emitEvent(e);return this};return e.setName("emitter")}})();var w={},E={},C={},D={},H={},F={},G={},I={"network/add-patch":["patch"]},v=n(I),y=x(I,v,"network",b);v["network/add-patch"].onValue(function(d){y.plug(d.events)});var K=c.emitter();h.prototype.render=function(d,e,g){d=Array.isArray(d)?d:[d];e=Array.isArray(e)?e:[e];for(var a=0,f=d.length,
b;a<f;a++)for(var n=0,c=e.length,l;n<c;n++){b=d[a];l=e[n];if(!G[b])throw Error("Renderer "+b+" is not registered");this.renderQueue.emit({alias:b,target:l,config:g})}return this};h.prototype.addNode=function(d,e){var g=this;return new k(d,this,e,function(e){g.events.plug(e.events);g.event["patch/add-node"].emit(e);e.turnOn()})};h.prototype.removeNode=function(d){d.turnOff();this.event["patch/remove-node"].emit(d);this.events.unplug(d.events)};h.prototype.enter=function(){this.event["patch/enter"].emit();
return this};h.prototype.exit=function(){this.event["patch/exit"].emit();return this};h.prototype.inputs=function(d){this.event["patch/set-inputs"].emit(d)};h.prototype.outputs=function(d){this.event["patch/set-outputs"].emit(d)};h.prototype.project=function(d){this.projections.emit(d)};k.prototype.turnOn=function(){this.event["node/turn-on"].emit()};k.prototype.turnOff=function(){this.event["node/turn-off"].emit()};k.prototype.addInlet=function(d,e,g,a,f,b,n){d=new m(d,this,e,g,a,f,b,n);this.events.plug(d.events);
this.event["node/add-inlet"].emit(d);d.toDefault();return d};k.prototype.addOutlet=function(d,e,g,a){d=new f(d,this,e,g,a);this.events.plug(d.events);this.event["node/add-outlet"].emit(d);d.toDefault();return d};k.prototype.removeInlet=function(d){this.event["node/remove-inlet"].emit(d);this.events.unplug(d.events)};k.prototype.removeOutlet=function(d){this.event["node/remove-outlet"].emit(d);this.events.unplug(d.events)};k.prototype.move=function(d,e){this.event["node/move"].emit([d,e]);return this};
m.prototype.receive=function(d){this.value.plug(c.constant(d))};m.prototype.stream=function(d){this.value.plug(d)};m.prototype.toDefault=function(){r(this.default)&&(this.default instanceof c.Stream?this.stream(this.default):this.receive(this.default))};m.prototype.allows=function(d){if(d.type===this.type)return!0;if(!this.def.allow&&d.type!==this.type)return!1;if(this.def.allow){var e=!1;this.def.allow.forEach(function(g){d.type===g&&(e=!0)});return e}return!0};f.prototype.connect=function(d){if(!d.allows(this))throw Error("Outlet of type "+
this.type+" is not allowed to connect to inlet of type "+d.type);var e=new a(this,d);this.events.plug(e.events);this.value.onValue(e.receiver);this.event["outlet/connect"].emit({link:e,inlet:d});return e};f.prototype.disconnect=function(d){this.event["outlet/disconnect"].emit(d);this.value.offValue(d.receiver);this.events.unplug(d.events);return this};f.prototype.send=function(d){this.value.plug(c.constant(d))};f.prototype.stream=function(d){this.value.plug(d)};f.prototype.toDefault=function(){r(this.default)&&
(this.default instanceof c.Stream?this.stream(this.default):this.send(this.default))};a.prototype.pass=function(d){this.value.emit(d)};a.prototype.enable=function(){this.event["link/enable"].emit()};a.prototype.disable=function(){this.event["link/disable"].emit()};a.prototype.disconnect=function(){this.outlet.disconnect(this)};return{VERSION:"v2.0",_:{Patch:h,Node:k,Inlet:m,Outlet:f,Link:a},unit:l,not:function(d){return!d},event:v,events:y,addPatch:function(d){d=new h(d);v["network/add-patch"].emit(d);
return d},render:function(d,e,g){K.emit([d,e,g]);var a=function(a){a.render(d,e,g)};v["network/add-patch"].onValue(a);return function(){v["network/add-patch"].offValue(a)}},nodetype:function(d,e){w[d]=e||{}},channeltype:function(d,e){E[d]=e||{}},nodedescription:function(d,e){H[d]=e},renderer:function(d,e){G[d]=e},styles:F,style:function(d,e,g){F[d]||(F[d]={});F[d][e]=g},noderenderer:function(d,e,g){if(!w[d])throw Error("Node type "+d+" is not registered");C[d]||(C[d]={});C[d][e]=g},channelrenderer:function(d,
e,g){if(!E[d])throw Error("Channel type "+d+" is not registered");D[d]||(D[d]={});D[d][e]=g},"import":{},"export":{},allNodeTypes:w,allNodeDescriptions:H,getStyle:function(d,e){if(!d)throw Error("Unknown style requested: "+d);if(!F[d])throw Error("Style '"+d+"' is not registered");var g=F[d][e];if(!g)throw Error("Style '"+d+"' has no definition for '"+e+"' renderer");return g},short_uid:z}}();"function"===typeof define&&define.amd?(define([],function(){return b}),k.Rpd=b):"object"===typeof module&&
"object"===typeof exports?(module.exports=b,b.Rpd=b):k.Rpd=b})(this);var d3_tiny=function(){function k(b,c,h){for(var k="function"===typeof c?c:function(){return c},m=b.selection,f=0,a=m.length;f<a;f++)h(m[f],k.bind(m[f])(f));return b}function c(b,c,h){c=c||document;selection="string"===typeof b?h?Array.prototype.slice.call(c.querySelectorAll(b),0):[c.querySelector(b)]:b instanceof Node?[b]:Array.isArray(b)?b:[b];this.namespace=1===selection.length&&selection[0]?selection[0].namespaceURI:null;this.selection=selection}c.prototype.empty=function(){return 1===this.selection.length&&
!this.selection[0]||!this.selection.length?!0:!1};c.prototype.attr=function(b,c){return"undefined"===typeof c&&1===this.selection.length?this.selection[0].getAttribute(b):k(this,c,function(c,l){c.setAttributeNS(null,b,l)})};c.prototype.property=function(b,c){return"undefined"===typeof c&&1===this.selection.length?this.selection[0][b]:k(this,c,function(c,l){c[b]=l})};c.prototype.style=function(b,c){"-"===b[0]&&(b=b.slice(1));b=b.replace(/-([a-z])/g,function(b){return b[1].toUpperCase()});return k(this,
c,function(c,l){c.style[b]=l})};c.prototype.text=function(b){return"undefined"===typeof b&&1===this.selection.length?this.selection[0].textContent||this.selection[0].innerText:k(this,b,function(b,c){b.innerText=b.textContent=c})};c.prototype.classed=function(b,c){return"object"===typeof b?k(this,Object.keys(b),function(c,l){for(var k=0,f=l.length;k<f;k++)c.classList.toggle(l[k],b[l[k]])}):k(this,c,function(c,l){c.classList.toggle(b,l)})};c.prototype.select=function(b){return new c(b,this.selection[0])};
c.prototype.selectAll=function(b){return new c(b,this.selection[0],!0)};c.prototype.append=function(b){var l=[];k(this,"string"===typeof b?document.createElementNS(this.namespace,b):b,function(b,c){b.appendChild(c);l.push(c)});return new c(l)};c.prototype.remove=function(){return k(this,function(){return null},function(b){b.parentElement.removeChild(b)})};c.prototype.node=function(b){return this.selection[b||0]};c.prototype.on=function(b,c){return k(this,function(){return c},function(c,l){c.addEventListener(b,
l)})};c.prototype.data=function(b){return b?k(this,b,function(b,c){b.__data__=c}):this.node().__data__};c.prototype.call=function(b){b(this);return this};return{ns:{prefix:{svg:"http://www.w3.org/2000/svg",html:"http://www.w3.org/1999/xhtml"}},select:function(b,l){return new c(b,l)},selectAll:function(b,l){return new c(b,l,!0)}}}();Rpd.Render=function(){function k(g){this.currentPatch=null;this.getPatchByHash=g;var a=this;Kefir.fromEvents(window,"hashchange").map(function(){return window.location.hash?window.location.hash.slice(1):null}).filter(function(g){return!(a.currentPatch&&g===a.currentPatch.id)}).map(a.getPatchByHash).filter(function(g){return null!=g}).onValue(function(g){a.currentPatch&&a.currentPatch.exit();g.enter()})}function c(g){this.nodeRects=[];this.edgePadding=g.edgePadding||{horizontal:30,vertical:20};this.boxPadding=
g.boxPadding||{horizontal:20,vertical:30}}function b(g,a){this.root=g;this.style=a}function l(g,a){this.link=g;this.style=a;this.element=this.styledLink=null}function h(){this.vlinks=[]}function p(g){g.stopPropagation();return g}function m(g){return{x:g.clientX,y:g.clientY}}function f(g,b,c,f){Kefir.fromEvents(g,"click").map(p).map(a(f||!1)).scan(Rpd.not).onValue(function(g){g?b():c()})}var a=Rpd.unit,q=d3_tiny||q;k.prototype.switch=function(g){g&&(this.currentPatch=g,0<=document.title.indexOf("\u2014")?
document.title=document.title.replace(/\u2014.+$/,"\u2014 "+g.name||"[Unnamed]"):document.title+=" \u2014 "+g.name||"[Unnamed]",window.location.hash=g.id)};c.DEFAULT_LIMITS=[1E3,1E3];c.prototype.nextPosition=function(g,a,b){b=b||c.DEFAULT_LIMITS;g=this.nodeRects;var f=this.boxPadding,l=this.edgePadding,k=a.width;a=a.height;var h=g.length?g[g.length-1]:null,h={x:h?h.x:l.horizontal,y:h?h.y+h.height+f.vertical:l.vertical,width:k,height:a};h.y+a+l.vertical>b.height&&(h.x=h.x+k+f.horizontal,h.y=l.vertical);
g.push(h);return{x:h.x,y:h.y}};b.prototype.add=function(g,a){var b=this.root,c=this.style,f=a.start,l=a.end,k=a.drag;Kefir.fromEvents(g.node(),"mousedown").map(m).map(c.getLocalPos).flatMap(function(a){var n=f(),k=a.x-n.x,h=a.y-n.y;a=Kefir.fromEvents(b.node(),"mousemove").map(p).takeUntilBy(Kefir.merge([Kefir.fromEvents(b.node(),"mouseup"),Kefir.fromEvents(g.node(),"mouseup")])).map(m).map(c.getLocalPos).map(function(g){return{x:g.x-k,y:g.y-h}}).toProperty(function(){return n});a.last().onValue(l);
return a}).onValue(k)};l.prototype.construct=function(g){if(this.styledLink)throw Error("VLink is already constructed");this.styledLink=g=this.style.createLink(this.link);this.element=q.select(g.element);return this};l.prototype.rotate=function(g,a,b,c){this.styledLink.rotate(g,a,b,c);return this};l.prototype.rotateI=function(g,a,b){var c=this.style,c=c.getLocalPos(c.getInletPos(b));return this.rotate(g,a,c.x,b.y)};l.prototype.rotateO=function(g,a,b){var c=this.style;g=c.getLocalPos(c.getOutletPos(g));
return this.rotate(g.x,g.y,a,b)};l.prototype.rotateOI=function(g,a){var b=this.style,c=b.getLocalPos(b.getOutletPos(g)),b=b.getLocalPos(b.getInletPos(a));return this.rotate(c.x,c.y,b.x,b.y)};l.prototype.update=function(){if(this.link){var a=this.link;this.rotateOI(a.outlet,a.inlet);return this}};l.prototype.appendTo=function(a){a.append(this.element.node());return this};l.prototype.removeFrom=function(a){this.element.remove();return this};l.prototype.noPointerEvents=function(){this.styledLink.noPointerEvents&&
this.styledLink.noPointerEvents();return this};l.prototype.listenForClicks=function(){var a=this.link;f(this.element.node(),function(){a.enable()},function(){a.disable()});return this};l.prototype.enable=function(){this.element.classed("rpd-disabled",!1)};l.prototype.disable=function(){this.element.classed("rpd-disabled",!0)};l.prototype.get=function(){return this.link};l.prototype.getElement=function(){return this.element.node()};h.prototype.clear=function(){this.vlinks=[]};h.prototype.add=function(a){this.vlinks.push(a);
return a};h.prototype.remove=function(a){this.vlinks=this.vlinks.filter(function(b){return b!==a})};h.prototype.forEach=function(a){this.vlinks.forEach(a)};h.prototype.updateAll=function(){this.forEach(function(a){a.update()})};h.prototype.count=function(){return this.vlinks.length};h.prototype.getLast=function(){return this.count()?this.vlinks[this.vlinks.length-1]:null};var r=function(){var a={};return function(b,c,f){c.classed("rpd-error",!0);a[b]&&clearTimeout(a[b]);a[b]=setTimeout(function(){c.classed("rpd-error",
!1);a[b]=null},f||1)}}(),t=function(){var a={};return function(b,c,f){c.classed("rpd-stale",!1);c.classed("rpd-fresh",!0);a[b]&&clearTimeout(a[b]);a[b]=setTimeout(function(){c.classed("rpd-fresh",!1);c.classed("rpd-stale",!0);a[b]=null},f||1)}}();return{Navigation:k,Placing:c,DragAndDrop:b,VLink:l,VLinks:h,mergeConfig:function(a,b){if(a){var c={};Object.keys(b).forEach(function(a){c[a]=b[a]});Object.keys(a).forEach(function(b){c[b]=a[b]});return c}return b},preventDefault:function(a){a.preventDefault();
return a},stopPropagation:p,extractPos:m,addTarget:function(a){return function(b){return{pos:b,target:a}}},addClickSwitch:f,addValueErrorEffect:r,addValueUpdateEffect:t,subscribeUpdates:function(a,b){b&&Object.keys(b).forEach(function(c){(function(b,c){a.event["node/add-inlet"].filter(function(a){return a.alias===c}).onValue(function(c){a.event["node/is-ready"].onValue(function(){b.default&&c.receive(b.default());if(b.valueOut)b.valueOut.onValue(function(a){c.receive(a)})})})})(b[c],c)})}}}();Rpd.style("realpd","svg",function(){function k(c){return document.createElementNS(b.ns.prefix.svg,c)}function c(b){b=b.getBoundingClientRect();return{x:b.left,y:b.top}}var b=b||d3_tiny;return function(l){function h(b){var c=a[b.id],k=c.length;if(!(1>=k)){var h=f[b.id].node().getBBox().width;c.forEach(function(a,b){r[a.id].attr("transform","translate("+(h/(k-1)*b-7/(k-1)*b)+",0)")})}}function p(a,b){var c=q[a.id],k=c.length;if(!(1>=k)){var h=f[a.id].node().getBBox().width;c.forEach(function(a,b){t[a.id].attr("transform",
"translate("+(h/(k-1)*b-7/(k-1)*b)+",0)")})}}var m,f={},a={},q={},r={},t={};return{createRoot:function(a,c){return{element:b.select(k("g")).classed("rpd-patch",!0).node()}},createNode:function(c,h,l){h=h.size?{width:h.size.width||50,height:h.size.height||18}:{width:18,height:18};l=b.select(k("g")).attr("class","rpd-node");l.classed("rpd-"+c.type.slice(0,c.type.indexOf("/"))+"-toolkit-node",!0).classed("rpd-"+c.type.replace("/","-"),!0);var m=0===c.type.indexOf("pd/");m||l.append("rect").classed("rpd-background").classed("rpd-drag-handle",
!0).attr("width",h.width).attr("height",h.height);l.append("g").classed("rpd-process",!0).classed("rpd-drag-handle",m);l.append("g").classed("rpd-inlets",!0);l.append("g").classed("rpd-outlets",!0).attr("transform","translate(0,16)");f[c.id]=l.select(".rpd-process");a[c.id]=[];q[c.id]=[];return{element:l.node(),size:h}},createInlet:function(c,f){var l=b.select(k("g")).attr("class","rpd-inlet");l.append("g").attr("class","rpd-connector").append("rect").attr("width",7).attr("height",2);r[c.id]=l;a[c.node.id].push(c);
h(c.node);return{element:l.node()}},createOutlet:function(a,c){var f=b.select(k("g")).attr("class","rpd-outlet");f.append("g").attr("class","rpd-connector").append("rect").attr("width",7).attr("height",2);t[a.id]=f;q[a.node.id].push(a);p(a.node);return{element:f.node()}},createLink:function(a){var c=b.select(k("line")).attr("class","rpd-link");return{element:c.node(),rotate:function(a,b,g,f){c.attr("x1",a).attr("y1",b).attr("x2",g).attr("y2",f)},noPointerEvents:function(){c.style("pointer-events",
"none")}}},getInletPos:function(a){a=c(r[a.id].select(".rpd-connector").node());return{x:a.x+3,y:a.y+1}},getOutletPos:function(a){a=c(t[a.id].select(".rpd-connector").node());return{x:a.x+3,y:a.y+1}},getLocalPos:function(a){if(!m)return a;var b=c(m.node());return{x:a.x-b.x,y:a.y-b.y}},onPatchSwitch:function(a,c){m=b.select(c)},onInletRemove:function(b){var c=b.node.id;a[c]=a[c].filter(function(a){return a.id!==b.id})},onOutletRemove:function(a){var b=a.node.id;q[b]=q[b].filter(function(b){return b.id!==
a.id})}}}}());(function(){function k(a){return document.createElementNS(m.ns.prefix.svg,a)}function c(b){return function(c,h){var w=x(h,p),v=Rpd.getStyle(w.style,"svg")(w);c=m.select(c).classed("rpd-network",!0);var y,A,d;return{"patch/is-ready":function(e){var h=m.select(document.documentElement);y=m.select(k("svg")).attr("width",h.property("clientWidth")).attr("height",h.property("clientHeight"));y.append("rect").attr("class","rpd-background").attr("width",h.property("clientWidth")).attr("height",h.property("clientHeight"));
var l=y.append(v.createRoot(b,c).element).classed("rpd-style-"+w.style,!0).classed("rpd-values-"+(w.valuesOnHover?"on-hover":"always-shown"),!0).classed("rpd-show-boxes",w.showBoxes).data(e.patch);a.patches[b.id]=y.data({root:l,width:h.property("clientWidth"),height:h.property("clientHeight"),patch:e.patch});a.patchToPlacing[b.id]=new f.Placing(v);a.patchToLinks[b.id]=new u;A=new g(y,v,w);w.nodeMovingAllowed&&(d=new f.DragAndDrop(y,v));Kefir.fromEvents(y.node(),"selectstart").onValue(B);Kefir.fromEvents(window,
"resize").map(function(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}).onValue(function(a){y.attr("height",a);y.data().height=a})},"patch/enter":function(e){r=e.patch;q.switch(e.patch);var b=a.patches[e.patch.id];c.append(b.node());a.patchToLinks[e.patch.id].updateAll();if(v.onPatchSwitch)v.onPatchSwitch(r,b.node())},"patch/exit":function(a){r=null;y.remove()},"patch/refer":function(e){var d=a.nodes[e.node.id];d.select(".rpd-node").classed("rpd-patch-reference",
!0);d.data().processTarget.append(k("text")).text("["+(e.target.name||e.target.id)+"]");Kefir.fromEvents(d.data().processTarget.node(),"click").onValue(function(a,e){return function(){a.exit();e.enter()}}(b,e.target))},"patch/add-node":function(e){var c=e.node,f=e.render;e=a.patchToPlacing[e.patch.id];var g=a.patches[r.id].data(),h=m.select(k("g")).attr("class","rpd-node-box"),l=v.createNode(c,f,t[c.type]),q=h.append(l.element);a.nodes[c.id]=h.data({inletsTarget:q.select(".rpd-inlets"),outletsTarget:q.select(".rpd-outlets"),
processTarget:q.select(".rpd-process"),position:n,size:l.size});var n=e.nextPosition(c,l.size,{width:g.width,height:g.height});c.move(n.x,n.y);var x=new u;a.nodeToLinks[c.id]=x;if(w.nodeMovingAllowed){var p=q.select(".rpd-shadow"),n=q.select(".rpd-drag-handle");n.empty()||d.add(n,{start:function(){q.classed("rpd-dragging",!0);p.empty()||p.attr("x",7).attr("y",8);return h.data().position},drag:function(a){h.attr("transform","translate("+a.x+","+a.y+")");x.forEach(function(a){a.update()})},end:function(a){c.move(a.x,
a.y);p.empty()||p.attr("x",5).attr("y",6);q.classed("rpd-dragging",!1)}})}f.prepare&&f.prepare.bind(c)(a.patches[b.id].node(),a.patches[r.id].node());f.first&&D(c,f.first.bind(c)(q.select(".rpd-process").node()));if(f.always)c.event["node/process"].throttle(100).onValue(function(){x.updateAll()});if(!q.select(".rpd-remove-button").empty())Kefir.fromEvents(q.select(".rpd-remove-button path").node(),"click").map(z).onValue(function(){b.removeNode(c)});a.patches[c.patch.id].data().root.append(h.node())},
"patch/remove-node":function(e){e=e.node;var b=a.nodes[e.id];a.nodeToLinks[e.id].forEach(function(a){a.get().disconnect()});b.remove();if(v.onNodeRemove)v.onNodeRemove(e);a.nodes[e.id]=null;a.nodeToLinks[e.id]=null},"node/move":function(e){var b=a.nodes[e.node.id];e=e.position;b.attr("transform","translate("+Math.floor(e[0])+","+Math.floor(e[1])+")");b.data().position={x:e[0],y:e[1]}},"node/process":function(e){var b=e.node,c=e.render;if(c.always){var d=a.nodes[b.id].data().processTarget.node();c.always.bind(b)(d,
e.inlets,e.outlets)}},"node/add-inlet":function(e){var b=e.inlet;if(!b.hidden){var c=a.nodes[e.node.id].data().inletsTarget;e=e.render;var d;d=m.select(v.createInlet(b,e).element);d.classed("rpd-"+b.type.replace("/","-"),!0);d.classed({"rpd-stale":!0,"rpd-readonly":b.readonly,"rpd-cold":b.cold});var f=null;!b.readonly&&e.edit&&(f=new l(b,e,y,d.select(".rpd-value-holder"),d.select(".rpd-value"),m.select(k("g"))),d.select(".rpd-value-holder").append(f.editorElm.node()));a.inlets[b.id]=d.data({connector:d.select(".rpd-connector"),
value:d.select(".rpd-value"),vlinks:new u,editor:f});b.event["inlet/update"].onError(function(){E(b.id,d,w.effectTime)});A.subscribeInlet(b,d.select(".rpd-connector"));c.append(d.node())}},"node/add-outlet":function(e){var b=e.outlet,d=a.nodes[e.node.id].data().outletsTarget;e=m.select(v.createOutlet(b,e.render).element);e.classed("rpd-"+b.type.replace("/","-"),!0);e.classed("rpd-stale",!0);a.outlets[b.id]=e.data({connector:e.select(".rpd-connector"),value:e.select(".rpd-value"),vlinks:new u});A.subscribeOutlet(b,
e.select(".rpd-connector"));d.append(e.node())},"node/remove-inlet":function(e){e=e.inlet;a.inlets[e.id].data().vlinks.forEach(function(a){a.get().disconnect()});a.inlets[e.id].remove();if(v.onInletRemove)v.onInletRemove(e);a.inlets[e.id]=null},"node/remove-outlet":function(e){e=e.outlet;a.outlets[e.id].data().vlinks.forEach(function(a){a.get().disconnect()});a.outlets[e.id].remove();if(v.onOutletRemove)v.onOutletRemove(e);a.outlets[e.id]=null},"inlet/update":function(e){var b=e.inlet;if(!b.hidden){var d=
e.render,c=a.inlets[b.id],f=c.data().value;if(!f.empty()){var g=b.def.show?b.def.show(e.value):e.value;d.show?d.show.bind(b)(f.node(),e.value,g):f.text(g)}C(b.id,c,w.effectTime)}},"outlet/update":function(b){var d=b.outlet,c=b.render,f=a.outlets[d.id],g=f.data().value;if(!g.empty()){var h=d.def.show?d.def.show(b.value):b.value;c.show?c.show.bind(d)(g.node(),b.value,h):g.text(h)}C(d.id,f,w.effectTime)},"outlet/connect":function(e){e=e.link;var d=e.outlet,c=e.inlet,f=a.inlets[c.id],g=a.outlets[d.id].data(),
f=f.data();if(!w.inletAcceptsMultipleLinks&&1===f.vlinks.count())throw Error("Inlet is already connected to a link");f.editor&&f.editor.disable();var h=new n(e,v);h.construct(w.linkWidth).rotateOI(d,c);m.select(h.getElement()).classed("rpd-"+c.type.replace("/","-"),!0).classed("rpd-"+d.type.replace("/","-"),!0);a.links[e.id]=h;g.vlinks.add(h);f.vlinks.add(h);a.nodeToLinks[d.node.id].add(h);d.node.id!==c.node.id&&a.nodeToLinks[c.node.id].add(h);a.patchToLinks[b.id].add(h);h.listenForClicks();h.appendTo(y)},
"outlet/disconnect":function(e){e=e.link;var d=a.links[e.id],c=e.outlet,f=e.inlet,g=a.outlets[c.id].data(),h=a.inlets[f.id].data();a.links[e.id]=null;g.vlinks.remove(d);h.vlinks.remove(d);a.nodeToLinks[c.node.id].remove(d);c.node.id!==f.node.id&&a.nodeToLinks[f.node.id].remove(d);a.patchToLinks[b.id].remove(d);d.removeFrom(y)},"link/enable":function(b){var d=a.inlets[b.link.inlet.id].data();d.editor&&d.editor.disable();a.links[b.link.id].enable()},"link/disable":function(b){a.links[b.link.id].disable()}}}}
function b(a,b){return Kefir.merge([a.map(h(!0)),b.map(h(!1))]).toProperty(h(!1))}function l(b,c,f,g,l,k){var m=Kefir.emitter(),d=Kefir.emitter();this.disableEditor=d;this.editorElm=k;this.valueElm=l;k.classed("rpd-value-editor",!0);c.edit.bind(b)(k.node(),b,m).onValue(function(a){b.receive(a)});Kefir.combine([Kefir.merge([Kefir.fromEvents(g.node(),"click").map(z).map(h(!0)),Kefir.fromEvents(f.node(),"click").merge(d).map(h(!1))]).toProperty(h(!1)).skipDuplicates()],[b.event["inlet/update"]]).map(function(a){return{lastValue:a[1],
startEditing:a[0],cancelEditing:!a[0]}}).onValue(function(d){if(d.startEditing){var c=a.inlets[b.id].data();c.link&&c.link.disable();m.emit(d.lastValue);g.classed("rpd-editor-enabled",!0)}else d.cancelEditing&&(l.classed("rpd-edited",!0),g.classed("rpd-editor-enabled",!1))});g.classed("rpd-editor-disabled",!0)}var h=Rpd.unit,p={style:"quartz",valuesOnHover:!1,showBoxes:!1,nodeMovingAllowed:!0,renderNodeList:!0,nodeListCollapsed:!0,inletAcceptsMultipleLinks:!1,effectTime:1E3},m=m||d3_tiny,f=Rpd.Render,
a={patches:{},nodes:{},inlets:{},outlets:{},links:{},patchToPlacing:{},patchToLinks:{},nodeToLinks:{}},q=new f.Navigation(function(a){return function(b){return a.patches[b].data().patch}}(a)),r,t=Rpd.allNodeDescriptions,g=function(){function c(b){return a.inlets[b.id].data().vlinks}function f(a){return function(){return 0<c(a).count()}}function g(a){1===a.count()&&(a=a.getLast().link,a.outlet.disconnect(a))}function l(a,b){a.forEach(function(a){a.link.outlet.id===b.id&&b.disconnect(a.link)})}function k(a,
c,d){this.root=a;this.style=c;this.config=d;this.rootClicks=Kefir.fromEvents(this.root.node(),"click");this.inletClicks=Kefir.pool();this.outletClicks=Kefir.pool();this.startLink=Kefir.emitter();this.finishLink=Kefir.emitter();this.doingLink=b(this.startLink,this.finishLink)}k.prototype.subscribeOutlet=function(a,f){var d=this.root,e=this.style,k=this.config,q=this.rootClicks,r=this.outletClicks,x=this.inletClicks,p=this.startLink,u=this.finishLink,t=this.doingLink;r.plug(Kefir.fromEvents(f.node(),
"click").map(A).map(w(a)));Kefir.fromEvents(f.node(),"click").map(z).filterBy(b(r,t)).map(A).onValue(function(b){p.emit();var f=(new n(null,e)).construct(k.linkWidth).rotateO(a,b.x,b.y).noPointerEvents().appendTo(d);m.select(f.getElement()).classed("rpd-"+a.type.replace("/","-"),!0);Kefir.fromEvents(d.node(),"mousemove").takeUntilBy(Kefir.merge([x,r.map(h(!1)),q.map(h(!1))]).take(1).onValue(function(b){if(b){b=b.target;var d=c(b);k.inletAcceptsMultipleLinks?l(d,a):g(d);a.connect(b)}})).map(A).map(e.getLocalPos).onValue(function(b){f.rotateO(a,
b.x,b.y)}).onEnd(function(){f.removeFrom(d);u.emit()})})};k.prototype.subscribeInlet=function(a,k){var d=this.root,e=this.style,q=this.config,r=this.rootClicks,x=this.outletClicks,p=this.inletClicks,u=this.startLink,t=this.finishLink,C=this.doingLink;p.plug(Kefir.fromEvents(k.node(),"click").map(A).map(w(a)));Kefir.fromEvents(k.node(),"click").map(z).filterBy(b(p,C)).filter(f(a)).onValue(function(b){var f=c(a).getLast().link,k=f.outlet;k.disconnect(f);u.emit();var z=(new n(null,e)).construct(q.linkWidth).rotateO(k,
b.x,b.y).noPointerEvents().appendTo(d);m.select(z.getElement()).classed("rpd-"+a.type.replace("/","-"),!0).classed("rpd-"+k.type.replace("/","-"),!0);Kefir.fromEvents(d.node(),"mousemove").takeUntilBy(Kefir.merge([p,x.map(h(!1)),r.map(h(!1))]).take(1).onValue(function(a){if(a){a=a.target;var b=c(a);q.inletAcceptsMultipleLinks?l(b,k):g(b);k.connect(a)}})).map(A).map(e.getLocalPos).onValue(function(a){z.rotateO(k,a.x,a.y)}).onEnd(function(){z.removeFrom(d);t.emit()})})};return k}();l.prototype.disable=
function(){this.valueElm.classed("rpd-edited",!1);this.disableEditor.emit()};var n=f.VLink,u=f.VLinks,x=f.mergeConfig,B=f.preventDefault,z=f.stopPropagation,A=f.extractPos,w=f.addTarget,E=f.addValueErrorEffect,C=f.addValueUpdateEffect,D=f.subscribeUpdates;Rpd.SvgRenderer=c;Rpd.renderer("svg",c)})();var PdView=function(){function k(a){this.inEditMode=Kefir.merge([n.map(h(!0)),u.map(h(!1))]).toProperty(h(!1));f=l.select(document.createElement("input")).attr("type","text").attr("class","rpd-pd-text-editor").style("width","300px").style("height",a.height+1+"px").node();document.addEventListener("DOMContentLoaded",function(){l.select(document.body).append(l.select(f).style("display","none").style("position","absolute").node())})}function c(a){return{x:a.clientX,y:a.clientY}}function b(a,b){this.element=
a;this.value=0;var f=this,g=Kefir.emitter();g.onValue(function(a){f.value=a});Kefir.fromEvents(a,"mousedown").filterBy(b).map(m).map(c).flatMap(function(a){var b=f.value;return Kefir.fromEvents(document.body,"mousemove").map(c).takeUntilBy(Kefir.fromEvents(document.body,"mouseup")).map(function(c){return b+(a.y-c.y)}).onValue(function(a){g.emit(a)})}).onEnd(function(){});this.changes=g}var l=l||d3_tiny,h=Rpd.unit,p=Rpd.not,m=Rpd.Render.stopPropagation,f,a=Kefir.emitter(),q=Kefir.emitter(),r=null,
t=Kefir.emitter(),g=Kefir.emitter(),n=Kefir.emitter(),u=Kefir.emitter();k.prototype.addSelection=function(a){Kefir.fromEvents(a,"click").filterBy(this.inEditMode.map(p)).map(m).onValue(function(){t.emit();r&&l.select(r).classed("rpd-pd-selected",!1);r=a;l.select(a).classed("rpd-pd-selected",!0);Kefir.fromEvents(document.body,"click").take(1).onValue(function(){l.select(a).classed("rpd-pd-selected",!1);r=null;g.emit()})})};k.prototype.addEditor=function(b,c,g){var h=l.select(c),k=l.select(f);Kefir.fromEvents(b,
"click").filterBy(this.inEditMode.map(p)).map(m).map(function(){return h.text()}).onValue(function(b){a.emit();var l=c.getBoundingClientRect();k.classed("rpd-pd-selected",!0).style("top",l.top-5+"px").style("left",l.left-1+"px");k.node().value=b||"";f.setSelectionRange(0,f.value.length);h.text("").style("display","none");k.style("display","block").node().focus();Kefir.merge([Kefir.fromEvents(document.body,"click"),Kefir.fromEvents(f,"keydown").map(function(a){return a.keyCode}).filter(function(a){return 13===
a}),t]).take(1).onValue(function(){var a=k.node().value;f.blur();h.text(a);k.node().value="";k.style("display","none").classed("rpd-pd-selected",!1);h.style("display","block");q.emit();g&&g(a)})})};k.prototype.addEditModeSwitch=function(a,b){Kefir.fromEvents(a,"click").map(m).map(h(!0)).scan(Rpd.not).onValue(function(a){a?n.emit():u.emit();l.select(b).classed("rpd-pd-enabled",a)})};k.prototype.addNodeAppender=function(a,b,c){Kefir.fromEvents(a,"click").map(m).onValue(function(){c.addNode(b)})};k.prototype.addValueSend=
function(a,b,c,f){var g;Kefir.fromEvents(a,"click").filterBy(this.inEditMode).map(m).onValue(function(){g&&clearTimeout(g);l.select(a).classed("rpd-pd-send-value",!0);g=setTimeout(function(){l.select(a).classed("rpd-pd-send-value",!1)},300);b.webPdObject.inlets[0].message(f())})};k.prototype.addSpinner=function(a){return new b(a,this.inEditMode)};k.prototype.measureText=function(a){a=a.node().getBBox();return{width:a.width,height:a.height}};b.prototype.getChangesStream=function(){return this.changes};
return k}(),PdModel=function(){function k(b,a){this.patch=b;this.webPdPatch=a;this.nodeToInlets={};this.nodeToOutlets={};this.webPdDummy={patch:a}}var c=window.Pd||null;if(!c)throw Error("Building PD Model requires WebPd present");var b=function(){return function(b,a,h){try{return b.webPdPatch.createObject(a,h)}catch(k){return k instanceof c.core.errors.UnkownObjectError||console.error(k,a,h),null}}}(),l=Kefir.emitter(),h=Kefir.emitter();h.toProperty();l.map(function(c){return{node:c.node,patch:c.node.patch,
command:c.command,arguments:c.arguments,object:b(c.node.patch,c.command,c.arguments)}}).onValue(function(b){h.emit(b)});var p=Pd.core.portlets.DspInlet,m=Pd.core.portlets.DspOutlet;k.prototype.connectToWebPd=function(b,a,h,k){if(b&&!h||b&&b.length!==h.length)throw Error("inlets number not matches to WebPd inlets number");if(a&&!k||a&&a.length!==k.length)throw Error("outlets number not matches to WebPd outlets number");b&&h&&b.forEach(function(a,b){if("pd/dsp"!==a.type){var c=h[b];if(!c)throw Error("Failed to find WebPd inlet corresponding to inlet "+
b);a.event["inlet/update"].onValue(function(a){c.message(a.get())})}});if(a&&k){var l=this.webPdDummy;a.forEach(function(a,b){if("pd/dsp"!==a.type){var f=new c.core.portlets.Inlet(l);f.message=function(b){a.send(PdValue.from(b))};if(k[b])k[b].connect(f);else throw Error("Failed to find WebPd outlet corresponding to outlet "+b);}})}};k.prototype.applyDefinition=function(b,a,c,h){c=this.nodeToInlets[b.id];var k=this.nodeToOutlets[b.id];c&&(c.forEach(function(a){b.removeInlet(a)}),this.nodeToInlets[b.id]=
null);k&&(k.forEach(function(a){b.removeOutlet(a)}),this.nodeToOutlets[b.id]=null);if(h){c=h.outlets||{};var g=[],l=[];(h.inlets||{}).forEach(function(a,c){g.push(b.addInlet(a instanceof p?"pd/dsp":"pd/value",c.toString()))});c.forEach(function(a,c){l.push(b.addOutlet(a instanceof m?"pd/dsp":"pd/value",c.toString()))});this.nodeToInlets[b.id]=g.length?g:null;this.nodeToOutlets[b.id]=l.length?l:null;this.connectToWebPd(g,l,h.inlets,h.outlets,"<"+b.id+"> "+(h.prefix||a||b.type))}};k.prototype.requestResolve=
function(b,a,c){l.emit({node:b,command:a,arguments:c})};k.prototype.whenResolved=function(b,a){h.filter(function(a){return a.node.id===b.id}).onValue(a)};k.prototype.initMessage=function(b,a){b.inlets.init.receive(PdValue.from(a))};k.getReceivingInlet=function(b){return b.inlets.receive};k.getSendingOutlet=function(b){return b.outlets.send};k.TYPE_MAP={obj:"pd/object",msg:"pd/message",floatatom:"pd/number",symbolatom:"pd/symbol",text:"pd/comment",bng:"pd/bang",tgl:"pd/toggle",nbx:null,vsl:null,hsl:null,
vradio:null,hradio:null,vu:null,cnv:null,graph:null,array:null};return k}();PdValue=function(){function k(c){this.value=c}k.prototype.get=function(){return this.value};k.prototype.isBang=function(){return"bang"===this.value[0]};k.isPdValue=function(c){return c instanceof k};k.from=function(c){return new k(c)};k.bang=function(){return new k(["bang"])};return k}();function nop(){}Rpd.channeltype("pd/value",{accept:function(k){return PdValue.isPdValue(k)}});Rpd.channeltype("pd/dsp",{});Rpd.nodetype("pd/object",function(k){var c,b=k.patch?k.patch.model:null;b&&b.whenResolved(k,function(b){c=b.definition?b.definition.process:null});return{inlets:{command:{type:"pd/value",hidden:!0}},process:function(){return c?c.apply(this,arguments):null}}});Rpd.nodetype("pd/comment",{inlets:{text:{type:"pd/value",hidden:!0}}});
Rpd.nodetype("pd/number",{inlets:{receive:{type:"pd/value"},spinner:{type:"pd/value",hidden:!0}},outlets:{send:{type:"pd/value"}},process:nop});Rpd.nodetype("pd/symbol",{inlets:{receive:{type:"pd/value"}},outlets:{send:{type:"pd/value"}}});Rpd.nodetype("pd/message",function(){return{inlets:{receive:{type:"pd/value"},init:{type:"pd/value",hidden:!0}},outlets:{send:{type:"pd/value"}},process:nop}});Rpd.nodetype("pd/bang",{inlets:{receive:{type:"pd/value"}},outlets:{send:{type:"pd/value"}},process:nop});
Rpd.nodetype("pd/toggle",{inlets:{receive:{type:"pd/value"}},outlets:{send:{type:"pd/value"}}});Rpd.nodetype("pd/toolbar",{});Rpd.nodetype("pd/edit-switch",{});(function(){function k(b){return document.createElementNS(c.ns.prefix.svg,b)}var c=c||d3_tiny,b={width:50,height:18},l=new PdView(b);Rpd.noderenderer("pd/number","svg",function(){var h,p,m;return{size:b,first:function(f){h=c.select(k("path")).attr("d","M 0,0 h "+(b.width-5)+" l 5 5 v "+(b.height-5)+" h "+-b.width+" v "+-b.height+" z");p=c.select(k("text")).attr("x",2).attr("y",b.height/2).text("0");m=l.addSpinner(p.node());var a=m.getChangesStream();l.addSelection(f);c.select(f).call(function(a){a.append(h.node());
a.append(p.node())});return{receive:{valueOut:a.map(function(a){return PdValue.from([parseFloat(a)])})}}},always:function(b,a){p.text((a.receive||a.spinner).get())}}});Rpd.noderenderer("pd/symbol","svg",function(){var h,p;return{size:b,first:function(m){h=c.select(k("path")).attr("d","M 0,0 h "+(b.width-5)+" l 5 5 v "+(b.height-5)+" h "+-b.width+" v "+-b.height+" z");p=c.select(k("text")).attr("x",2).attr("y",b.height/2).text("symbol");l.addSelection(m);c.select(m).call(function(b){b.append(h.node());
b.append(p.node())})}}});Rpd.noderenderer("pd/message","svg",function(){var h,p,m,f=!1;return{size:b,first:function(a){h=c.select(k("path")).attr("d","M 0,0 h "+b.width+" l -4 4 v "+(b.height-8)+" l 4 4 h "+-b.width+" v "+-b.height+" z");p=c.select(k("text")).attr("x",2).attr("y",b.height/2);p.text("");l.addSelection(a);l.addEditor(a,p.node(),function(a){m=PdValue.from(a.split(" "))});l.addValueSend(a,this,"receive",function(){return m.get()});c.select(a).call(function(a){a.append(h.node());a.append(p.node())})},
always:function(a,b){b.init&&!f?(m=b.init,p.text(m.get().join(" ")),f=!0):b.receive&&!b.receive.isBang()&&(m=b.receive)}}});Rpd.noderenderer("pd/comment","svg",function(){return{size:b,first:function(h){var p=c.select(k("rect")).attr("width",b.width).attr("height",b.height),m=c.select(k("text")).attr("y",b.height/2).text("comment");l.addSelection(h);l.addEditor(h,m.node());c.select(h).call(function(b){b.append(p.node());b.append(m.node())})}}});Rpd.noderenderer("pd/object","svg",function(){return{size:b,
first:function(h){var p=this,m=p.patch?p.patch.model:null,f=c.select(k("rect")).classed("rpd-pd-erratic",!0);f.attr("width",b.width).attr("height",b.height);var a=c.select(k("text")).attr("x",2).attr("y",b.height/2);l.addSelection(h);l.addEditor(h,a.node(),function(a){m&&(a=a.split(" "),m.requestResolve(p,a[0],a.slice(1)))});if(m){var q;m.whenResolved(p,function(b){var c=b.command+(b.arguments.length?" "+b.arguments.join(" "):"");if(!q||c!==q){a.text(c);var g=l.measureText(a);f.attr("width",g.width+
6);f.classed("rpd-pd-erratic",!b.object);m.applyDefinition(b.node,b.command,b.arguments,b.object);q=c}})}c.select(h).call(function(b){b.append(f.node());b.append(a.node())})}}});Rpd.noderenderer("pd/toggle","svg",function(){var h,p=b.height,m=b.height;return{size:b,first:function(b){h=c.select(k("rect"));h.attr("width",p).attr("height",m);l.addSelection(b);c.select(b).append(h.node())}}});Rpd.noderenderer("pd/bang","svg",function(){var h,p,m=b.height,f=b.height;return{size:b,first:function(a){h=c.select(k("rect")).attr("width",
m).attr("height",f);p=c.select(k("circle")).attr("cx",m/2).attr("cy",m/2).attr("r",m/2);l.addSelection(a);l.addValueSend(a,this,"receive",function(){return{}});c.select(a).call(function(a){a.append(h.node());a.append(p.node())})}}});Rpd.noderenderer("pd/toolbar","svg",function(b){var p=PdModel.TYPE_MAP;return{size:{width:400,height:70},first:function(m){var f=c.select(k("g")).classed("rpd-pd-toolbar-group",!0);f.append("rect").classed("rpd-pd-toolbar-border",!0).attr("height",70).attr("width",400).attr("rx",
5).attr("ry",5);f.append("g").call(function(a){a.attr("transform","translate(12, 35)").classed("rpd-pd-edit-mode",!0);var b=c.select(k("circle")).attr("r",7),f=c.select(k("circle")).attr("r",5);a.append(b.node());a.append(f.node()).style("pointer-events","none");f=c.select(k("text")).attr("x",10).text("Edit mode");a.append(f.node());l.addEditModeSwitch(b.node(),a.node());l.addEditModeSwitch(f.node(),a.node())});f.append("g").call(function(a){a.attr("transform","translate(95, 0)").classed("rpd-pd-buttons",
!0);var f,m;Object.keys(p).forEach(function(t,g){f=g%4*75;m=17.5*Math.floor(g/4);var n=c.select(k("g")).attr("transform","translate("+f+","+m+")").classed("rpd-pd-accessible",p[t]?!0:!1);n.append("rect").attr("width",75).attr("height",17.5);n.append("text").attr("x",10).attr("y",8.75).text(t);p[t]&&l.addNodeAppender(n.node(),p[t],b.patch);a.append(n.node())})});c.select(m).append(f.node())}}});Rpd.noderenderer("pd/edit-switch","svg",function(b){return{first:function(b){var h=c.select(k("g")).classed("rpd-pd-edit-switch-group",
!0),f=c.select(k("circle")).attr("r",7),a=c.select(k("circle")).attr("r",5);h.append(f.node());h.append(a.node()).style("pointer-events","none");a=c.select(k("text")).attr("x",10).text("Edit mode");h.append(a.node());l.addEditModeSwitch(f.node(),h.node());l.addEditModeSwitch(a.node(),h.node());c.select(b).append(h.node())}}})})();(function(k){Rpd.export.pd=function(c){var b=[];Rpd.events.onValue(function(){});return function(){return b.join("\r\n")}};Rpd.import.pd=function(c){function b(a){g[a.node.id]||(g[a.node.id]=[]);g[a.node.id].push(a.inlet)}function l(a){n[a.node.id]||(n[a.node.id]=[]);n[a.node.id].push(a.outlet)}function h(a){g[a.node.id].pop()}function p(a){n[a.node.id].pop()}function m(a){return function(b){return b.type===a}}var f=k.Pd||null;if(!f)throw Error("WebPd is required to import PD files");c=f.parsePatch(c);
var a=f.loadPatch(c),q=[],r=Rpd.addPatch("PD").enter(),t=new PdModel(r,a);r.model=t;r.webPdPatch=a;var g={},n={},f=r.events.filter(m("node/add-inlet")).filter(function(a){return!a.inlet.hidden}),u=r.events.filter(m("node/add-outlet")),x=r.events.filter(m("node/remove-inlet")),B=r.events.filter(m("node/remove-outlet"));f.onValue(b);u.onValue(l);x.onValue(h);B.onValue(p);c.nodes.forEach(function(b,c){var g=b.proto,f=PdModel.TYPE_MAP[g],h=r.addNode(f||"pd/object");h.move(b.layout.x,b.layout.y);h.webPdObject=
a.objects[c];if(f)try{t.connectToWebPd([PdModel.getReceivingInlet(h)],[PdModel.getSendingOutlet(h)],h.webPdObject.inlets,h.webPdObject.outlets,"<"+h.id+"> "+f)}catch(k){console.error(k)}else t.requestResolve(h,g,b.args);f&&"pd/message"===f&&t.initMessage(h,b.args);q.push(h)});c.connections.forEach(function(a){var b=a.source.id,c=a.sink.id,f=a.source.port;a=a.sink.port;var h=q[b],k=q[c];n[h.id]&&g[k.id]?(f=n[h.id][f],(a=g[k.id][a])&&f?f.connect(a,"pd/dsp"===f.type?"pd/dsp":"pd/value"):console.error("Failed to connect object "+
b+" to object "+c)):console.error("Failed to connect object "+b+" to object "+c)});f.offValue(b);u.offValue(l);x.offValue(h);B.offValue(p);return r}})(this);

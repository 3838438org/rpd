/**
 * rpd - RPD is a minimal framework for building Node-Based User Interfaces, powered by Reactive Programming
 * Built at Wed, 30 Dec 2015 08:26:25 GMT
 *
 * @version v0.2.0
 * @link http://shamansir.github.io/rpd
 * @author Ulric Wilfred <shaman.sir@gmail.com>
 * @license MIT
 * 
 * Selected Renderers: svg
 * Selected Styles: realpd
 * Selected Toolkits: pd
 * Selected I/O Modules: pd
 * d3.js or d3_tiny.js: d3_tiny.js
 *
 * User Styles: [None]
 * User Toolkits: [None]
 *
 * Command: gulp --root . --renderer svg --style realpd --toolkit pd --io pd --target-name rpd-pd-file --compilation simple
 */
(function(a){var c=a.Kefir;"undefined"===typeof c&&"undefined"!==typeof require&&(c=require("../vendor/kefir.min.js"));if(!c)throw Error("Kefir.js (https://github.com/rpominov/kefir) is required for Rpd to work");var f=function(){function a(d){return function(){return d}}function b(d){this.id=y();this.name=d;var k=this;d={"patch/is-ready":[],"patch/enter":[],"patch/exit":[],"patch/set-inputs":["inputs"],"patch/set-outputs":["outputs"],"patch/project":["node","target"],"patch/refer":["node","target"],
"patch/add-node":["node"],"patch/remove-node":["node"]};this.event=u(d);this.events=z(d,this.event,"patch",this);this.renderQueue=c.emitter();d=c.combine([this.events],[this.renderQueue.scan(function(d,e){var b=e.alias,c=e.target,a=e.config,f=d[b];f||(f={},f.produce=H[b](k),f.handlers=[],d[b]=f);if(f.produce){var g=f.produce(c,a);g&&f.handlers.push("function"===typeof g?g:function(d){if(g[d.type])g[d.type](d)})}return d},{})]);d=d.bufferBy(this.renderQueue).take(1).flatten().concat(d);d.onValue(function(d){var k=
d[0];d=d[1];for(var e=Object.keys(d),b,c=0,f=e.length;c<f;c++){b=d[e[c]];b=b.handlers;for(var a=0,g=b.length;a<g;a++)b[a](w(q(k),e[c]))}});this.projections=c.emitter();c.combine([this.projections],[this.event["patch/set-inputs"],this.event["patch/set-outputs"]]).onValue(function(d){var e=d[0],b=d[1];d=d[2];for(var c,f=0;f<b.length;f++)c=e.addInlet(b[f].type,b[f].name),c.event["inlet/update"].onValue(function(d){return function(k){d.receive(k)}}(b[f]));for(f=0;f<d.length;f++)b=e.addOutlet(d[f].type,
d[f].name),d[f].event["outlet/update"].onValue(function(d){return function(k){d.send(k)}}(b));k.event["patch/project"].emit({node:e,target:e.patch});e.patch.event["patch/refer"].emit({node:e,target:k})});this.nodesToRemove=c.emitter();this.event["patch/is-ready"].emit()}function p(d,k,b,f){this.type=d||"core/empty";this.id=y();this.patch=k;k={"node/turn-on":[],"node/is-ready":[],"node/process":["inlets","outlets"],"node/turn-off":[],"node/add-inlet":["inlet"],"node/remove-inlet":["inlet"],"node/add-outlet":["outlet"],
"node/remove-outlet":["outlet"],"node/move":["position"]};this.event=u(k);this.events=z(k,this.event,"node",this);(k=v(r[this.type],this))||A("Node type "+this.type+" is not registered!");this.def=k;this.name=b||k.name||d;this.render=e(B[this.type],this);f&&f(this);var a=this;if(this.def.handle)this.events.onValue(function(d){if(a.def.handle[d.type])a.def.handle[d.type](d)});if(this.def.process){var g=this.def.process;d=c.combine([this.event["node/add-inlet"].flatMap(function(d){var k=d.event["inlet/update"].map(function(k){return{inlet:d,
value:k}});a.def.tune&&(k=a.def.tune(k));return k})],[this.event["node/add-outlet"].scan(function(d,k){d[k.alias]=k;return d},{})]);d=d.bufferBy(this.event["node/is-ready"]).take(1).flatten().concat(d);d=d.scan(function(d,k){var e=k[0].inlet,b=e.alias;d.inlets.prev[b]=d.inlets.cur[b];d.inlets.cur[b]=k[0].value;d.outlets=k[1];d.source=e;return d},{inlets:{prev:{},cur:{}},outlets:{}}).changes();d=d.filter(function(d){return!d.source.cold});d.onValue(function(d){var k=g.bind(a)(d.inlets.cur,d.inlets.prev);
a.event["node/process"].emit({inlets:d.inlets.cur,outlets:k});d=d.outlets;for(var e in k)d[e]&&(k[e]instanceof c.Stream?d[e].stream(k[e]):d[e].send(k[e]))})}if(this.def.inlets){this.inlets={};for(var t in this.def.inlets)d=this.def.inlets[t],d=this.addInlet(d.type,t,d.name,d.default,d.hidden,d.readonly,d.cold),this.inlets[t]=d}if(this.def.outlets)for(t in this.outlets={},this.def.outlets)d=this.def.outlets[t],d=this.addOutlet(d.type,t,d.name,d.default),this.outlets[t]=d;this.def.prepare&&this.def.prepare(this.inlets,
this.outlets);this.event["node/is-ready"].emit()}function l(d,k,b,f,a,g,t,h){this.type=d||"core/any";this.id=y();var l=v(D[this.type],this);l||A("Channel type "+this.type+" is not registered!");this.def=l;(this.alias=b||l.alias||f)||A("Inlet should have either alias or name");this.name=f||l.name||this.alias||d;this.node=k;this.hidden=g||!1;this.readonly=m(t||l.readonly)?t||l.readonly:!0;this.cold=h||!1;this.default=m(a)?a:l.default;this.value=c.pool();this.render=e(C[this.type],this);d={"inlet/update":["value"]};
this.event=u(d);var p=this.event["inlet/update"];k=p.merge(this.value);l.tune&&(k=l.tune(k));l.accept&&(k=k.flatten(function(d){if(l.accept(d))return[d];p.error();return[]}));l.adapt&&(k=k.map(l.adapt));this.event["inlet/update"]=k.onValue(function(){});this.events=z(d,this.event,"inlet",this)}function g(d,k,b,f,a){this.type=d||"core/any";this.id=y();var g=v(D[this.type],this);g||A("Channel type "+this.type+" is not registered!");this.def=g;(this.alias=b||g.alias||f)||A("Outlet should have either alias or name");
this.name=f||this.alias||g.name||d;this.node=k;this.default=m(a)?a:g.default;this.value=c.pool();this.render=e(C[this.type],this);d={"outlet/update":["value"],"outlet/connect":["link","inlet"],"outlet/disconnect":["link"]};this.event=u(d);k=this.event["outlet/update"].merge(this.value);this.event["outlet/update"]=k.onValue(function(d){});this.events=z(d,this.event,"outlet",this);var t=this;c.combine([this.event["outlet/connect"]],[this.event["outlet/update"]]).onValue(function(d){t.value.plug(c.constant(d[1]))})}
function h(d,k,e){this.id=y();this.name=e||"";this.outlet=d;this.inlet=k;this.value=c.emitter();var b=this;this.receiver=d.node.id!==k.node.id?function(d){b.pass(d)}:function(d){setTimeout(function(){b.pass(d)},0)};d={"link/enable":[],"link/disable":[],"link/pass":["value"]};this.event=u(d);e=this.event["link/pass"].merge(this.value);this.event["link/pass"]=e.onValue(function(d){});this.events=z(d,this.event,"link",this);this.enabled=c.merge([this.event["link/disable"].map(a(!1)),this.event["link/enable"].map(a(!0))]).toProperty(a(!0));
this.event["link/pass"].filterBy(this.enabled).onValue(function(d){k.receive(d)});c.combine([this.event["link/enable"]],[this.event["link/pass"]]).onValue(function(d){b.pass(d[1])})}function q(d){for(var k={},e=Object.keys(d),b=0,f=e.length;b<f;b++)k[e[b]]=d[e[b]];return k}function m(d){return"undefined"!==typeof d}function v(d,k){return d?"function"===typeof d?d(k):d:null}function e(d,k){if(!d)return{};var e={},b;for(b in d)e[b]=v(d[b],k);return e}function u(d){var k={};d=Object.keys(d);for(var e=
0,b;e<d.length;e++)b=d[e],k[b]=c.emitter();return k}function t(d,k){if(0===k.length)return function(){return{type:d}};if(1===k.length)return function(e){var b={};b.type=d;b[k[0]]=e;return b};if(1<k.length)return function(k){k=q(k);k.type=d;return k}}function z(d,k,e,b){for(var f=c.pool(),a=Object.keys(d),g=0;g<a.length;g++)f.plug(k[a[g]].map(t(a[g],d[a[g]])).map(function(d){d[e]=b;return d}));return f}function A(d,k){throw k||Error(d);}function y(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}
function w(d,k){var e=d.type;if("patch/add-node"===e||"node/process"===e)d.render=d.node.render[k]||{};else if("node/add-inlet"===e||"inlet/update"===e)d.render=d.inlet.render[k]||{};else if("node/add-outlet"===e||"outlet/update"===e)d.render=d.outlet.render[k]||{};return d}(function(){c.emitter=function(){var d,k=c.stream(function(k){d=k;return function(){d=void 0}});k.emit=function(k){d&&d.emit(k);return this};k.error=function(k){d&&d.error(k);return this};k.end=function(){d&&d.end();return this};
k.emitEvent=function(k){d&&d.emitEvent(k);return this};return k.setName("emitter")}})();var r={},D={},B={},C={},I={},E={},H={},J={"network/add-patch":["patch"]},F=u(J),x=z(J,F,"network",f);F["network/add-patch"].onValue(function(d){x.plug(d.events)});var G=c.emitter();b.prototype.render=function(d,k,e){d=Array.isArray(d)?d:[d];k=Array.isArray(k)?k:[k];for(var b=0,f=d.length,a;b<f;b++)for(var c=0,g=k.length,t;c<g;c++){a=d[b];t=k[c];if(!H[a])throw Error("Renderer "+a+" is not registered");this.renderQueue.emit({alias:a,
target:t,config:e})}return this};b.prototype.addNode=function(d,k){var e=this;return new p(d,this,k,function(d){e.events.plug(d.events);e.event["patch/add-node"].emit(d);d.turnOn()})};b.prototype.removeNode=function(d){d.turnOff();this.event["patch/remove-node"].emit(d);this.events.unplug(d.events)};b.prototype.enter=function(){this.event["patch/enter"].emit();return this};b.prototype.exit=function(){this.event["patch/exit"].emit();return this};b.prototype.inputs=function(d){this.event["patch/set-inputs"].emit(d)};
b.prototype.outputs=function(d){this.event["patch/set-outputs"].emit(d)};b.prototype.project=function(d){this.projections.emit(d)};p.prototype.turnOn=function(){this.event["node/turn-on"].emit()};p.prototype.turnOff=function(){this.event["node/turn-off"].emit()};p.prototype.addInlet=function(d,k,e,b,f,a,c){d=new l(d,this,k,e,b,f,a,c);this.events.plug(d.events);this.event["node/add-inlet"].emit(d);d.toDefault();return d};p.prototype.addOutlet=function(d,k,e,b){d=new g(d,this,k,e,b);this.events.plug(d.events);
this.event["node/add-outlet"].emit(d);d.toDefault();return d};p.prototype.removeInlet=function(d){this.event["node/remove-inlet"].emit(d);this.events.unplug(d.events)};p.prototype.removeOutlet=function(d){this.event["node/remove-outlet"].emit(d);this.events.unplug(d.events)};p.prototype.move=function(d,k){this.event["node/move"].emit([d,k]);return this};l.prototype.receive=function(d){this.value.plug(c.constant(d))};l.prototype.stream=function(d){this.value.plug(d)};l.prototype.toDefault=function(){m(this.default)&&
(this.default instanceof c.Stream?this.stream(this.default):this.receive(this.default))};l.prototype.allows=function(d){if(d.type===this.type)return!0;if(!this.def.allow&&d.type!==this.type)return!1;if(this.def.allow){var k=!1;this.def.allow.forEach(function(e){d.type===e&&(k=!0)});return k}return!0};g.prototype.connect=function(d){if(!d.allows(this))throw Error("Outlet of type "+this.type+" is not allowed to connect to inlet of type "+d.type);var k=new h(this,d);this.events.plug(k.events);this.value.onValue(k.receiver);
this.event["outlet/connect"].emit({link:k,inlet:d});return k};g.prototype.disconnect=function(d){this.event["outlet/disconnect"].emit(d);this.value.offValue(d.receiver);this.events.unplug(d.events);return this};g.prototype.send=function(d){this.value.plug(c.constant(d))};g.prototype.stream=function(d){this.value.plug(d)};g.prototype.toDefault=function(){m(this.default)&&(this.default instanceof c.Stream?this.stream(this.default):this.send(this.default))};h.prototype.pass=function(d){this.value.emit(d)};
h.prototype.enable=function(){this.event["link/enable"].emit()};h.prototype.disable=function(){this.event["link/disable"].emit()};h.prototype.disconnect=function(){this.outlet.disconnect(this)};return{VERSION:"v2.0",_:{Patch:b,Node:p,Inlet:l,Outlet:g,Link:h},unit:a,not:function(d){return!d},event:F,events:x,addPatch:function(d){d=new b(d);F["network/add-patch"].emit(d);return d},render:function(d,k,e){G.emit([d,k,e]);var b=function(b){b.render(d,k,e)};F["network/add-patch"].onValue(b);return function(){F["network/add-patch"].offValue(b)}},
nodetype:function(d,k){r[d]=k||{}},channeltype:function(d,k){D[d]=k||{}},nodedescription:function(d,k){I[d]=k},renderer:function(d,k){H[d]=k},styles:E,style:function(d,k,e){E[d]||(E[d]={});E[d][k]=e},noderenderer:function(d,k,e){if(!r[d])throw Error("Node type "+d+" is not registered");B[d]||(B[d]={});B[d][k]=e},channelrenderer:function(d,k,e){if(!D[d])throw Error("Channel type "+d+" is not registered");C[d]||(C[d]={});C[d][k]=e},"import":{},"export":{},allNodeTypes:r,allNodeDescriptions:I,getStyle:function(d,
k){if(!d)throw Error("Unknown style requested: "+d);if(!E[d])throw Error("Style '"+d+"' is not registered");var e=E[d][k];if(!e)throw Error("Style '"+d+"' has no definition for '"+k+"' renderer");return e},short_uid:y}}();"function"===typeof define&&define.amd?(define([],function(){return f}),a.Rpd=f):"object"===typeof module&&"object"===typeof exports?(module.exports=f,f.Rpd=f):a.Rpd=f})(this);var d3_tiny=function(){function a(f,a,b){for(var c="function"===typeof a?a:function(){return a},l=f.selection,g=0,h=l.length;g<h;g++)b(l[g],c.bind(l[g])(g));return f}function c(f,a,b){a=a||document;selection="string"===typeof f?b?Array.prototype.slice.call(a.querySelectorAll(f),0):[a.querySelector(f)]:f instanceof Node?[f]:Array.isArray(f)?f:[f];this.namespace=1===selection.length&&selection[0]?selection[0].namespaceURI:null;this.selection=selection}c.prototype.empty=function(){return 1===this.selection.length&&
!this.selection[0]||!this.selection.length?!0:!1};c.prototype.attr=function(f,c){return"undefined"===typeof c&&1===this.selection.length?this.selection[0].getAttribute(f):a(this,c,function(b,a){b.setAttributeNS(null,f,a)})};c.prototype.property=function(f,c){return"undefined"===typeof c&&1===this.selection.length?this.selection[0][f]:a(this,c,function(b,a){b[f]=a})};c.prototype.style=function(f,c){"-"===f[0]&&(f=f.slice(1));f=f.replace(/-([a-z])/g,function(b){return b[1].toUpperCase()});return a(this,
c,function(b,a){b.style[f]=a})};c.prototype.text=function(f){return"undefined"===typeof f&&1===this.selection.length?this.selection[0].textContent||this.selection[0].innerText:a(this,f,function(a,b){a.innerText=a.textContent=b})};c.prototype.classed=function(f,c){return"object"===typeof f?a(this,Object.keys(f),function(b,a){for(var c=0,g=a.length;c<g;c++)b.classList.toggle(a[c],f[a[c]])}):a(this,c,function(b,a){b.classList.toggle(f,a)})};c.prototype.select=function(a){return new c(a,this.selection[0])};
c.prototype.selectAll=function(a){return new c(a,this.selection[0],!0)};c.prototype.append=function(f){var n=[];a(this,"string"===typeof f?document.createElementNS(this.namespace,f):f,function(b,a){b.appendChild(a);n.push(a)});return new c(n)};c.prototype.remove=function(){return a(this,function(){return null},function(a){a.parentElement.removeChild(a)})};c.prototype.node=function(a){return this.selection[a||0]};c.prototype.on=function(c,n){return a(this,function(){return n},function(b,a){b.addEventListener(c,
a)})};c.prototype.data=function(c){return c?a(this,c,function(a,b){a.__data__=b}):this.node().__data__};c.prototype.call=function(a){a(this);return this};return{ns:{prefix:{svg:"http://www.w3.org/2000/svg",html:"http://www.w3.org/1999/xhtml"}},select:function(a,n){return new c(a,n)},selectAll:function(a,n){return new c(a,n,!0)}}}();Rpd.Render=function(){function a(e){this.currentPatch=null;this.getPatchByHash=e;var a=this;Kefir.fromEvents(window,"hashchange").map(function(){return window.location.hash?window.location.hash.slice(1):null}).filter(function(e){return!(a.currentPatch&&e===a.currentPatch.id)}).map(a.getPatchByHash).filter(function(e){return null!=e}).onValue(function(e){a.currentPatch&&a.currentPatch.exit();e.enter()})}function c(e){this.nodeRects=[];this.edgePadding=e.edgePadding||{horizontal:30,vertical:20};this.boxPadding=
e.boxPadding||{horizontal:20,vertical:30}}function f(e,a){this.root=e;this.style=a}function n(e,a){this.link=e;this.style=a;this.element=this.styledLink=null}function b(){this.vlinks=[]}function p(e){e.stopPropagation();return e}function l(e){return{x:e.clientX,y:e.clientY}}function g(e,a,b,c){Kefir.fromEvents(e,"click").map(p).map(h(c||!1)).scan(Rpd.not).onValue(function(e){e?a():b()})}var h=Rpd.unit,q=d3_tiny||q;a.prototype.switch=function(e){e&&(this.currentPatch=e,0<=document.title.indexOf("\u2014")?
document.title=document.title.replace(/\u2014.+$/,"\u2014 "+e.name||"[Unnamed]"):document.title+=" \u2014 "+e.name||"[Unnamed]",window.location.hash=e.id)};c.DEFAULT_LIMITS=[1E3,1E3];c.prototype.nextPosition=function(e,a,b){b=b||c.DEFAULT_LIMITS;e=this.nodeRects;var g=this.boxPadding,f=this.edgePadding,l=a.width;a=a.height;var h=e.length?e[e.length-1]:null,h={x:h?h.x:f.horizontal,y:h?h.y+h.height+g.vertical:f.vertical,width:l,height:a};h.y+a+f.vertical>b.height&&(h.x=h.x+l+g.horizontal,h.y=f.vertical);
e.push(h);return{x:h.x,y:h.y}};f.prototype.add=function(e,a){var b=this.root,c=this.style,g=a.start,f=a.end,h=a.drag;Kefir.fromEvents(e.node(),"mousedown").map(l).map(c.getLocalPos).flatMap(function(a){var h=g(),m=a.x-h.x,u=a.y-h.y;a=Kefir.fromEvents(b.node(),"mousemove").map(p).takeUntilBy(Kefir.merge([Kefir.fromEvents(b.node(),"mouseup"),Kefir.fromEvents(e.node(),"mouseup")])).map(l).map(c.getLocalPos).map(function(e){return{x:e.x-m,y:e.y-u}}).toProperty(function(){return h});a.last().onValue(f);
return a}).onValue(h)};n.prototype.construct=function(e){if(this.styledLink)throw Error("VLink is already constructed");this.styledLink=e=this.style.createLink(this.link);this.element=q.select(e.element);return this};n.prototype.rotate=function(e,a,b,c){this.styledLink.rotate(e,a,b,c);return this};n.prototype.rotateI=function(e,a,b){var c=this.style,c=c.getLocalPos(c.getInletPos(b));return this.rotate(e,a,c.x,b.y)};n.prototype.rotateO=function(e,a,b){var c=this.style;e=c.getLocalPos(c.getOutletPos(e));
return this.rotate(e.x,e.y,a,b)};n.prototype.rotateOI=function(e,a){var b=this.style,c=b.getLocalPos(b.getOutletPos(e)),b=b.getLocalPos(b.getInletPos(a));return this.rotate(c.x,c.y,b.x,b.y)};n.prototype.update=function(){if(this.link){var e=this.link;this.rotateOI(e.outlet,e.inlet);return this}};n.prototype.appendTo=function(e){e.append(this.element.node());return this};n.prototype.removeFrom=function(e){this.element.remove();return this};n.prototype.noPointerEvents=function(){this.styledLink.noPointerEvents&&
this.styledLink.noPointerEvents();return this};n.prototype.listenForClicks=function(){var e=this.link;g(this.element.node(),function(){e.enable()},function(){e.disable()});return this};n.prototype.enable=function(){this.element.classed("rpd-disabled",!1)};n.prototype.disable=function(){this.element.classed("rpd-disabled",!0)};n.prototype.get=function(){return this.link};n.prototype.getElement=function(){return this.element.node()};b.prototype.clear=function(){this.vlinks=[]};b.prototype.add=function(e){this.vlinks.push(e);
return e};b.prototype.remove=function(e){this.vlinks=this.vlinks.filter(function(a){return a!==e})};b.prototype.forEach=function(e){this.vlinks.forEach(e)};b.prototype.updateAll=function(){this.forEach(function(e){e.update()})};b.prototype.count=function(){return this.vlinks.length};b.prototype.getLast=function(){return this.count()?this.vlinks[this.vlinks.length-1]:null};var m=function(){var e={};return function(a,b,c){b.classed("rpd-error",!0);e[a]&&clearTimeout(e[a]);e[a]=setTimeout(function(){b.classed("rpd-error",
!1);e[a]=null},c||1)}}(),v=function(){var e={};return function(a,b,c){b.classed("rpd-stale",!1);b.classed("rpd-fresh",!0);e[a]&&clearTimeout(e[a]);e[a]=setTimeout(function(){b.classed("rpd-fresh",!1);b.classed("rpd-stale",!0);e[a]=null},c||1)}}();return{Navigation:a,Placing:c,DragAndDrop:f,VLink:n,VLinks:b,mergeConfig:function(e,a){if(e){var b={};Object.keys(a).forEach(function(e){b[e]=a[e]});Object.keys(e).forEach(function(a){b[a]=e[a]});return b}return a},preventDefault:function(a){a.preventDefault();
return a},stopPropagation:p,extractPos:l,addTarget:function(a){return function(b){return{pos:b,target:a}}},addClickSwitch:g,addValueErrorEffect:m,addValueUpdateEffect:v,subscribeUpdates:function(a,b){b&&Object.keys(b).forEach(function(c){(function(b,c){a.event["node/add-inlet"].filter(function(a){return a.alias===c}).onValue(function(c){a.event["node/is-ready"].onValue(function(){b.default&&c.receive(b.default());if(b.valueOut)b.valueOut.onValue(function(a){c.receive(a)})})})})(b[c],c)})}}}();Rpd.style("realpd","svg",function(){function a(a){return document.createElementNS(f.ns.prefix.svg,a)}function c(a){a=a.getBoundingClientRect();return{x:a.left,y:a.top}}var f=f||d3_tiny;return function(n){function b(a){var b=h[a.id],c=b.length;if(!(1>=c)){var f=g[a.id].node().getBBox().width;b.forEach(function(a,b){m[a.id].attr("transform","translate("+(f/(c-1)*b-7/(c-1)*b)+",0)")})}}function p(a){var b=q[a.id],c=b.length;if(!(1>=c)){var f=g[a.id].node().getBBox().width;b.forEach(function(a,b){v[a.id].attr("transform",
"translate("+(f/(c-1)*b-7/(c-1)*b)+",0)")})}}var l,g={},h={},q={},m={},v={};return{createRoot:function(b,c){return{element:f.select(a("g")).classed("rpd-patch",!0).node()}},createNode:function(b,c,l){c=c.size?{width:c.size.width||50,height:c.size.height||18}:{width:18,height:18};l=f.select(a("g")).attr("class","rpd-node");l.classed("rpd-"+b.type.slice(0,b.type.indexOf("/"))+"-toolkit-node",!0).classed("rpd-"+b.type.replace("/","-"),!0);var m=0===b.type.indexOf("pd/");m||l.append("rect").classed("rpd-background").classed("rpd-drag-handle",
!0).attr("width",c.width).attr("height",c.height);l.append("g").classed("rpd-process",!0).classed("rpd-drag-handle",m);l.append("g").classed("rpd-inlets",!0);l.append("g").classed("rpd-outlets",!0).attr("transform","translate(0,16)");g[b.id]=l.select(".rpd-process");h[b.id]=[];q[b.id]=[];return{element:l.node(),size:c}},createInlet:function(e,c){var g=f.select(a("g")).attr("class","rpd-inlet");g.append("g").attr("class","rpd-connector").append("rect").attr("width",7).attr("height",2);m[e.id]=g;h[e.node.id].push(e);
b(e.node);return{element:g.node()}},createOutlet:function(b,c){var g=f.select(a("g")).attr("class","rpd-outlet");g.append("g").attr("class","rpd-connector").append("rect").attr("width",7).attr("height",2);v[b.id]=g;q[b.node.id].push(b);p(b.node);return{element:g.node()}},createLink:function(b){var c=f.select(a("line")).attr("class","rpd-link");return{element:c.node(),rotate:function(a,b,e,g){c.attr("x1",a).attr("y1",b).attr("x2",e).attr("y2",g)},noPointerEvents:function(){c.style("pointer-events",
"none")}}},getInletPos:function(a){a=c(m[a.id].select(".rpd-connector").node());return{x:a.x+3,y:a.y+1}},getOutletPos:function(a){a=c(v[a.id].select(".rpd-connector").node());return{x:a.x+3,y:a.y+1}},getLocalPos:function(a){if(!l)return a;var b=c(l.node());return{x:a.x-b.x,y:a.y-b.y}},onPatchSwitch:function(a,b){l=f.select(b)},onInletRemove:function(a){var b=a.node.id;h[b]=h[b].filter(function(b){return b.id!==a.id})},onOutletRemove:function(a){var b=a.node.id;q[b]=q[b].filter(function(b){return b.id!==
a.id})}}}}());(function(){function a(a){return document.createElementNS(l.ns.prefix.svg,a)}function c(b){return function(c,f){var w=z(f,p),r=Rpd.getStyle(w.style,"svg")(w);c=l.select(c).classed("rpd-network",!0);var x,G,d;return{"patch/is-ready":function(k){var f=l.select(document.documentElement);x=l.select(a("svg")).attr("width",f.property("clientWidth")).attr("height",f.property("clientHeight"));x.append("rect").attr("class","rpd-background").attr("width",f.property("clientWidth")).attr("height",f.property("clientHeight"));
var m=x.append(r.createRoot(b,c).element).classed("rpd-style-"+w.style,!0).classed("rpd-values-"+(w.valuesOnHover?"on-hover":"always-shown"),!0).classed("rpd-show-boxes",w.showBoxes).data(k.patch);h.patches[b.id]=x.data({root:m,width:f.property("clientWidth"),height:f.property("clientHeight"),patch:k.patch});h.patchToPlacing[b.id]=new g.Placing(r);h.patchToLinks[b.id]=new t;G=new e(x,r,w);w.nodeMovingAllowed&&(d=new g.DragAndDrop(x,r));Kefir.fromEvents(x.node(),"selectstart").onValue(A);Kefir.fromEvents(window,
"resize").map(function(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}).onValue(function(a){x.attr("height",a);x.data().height=a})},"patch/enter":function(a){m=a.patch;q.switch(a.patch);var b=h.patches[a.patch.id];c.append(b.node());h.patchToLinks[a.patch.id].updateAll();if(r.onPatchSwitch)r.onPatchSwitch(m,b.node())},"patch/exit":function(a){m=null;x.remove()},"patch/refer":function(d){var c=h.nodes[d.node.id];c.select(".rpd-node").classed("rpd-patch-reference",
!0);c.data().processTarget.append(a("text")).text("["+(d.target.name||d.target.id)+"]");Kefir.fromEvents(c.data().processTarget.node(),"click").onValue(function(a,b){return function(){a.exit();b.enter()}}(b,d.target))},"patch/add-node":function(k){var c=k.node,e=k.render;k=h.patchToPlacing[k.patch.id];var f=h.patches[m.id].data(),g=l.select(a("g")).attr("class","rpd-node-box"),q=r.createNode(c,e,v[c.type]),p=g.append(q.element);h.nodes[c.id]=g.data({inletsTarget:p.select(".rpd-inlets"),outletsTarget:p.select(".rpd-outlets"),
processTarget:p.select(".rpd-process"),position:n,size:q.size});var n=k.nextPosition(c,q.size,{width:f.width,height:f.height});c.move(n.x,n.y);var x=new t;h.nodeToLinks[c.id]=x;if(w.nodeMovingAllowed){var u=p.select(".rpd-shadow"),n=p.select(".rpd-drag-handle");n.empty()||d.add(n,{start:function(){p.classed("rpd-dragging",!0);u.empty()||u.attr("x",7).attr("y",8);return g.data().position},drag:function(a){g.attr("transform","translate("+a.x+","+a.y+")");x.forEach(function(a){a.update()})},end:function(a){c.move(a.x,
a.y);u.empty()||u.attr("x",5).attr("y",6);p.classed("rpd-dragging",!1)}})}e.prepare&&e.prepare.bind(c)(h.patches[b.id].node(),h.patches[m.id].node());e.first&&C(c,e.first.bind(c)(p.select(".rpd-process").node()));if(e.always)c.event["node/process"].throttle(100).onValue(function(){x.updateAll()});if(!p.select(".rpd-remove-button").empty())Kefir.fromEvents(p.select(".rpd-remove-button path").node(),"click").map(y).onValue(function(){b.removeNode(c)});h.patches[c.patch.id].data().root.append(g.node())},
"patch/remove-node":function(a){a=a.node;var b=h.nodes[a.id];h.nodeToLinks[a.id].forEach(function(a){a.get().disconnect()});b.remove();if(r.onNodeRemove)r.onNodeRemove(a);h.nodes[a.id]=null;h.nodeToLinks[a.id]=null},"node/move":function(a){var b=h.nodes[a.node.id];a=a.position;b.attr("transform","translate("+Math.floor(a[0])+","+Math.floor(a[1])+")");b.data().position={x:a[0],y:a[1]}},"node/process":function(a){var b=a.node,d=a.render;if(d.always){var c=h.nodes[b.id].data().processTarget.node();d.always.bind(b)(c,
a.inlets,a.outlets)}},"node/add-inlet":function(b){var d=b.inlet;if(!d.hidden){var c=h.nodes[b.node.id].data().inletsTarget;b=b.render;var e;e=l.select(r.createInlet(d,b).element);e.classed("rpd-"+d.type.replace("/","-"),!0);e.classed({"rpd-stale":!0,"rpd-readonly":d.readonly,"rpd-cold":d.cold});var g=null;!d.readonly&&b.edit&&(g=new n(d,b,x,e.select(".rpd-value-holder"),e.select(".rpd-value"),l.select(a("g"))),e.select(".rpd-value-holder").append(g.editorElm.node()));h.inlets[d.id]=e.data({connector:e.select(".rpd-connector"),
value:e.select(".rpd-value"),vlinks:new t,editor:g});d.event["inlet/update"].onError(function(){D(d.id,e,w.effectTime)});G.subscribeInlet(d,e.select(".rpd-connector"));c.append(e.node())}},"node/add-outlet":function(a){var b=a.outlet,d=h.nodes[a.node.id].data().outletsTarget;a=l.select(r.createOutlet(b,a.render).element);a.classed("rpd-"+b.type.replace("/","-"),!0);a.classed("rpd-stale",!0);h.outlets[b.id]=a.data({connector:a.select(".rpd-connector"),value:a.select(".rpd-value"),vlinks:new t});G.subscribeOutlet(b,
a.select(".rpd-connector"));d.append(a.node())},"node/remove-inlet":function(a){a=a.inlet;h.inlets[a.id].data().vlinks.forEach(function(a){a.get().disconnect()});h.inlets[a.id].remove();if(r.onInletRemove)r.onInletRemove(a);h.inlets[a.id]=null},"node/remove-outlet":function(a){a=a.outlet;h.outlets[a.id].data().vlinks.forEach(function(a){a.get().disconnect()});h.outlets[a.id].remove();if(r.onOutletRemove)r.onOutletRemove(a);h.outlets[a.id]=null},"inlet/update":function(a){var b=a.inlet;if(!b.hidden){var d=
a.render,c=h.inlets[b.id],e=c.data().value;if(!e.empty()){var g=b.def.show?b.def.show(a.value):a.value;d.show?d.show.bind(b)(e.node(),a.value,g):e.text(g)}B(b.id,c,w.effectTime)}},"outlet/update":function(a){var b=a.outlet,d=a.render,c=h.outlets[b.id],e=c.data().value;if(!e.empty()){var g=b.def.show?b.def.show(a.value):a.value;d.show?d.show.bind(b)(e.node(),a.value,g):e.text(g)}B(b.id,c,w.effectTime)},"outlet/connect":function(a){a=a.link;var d=a.outlet,c=a.inlet,e=h.inlets[c.id],g=h.outlets[d.id].data(),
e=e.data();if(!w.inletAcceptsMultipleLinks&&1===e.vlinks.count())throw Error("Inlet is already connected to a link");e.editor&&e.editor.disable();var f=new u(a,r);f.construct(w.linkWidth).rotateOI(d,c);l.select(f.getElement()).classed("rpd-"+c.type.replace("/","-"),!0).classed("rpd-"+d.type.replace("/","-"),!0);h.links[a.id]=f;g.vlinks.add(f);e.vlinks.add(f);h.nodeToLinks[d.node.id].add(f);d.node.id!==c.node.id&&h.nodeToLinks[c.node.id].add(f);h.patchToLinks[b.id].add(f);f.listenForClicks();f.appendTo(x)},
"outlet/disconnect":function(a){a=a.link;var d=h.links[a.id],c=a.outlet,e=a.inlet,g=h.outlets[c.id].data(),f=h.inlets[e.id].data();h.links[a.id]=null;g.vlinks.remove(d);f.vlinks.remove(d);h.nodeToLinks[c.node.id].remove(d);c.node.id!==e.node.id&&h.nodeToLinks[e.node.id].remove(d);h.patchToLinks[b.id].remove(d);d.removeFrom(x)},"link/enable":function(a){var b=h.inlets[a.link.inlet.id].data();b.editor&&b.editor.disable();h.links[a.link.id].enable()},"link/disable":function(a){h.links[a.link.id].disable()}}}}
function f(a,c){return Kefir.merge([a.map(b(!0)),c.map(b(!1))]).toProperty(b(!1))}function n(a,c,e,g,f,l){var m=Kefir.emitter(),d=Kefir.emitter();this.disableEditor=d;this.editorElm=l;this.valueElm=f;l.classed("rpd-value-editor",!0);c.edit.bind(a)(l.node(),a,m).onValue(function(b){a.receive(b)});Kefir.combine([Kefir.merge([Kefir.fromEvents(g.node(),"click").map(y).map(b(!0)),Kefir.fromEvents(e.node(),"click").merge(d).map(b(!1))]).toProperty(b(!1)).skipDuplicates()],[a.event["inlet/update"]]).map(function(a){return{lastValue:a[1],
startEditing:a[0],cancelEditing:!a[0]}}).onValue(function(b){if(b.startEditing){var d=h.inlets[a.id].data();d.link&&d.link.disable();m.emit(b.lastValue);g.classed("rpd-editor-enabled",!0)}else b.cancelEditing&&(f.classed("rpd-edited",!0),g.classed("rpd-editor-enabled",!1))});g.classed("rpd-editor-disabled",!0)}var b=Rpd.unit,p={style:"quartz",valuesOnHover:!1,showBoxes:!1,nodeMovingAllowed:!0,renderNodeList:!0,nodeListCollapsed:!0,inletAcceptsMultipleLinks:!1,effectTime:1E3},l=l||d3_tiny,g=Rpd.Render,
h={patches:{},nodes:{},inlets:{},outlets:{},links:{},patchToPlacing:{},patchToLinks:{},nodeToLinks:{}},q=new g.Navigation(function(a){return function(b){return a.patches[b].data().patch}}(h)),m,v=Rpd.allNodeDescriptions,e=function(){function a(b){return h.inlets[b.id].data().vlinks}function c(b){return function(){return 0<a(b).count()}}function e(a){1===a.count()&&(a=a.getLast().link,a.outlet.disconnect(a))}function g(a,b){a.forEach(function(a){a.link.outlet.id===b.id&&b.disconnect(a.link)})}function m(a,
b,d){this.root=a;this.style=b;this.config=d;this.rootClicks=Kefir.fromEvents(this.root.node(),"click");this.inletClicks=Kefir.pool();this.outletClicks=Kefir.pool();this.startLink=Kefir.emitter();this.finishLink=Kefir.emitter();this.doingLink=f(this.startLink,this.finishLink)}m.prototype.subscribeOutlet=function(c,h){var d=this.root,k=this.style,m=this.config,p=this.rootClicks,q=this.outletClicks,n=this.inletClicks,v=this.startLink,t=this.finishLink,z=this.doingLink;q.plug(Kefir.fromEvents(h.node(),
"click").map(w).map(r(c)));Kefir.fromEvents(h.node(),"click").map(y).filterBy(f(q,z)).map(w).onValue(function(f){v.emit();var h=(new u(null,k)).construct(m.linkWidth).rotateO(c,f.x,f.y).noPointerEvents().appendTo(d);l.select(h.getElement()).classed("rpd-"+c.type.replace("/","-"),!0);Kefir.fromEvents(d.node(),"mousemove").takeUntilBy(Kefir.merge([n,q.map(b(!1)),p.map(b(!1))]).take(1).onValue(function(b){if(b){b=b.target;var d=a(b);m.inletAcceptsMultipleLinks?g(d,c):e(d);c.connect(b)}})).map(w).map(k.getLocalPos).onValue(function(a){h.rotateO(c,
a.x,a.y)}).onEnd(function(){h.removeFrom(d);t.emit()})})};m.prototype.subscribeInlet=function(h,m){var d=this.root,k=this.style,p=this.config,q=this.rootClicks,n=this.outletClicks,v=this.inletClicks,t=this.startLink,z=this.finishLink,A=this.doingLink;v.plug(Kefir.fromEvents(m.node(),"click").map(w).map(r(h)));Kefir.fromEvents(m.node(),"click").map(y).filterBy(f(v,A)).filter(c(h)).onValue(function(c){var f=a(h).getLast().link,m=f.outlet;m.disconnect(f);t.emit();var r=(new u(null,k)).construct(p.linkWidth).rotateO(m,
c.x,c.y).noPointerEvents().appendTo(d);l.select(r.getElement()).classed("rpd-"+h.type.replace("/","-"),!0).classed("rpd-"+m.type.replace("/","-"),!0);Kefir.fromEvents(d.node(),"mousemove").takeUntilBy(Kefir.merge([v,n.map(b(!1)),q.map(b(!1))]).take(1).onValue(function(b){if(b){b=b.target;var d=a(b);p.inletAcceptsMultipleLinks?g(d,m):e(d);m.connect(b)}})).map(w).map(k.getLocalPos).onValue(function(a){r.rotateO(m,a.x,a.y)}).onEnd(function(){r.removeFrom(d);z.emit()})})};return m}();n.prototype.disable=
function(){this.valueElm.classed("rpd-edited",!1);this.disableEditor.emit()};var u=g.VLink,t=g.VLinks,z=g.mergeConfig,A=g.preventDefault,y=g.stopPropagation,w=g.extractPos,r=g.addTarget,D=g.addValueErrorEffect,B=g.addValueUpdateEffect,C=g.subscribeUpdates;Rpd.SvgRenderer=c;Rpd.renderer("svg",c)})();function getKey(a){return a.which||a.keyCode}function isKey(a,c){return getKey(a)===c}function isAltAnd(a,c){return a.altKey&&isKey(a,c)}function isAltShiftAnd(a,c){return a.shiftKey&&isAltAnd(a,c)}
var PdView=function(){function a(a,c){this.root=c;this.inEditMode=u.map(b(!0)).scan(Rpd.not,!1).toProperty(b(!1));g=n.select(document.createElement("input")).attr("type","text").attr("class","rpd-pd-text-editor").style("width","300px").style("height",a.height+1+"px").node();var e=this;document.addEventListener("DOMContentLoaded",function(){e.root||(e.root=document.body);n.select(e.root).append(n.select(g).style("display","none").style("position","absolute").node());Kefir.fromEvents(e.root,"keydown").filter(function(a){return isAltAnd(a,
69)}).onValue(function(){u.emit()});Kefir.fromEvents(e.root,"keydown").filter(function(a){return isAltAnd(a,8)&&m}).onValue(function(){var a=m.node;a&&(a.patch.removeNode(a),q.emit())});Kefir.fromEvents(e.root,"keydown").filter(function(){return PdModel.lastPatch}).map(function(a){return PdModel.getNodeTypeByKey(a)}).filter(function(a){return a}).onValue(function(a){PdModel.lastPatch.addNode(a)})})}function c(a){return{x:a.clientX,y:a.clientY}}function f(a,b,e){this.element=b;this.value=0;var g=this,
f=Kefir.emitter();f.onValue(function(a){g.value=a});Kefir.fromEvents(b,"mousedown").filterBy(e).map(l).map(c).flatMap(function(b){var e=g.value;return Kefir.fromEvents(a,"mousemove").map(c).takeUntilBy(Kefir.fromEvents(a,"mouseup")).map(function(a){return e+(b.y-a.y)}).onValue(function(a){f.emit(a)})}).onEnd(function(){});this.changes=f}var n=n||d3_tiny,b=Rpd.unit,p=Rpd.not,l=Rpd.Render.stopPropagation,g,h=Kefir.emitter(),q=Kefir.emitter(),m=null,v=Kefir.emitter(),e=Kefir.emitter(),u=Kefir.emitter();
a.prototype.addSelection=function(a,b){var c=this.root;Kefir.fromEvents(a,"click").filterBy(this.inEditMode.map(p)).map(l).onValue(function(){v.emit();m&&n.select(m.element).classed("rpd-pd-selected",!1);m={element:a,node:b};n.select(a).classed("rpd-pd-selected",!0);Kefir.fromEvents(c,"click").take(1).onValue(function(){n.select(a).classed("rpd-pd-selected",!1);m=null;e.emit()})})};a.prototype.addEditor=function(a,b,c){var e=this.root,f=n.select(b),m=n.select(g);Kefir.fromEvents(a,"click").filterBy(this.inEditMode.map(p)).map(l).map(function(){return f.text()}).onValue(function(a){h.emit();
var l=b.getBoundingClientRect();m.classed("rpd-pd-selected",!0).style("top",l.top-5+"px").style("left",l.left-1+"px");m.node().value=a||"";g.setSelectionRange(0,g.value.length);f.text("").style("display","none");m.style("display","block").node().focus();Kefir.merge([Kefir.fromEvents(e,"click"),Kefir.fromEvents(g,"keydown").filter(function(a){return isKey(a,13)}),v]).take(1).onValue(function(){var a=m.node().value;g.blur();f.text(a);m.node().value="";m.style("display","none").classed("rpd-pd-selected",
!1);f.style("display","block");q.emit();c&&c(a)})})};a.prototype.addEditModeSwitch=function(a,b){Kefir.fromEvents(a,"click").map(l).onValue(function(){u.emit()});this.inEditMode.onValue(function(a){n.select(b).classed("rpd-pd-enabled",a)})};a.prototype.addNodeAppender=function(a,b,c){Kefir.fromEvents(a,"click").map(l).onValue(function(){c.addNode(b)})};a.prototype.addValueSend=function(a,b,c,e){var f=b.patch.model,g;Kefir.fromEvents(a,"click").filterBy(this.inEditMode).map(l).onValue(function(){g&&
clearTimeout(g);n.select(a).classed("rpd-pd-send-value",!0);g=setTimeout(function(){n.select(a).classed("rpd-pd-send-value",!1)},300);f.sendPdMessageValue(b,e())})};a.prototype.addSpinner=function(a){return new f(this.root,a,this.inEditMode)};a.prototype.measureText=function(a){a=a.node().getBBox();return{width:a.width,height:a.height}};a.EDIT_MODE_KEY_LABEL="\u2325E";a.NODE_TYPE_TO_KEY_LABEL={"pd/object":"\u23251","pd/message":"\u23252","pd/number":"\u23253","pd/symbol":"\u23254","pd/comment":"\u23255",
"pd/bang":"\u2325\u21e7B","pd/toggle":"\u2325\u21e7T"};f.prototype.getChangesStream=function(){return this.changes};return a}(),PdModel=function(){function a(b,f){this.patch=b;this.webPdPatch=f||c.createPatch();this.nodeToInlets={};this.nodeToOutlets={};this.webPdDummy={patch:f};a.lastPatch=b;this._requestResolve=Kefir.emitter();this._alreadyResolved=Kefir.emitter();this._requestApply=Kefir.emitter();this._sendMessage=Kefir.emitter();var l={"pd/request-resolve":this._requestResolve,"pd/is-resolved":null,
"pd/request-apply":this._requestApply,"pd/is-applied":null,"pd/send-message":null},g=this;l["pd/is-resolved"]=this._requestResolve.map(function(a){var b=a.node,f=b.patch,e=a.command;a=a.arguments;var g;try{g=f.webPdPatch.createObject(e,a)}catch(h){h instanceof c.core.errors.UnkownObjectError||console.error(h,e,a)}return{node:b,command:e,arguments:a,webPdObject:g}}).merge(this._alreadyResolved);var h=l["pd/is-resolved"].scan(function(a,b){a[b.node.id]=b;return a},{});l["pd/is-applied"]=h.sampledBy(this._requestApply.map(function(a){return a.node}),
function(a,b){return a[b.id]}).map(function(b){var c=b.node,f=b.webPdObject;if("pd/object"===c.type)g.updatePdObject(c,b.command,b.arguments,f);else if("pd/comment"!==c.type)try{g.connectToWebPd([a.getReceivingInlet(c)],[a.getSendingOutlet(c)],f.inlets,f.outlets,"<"+c.id+"> "+c.type)}catch(e){console.error(e)}"pd/message"===c.type&&g.initPdMessage(c,b.arguments)}).onValue(function(){});l["pd/send-message"]=h.sampledBy(this._sendMessage,function(a,b){return{node:b.node,data:a[b.node.id],message:b.message}}).map(function(a){a.data&&
a.data.webPdObject?a.data.webPdObject.inlets[0].message(a.message):console.error("Message node is not connected to WebPd")}).onValue(function(){});this.events=l}var c=window.Pd||null;if(!c)throw Error("Building PD Model requires WebPd present");a.prototype.listenForNewNodes=function(){var b=a.TYPE_TO_COMMAND,c=this,f=this.patch;f.event["patch/add-node"].onValue(function(a){a.event["node/is-ready"].onValue(function(){"pd/object"!==a.type&&b[a.type]&&(c.requestResolve(a,b[a.type],[]),c.requestApply(a))})});
f.event["patch/remove-node"].onValue(function(a){})};a.prototype.requestResolve=function(a,c,f){this._requestResolve.emit({node:a,command:c,arguments:f})};a.prototype.requestApply=function(a){this._requestApply.emit({node:a})};a.prototype.markResolved=function(a,c,f,g){this._alreadyResolved.emit({node:a,patch:a.patch,command:c,arguments:f,webPdObject:g})};a.prototype.markResolvedAndApply=function(a,c,f,g){this.markResolved(a,c,f,g);this.requestApply(a)};a.prototype.whenResolved=function(a,c){var f=
this;this.events["pd/is-resolved"].filter(function(c){return c.node.id===a.id}).onValue(function(a){c(a)&&f._requestApply.emit({node:a.node})})};a.prototype.switchAudioChannel=function(a,c){Pd._glob.audio&&(Pd._glob.audio.channels[a].gain.value=c?1:0)};a.prototype.isAudioChannelOn=function(a){return Pd._glob.audio?0<Pd._glob.audio.channels[a].gain.value?!0:!1:!1};var f=Pd.core.portlets.DspInlet,n=Pd.core.portlets.DspOutlet;a.prototype.updatePdObject=function(a,c,l,g){l=this.nodeToInlets[a.id];var h=
this.nodeToOutlets[a.id];l&&(l.forEach(function(c){a.removeInlet(c)}),this.nodeToInlets[a.id]=null);h&&(h.forEach(function(c){a.removeOutlet(c)}),this.nodeToOutlets[a.id]=null);if(g){l=g.outlets||{};var q=[],m=[];(g.inlets||{}).forEach(function(c,e){q.push(a.addInlet(c instanceof f?"pd/dsp":"pd/value",e.toString()))});l.forEach(function(c,e){m.push(a.addOutlet(c instanceof n?"pd/dsp":"pd/value",e.toString()))});this.nodeToInlets[a.id]=q.length?q:null;this.nodeToOutlets[a.id]=m.length?m:null;this.connectToWebPd(q,
m,g.inlets,g.outlets,"<"+a.id+"> "+(g.prefix||c||a.type))}};a.prototype.connectToWebPd=function(a,f,l,g){if(a&&!l||a&&a.length!==l.length)throw Error("inlets number not matches to WebPd inlets number");if(f&&!g||f&&f.length!==g.length)throw Error("outlets number not matches to WebPd outlets number");a&&l&&a.forEach(function(a,b){if("pd/dsp"!==a.type){var c=l[b];if(!c)throw Error("Failed to find WebPd inlet corresponding to inlet "+b);a.event["inlet/update"].onValue(function(a){c.message(a.get())})}});
if(f&&g){var h=this.webPdDummy;f.forEach(function(a,b){if("pd/dsp"!==a.type){var f=new c.core.portlets.Inlet(h);f.message=function(b){a.send(PdValue.from(b))};if(g[b])g[b].connect(f);else throw Error("Failed to find WebPd outlet corresponding to outlet "+b);}})}};a.prototype.initPdMessage=function(a,c){a.inlets.init.receive(PdValue.from(c))};a.prototype.sendPdMessageValue=function(a,c){this._sendMessage.emit({node:a,message:c})};a.getReceivingInlet=function(a){return a.inlets.receive};a.getSendingOutlet=
function(a){return a.outlets.send};a.COMMAND_TO_TYPE={obj:"pd/object",msg:"pd/message",floatatom:"pd/number",symbolatom:"pd/symbol",text:"pd/comment",bng:"pd/bang",tgl:"pd/toggle",nbx:null,vsl:null,hsl:null,vradio:null,hradio:null,vu:null,cnv:null,graph:null,array:null};a.TYPE_TO_COMMAND={};Object.keys(a.COMMAND_TO_TYPE).forEach(function(b){var c=a.COMMAND_TO_TYPE[b];c&&(a.TYPE_TO_COMMAND[c]=b)});a.getNodeTypeByKey=function(a){if(a.altKey){if(isAltAnd(a,49))return"pd/object";if(isAltAnd(a,50))return"pd/message";
if(isAltAnd(a,51))return"pd/number";if(isAltAnd(a,52))return"pd/symbol";if(isAltAnd(a,53))return"pd/comment";if(isAltShiftAnd(a,66))return"pd/bang";if(isAltShiftAnd(a,84))return"pd/toggle"}};return a}();
PdValue=function(){function a(a){this.value=a}a.prototype.get=function(){return this.value};a.prototype.getByIndex=function(a){return this.value[a]};a.prototype.isBang=function(){return"bang"===this.value[0]};a.isPdValue=function(c){return c instanceof a};a.from=function(c){return new a(c)};a.extract=function(c){if(!c)return a.from([]);if(Array.isArray(c))return a.from(c);c=c.split(" ");return a.from(c.map(function(a){return Number.isNaN(parseFloat(a))?a:parseFloat(a)}))};a.bang=function(){return new a(["bang"])};
return a}();function nop(){}Rpd.channeltype("pd/value",{accept:function(a){return PdValue.isPdValue(a)}});Rpd.channeltype("pd/dsp",{});Rpd.nodetype("pd/object",function(a){var c;a.patch.model.whenResolved(a,function(a){c=a.definition?a.definition.process:null});return{inlets:{command:{type:"pd/value",hidden:!0}},process:function(){return c?c.apply(this,arguments):null}}});Rpd.nodetype("pd/comment",{inlets:{text:{type:"pd/value",hidden:!0}}});
Rpd.nodetype("pd/number",{inlets:{receive:{type:"pd/value"},spinner:{type:"pd/value",hidden:!0}},outlets:{send:{type:"pd/value"}},process:nop});Rpd.nodetype("pd/symbol",{inlets:{receive:{type:"pd/value"}},outlets:{send:{type:"pd/value"}}});Rpd.nodetype("pd/message",function(){return{inlets:{receive:{type:"pd/value"},init:{type:"pd/value",hidden:!0}},outlets:{send:{type:"pd/value"}},process:nop}});Rpd.nodetype("pd/bang",{inlets:{receive:{type:"pd/value"}},outlets:{send:{type:"pd/value"}},process:nop});
Rpd.nodetype("pd/toggle",{inlets:{receive:{type:"pd/value"}},outlets:{send:{type:"pd/value"}},process:nop});Rpd.nodetype("pd/toolbar",{});Rpd.nodetype("pd/edit-switch",{});Rpd.nodetype("pd/audio-control",{});(function(){function a(a){return document.createElementNS(c.ns.prefix.svg,a)}var c=c||d3_tiny,f={width:50,height:18},n=new PdView(f);Rpd.noderenderer("pd/number","svg",function(b){var p,l,g,h;return{size:f,first:function(q){p=c.select(a("path")).attr("d","M 0,0 h "+(f.width-5)+" l 5 5 v "+(f.height-5)+" h "+-f.width+" v "+-f.height+" z");g=c.select(a("rect")).classed("rpd-pd-handle",!0).attr("x",2).attr("y",2).attr("width",f.height-2).attr("height",Math.floor(.7*f.width));l=c.select(a("text")).attr("x",
2).attr("y",f.height/2).text("0");h=n.addSpinner(g.node());var m=h.getChangesStream();n.addSelection(q,b);c.select(q).call(function(a){a.append(p.node());a.append(l.node());a.append(g.node())});return{receive:{valueOut:m.map(function(a){return PdValue.from([parseFloat(a)])})}}},always:function(a,b){var c=b.receive||b.spinner;c.isBang()||l.text(c.getByIndex(0))}}});Rpd.noderenderer("pd/symbol","svg",function(b){var p,l;return{size:f,first:function(g){p=c.select(a("path")).attr("d","M 0,0 h "+(f.width-
5)+" l 5 5 v "+(f.height-5)+" h "+-f.width+" v "+-f.height+" z");l=c.select(a("text")).attr("x",2).attr("y",f.height/2).text("symbol");n.addSelection(g,b);c.select(g).call(function(a){a.append(p.node());a.append(l.node())})}}});Rpd.noderenderer("pd/message","svg",function(b){var p,l,g,h=!1;return{size:f,first:function(h){p=c.select(a("path")).attr("d","M 0,0 h "+f.width+" l -4 4 v "+(f.height-8)+" l 4 4 h "+-f.width+" v "+-f.height+" z");l=c.select(a("text")).attr("x",2).attr("y",f.height/2);l.text("");
n.addSelection(h,b);n.addEditor(h,l.node(),function(a){g=PdValue.extract(a)});n.addValueSend(h,this,"receive",function(){return g.get()});c.select(h).call(function(a){a.append(p.node());a.append(l.node())})},always:function(a,b){b.init&&!h?(g=b.init,l.text(g.get().join(" ")),h=!0):b.receive&&!b.receive.isBang()&&(g=b.receive)}}});Rpd.noderenderer("pd/comment","svg",function(b){return{size:f,first:function(p){var l=c.select(a("rect")).attr("width",f.width).attr("height",f.height),g=c.select(a("text")).attr("y",
f.height/2).text("comment");n.addSelection(p,b);n.addEditor(p,g.node());c.select(p).call(function(a){a.append(l.node());a.append(g.node())})}}});Rpd.noderenderer("pd/object","svg",function(b){var p=b.patch.model;return{size:f,first:function(l){var g=c.select(a("rect")).classed("rpd-pd-erratic",!0);g.attr("width",f.width).attr("height",f.height);var h=c.select(a("text")).attr("x",2).attr("y",f.height/2);n.addSelection(l,b);n.addEditor(l,h.node(),function(a){a=PdValue.extract(a).get();p.requestResolve(b,
a[0],a.slice(1))});var q;p.whenResolved(b,function(a){var b;a.command&&(b=a.command+(a.arguments.length?" "+a.arguments.join(" "):""));if(!q||b!==q){h.text(b||"");var c=n.measureText(h);g.attr("width",30<c.width?c.width+6:30);g.classed("rpd-pd-erratic",!a.webPdObject||!a.command);q=b;return!0}});c.select(l).call(function(a){a.append(g.node());a.append(h.node())})}}});Rpd.noderenderer("pd/toggle","svg",function(b){var p,l,g={width:f.height,height:f.height},h=PdValue.from([0]),q=Kefir.emitter(),m=!1;
return{size:g,first:function(f){p=c.select(a("rect")).attr("width",g.width).attr("height",g.height);l=c.select(a("g")).classed("rpd-pd-mark",!0).call(function(b){b.append(c.select(a("line")).attr("x1",0).attr("y1",0).attr("x2",g.width).attr("y2",g.height).node());b.append(c.select(a("line")).attr("x1",g.width).attr("y1",0).attr("x2",0).attr("y2",g.height).node())});n.addSelection(f,b);n.addValueSend(p.node(),this,"receive",function(){h=0<h.getByIndex(0)?PdValue.from([0]):PdValue.from([1]);q.emit(h);
return h.get()});l.classed("rpd-pd-enabled",0<h.getByIndex(0));c.select(f).append(l.node());c.select(f).append(p.node());q.emit(h);return{receive:{valueOut:q.toProperty(function(){return PdValue.from([0])})}}},always:function(a,b){var c;b.init&&!m?(c=b.init,m=!0):b.receive&&(c=b.receive);c.isBang()&&(c=0<h.getByIndex(0)?PdValue.from([0]):PdValue.from([1]));h=c;l.classed("rpd-pd-enabled",0<h.getByIndex(0))}}});Rpd.noderenderer("pd/bang","svg",function(b){var p,l,g={width:f.height,height:f.height};
return{size:g,first:function(f){p=c.select(a("rect")).attr("width",g.width).attr("height",g.height);l=c.select(a("circle")).attr("cx",g.width/2).attr("cy",g.width/2).attr("r",g.width/2);n.addSelection(f,b);n.addValueSend(f,this,"receive",function(){return PdValue.bang().get()});c.select(f).call(function(a){a.append(p.node());a.append(l.node())})}}});Rpd.noderenderer("pd/toolbar","svg",function(b){var f=PdModel.COMMAND_TO_TYPE,l=PdView.EDIT_MODE_KEY_LABEL,g=PdView.NODE_TYPE_TO_KEY_LABEL,h={obj:"object",
msg:"message",floatatom:"number",symbolatom:"symbol",text:"comment",bng:"bang",tgl:"toggle",nbx:"number2",vsl:"vslider",hsl:"hslider",vradio:"vradio",hradio:"hradio",vu:"vumeter",cnv:"canvas",graph:"graph",array:"array"};return{size:{width:425,height:70},first:function(q){var m=c.select(a("g")).classed("rpd-pd-toolbar-group",!0);m.append("rect").classed("rpd-pd-toolbar-border",!0).attr("height",70).attr("width",425).attr("rx",5).attr("ry",5);m.append("g").call(function(b){b.attr("transform","translate(12, 35)").classed("rpd-pd-edit-mode",
!0);var e=c.select(a("circle")).attr("r",7),f=c.select(a("circle")).attr("r",5);b.append(e.node());b.append(f.node()).style("pointer-events","none");var f=c.select(a("text")).text("Edit mode").attr("x",10),g=c.select(a("text")).text("("+l+")").attr("x",55).attr("y",1).classed("rpd-pd-key-label",!0);b.append(f.node());b.append(g.node());n.addEditModeSwitch(e.node(),b.node());n.addEditModeSwitch(f.node(),b.node())});m.append("g").call(function(l){l.attr("transform","translate(95, 0)").classed("rpd-pd-buttons",
!0);var e,m;Object.keys(f).forEach(function(q,z){e=81.25*Math.floor(z/4);m=z%4*17.5;var A=h[q],y=f[q],w=y?g[y]:null,r=c.select(a("g")).attr("transform","translate("+e+","+m+")").classed("rpd-pd-accessible",y?!0:!1);r.append("rect").attr("width",81.25).attr("height",17.5);r.append("text").attr("x",10).attr("y",8.75).text(A);w&&r.append("text").attr("x",78.25).attr("y",8.75).text("("+w+")").classed("rpd-pd-key-label",!0);f[q]&&n.addNodeAppender(r.node(),y,b.patch);l.append(r.node())})});c.select(q).append(m.node())}}});
Rpd.noderenderer("pd/edit-switch","svg",function(b){return{first:function(b){var f=c.select(a("g")).classed("rpd-pd-edit-switch-group",!0),g=c.select(a("circle")).attr("r",7),h=c.select(a("circle")).attr("r",5);f.append(g.node());f.append(h.node()).style("pointer-events","none");h=c.select(a("text")).attr("x",10).text("Edit mode");f.append(h.node());n.addEditModeSwitch(g.node(),f.node());n.addEditModeSwitch(h.node(),f.node());c.select(b).append(f.node())}}});Rpd.noderenderer("pd/audio-control","svg",
function(b){var f=b.patch.model;return{first:function(b){var g=c.select(a("text")).classed("rpd-pd-channel",!0);Kefir.fromEvents(g.node(),"click").toProperty(function(){return f.isAudioChannelOn(0)}).scan(function(a,b){return!a}).onValue(function(a){f.switchAudioChannel(0,a);g.classed("rpd-pd-channel-on",a).text("CH0:"+(a?"\u2714":"\u2718"))});c.select(b).append(g.node());c.select(b).append(c.select(a("text")).text("/").attr("x",35).node());var h=c.select(a("text")).attr("x",45).classed("rpd-pd-channel",
!0);Kefir.fromEvents(h.node(),"click").toProperty(function(){return f.isAudioChannelOn(1)}).scan(function(a,b){return!a}).onValue(function(a){f.switchAudioChannel(1,a);h.classed("rpd-pd-channel-on",a).text("CH1:"+(a?"\u2714":"\u2718"))});c.select(b).append(h.node())}}})})();(function(a){Rpd.export.pd=function(a){var f=[];Rpd.events.onValue(function(){});return function(){return f.join("\r\n")}};Rpd.import.pd=function(c){function f(a){e[a.node.id]||(e[a.node.id]=[]);e[a.node.id].push(a.inlet)}function n(a){u[a.node.id]||(u[a.node.id]=[]);u[a.node.id].push(a.outlet)}function b(a){e[a.node.id].pop()}function p(a){u[a.node.id].pop()}function l(a){return function(b){return b.type===a}}var g=a.Pd||null;if(!g)throw Error("WebPd is required to import PD files");c=g.parsePatch(c);
var h=g.loadPatch(c),q=[],m=Rpd.addPatch("PD").enter(),v=new PdModel(m,h);m.model=v;m.webPdPatch=h;var e={},u={},g=m.events.filter(l("node/add-inlet")).filter(function(a){return!a.inlet.hidden}),t=m.events.filter(l("node/add-outlet")),z=m.events.filter(l("node/remove-inlet")),A=m.events.filter(l("node/remove-outlet"));g.onValue(f);t.onValue(n);z.onValue(b);A.onValue(p);var y=PdModel.COMMAND_TO_TYPE;c.nodes.forEach(function(a,b){var c=a.proto,e=m.addNode(y[c]||"pd/object");e.move(a.layout.x,a.layout.y);
v.markResolvedAndApply(e,c,a.args,h.objects[b]);q.push(e)});c.connections.forEach(function(a){var b=a.source.id,c=a.sink.id,f=a.source.port;a=a.sink.port;var g=q[b],h=q[c];u[g.id]&&e[h.id]?(f=u[g.id][f],(a=e[h.id][a])&&f?f.connect(a,"pd/dsp"===f.type?"pd/dsp":"pd/value"):console.error("Failed to connect object "+b+" to object "+c)):console.error("Failed to connect object "+b+" to object "+c)});g.offValue(f);t.offValue(n);z.offValue(b);A.offValue(p);v.listenForNewNodes();return m}})(this);

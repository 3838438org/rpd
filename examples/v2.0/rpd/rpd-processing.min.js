/**
 * rpd - RPD is a minimal framework for building Node-Based User Interfaces, powered by Reactive Programming
 * Built at Sat, 12 Dec 2015 09:19:03 GMT
 *
 * @version v0.2.0
 * @link http://shamansir.github.io/rpd
 * @author Ulric Wilfred <shaman.sir@gmail.com>
 * @license MIT
 * 
 * Selected Renderers: html
 * Selected Styles: quartz
 * Selected Toolkits: core, demo
 * Selected I/O Modules: [None]
 * d3.js or d3_tiny.js: d3_tiny.js
 *
 * User Styles: [None]
 * User Toolkits: [None]
 *
 * Command: gulp --root . --renderer html --style quartz --toolkit core --toolkit demo --target-name rpd-processing --compilation simple
 */
(function(d){var e=d.Kefir;"undefined"===typeof e&&"undefined"!==typeof require&&(e=require("../vendor/kefir.min.js"));if(!e)throw Error("Kefir.js (https://github.com/rpominov/kefir) is required for Rpd to work");var a=function(){function c(b){return function(){return b}}function h(b){this.id=x();this.name=b;var l=this;b={"patch/is-ready":[],"patch/enter":[],"patch/exit":[],"patch/set-inputs":["inputs"],"patch/set-outputs":["outputs"],"patch/project":["node","target"],"patch/refer":["node","target"],
"patch/add-node":["node"],"patch/remove-node":["node"]};this.event=w(b);this.events=v(b,this.event,"patch",this);this.renderQueue=e.emitter();b=e.combine([this.events],[this.renderQueue.scan(function(b,g){var p=g.alias,a=g.target,k=g.config,c=b[p];c||(c={},c.produce=L[p](l),c.handlers=[],b[p]=c);if(c.produce){var I=c.produce(a,k);I&&c.handlers.push("function"===typeof I?I:function(b){if(I[b.type])I[b.type](b)})}return b},{})]);b=b.bufferBy(this.renderQueue).take(1).flatten().concat(b);b.onValue(function(b){var g=
b[0];b=b[1];for(var p=Object.keys(b),l,a=0,k=p.length;a<k;a++){l=b[p[a]];l=l.handlers;for(var c=0,f=l.length;c<f;c++)l[c](C(D(g),p[a]))}});this.projections=e.emitter();e.combine([this.projections],[this.event["patch/set-inputs"],this.event["patch/set-outputs"]]).onValue(function(b){var g=b[0],p=b[1];b=b[2];for(var a,k=0;k<p.length;k++)a=g.addInlet(p[k].type,p[k].name),a.event["inlet/update"].onValue(function(b){return function(g){b.receive(g)}}(p[k]));for(k=0;k<b.length;k++)p=g.addOutlet(b[k].type,
b[k].name),b[k].event["outlet/update"].onValue(function(b){return function(g){b.send(g)}}(p));l.event["patch/project"].emit({node:g,target:g.patch});g.patch.event["patch/refer"].emit({node:g,target:l})});this.nodesToRemove=e.emitter();this.event["patch/is-ready"].emit()}function d(b,l,a,g){this.type=b||"core/empty";this.id=x();var p=z(y[this.type],this);p||E("Node type "+this.type+" is not registered!");this.def=p;this.name=a||p.name||b;this.patch=l;this.render=k(A[this.type],this);b={"node/turn-on":[],
"node/is-ready":[],"node/process":["inlets","outlets"],"node/turn-off":[],"node/add-inlet":["inlet"],"node/remove-inlet":["inlet"],"node/add-outlet":["outlet"],"node/remove-outlet":["outlet"],"node/move":["position"]};this.event=w(b);this.events=v(b,this.event,"node",this);g&&g(this);var c=this;if(this.def.handle)this.events.onValue(function(b){if(c.def.handle[b.type])c.def.handle[b.type](b)});if(this.def.process){var f=this.def.process;g=e.combine([this.event["node/add-inlet"].flatMap(function(b){var g=
b.event["inlet/update"].map(function(g){return{inlet:b,value:g}});c.def.tune&&(g=c.def.tune(g));return g})],[this.event["node/add-outlet"].scan(function(b,g){b[g.alias]=g;return b},{})]);g=g.bufferBy(this.event["node/is-ready"]).take(1).flatten().concat(g);g=g.scan(function(b,g){var p=g[0].inlet,l=p.alias;b.inlets.prev[l]=b.inlets.cur[l];b.inlets.cur[l]=g[0].value;b.outlets=g[1];b.source=p;return b},{inlets:{prev:{},cur:{}},outlets:{}}).changes();g=g.filter(function(b){return!b.source.cold});g.onValue(function(b){var g=
f.bind(c)(b.inlets.cur,b.inlets.prev);c.event["node/process"].emit({inlets:b.inlets.cur,outlets:g});b=b.outlets;for(var p in g)b[p]&&(g[p]instanceof e.Stream?b[p].stream(g[p]):b[p].send(g[p]))})}if(this.def.inlets){this.inlets={};for(var m in this.def.inlets)g=this.def.inlets[m],g=this.addInlet(g.type,m,g.name,g.default,g.hidden,g.readonly,g.cold),this.inlets[m]=g}if(this.def.outlets)for(m in this.outlets={},this.def.outlets)g=this.def.outlets[m],g=this.addOutlet(g.type,m,g.name,g.default),this.outlets[m]=
g;this.def.prepare&&this.def.prepare(this.inlets,this.outlets);this.event["node/is-ready"].emit()}function m(b,l,a,g,p,c,f,m){this.type=b||"core/any";this.id=x();var d=z(F[this.type],this);d||E("Channel type "+this.type+" is not registered!");this.def=d;(this.alias=a||d.alias||g)||E("Inlet should have either alias or name");this.name=g||d.name||this.alias||b;this.node=l;this.hidden=c||!1;this.readonly=r(f||d.readonly)?f||d.readonly:!0;this.cold=m||!1;this.default=r(p)?p:d.default;this.value=e.pool();
this.render=k(G[this.type],this);b={"inlet/update":["value"]};this.event=w(b);var h=this.event["inlet/update"];l=h.merge(this.value);d.tune&&(l=d.tune(l));d.accept&&(l=l.flatten(function(b){if(d.accept(b))return[b];h.error();return[]}));d.adapt&&(l=l.map(d.adapt));this.event["inlet/update"]=l.onValue(function(){});this.events=v(b,this.event,"inlet",this)}function n(b,l,a,g,p){this.type=b||"core/any";this.id=x();var c=z(F[this.type],this);c||E("Channel type "+this.type+" is not registered!");this.def=
c;(this.alias=a||c.alias||g)||E("Outlet should have either alias or name");this.name=g||this.alias||c.name||b;this.node=l;this.default=r(p)?p:c.default;this.value=e.pool();this.render=k(G[this.type],this);b={"outlet/update":["value"],"outlet/connect":["link","inlet"],"outlet/disconnect":["link"]};this.event=w(b);l=this.event["outlet/update"].merge(this.value);this.event["outlet/update"]=l.onValue(function(b){});this.events=v(b,this.event,"outlet",this);var d=this;e.combine([this.event["outlet/connect"]],
[this.event["outlet/update"]]).onValue(function(b){d.value.plug(e.constant(b[1]))})}function f(b,l,a){this.id=x();this.name=a||"";this.outlet=b;this.inlet=l;this.value=e.emitter();var g=this;this.receiver=b.node.id!==l.node.id?function(b){g.pass(b)}:function(b){setTimeout(function(){g.pass(b)},0)};b={"link/enable":[],"link/disable":[],"link/pass":["value"]};this.event=w(b);a=this.event["link/pass"].merge(this.value);this.event["link/pass"]=a.onValue(function(b){});this.events=v(b,this.event,"link",
this);this.enabled=e.merge([this.event["link/disable"].map(c(!1)),this.event["link/enable"].map(c(!0))]).toProperty(c(!0));this.event["link/pass"].filterBy(this.enabled).onValue(function(b){l.receive(b)});e.combine([this.event["link/enable"]],[this.event["link/pass"]]).onValue(function(b){g.pass(b[1])})}function D(b){for(var l={},a=Object.keys(b),g=0,p=a.length;g<p;g++)l[a[g]]=b[a[g]];return l}function r(b){return"undefined"!==typeof b}function z(b,a){return b?"function"===typeof b?b(a):b:null}function k(b,
a){if(!b)return{};var k={},g;for(g in b)k[g]=z(b[g],a);return k}function w(b){var a={};b=Object.keys(b);for(var k=0,g;k<b.length;k++)g=b[k],a[g]=e.emitter();return a}function J(b,a){if(0===a.length)return function(){return{type:b}};if(1===a.length)return function(k){var g={};g.type=b;g[a[0]]=k;return g};if(1<a.length)return function(a){a=D(a);a.type=b;return a}}function v(b,a,k,g){for(var p=e.pool(),c=Object.keys(b),d=0;d<c.length;d++)p.plug(a[c[d]].map(J(c[d],b[c[d]])).map(function(b){b[k]=g;return b}));
return p}function E(b,a){throw a||Error(b);}function x(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}function C(b,a){var k=b.type;if("patch/add-node"===k||"node/process"===k)b.render=b.node.render[a]||{};else if("node/add-inlet"===k||"inlet/update"===k)b.render=b.inlet.render[a]||{};else if("node/add-outlet"===k||"outlet/update"===k)b.render=b.outlet.render[a]||{};return b}(function(){e.emitter=function(){var b,a=e.stream(function(a){b=a;return function(){b=void 0}});a.emit=
function(a){b&&b.emit(a);return this};a.error=function(a){b&&b.error(a);return this};a.end=function(){b&&b.end();return this};a.emitEvent=function(a){b&&b.emitEvent(a);return this};return a.setName("emitter")}})();var y={},F={},A={},G={},K={},B={},L={},N={"network/add-patch":["patch"]},H=w(N),u=v(N,H,"network",a);H["network/add-patch"].onValue(function(b){u.plug(b.events)});var q=e.emitter();h.prototype.render=function(b,a,k){b=Array.isArray(b)?b:[b];a=Array.isArray(a)?a:[a];for(var g=0,p=b.length,
c;g<p;g++)for(var d=0,f=a.length,m;d<f;d++){c=b[g];m=a[d];if(!L[c])throw Error("Renderer "+c+" is not registered");this.renderQueue.emit({alias:c,target:m,config:k})}return this};h.prototype.addNode=function(b,a){var k=this;return new d(b,this,a,function(b){k.events.plug(b.events);k.event["patch/add-node"].emit(b);b.turnOn()})};h.prototype.removeNode=function(b){b.turnOff();this.event["patch/remove-node"].emit(b);this.events.unplug(b.events)};h.prototype.enter=function(){this.event["patch/enter"].emit();
return this};h.prototype.exit=function(){this.event["patch/exit"].emit();return this};h.prototype.inputs=function(b){this.event["patch/set-inputs"].emit(b)};h.prototype.outputs=function(b){this.event["patch/set-outputs"].emit(b)};h.prototype.project=function(b){this.projections.emit(b)};d.prototype.turnOn=function(){this.event["node/turn-on"].emit()};d.prototype.turnOff=function(){this.event["node/turn-off"].emit()};d.prototype.addInlet=function(b,a,k,g,p,c,d){b=new m(b,this,a,k,g,p,c,d);this.events.plug(b.events);
this.event["node/add-inlet"].emit(b);b.toDefault();return b};d.prototype.addOutlet=function(b,a,k,g){b=new n(b,this,a,k,g);this.events.plug(b.events);this.event["node/add-outlet"].emit(b);b.toDefault();return b};d.prototype.removeInlet=function(b){this.event["node/remove-inlet"].emit(b);this.events.unplug(b.events)};d.prototype.removeOutlet=function(b){this.event["node/remove-outlet"].emit(b);this.events.unplug(b.events)};d.prototype.move=function(b,a){this.event["node/move"].emit([b,a]);return this};
m.prototype.receive=function(b){this.value.plug(e.constant(b))};m.prototype.stream=function(b){this.value.plug(b)};m.prototype.toDefault=function(){r(this.default)&&(this.default instanceof e.Stream?this.stream(this.default):this.receive(this.default))};m.prototype.allows=function(b){if(b.type===this.type)return!0;if(!this.def.allow&&b.type!==this.type)return!1;if(this.def.allow){var a=!1;this.def.allow.forEach(function(k){b.type===k&&(a=!0)});return a}return!0};n.prototype.connect=function(b){if(!b.allows(this))throw Error("Outlet of type "+
this.type+" is not allowed to connect to inlet of type "+b.type);var a=new f(this,b);this.events.plug(a.events);this.value.onValue(a.receiver);this.event["outlet/connect"].emit({link:a,inlet:b});return a};n.prototype.disconnect=function(b){this.event["outlet/disconnect"].emit(b);this.value.offValue(b.receiver);this.events.unplug(b.events);return this};n.prototype.send=function(b){this.value.plug(e.constant(b))};n.prototype.stream=function(b){this.value.plug(b)};n.prototype.toDefault=function(){r(this.default)&&
(this.default instanceof e.Stream?this.stream(this.default):this.send(this.default))};f.prototype.pass=function(b){this.value.emit(b)};f.prototype.enable=function(){this.event["link/enable"].emit()};f.prototype.disable=function(){this.event["link/disable"].emit()};f.prototype.disconnect=function(){this.outlet.disconnect(this)};return{VERSION:"v2.0",_:{Patch:h,Node:d,Inlet:m,Outlet:n,Link:f},unit:c,not:function(b){return!b},event:H,events:u,addPatch:function(b){b=new h(b);H["network/add-patch"].emit(b);
return b},render:function(b,a,k){q.emit([b,a,k]);var g=function(g){g.render(b,a,k)};H["network/add-patch"].onValue(g);return function(){H["network/add-patch"].offValue(g)}},nodetype:function(b,a){y[b]=a||{}},channeltype:function(b,a){F[b]=a||{}},nodedescription:function(b,a){K[b]=a},renderer:function(b,a){L[b]=a},styles:B,style:function(b,a,k){B[b]||(B[b]={});B[b][a]=k},noderenderer:function(b,a,k){if(!y[b])throw Error("Node type "+b+" is not registered");A[b]||(A[b]={});A[b][a]=k},channelrenderer:function(b,
a,k){if(!F[b])throw Error("Channel type "+b+" is not registered");G[b]||(G[b]={});G[b][a]=k},"import":{},"export":{},allNodeTypes:y,allNodeDescriptions:K,getStyle:function(b,a){if(!b)throw Error("Unknown style requested: "+b);if(!B[b])throw Error("Style '"+b+"' is not registered");var k=B[b][a];if(!k)throw Error("Style '"+b+"' has no definition for '"+a+"' renderer");return k},short_uid:x}}();"function"===typeof define&&define.amd?(define([],function(){return a}),d.Rpd=a):"object"===typeof module&&
"object"===typeof exports?(module.exports=a,a.Rpd=a):d.Rpd=a})(this);var d3_tiny=function(){function d(a,c,d){for(var e="function"===typeof c?c:function(){return c},m=a.selection,n=0,f=m.length;n<f;n++)d(m[n],e.bind(m[n])(n));return a}function e(a,c,d){c=c||document;selection="string"===typeof a?d?Array.prototype.slice.call(c.querySelectorAll(a),0):[c.querySelector(a)]:a instanceof Node?[a]:Array.isArray(a)?a:[a];this.namespace=1===selection.length&&selection[0]?selection[0].namespaceURI:null;this.selection=selection}e.prototype.empty=function(){return 1===this.selection.length&&
!this.selection[0]||!this.selection.length?!0:!1};e.prototype.attr=function(a,c){return"undefined"===typeof c&&1===this.selection.length?this.selection[0].getAttribute(a):d(this,c,function(c,d){c.setAttributeNS(null,a,d)})};e.prototype.property=function(a,c){return"undefined"===typeof c&&1===this.selection.length?this.selection[0][a]:d(this,c,function(c,d){c[a]=d})};e.prototype.style=function(a,c){"-"===a[0]&&(a=a.slice(1));a=a.replace(/-([a-z])/g,function(a){return a[1].toUpperCase()});return d(this,
c,function(c,d){c.style[a]=d})};e.prototype.text=function(a){return"undefined"===typeof a&&1===this.selection.length?this.selection[0].textContent||this.selection[0].innerText:d(this,a,function(a,d){a.innerText=a.textContent=d})};e.prototype.classed=function(a,c){return"object"===typeof a?d(this,Object.keys(a),function(c,d){for(var m=0,e=d.length;m<e;m++)c.classList.toggle(d[m],a[d[m]])}):d(this,c,function(c,d){c.classList.toggle(a,d)})};e.prototype.select=function(a){return new e(a,this.selection[0])};
e.prototype.selectAll=function(a){return new e(a,this.selection[0],!0)};e.prototype.append=function(a){var c=[];d(this,"string"===typeof a?document.createElementNS(this.namespace,a):a,function(a,d){a.appendChild(d);c.push(d)});return new e(c)};e.prototype.remove=function(){return d(this,function(){return null},function(a){a.parentElement.removeChild(a)})};e.prototype.node=function(a){return this.selection[a||0]};e.prototype.on=function(a,c){return d(this,function(){return c},function(c,d){c.addEventListener(a,
d)})};e.prototype.data=function(a){return a?d(this,a,function(a,d){a.__data__=d}):this.node().__data__};e.prototype.call=function(a){a(this);return this};return{ns:{prefix:{svg:"http://www.w3.org/2000/svg",html:"http://www.w3.org/1999/xhtml"}},select:function(a,c){return new e(a,c)},selectAll:function(a,c){return new e(a,c,!0)}}}();Rpd.Render=function(){function d(a){this.currentPatch=null;this.getPatchByHash=a;var c=this;Kefir.fromEvents(window,"hashchange").map(function(){return window.location.hash?window.location.hash.slice(1):null}).filter(function(a){return!(c.currentPatch&&a===c.currentPatch.id)}).map(c.getPatchByHash).filter(function(a){return null!=a}).onValue(function(a){c.currentPatch&&c.currentPatch.exit();a.enter()})}function e(a){this.nodeRects=[];this.edgePadding=a.edgePadding||{horizontal:30,vertical:20};this.boxPadding=
a.boxPadding||{horizontal:20,vertical:30}}function a(a,c){this.root=a;this.style=c}function c(a,c){this.link=a;this.style=c;this.element=this.styledLink=null}function h(){this.vlinks=[]}function t(a){a.stopPropagation();return a}function m(a){return{x:a.clientX,y:a.clientY}}function n(a,c,d,m){Kefir.fromEvents(a,"click").map(t).map(f(m||!1)).scan(Rpd.not).onValue(function(a){a?c():d()})}var f=Rpd.unit,D=d3_tiny||D;d.prototype.switch=function(a){a&&(this.currentPatch=a,0<=document.title.indexOf("\u2014")?
document.title=document.title.replace(/\u2014.+$/,"\u2014 "+a.name||"[Unnamed]"):document.title+=" \u2014 "+a.name||"[Unnamed]",window.location.hash=a.id)};e.DEFAULT_LIMITS=[1E3,1E3];e.prototype.nextPosition=function(a,c,d){d=d||e.DEFAULT_LIMITS;a=this.nodeRects;var f=this.boxPadding,m=this.edgePadding,n=c.width;c=c.height;var h=a.length?a[a.length-1]:null,h={x:h?h.x:m.horizontal,y:h?h.y+h.height+f.vertical:m.vertical,width:n,height:c};h.y+c+m.vertical>d.height&&(h.x=h.x+n+f.horizontal,h.y=m.vertical);
a.push(h);return{x:h.x,y:h.y}};a.prototype.add=function(a,c){var d=this.root,f=this.style,e=c.start,h=c.end,n=c.drag;Kefir.fromEvents(a.node(),"mousedown").map(m).map(f.getLocalPos).flatMap(function(c){var n=e(),w=c.x-n.x,r=c.y-n.y;c=Kefir.fromEvents(d.node(),"mousemove").map(t).takeUntilBy(Kefir.merge([Kefir.fromEvents(d.node(),"mouseup"),Kefir.fromEvents(a.node(),"mouseup")])).map(m).map(f.getLocalPos).map(function(a){return{x:a.x-w,y:a.y-r}}).toProperty(function(){return n});c.last().onValue(h);
return c}).onValue(n)};c.prototype.construct=function(a){if(this.styledLink)throw Error("VLink is already constructed");this.styledLink=a=this.style.createLink(this.link);this.element=D.select(a.element);return this};c.prototype.rotate=function(a,c,d,f){this.styledLink.rotate(a,c,d,f);return this};c.prototype.rotateI=function(a,c,d){var f=this.style,f=f.getLocalPos(f.getInletPos(d));return this.rotate(a,c,f.x,d.y)};c.prototype.rotateO=function(a,c,d){var f=this.style;a=f.getLocalPos(f.getOutletPos(a));
return this.rotate(a.x,a.y,c,d)};c.prototype.rotateOI=function(a,c){var d=this.style,f=d.getLocalPos(d.getOutletPos(a)),d=d.getLocalPos(d.getInletPos(c));return this.rotate(f.x,f.y,d.x,d.y)};c.prototype.update=function(){if(this.link){var a=this.link;this.rotateOI(a.outlet,a.inlet);return this}};c.prototype.appendTo=function(a){a.append(this.element.node());return this};c.prototype.removeFrom=function(a){this.element.remove();return this};c.prototype.noPointerEvents=function(){this.styledLink.noPointerEvents&&
this.styledLink.noPointerEvents();return this};c.prototype.listenForClicks=function(){var a=this.link;n(this.element.node(),function(){a.enable()},function(){a.disable()});return this};c.prototype.enable=function(){this.element.classed("rpd-disabled",!1)};c.prototype.disable=function(){this.element.classed("rpd-disabled",!0)};c.prototype.get=function(){return this.link};c.prototype.getElement=function(){return this.element.node()};h.prototype.clear=function(){this.vlinks=[]};h.prototype.add=function(a){this.vlinks.push(a);
return a};h.prototype.remove=function(a){this.vlinks=this.vlinks.filter(function(c){return c!==a})};h.prototype.forEach=function(a){this.vlinks.forEach(a)};h.prototype.updateAll=function(){this.forEach(function(a){a.update()})};h.prototype.count=function(){return this.vlinks.length};h.prototype.getLast=function(){return this.count()?this.vlinks[this.vlinks.length-1]:null};var r=function(){var a={};return function(c,d,f){d.classed("rpd-error",!0);a[c]&&clearTimeout(a[c]);a[c]=setTimeout(function(){d.classed("rpd-error",
!1);a[c]=null},f||1)}}(),z=function(){var a={};return function(c,d,f){d.classed("rpd-stale",!1);d.classed("rpd-fresh",!0);a[c]&&clearTimeout(a[c]);a[c]=setTimeout(function(){d.classed("rpd-fresh",!1);d.classed("rpd-stale",!0);a[c]=null},f||1)}}();return{Navigation:d,Placing:e,DragAndDrop:a,VLink:c,VLinks:h,mergeConfig:function(a,c){if(a){var d={};Object.keys(c).forEach(function(a){d[a]=c[a]});Object.keys(a).forEach(function(c){d[c]=a[c]});return d}return c},preventDefault:function(a){a.preventDefault();
return a},stopPropagation:t,extractPos:m,addTarget:function(a){return function(c){return{pos:c,target:a}}},addClickSwitch:n,addValueErrorEffect:r,addValueUpdateEffect:z,subscribeUpdates:function(a,c){c&&Object.keys(c).forEach(function(d){(function(c,d){a.event["node/add-inlet"].filter(function(a){return a.alias===d}).onValue(function(d){a.event["node/is-ready"].onValue(function(){c.default&&d.receive(c.default());if(c.valueOut)c.valueOut.onValue(function(a){d.receive(a)})})})})(c[d],d)})}}}();Rpd.style("quartz","html",function(d){function e(a){a=a.getBoundingClientRect();return{x:a.left,y:a.top}}var a=a||d3_tiny,c,h={},t={};return{edgePadding:{horizontal:30,vertical:20},boxPadding:{horizontal:20,vertical:30},createRoot:function(c,d){return{element:a.select(document.createElement("div")).classed("rpd-patch",!0).node()}},createNode:function(c,e,f){var h=a.select(document.createElement("table")).attr("class","rpd-node");h.append("thead").attr("class","rpd-title").classed("rpd-drag-handle",
!0).call(function(a){a.append("tr").attr("class","rpd-remove-button").append("th").text("x")}).call(function(a){a.append("tr").attr("class","rpd-header").append("th").attr("colspan",3).call(function(a){d.showTypes&&a.append("span").attr("class","rpd-type").text(c.type);a.append("span").attr("class","rpd-name").text(c.name);a.attr("title",f?f+" ("+c.type+")":c.type)})});h.append("tbody").attr("class","rpd-content").call(function(a){a.append("tr").call(function(a){a.append("td").attr("class","rpd-inlets").append("table").append("tbody").append("div").attr("class",
"rpd-inlets-target")}).call(function(a){a.append("td").attr("class","rpd-body").append("table").append("tbody").append("tr").append("td").append("div").attr("class","rpd-process-target")}).call(function(a){a.append("td").attr("class","rpd-outlets").append("table").append("tbody").append("div").attr("class","rpd-outlets-target")})});return{element:h.node(),size:e.size?{width:e.size.width||70,height:e.size.height||30}:{width:70,height:30}}},createInlet:function(c,e){var f=a.select(document.createElement("tr")).attr("class",
"rpd-inlet").call(function(a){a.append("td").attr("class","rpd-connector");a.append("td").attr("class","rpd-value-holder").append("span").attr("class","rpd-value");a.append("td").attr("class","rpd-name").text(c.name);d.showTypes&&a.append("td").attr("class","rpd-type").text(c.type)});h[c.id]=f.select(".rpd-connector");return{element:f.node()}},createOutlet:function(c,e){var f=a.select(document.createElement("tr")).attr("class","rpd-outlet").call(function(a){a.append("td").attr("class","rpd-connector");
a.append("td").attr("class","rpd-value");d.showTypes&&a.append("td").attr("class","rpd-type").text(c.type);a.append("td").attr("class","rpd-name").text(c.name)});t[c.id]=f.select(".rpd-connector");return{element:f.node()}},createLink:function(c){var d=a.select(document.createElement("span")).attr("class","rpd-link").style("position","absolute").style("transform-origin","left top").style("-webkit-transform-origin","left top");return{element:d.node(),rotate:function(a,c,e,m){var h=Math.sqrt((a-e)*(a-
e)+(c-m)*(c-m));e=Math.atan2(m-c,e-a);d.style("left",a+"px").style("top",c+"px").style("width",Math.floor(h)+"px").style("transform","rotateZ("+e+"rad)").style("-webkit-transform","rotateZ("+e+"rad)")}}},getInletPos:function(a){return e(h[a.id].node())},getOutletPos:function(a){return e(t[a.id].node())},getLocalPos:function(a){if(!c)return a;var d=e(c.node());return{x:a.x+d.x,y:a.y+d.y}},onPatchSwitch:function(d,e){c=a.select(e)}}});(function(){function d(d){return function(e,h){var u=E(h,t),q=Rpd.getStyle(u.style,"html")(u);e=m.select(e).classed("rpd-network",!0);var b,l,M;return{"patch/is-ready":function(g){var c=m.select(document.documentElement);b=m.select(q.createRoot(d,e).element).style("height",c.property("clientHeight")+"px");b.classed("rpd-style-"+u.style,!0).classed("rpd-values-"+(u.valuesOnHover?"on-hover":"always-shown"),!0).classed("rpd-show-boxes",u.showBoxes);f.patches[d.id]=b.data({patch:g.patch});f.patchToPlacing[d.id]=
new n.Placing(q);f.patchToLinks[d.id]=new v;l=new w(b,q,u);u.nodeMovingAllowed&&(M=new n.DragAndDrop(b,q));u.renderNodeList&&a(b,z,k);Kefir.fromEvents(window,"resize").map(function(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}).onValue(function(a){b.style("height",a+"px")});Kefir.fromEvents(b.node(),"selectstart").onValue(x)},"patch/enter":function(a){r=a.patch;D.switch(a.patch);var b=f.patches[a.patch.id];e.append(b.node());f.patchToLinks[a.patch.id].updateAll();
if(q.onPatchSwitch)q.onPatchSwitch(r,b.node())},"patch/exit":function(a){r=null;b.remove()},"patch/refer":function(a){var b=f.nodes[a.node.id];b.select(".rpd-node").classed("rpd-patch-reference",!0);b.data().processTarget.text("["+(a.target.name||a.target.id)+"]");Kefir.fromEvents(b.data().processTarget.node(),"click").onValue(function(a,b){return function(){a.exit();b.enter()}}(d,a.target))},"patch/add-node":function(a){var b=a.node,c=a.patch,d=a.render,e=m.select(document.createElement("div")).attr("class",
"rpd-node-box"),h=q.createNode(b,d,k[b.type]),l=e.append(h.element);l.classed("rpd-"+b.type.slice(0,b.type.indexOf("/"))+"-toolkit-node",!0).classed("rpd-"+b.type.replace("/","-"),!0);e.style("z-index",0);f.nodes[b.id]=e.data({inletsTarget:l.select(".rpd-inlets-target"),outletsTarget:l.select(".rpd-outlets-target"),processTarget:l.select(".rpd-process-target"),pos:{x:0,y:0}});var n=new v;f.nodeToLinks[b.id]=n;if(u.nodeMovingAllowed){var t=l.select(".rpd-drag-handle");t.empty()||M.add(t,{start:function(){e.classed("rpd-dragging",
!0);e.style("z-index",1);return e.data().pos},drag:function(a){e.style("left",a.x+"px");e.style("top",a.y+"px");n.forEach(function(a){a.element.style("z-index",3);a.update()})},end:function(a){b.move(a.x,a.y);e.classed("rpd-dragging",!1);e.style("z-index",0);n.forEach(function(a){a.element.style("z-index",2)})}})}d.prepare&&d.prepare.bind(b)(f.patches[c.id].node(),f.patches[r.id].node());d.first&&B(b,d.first.bind(b)(l.select(".rpd-process-target").node()));if(d.always)b.event["node/process"].throttle(100).onValue(function(){n.updateAll()});
d=f.patches[r.id];h=h.size;nodePos=f.patchToPlacing[a.patch.id].nextPosition(b,h,{width:d.node().offsetWidth,height:d.node().offsetHeight});l.select(".rpd-body").style("min-width",Math.floor(h.width)+"px");l.select(".rpd-body").style("height",Math.floor(h.height)+"px");b.move(nodePos.x,nodePos.y);a=l.select(".rpd-remove-button");if(!a.empty())Kefir.fromEvents(a.node(),"click").map(C).onValue(function(){c.removeNode(b)});f.patches[c.id].append(e.node())},"patch/remove-node":function(a){a=a.node;var b=
f.nodes[a.id];f.nodeToLinks[a.id].forEach(function(a){a.get().disconnect()});b.remove();if(q.onNodeRemove)q.onNodeRemove(a);f.nodes[a.id]=null;f.nodeToLinks[a.id]=null},"node/move":function(a){var b=f.nodes[a.node.id];a=a.position;b.style("left",Math.floor(a[0])+"px");b.style("top",Math.floor(a[1])+"px");b.data().pos={x:a[0],y:a[1]}},"node/process":function(a){var b=a.node,c=a.render;if(c.always){var d=f.nodes[b.id].data().processTarget.node();c.always.bind(b)(d,a.inlets,a.outlets)}},"node/add-inlet":function(a){var d=
a.inlet;if(!d.hidden){var e=f.nodes[a.node.id].data().inletsTarget;a=a.render;var h=m.select(q.createInlet(d,a).element);h.classed("rpd-"+d.type.replace("/","-"),!0);h.classed({"rpd-stale":!0,"rpd-readonly":d.readonly,"rpd-cold":d.cold});var k=null;!d.readonly&&a.edit&&(k=new c(d,a,b,h.select(".rpd-value-holder"),h.select(".rpd-value"),m.select(document.createElement("div"))),h.select(".rpd-value-holder").append(k.editorElm.node()));f.inlets[d.id]=h.data({connector:h.select(".rpd-connector"),value:h.select(".rpd-value"),
vlinks:new v,editor:k});d.event["inlet/update"].onError(function(){G(d.id,h,u.effectTime)});l.subscribeInlet(d,h.select(".rpd-connector"));e.append(h.node())}},"node/add-outlet":function(a){var b=a.outlet,c=f.nodes[a.node.id].data().outletsTarget;a=m.select(q.createOutlet(b,a.render).element);a.classed("rpd-"+b.type.replace("/","-"),!0);a.classed("rpd-stale",!0);f.outlets[b.id]=a.data({connector:a.select(".rpd-connector"),value:a.select(".rpd-value"),vlinks:new v});l.subscribeOutlet(b,a.select(".rpd-connector"));
c.append(a.node())},"node/remove-inlet":function(a){a=a.inlet;f.inlets[a.id].data().vlinks.forEach(function(a){a.get().disconnect()});f.inlets[a.id].remove();if(q.onInletRemove)q.onInletRemove(a);f.inlets[a.id]=null},"node/remove-outlet":function(a){a=a.outlet;f.outlets[a.id].data().vlinks.forEach(function(a){a.get().disconnect()});f.outlets[a.id].remove();if(q.onOutletRemove)q.onOutletRemove(a);f.outlets[a.id]=null},"inlet/update":function(a){var b=a.inlet;if(!b.hidden){var c=a.render,d=f.inlets[b.id],
e=d.data().value;if(!e.empty()){var h=b.def.show?b.def.show(a.value):a.value;c.show?c.show.bind(b)(e.node(),a.value,h):e.text(h)}K(b.id,d,u.effectTime)}},"outlet/update":function(a){var b=a.outlet,c=a.render,d=f.outlets[b.id],e=d.data().value;if(!e.empty()){var h=b.def.show?b.def.show(a.value):a.value;c.show?c.show.bind(b)(e.node(),a.value,h):e.text(h)}K(b.id,d,u.effectTime)},"outlet/connect":function(a){a=a.link;var c=a.outlet,e=a.inlet,h=f.inlets[e.id],l=f.outlets[c.id].data(),h=h.data();if(!u.inletAcceptsMultipleLinks&&
1===h.vlinks.count())throw Error("Inlet is already connected to a link");h.editor&&h.editor.disable();var k=new J(a,q);k.construct(u.linkWidth).rotateOI(c,e);m.select(k.getElement()).style("z-index",2).classed("rpd-"+e.type.replace("/","-"),!0).classed("rpd-"+c.type.replace("/","-"),!0);f.links[a.id]=k;l.vlinks.add(k);h.vlinks.add(k);f.nodeToLinks[c.node.id].add(k);c.node.id!==e.node.id&&f.nodeToLinks[e.node.id].add(k);f.patchToLinks[d.id].add(k);k.listenForClicks();k.appendTo(b)},"outlet/disconnect":function(a){a=
a.link;var c=f.links[a.id],e=a.outlet,h=a.inlet,k=f.outlets[e.id].data(),l=f.inlets[h.id].data();f.links[a.id]=null;k.vlinks.remove(c);l.vlinks.remove(c);f.nodeToLinks[e.node.id].remove(c);e.node.id!==h.node.id&&f.nodeToLinks[h.node.id].remove(c);f.patchToLinks[d.id].remove(c);c.removeFrom(b)},"link/enable":function(a){var b=f.inlets[a.link.inlet.id].data();b.editor&&b.editor.disable();f.links[a.link.id].enable()},"link/disable":function(a){f.links[a.link.id].disable()}}}}function e(a,c){return Kefir.merge([a.map(h(!0)),
c.map(h(!1))]).toProperty(h(!1))}function a(a,c,d){var e={};Object.keys(c).forEach(function(a){var d=a.split("/"),h=d[0],d=d[1];e[h]||(e[h]={});e[h][d]=c[a]});var h=m.select(document.createElement("dl")).attr("class","rpd-nodelist");Object.keys(e).forEach(function(a){var c=h.append("dd").attr("class","rpd-toolkit-name").text(a);h.append("dt").append("dl").attr("class","rpd-toolkit").data({titleElm:c,nodeTypes:e[a],toolkit:a}).call(function(a){var b=a.data().titleElm;A(b.node(),function(){a.classed("rpd-collapsed",
!0)},function(){a.classed("rpd-collapsed",!1)},!0)}).call(function(a){var b=a.data().toolkit,c=a.data().nodeTypes;Object.keys(c).forEach(function(c){var e=b+"/"+c;c=a.append("dd").attr("class","rpd-node-title").text(c);c.append("span").attr("class","rpd-add-node").text("+ Add").data(e).call(function(a){Kefir.fromEvents(a.node(),"click").map(C).onValue(function(){r.addNode(a.data())})});a.append("dd").attr("class","rpd-node-description").data({titleElm:c}).text(d[e]||"[No Description]").classed("rpd-collapsed",
!0).call(function(a){A(a.data().titleElm.node(),function(){a.classed("rpd-collapsed",!0)},function(){a.classed("rpd-collapsed",!1)})})})})});a.append(h.node());a.append(m.select(document.createElement("span")).attr("class","rpd-collapse-nodelist").text(">>").call(function(a){A(a.node(),function(){a.classed("rpd-collapsed",!0).text("<<");h.classed("rpd-collapsed",!0)},function(){a.classed("rpd-collapsed",!1).text(">>");h.classed("rpd-collapsed",!1)},!0)}).node())}function c(a,c,d,e,k,b){var l=Kefir.emitter(),
m=Kefir.emitter();this.disableEditor=m;this.editorElm=b;this.valueElm=k;b.classed("rpd-value-editor",!0);c.edit.bind(a)(b.node(),a,l).onValue(function(b){a.receive(b)});Kefir.combine([Kefir.merge([Kefir.fromEvents(e.node(),"click").map(C).map(h(!0)),Kefir.fromEvents(d.node(),"click").merge(m).map(h(!1))]).toProperty(h(!1)).skipDuplicates()],[a.event["inlet/update"]]).map(function(a){return{lastValue:a[1],startEditing:a[0],cancelEditing:!a[0]}}).onValue(function(b){if(b.startEditing){var c=f.inlets[a.id].data();
c.link&&c.link.disable();l.emit(b.lastValue);e.classed("rpd-editor-enabled",!0)}else b.cancelEditing&&(k.classed("rpd-edited",!0),e.classed("rpd-editor-enabled",!1))});e.classed("rpd-editor-disabled",!0)}var h=Rpd.unit,t={style:"quartz",valuesOnHover:!1,showTypes:!1,showBoxes:!1,nodeMovingAllowed:!0,renderNodeList:!0,nodeListCollapsed:!0,inletAcceptsMultipleLinks:!1,effectTime:1E3},m=m||d3_tiny,n=Rpd.Render,f={patches:{},nodes:{},inlets:{},outlets:{},links:{},patchToPlacing:{},patchToLinks:{},nodeToLinks:{}},
D=new n.Navigation(function(a){return function(c){return a.patches[c].data().patch}}(f)),r,z=Rpd.allNodeTypes,k=Rpd.allNodeDescriptions,w=function(){function a(b){return f.inlets[b.id].data().vlinks}function c(b){return function(){return 0<a(b).count()}}function d(a){1===a.count()&&(a=a.getLast().link,a.outlet.disconnect(a))}function k(a,c){a.forEach(function(a){a.link.outlet.id===c.id&&c.disconnect(a.link)})}function n(a,c,d){this.root=a;this.style=c;this.config=d;this.rootClicks=Kefir.fromEvents(this.root.node(),
"click");this.inletClicks=Kefir.pool();this.outletClicks=Kefir.pool();this.startLink=Kefir.emitter();this.finishLink=Kefir.emitter();this.doingLink=e(this.startLink,this.finishLink)}n.prototype.subscribeOutlet=function(b,c){var f=this.root,g=this.style,n=this.config,t=this.rootClicks,q=this.outletClicks,r=this.inletClicks,v=this.startLink,w=this.finishLink,x=this.doingLink;q.plug(Kefir.fromEvents(c.node(),"click").map(y).map(F(b)));Kefir.fromEvents(c.node(),"click").map(C).filterBy(e(q,x)).map(y).onValue(function(c){v.emit();
var e=(new J(null,g)).construct(n.linkWidth).rotateO(b,c.x,c.y).noPointerEvents().appendTo(f);m.select(e.getElement()).style("z-index",2).classed("rpd-"+b.type.replace("/","-"),!0);Kefir.fromEvents(f.node(),"mousemove").takeUntilBy(Kefir.merge([r,q.map(h(!1)),t.map(h(!1))]).take(1).onValue(function(c){if(c){c=c.target;var e=a(c);n.inletAcceptsMultipleLinks?k(e,b):d(e);b.connect(c)}})).map(y).onValue(function(a){e.rotateO(b,a.x,a.y)}).onEnd(function(){e.removeFrom(f);w.emit()})})};n.prototype.subscribeInlet=
function(b,f){var n=this.root,g=this.style,p=this.config,t=this.rootClicks,q=this.outletClicks,r=this.inletClicks,v=this.startLink,w=this.finishLink,x=this.doingLink;r.plug(Kefir.fromEvents(f.node(),"click").map(y).map(F(b)));Kefir.fromEvents(f.node(),"click").map(C).filterBy(e(r,x)).filter(c(b)).onValue(function(c){var e=a(b).getLast().link,f=e.outlet;f.disconnect(e);v.emit();var l=(new J(null,g)).construct(p.linkWidth).rotateO(f,c.x,c.y).noPointerEvents().appendTo(n);m.select(l.getElement()).style("z-index",
2).classed("rpd-"+b.type.replace("/","-"),!0).classed("rpd-"+f.type.replace("/","-"),!0);Kefir.fromEvents(n.node(),"mousemove").takeUntilBy(Kefir.merge([r,q.map(h(!1)),t.map(h(!1))]).take(1).onValue(function(b){if(b){b=b.target;var c=a(b);p.inletAcceptsMultipleLinks?k(c,f):d(c);f.connect(b)}})).map(y).map(g.getLocalPos).onValue(function(a){l.rotateO(f,a.x,a.y)}).onEnd(function(){l.removeFrom(n);w.emit()})})};return n}();c.prototype.disable=function(){this.valueElm.classed("rpd-edited",!1);this.disableEditor.emit()};
var J=n.VLink,v=n.VLinks,E=n.mergeConfig,x=n.preventDefault,C=n.stopPropagation,y=n.extractPos,F=n.addTarget,A=n.addClickSwitch,G=n.addValueErrorEffect,K=n.addValueUpdateEffect,B=n.subscribeUpdates;Rpd.HtmlRenderer=d;Rpd.renderer("html",d)})();Rpd.nodedescription("core/custom","May have any number of inlets and outlets, a target for extension.");Rpd.nodetype("core/custom",{name:"Custom"});Rpd.channeltype("core/number",{default:0,readonly:!1,accept:function(d){if(Infinity===d)return!0;d=parseFloat(d);return!isNaN(d)&&isFinite(d)},adapt:function(d){return parseFloat(d)}});
Rpd.channeltype("core/time",{default:1E3,accept:function(d){d=parseFloat(d);return!isNaN(d)&&isFinite(d)},adapt:function(d){return parseFloat(d)},show:function(d){return Math.floor(d/10)/100+"s"}});Rpd.nodetype("core/number",{name:"number",inlets:{"user-value":{type:"core/number",default:0,hidden:!0}},outlets:{out:{type:"core/number"}},process:function(d){return{out:d["user-value"]}}});
Rpd.nodetype("core/random",function(){var d=0;return{name:"random",inlets:{min:{type:"core/number",default:0},max:{type:"core/number",default:100},period:{type:"core/time",default:1E3}},outlets:{out:{type:"core/number"}},process:function(e){if(e.hasOwnProperty("period"))return d++,{out:Kefir.withInterval(e.period,function(a){a.emit(Math.floor(e.min+Math.random()*(e.max-e.min)))}).takeWhile(function(a){return function(){return a===d}}(d))}}}});
Rpd.nodetype("core/bounded-number",{name:"bounded number",inlets:{min:{type:"core/number",default:0},max:{type:"core/number",default:Infinity},spinner:{type:"core/number",default:0,hidden:!0}},outlets:{out:{type:"core/number"}},process:function(d){if(d.hasOwnProperty("spinner"))return{out:d.spinner}}});Rpd.channeltype("core/any",{});Rpd.channeltype("core/boolean",{default:!1,readonly:!1,adapt:function(d){return d?!0:!1}});(function(){function d(a){return{x:a.clientX,y:a.clientY}}function e(a,c,e){this.element=a;this.min=c||0;this.max=isNaN(e)?Infinity:e;this.value=this.min;var t=this;this.incoming=Kefir.emitter();Kefir.fromEvents(a,"mousedown").map(d).flatMap(function(a){var c=t.value;return Kefir.fromEvents(document.body,"mousemove").map(d).takeUntilBy(Kefir.fromEvents(document.body,"mouseup")).map(function(d){return c+(d.x-a.x)}).onValue(function(a){t.incoming.emit(a)})}).onEnd(function(){});this.changes=this.incoming.map(function(a){return t.setValue(a)})}
Rpd.noderenderer("core/number","html",{first:function(a){var c=document.createElement("input");c.style.display="block";c.type="number";c.min=0;c.max=1E3;a.appendChild(c);return{"user-value":{default:function(){return c.value=0},valueOut:Kefir.fromEvents(c,"change").map(function(){return c.value})}}}});Rpd.channelrenderer("core/boolean","html",{edit:function(a,c,d){var e=document.createElement("input");e.type="checkbox";d.onValue(function(a){e.checked=a?!0:!1});a.appendChild(e);return Kefir.fromEvents(e,
"change").map(function(){return e.checked}).toProperty(function(){return!1})}});Rpd.channelrenderer("core/number","html",{edit:function(a,c,d){var e=document.createElement("input");e.type="number";d.onValue(function(a){e.value=a});a.appendChild(e);return Kefir.fromEvents(e,"change").map(function(){return e.value})}});Rpd.noderenderer("core/bounded-number","html",function(){var a,c;return{first:function(d){a=document.createElement("span");a.classList.add("rpd-core-spinner");c=new e(a);var t=c.getChangesStream();
d.appendChild(a);return{spinner:{valueOut:t.map(function(a){return parseFloat(a)})}}},always:function(d,e){c.updateBounds(e.min,e.max);a.innerText=a.textContent=c.setValue(e.spinner)}}});e.prototype.setValue=function(a){this.value=a;return this.checkValue()};e.prototype.checkValue=function(){if(isNaN(this.value)||this.value<this.min)this.value=this.min,this.incoming.emit(this.min);this.value>this.max&&(this.value=this.max,this.incoming.emit(this.max));return this.value};e.prototype.updateBounds=function(a,
c){this.min=a||0;this.max=isNaN(c)?Infinity:c;return this.checkValue()};e.prototype.getChangesStream=function(){return this.changes}})();Rpd.nodedescription("demo/empty","Does not allow adding any inlets or outlets.");Rpd.nodetype("demo/empty",{name:"Empty",handle:{"inlet/add":function(){throw Error("Empty node can not have any inlets");},"outlet/add":function(){throw Error("Empty node can not have any outlets");}}});
Rpd.nodetype("demo/sum-of-three",{name:"Sum of Three",width:1.8,inlets:{a:{type:"core/number",name:"A"},b:{type:"core/number",name:"B"},c:{type:"core/number",name:"C"}},outlets:{sum:{type:"core/number",name:"\u2211"}},process:function(d){return{sum:(d.a||0)+(d.b||0)+(d.c||0)}}});Rpd.nodedescription("demo/hot-and-cold","An example of cold inlet.");
Rpd.nodetype("demo/hot-and-cold",{name:"Hot and Cold",inlets:{hot:{type:"core/number",name:"A",default:1},cold:{type:"core/number",name:"B",default:1,cold:!0}},outlets:{value:{type:"core/any"}},process:function(d){return{value:[d.hot,d.cold]}}});Rpd.noderenderer("demo/sum-of-three","html",{size:{width:null,height:200},always:function(d,e,a){d.innerHTML="\u2211 ("+(e.a||"?")+", "+(e.b||"?")+", "+(e.c||"?")+") = "+(a.sum||"?")}});

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />

        <!-- gulp html-head ==style compact-v ==renderer svg ==toolkit core ==root .. -->

        <!-- Built with RPD v0.2.0a <http://shamansir.github.io/rpd> -->

        <!-- RPD Renderer: svg -->
        <link rel="stylesheet" href="../src/render/html.css"></style>
        <!-- RPD Style: compact-v (svg) -->
        <link rel="stylesheet" href="../src/style/compact-v/svg.css"></style>
        <!-- RPD Toolkit: core (svg) -->
        <link rel="stylesheet" href="../src/toolkit/core/svg.css"></style>

        <!-- Kefir -->
        <script src="../vendor/kefir.min.js"></script>
        <!-- RPD -->
        <script src="../src/rpd.js"></script>

        <!-- RPD's d3_tiny.js -->
        <script src="../src/d3_tiny.js"></script>
        <!-- RPD Rendering Engine: -->
        <script src="../src/render/shared.js"></script>
        <!-- RPD Style: compact-v (svg) -->
        <script src="../src/style/compact-v/svg.js"></script>
        <!-- RPD Renderer: svg -->
        <script src="../src/render/svg.js"></script>
        <!-- RPD Toolkit: core -->
        <script src="../src/toolkit/core/shared.js"></script>
        <script src="../src/toolkit/core/toolkit.js"></script>
        <!-- RPD Toolkit: core (svg) -->
        <script src="../src/toolkit/core/svg.js"></script>

        <style>
            .rpd-core-random .rpd-process text {
                font-size: 0.8em;
            }
        </style>

    </head>

    <body>

        <script>
            window.sketchUpdate = function(config) {
                window.missedSketchConfig = config;
            }; // we'll replace it later

            // ============= Register p5/sketch node type and renderer =============

            Rpd.nodetype('p5/sketch', {
                inlets: {
                    'shape': { type: 'p5/shape', default: 'circle', name: 'shape' },
                    'wavescount': { type: 'core/number', default: 5, name: 'waves' },
                    'startcolor': { type: 'p5/color', name: 'from' },
                    'endcolor': { type: 'p5/color', name: 'to' },
                    'xspacing': { type: 'core/number', default: 16, name: 'xspan' },
                    'amplitude': { type: 'core/number', default: 75, name: 'ampl.' },
                    'period': { type: 'core/number', default: 500, name: 'period' }
                },
                process: function(inlets) {
                    window.sketchUpdate(inlets);
                }
            });

            Rpd.noderenderer('p5/sketch', 'svg', {
                size: { width: 420, height: 320 },
                first: function(bodyElm) {
                    var group = document.createElementNS(SVG_XMLNS, 'g');
                    group.setAttributeNS(null, 'transform', 'translate(10, -150)');
                    var foreign = document.createElementNS(SVG_XMLNS, 'foreignObject');
                    var p5Target = document.createElement('div');
                    p5Target.id = 'p5-canvas';
                    foreign.appendChild(p5Target);
                    group.appendChild(foreign);
                    bodyElm.appendChild(group);
                }
            });

            // ============= Monkey-patch core/random renderer =============

            var curSvgRandomRendererFunc = Rpd.allNodeRenderers['core/random'].svg;
            var newSvgRandomRendererFunc = function(node) {
                var returnObj = curSvgRandomRendererFunc.apply(this, arguments);
                if (returnObj.size) {
                    returnObj.size.width = 120;
                } else {
                    returnObj.size = { width: 120 };
                }
                var textElm;
                returnObj.first = function(bodyElm) {
                    textElm = document.createElementNS(SVG_XMLNS, 'text');
                    textElm.innerText = textElm.textContent = '?';
                    textElm.setAttributeNS(null, 'x', 10);
                    bodyElm.appendChild(textElm);
                };
                returnObj.always = function(bodyElm, inlets, outlets) {
                    textElm.innerText = textElm.textContent = 'from ' + inlets.min + ' to ' + inlets.max + ' every ' + (inlets.period / 1000) + 's';
                };
                return returnObj;
            };
            Rpd.allNodeRenderers['core/random'].svg = newSvgRandomRendererFunc;

            // ============= Build and render patch =============

            var patch = Rpd.addPatch('processing');

            patch.render('svg', document.body, { style: 'compact-v',
                                                 fullPage: true,
                                                 renderNodeList: false });
            var sketch = patch.addNode('p5/sketch').move(450, 50);

            var random1 = patch.addNode('core/random').move(50, 50);
            random1.inlets['min'].receive(50); random1.inlets['max'].receive(255);

            var color1 = patch.addNode('p5/color').move(50, 150);
            var color2 = patch.addNode('p5/color').move(240, 50);

            random1.outlets['out'].connect(color1.inlets['r']);

            color2.outlets['color'].connect(sketch.inlets['endcolor']);
            color2.inlets['r'].receive(20); color2.inlets['g'].receive(0); color2.inlets['b'].receive(0);

            var random2 = patch.addNode('core/random').move(240, 150);
            random2.inlets['min'].receive(5); random2.inlets['max'].receive(25);

            var shape = patch.addNode('p5/shape').move(240, 250);
            shape.outlets['shape'].connect(sketch.inlets['shape']);
        </script>

        <!-- p5.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.4.19/p5.min.js"></script>
        <!-- p5 Sketch -->
        <script src="./example.sketch.js"></script>

        <script>
            window.addEventListener('load', function() {
                window.sketchUpdate = function(inlets) {
                    sketchConfig = inlets;
                    // uses a global function from the sketch
                    updateWithConfig(sketchConfig);
                };

                if (window.missedSketchConfig) window.sketchUpdate(window.missedSketchConfig);
            });
        </script>

    </body>
</html>
